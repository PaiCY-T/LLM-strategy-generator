{
  "id": "snapshot_1761660712961_t6npv8cpg",
  "approvalId": "approval_1761660569219_qybgp2m5f",
  "approvalTitle": "Docker Sandbox Integration Testing - Requirements",
  "version": 2,
  "timestamp": "2025-10-28T14:11:52.961Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document: Docker Sandbox Integration Testing\n\n## Introduction\n\nThis specification defines the testing and integration plan for the Docker Sandbox security layer (91% complete, 2,529 lines of code). The Docker Sandbox was recently developed to provide **dual-layer security defense** (AST validation + Container isolation) but remains untested and disabled by default (`sandbox.enabled: false`).\n\n**Purpose**: Validate Docker Sandbox functionality, integrate into autonomous evolution loop, and assess whether to enable by default based on performance metrics.\n\n**Value**: Upgrade from single-layer defense (AST-only) to dual-layer defense (AST + Docker Sandbox), significantly improving security posture while maintaining acceptable performance.\n\n**Timeline**: 2 weeks (10 working days)\n**Priority**: HIGH - Critical path to production\n\n## Alignment with Product Vision\n\nThis feature directly supports the product vision's emphasis on **security and safety**:\n\n- **7-Layer Validation Framework**: Docker Sandbox represents Layer 2 (Container Isolation) between Layer 1 (AST Validation) and Layer 3 (Execution Monitoring)\n- **Production-Ready System**: Current AST-only approach is acceptable for MVP but requires hardening for production with untrusted strategy generation\n- **LLM Integration Enablement**: Dual-layer security is prerequisite for confidently enabling LLM-driven innovation (20% innovation rate target)\n\n**Risk Mitigation**: Windows multiprocessing \"spawn\" overhead was previously identified as a potential blocker. This testing phase will empirically determine if the performance impact is acceptable (<50% overhead target).\n\n## Requirements\n\n### Requirement 1: Basic Docker Sandbox Functionality\n\n**User Story:** As a system administrator, I want Docker containers to start, execute strategies, and stop reliably, so that the sandbox infrastructure is proven stable before integration.\n\n#### Acceptance Criteria\n\n1. WHEN a strategy code is submitted THEN the Docker container SHALL start within 10 seconds\n2. WHEN a container is started THEN the system SHALL execute the strategy and collect results successfully\n3. WHEN strategy execution completes THEN the container SHALL terminate cleanly within 5 seconds\n4. WHEN a container fails THEN the system SHALL log the error and return a meaningful failure message\n5. IF multiple strategies are submitted concurrently THEN each SHALL execute in isolated containers without interference\n\n**Performance Target**: Container startup + execution + cleanup < 60 seconds per strategy (including Taiwan stock data load ~10M points)\n\n### Requirement 2: Resource Limits Enforcement\n\n**User Story:** As a security engineer, I want resource limits (CPU, Memory, Disk) enforced at the container level, so that malicious or buggy strategies cannot consume excessive system resources.\n\n#### Acceptance Criteria\n\n1. WHEN a strategy exceeds memory limit (2GB) THEN the container SHALL be terminated with OOMKilled status\n2. WHEN a strategy exceeds CPU time limit (300 seconds) THEN the container SHALL be terminated with Timeout status\n3. WHEN a strategy attempts excessive disk writes (>1GB) THEN the container SHALL be terminated or restricted\n4. WHEN resource limits are enforced THEN the system SHALL log the violation type and return error metadata\n5. IF a container is terminated due to resource limits THEN the autonomous loop SHALL skip this strategy and continue\n\n**Validation Method**: Intentionally submit strategies that violate each limit and verify correct termination behavior.\n\n### Requirement 3: Seccomp Security Profile\n\n**User Story:** As a security engineer, I want dangerous system calls blocked at the kernel level, so that strategies cannot perform file I/O, network access, or process manipulation outside the container.\n\n#### Acceptance Criteria\n\n1. WHEN a strategy attempts file I/O (open, read, write) to host filesystem THEN the syscall SHALL be blocked with EPERM\n2. WHEN a strategy attempts network access (socket, connect) THEN the syscall SHALL be blocked with EPERM\n3. WHEN a strategy attempts process manipulation (fork, exec, kill) THEN the syscall SHALL be blocked with EPERM\n4. WHEN a strategy attempts time manipulation (settimeofday, clock_settime) THEN the syscall SHALL be blocked with EPERM\n5. IF a blocked syscall is attempted THEN the system SHALL log the violation with strategy ID and syscall name\n\n**Security Test Cases**: Submit strategies that attempt each blocked operation and verify Seccomp enforcement.\n\n### Requirement 4: Integration with Autonomous Loop\n\n**User Story:** As a developer, I want Docker Sandbox integrated into `autonomous_loop.py` with automatic fallback to AST-only execution, so that the system gracefully handles sandbox failures without halting evolution.\n\n#### Acceptance Criteria\n\n1. WHEN `sandbox.enabled: true` in config THEN the autonomous loop SHALL route strategy execution through Docker Sandbox\n2. WHEN a sandbox execution fails (timeout, error) THEN the system SHALL automatically fallback to AST-only execution\n3. WHEN fallback occurs THEN the system SHALL log a WARNING with failure reason and continue the iteration\n4. IF sandbox is disabled (`sandbox.enabled: false`) THEN the system SHALL use AST-only execution (current behavior)\n5. WHEN an iteration completes THEN the system SHALL record whether sandbox or fallback was used in iteration metadata\n\n**Backward Compatibility**: All existing tests must pass with `sandbox.enabled: false` (no regressions).\n\n### Requirement 5: Performance Benchmarking\n\n**User Story:** As a product owner, I want empirical performance data comparing Docker Sandbox vs. AST-only execution, so that I can make an informed decision on whether to enable by default.\n\n#### Acceptance Criteria\n\n1. WHEN running 5-iteration smoke test THEN the system SHALL record per-iteration timing with sandbox enabled\n2. WHEN running 20-iteration validation test THEN the system SHALL record average iteration time and overhead percentage\n3. WHEN performance data is collected THEN the system SHALL calculate: `overhead = (sandbox_time - ast_only_time) / ast_only_time * 100%`\n4. IF overhead < 50% THEN recommend enabling sandbox by default\n5. IF overhead >= 100% THEN document as optional feature with manual enable instructions\n\n**Metrics to Track**:\n- Iteration time (AST-only baseline): 13-26 seconds (from STATUS.md)\n- Iteration time (Docker Sandbox): [To be measured]\n- Overhead percentage: [To be calculated]\n- Success rate (both modes): Target 100%\n\n### Requirement 6: Decision Framework\n\n**User Story:** As a product owner, I want a clear decision framework based on test results, so that the team knows whether to enable Docker Sandbox by default or keep it as an optional feature.\n\n#### Acceptance Criteria\n\n1. WHEN all functional tests pass (Req 1-3) AND overhead < 50% THEN recommend enabling by default (`sandbox.enabled: true`)\n2. WHEN all functional tests pass AND overhead >= 50% AND < 100% THEN recommend optional feature with documentation\n3. WHEN any functional test fails OR overhead >= 100% THEN document as experimental with known issues\n4. WHEN decision is made THEN update `config/learning_system.yaml` and document rationale in STATUS.md\n5. IF sandbox is not enabled by default THEN provide clear activation instructions in documentation\n\n**Decision Matrix**:\n```\n| Functional Tests | Overhead | Decision |\n|-----------------|----------|----------|\n| ✅ PASS | < 50% | ✅ Enable by default |\n| ✅ PASS | 50-100% | ⚠️ Optional feature |\n| ✅ PASS | > 100% | ❌ Document only |\n| ❌ FAIL | Any | ❌ Do not use |\n```\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility**: Separate test modules for functional, integration, and performance tests\n- **Reusable Test Utilities**: Shared fixtures for container lifecycle management\n- **Clear Test Organization**: Group tests by phase (Basic → Integration → Performance → Decision)\n- **Minimal Changes to Core**: Integration should require <50 lines of changes to `autonomous_loop.py`\n\n### Performance\n- **Container Startup**: < 10 seconds per container\n- **Strategy Execution**: Comparable to AST-only (target: <50% overhead)\n- **Total Iteration Time**: < 60 seconds (vs 13-26 seconds AST-only baseline)\n- **Concurrent Execution**: Support 5 parallel containers without degradation\n\n### Security\n- **Defense in Depth**: AST validation must remain enabled (dual-layer, not replacement)\n- **Isolation Guarantee**: Strategies cannot access host filesystem, network, or other containers\n- **Audit Logging**: All security violations logged with strategy ID, timestamp, and violation type\n- **Seccomp Enforcement**: 100% of dangerous syscalls blocked (verified by test suite)\n\n### Reliability\n- **Graceful Degradation**: Sandbox failures must not halt autonomous loop (fallback to AST-only)\n- **Container Cleanup**: All containers must terminate within 10 seconds of completion/timeout\n- **Error Recovery**: System must recover from Docker daemon errors, OOM conditions, and timeouts\n- **Zero Data Loss**: Strategy execution results must be preserved even on sandbox failure (via fallback)\n\n### Usability\n- **Simple Configuration**: Single flag `sandbox.enabled: true/false` to control behavior\n- **Clear Logging**: Distinguish sandbox vs. AST-only execution in logs\n- **Performance Visibility**: Iteration metadata includes sandbox usage and timing\n- **Documentation**: README and troubleshooting guide for common sandbox issues (Docker not running, Windows multiprocessing, resource limits)\n\n### Maintainability\n- **Test Coverage**: ≥90% coverage for Docker Sandbox integration code\n- **Automated Testing**: All functional and integration tests run in CI/CD\n- **Performance Baselines**: Established benchmarks for regression detection\n- **Decision Documentation**: Clear rationale documented for enable/disable decision\n\n## Success Criteria\n\n**Phase 1 Success (Basic Functionality)**:\n- ✅ All Requirement 1-3 tests pass (Container lifecycle, Resource limits, Seccomp)\n- ✅ Zero security violations in positive test cases\n- ✅ 100% security violation detection in negative test cases\n\n**Phase 2 Success (Integration)**:\n- ✅ Requirement 4 tests pass (Autonomous loop integration with fallback)\n- ✅ 5-iteration smoke test completes successfully with sandbox enabled\n- ✅ 20-iteration validation test maintains 100% success rate\n- ✅ Zero regressions with `sandbox.enabled: false`\n\n**Phase 3 Success (Decision)**:\n- ✅ Performance benchmarks collected for both modes\n- ✅ Overhead percentage calculated and documented\n- ✅ Decision made per Requirement 6 framework\n- ✅ Configuration and documentation updated accordingly\n\n**Overall Success**: Docker Sandbox validated as production-ready (either enabled by default or documented as optional feature with clear activation path).\n\n## Out of Scope\n\n**Not in this specification**:\n- Docker Sandbox implementation (already complete at 91%, 2,529 lines)\n- AST validation improvements (separate concern, current defense)\n- Multi-host orchestration (single-machine scope for MVP)\n- GPU resource management (CPU/Memory only)\n- Windows-specific optimizations (test on Windows first, optimize if needed)\n\n**Future Enhancements** (separate specs if needed):\n- Container image caching for faster startup\n- Process pool pre-warming (if startup overhead is unacceptable)\n- Linux-specific optimizations (fork vs spawn multiprocessing)\n- Alternative isolation methods (thread-based, pyodide WASM)\n\n## Dependencies\n\n**Prerequisites**:\n- Docker Sandbox implementation complete (91%, Task 1-20 from docker-sandbox-security spec)\n- Docker Desktop installed and running on development/test machine\n- Autonomous loop baseline established (13-26 seconds per iteration, 100% success rate with AST-only)\n- Monitoring system operational (resource tracking, metrics collection)\n\n**Blocks**:\n- LLM Integration Activation (Week 3) - Requires dual-layer security confidence before enabling LLM innovation\n\n## Risk Assessment\n\n| Risk | Probability | Impact | Mitigation |\n|------|------------|--------|------------|\n| Windows multiprocessing overhead >100% | MEDIUM | HIGH | Fallback to AST-only, document as optional |\n| Docker daemon crashes/errors | LOW | MEDIUM | Automatic fallback, retry logic |\n| Seccomp profile too restrictive | LOW | LOW | Iterative refinement, test real strategies |\n| Taiwan stock data load timeout | MEDIUM | HIGH | Increase timeout, optimize data loading |\n| Integration breaks existing tests | LOW | HIGH | Backward compatibility requirement, feature flag |\n\n**Critical Risk**: Windows multiprocessing \"spawn\" overhead was noted in STATUS.md as previously causing 120s+ timeouts. If this recurs, the decision framework (Requirement 6) provides clear guidance to document as optional feature rather than blocking.\n",
  "fileStats": {
    "size": 12866,
    "lines": 218,
    "lastModified": "2025-10-28T14:09:15.480Z"
  },
  "comments": []
}