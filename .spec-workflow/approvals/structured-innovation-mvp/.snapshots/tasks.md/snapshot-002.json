{
  "id": "snapshot_1761401642170_ydfrh27up",
  "approvalId": "approval_1761396013177_ugen1q53h",
  "approvalTitle": "Review tasks.md for structured-innovation-mvp (13 tasks, 2-3 days)",
  "version": 2,
  "timestamp": "2025-10-25T14:14:02.170Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: Structured Innovation MVP (Phase 2a)\n\n## Phase 1: YAML Schema & Validation (Tasks 1-2)\n\n- [ ] 1. Create YAML strategy schema\n  - File: `schemas/strategy_schema_v1.json`\n  - Define JSON Schema for strategy specifications\n  - Include sections: metadata, indicators, entry_conditions, exit_conditions, position_sizing\n  - Support indicator types: technical (RSI, MACD, BB), fundamental (ROE, PB_ratio), custom calculations\n  - Define validation rules for all fields\n  - Purpose: Formal specification for LLM-generated YAML strategies\n  - _Leverage: JSON Schema v7 specification_\n  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 4.1, 4.2, 4.3, 4.4_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: API Architect with expertise in JSON Schema and strategy specification | Task: Create comprehensive JSON Schema for YAML strategy specifications following requirements 1.1-1.5 and 4.1-4.4, defining all required fields and validation rules | Restrictions: Must use JSON Schema v7, include clear descriptions for all fields, support 3 strategy types (momentum/mean_reversion/factor_combination) | _Leverage: JSON Schema v7 specification, existing strategy patterns | _Requirements: Requirements 1.1-1.5 (Schema structure), 4.1-4.4 (Coverage for 85% patterns) | Success: Schema is comprehensive, validates valid YAML specs, rejects invalid ones, supports 85% of patterns | Instructions: Set task to [-] in tasks.md, mark [x] when schema validated with test specs_\n\n- [ ] 2. Create YAMLSchemaValidator module\n  - File: `src/generators/yaml_schema_validator.py`\n  - Implement YAML validation against JSON Schema\n  - Check required fields (metadata, indicators, entry_conditions)\n  - Validate indicator types and parameters\n  - Provide clear error messages for validation failures\n  - Purpose: Validate LLM-generated YAML before code generation\n  - _Leverage: `jsonschema` library, strategy_schema_v1.json_\n  - _Requirements: 2.1, 2.2_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Backend Developer with expertise in JSON Schema validation and Python | Task: Create YAMLSchemaValidator class following requirements 2.1-2.2, validating YAML specs against JSON Schema and providing clear error messages | Restrictions: Must validate all required fields, check indicator types, return actionable error messages with field paths | _Leverage: jsonschema library, schemas/strategy_schema_v1.json | _Requirements: Requirements 2.1-2.2 (YAML validation and error reporting) | Success: Valid specs pass validation, invalid specs rejected with clear errors, >95% validation success on conforming specs | Instructions: Set task to [-], mark [x] when YAMLSchemaValidator tests pass with >95% accuracy_\n\n## Phase 2: Code Generation from YAML (Tasks 3-4)\n\n- [ ] 3. Create Jinja2 code generation templates\n  - File: `src/generators/yaml_to_code_template.py`\n  - Design Jinja2 template for Python strategy generation\n  - Include sections for indicators, entry conditions, exit conditions, position sizing\n  - Map YAML indicator specs to FinLab API calls (data.get('RSI_14'), etc.)\n  - Map entry conditions to boolean masks ((rsi > 30) & (close > ma_50))\n  - Purpose: Generate syntactically correct Python from YAML specs\n  - _Leverage: Jinja2 template engine, FinLab API patterns_\n  - _Requirements: 2.3, 2.4, 2.5_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Template Engineer with expertise in Jinja2 and code generation | Task: Create Jinja2 templates for Python strategy generation following requirements 2.3-2.5, mapping YAML specs to FinLab API calls and valid Python syntax | Restrictions: Must generate syntactically correct code, use proper FinLab API syntax, handle all indicator and condition types from schema | _Leverage: Jinja2 template engine, FinLab API documentation | _Requirements: Requirements 2.3-2.5 (Code generation correctness) | Success: Templates generate valid Python for all YAML specs, code passes ast.parse(), uses correct FinLab API | Instructions: Set task to [-], mark [x] when template tests pass with 100% syntax correctness_\n\n- [ ] 4. Create YAMLToCodeGenerator module\n  - File: `src/generators/yaml_to_code_generator.py`\n  - Implement code generation from validated YAML specs\n  - Generate indicators section (FinLab API calls)\n  - Generate entry conditions section (boolean masks)\n  - Generate exit conditions section (stop_loss, take_profit)\n  - Generate position sizing section (equal_weight, factor_weighted, etc.)\n  - Purpose: Complete YAML → Python code pipeline\n  - _Leverage: Jinja2 template, YAMLSchemaValidator for pre-validation_\n  - _Requirements: 2.3, 2.4, 2.5_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Code Generation Engineer with expertise in AST and Python code synthesis | Task: Create YAMLToCodeGenerator class following requirements 2.3-2.5, using Jinja2 templates to generate complete Python strategies from YAML | Restrictions: Must validate YAML first, generate complete strategy function, ensure ast.parse() passes, add generated code comments | _Leverage: src/generators/yaml_to_code_template.py, YAMLSchemaValidator | _Requirements: Requirements 2.3-2.5 (Successful code generation) | Success: Generated code is syntactically correct, executes without errors, matches YAML spec intent | Instructions: Set task to [-], mark [x] when YAMLToCodeGenerator tests pass with 100% generation success_\n\n## Phase 3: LLM Prompt Engineering (Tasks 5-6)\n\n- [ ] 5. Create StructuredPromptBuilder module\n  - File: `src/innovation/structured_prompt_builder.py`\n  - Build prompts for YAML spec generation (not full Python code)\n  - Include full YAML schema with examples in prompt\n  - Add 3 complete strategy examples (momentum, mean reversion, factor combo)\n  - Implement YAML extraction from LLM response using regex\n  - Purpose: Guide LLM to generate valid YAML specs\n  - _Leverage: YAML schema, champion YAML specs from history_\n  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Prompt Engineer with expertise in structured LLM output and YAML generation | Task: Create StructuredPromptBuilder class following requirements 3.1-3.5, constructing prompts that guide LLM to generate valid YAML specs with examples | Restrictions: Must include full schema in prompt, add 3 diverse examples, implement robust YAML extraction regex, retry logic for malformed responses | _Leverage: schemas/strategy_schema_v1.json, existing champion specs | _Requirements: Requirements 3.1-3.5 (Prompt structure for YAML generation) | Success: Prompts guide LLM to valid YAML >90% of time, extraction works reliably, examples are clear | Instructions: Set task to [-], mark [x] when StructuredPromptBuilder tests pass_\n\n- [ ] 6. Create YAML strategy examples library\n  - Files: `examples/yaml_strategies/momentum_example.yaml`, `mean_reversion_example.yaml`, `factor_combo_example.yaml`\n  - Create 3 complete, working YAML strategy examples\n  - Cover different strategy types and indicator combinations\n  - Validate against schema and test code generation\n  - Purpose: Provide few-shot examples for LLM prompts\n  - _Leverage: Existing successful strategies, YAML schema_\n  - _Requirements: 4.1, 4.2, 4.3_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Quantitative Strategist with expertise in trading strategies and YAML | Task: Create 3 complete YAML strategy examples following requirements 4.1-4.3, covering diverse strategy types and demonstrating schema capabilities | Restrictions: Must validate against schema, generate working Python code, represent realistic trading strategies, cover indicator diversity | _Leverage: schemas/strategy_schema_v1.json, existing successful strategies | _Requirements: Requirements 4.1-4.3 (Strategy type coverage) | Success: All 3 examples validate against schema, generate working code, cover diverse patterns | Instructions: Set task to [-], mark [x] when examples validated and tested_\n\n## Phase 4: Integration with InnovationEngine (Tasks 7-8)\n\n- [ ] 7. Extend InnovationEngine with structured mode\n  - File: `src/innovation/innovation_engine.py` (modify existing)\n  - Add `generate_structured()` method for YAML-based generation\n  - Integrate StructuredPromptBuilder for YAML prompts\n  - Integrate YAMLSchemaValidator and YAMLToCodeGenerator\n  - Implement fallback to full code generation on YAML failures\n  - Purpose: Enable LLM to generate via YAML specs instead of full code\n  - _Leverage: Existing InnovationEngine, new YAML modules_\n  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: ML Engineer with expertise in LLM integration and multi-mode systems | Task: Extend InnovationEngine with structured YAML generation mode following requirements 5.1-5.5, integrating validation and code generation with fallback to full code mode | Restrictions: Must maintain existing full code mode, implement mode selection (structured/code/hybrid), log all failures and fallbacks | _Leverage: src/innovation/innovation_engine.py, YAML modules | _Requirements: Requirements 5.1-5.5 (Structured mode integration and fallback) | Success: Structured mode generates via YAML, falls back gracefully on failures, both modes coexist | Instructions: Set task to [-], mark [x] when InnovationEngine structured mode tests pass_\n\n- [ ] 8. Add structured mode configuration\n  - File: `config/learning_system.yaml` (modify existing)\n  - Add `llm.mode` setting: \"structured\", \"code\", \"hybrid\"\n  - Add `llm.hybrid_structured_ratio` (default 0.80 for 80% YAML, 20% code)\n  - Document mode options and when to use each\n  - Purpose: Control LLM generation mode in production\n  - _Leverage: Existing learning_system.yaml structure_\n  - _Requirements: 5.1, 5.3_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: DevOps Engineer with expertise in YAML configuration and feature flags | Task: Extend learning_system.yaml with structured mode configuration following requirements 5.1 and 5.3, supporting mode selection and hybrid ratios | Restrictions: Must maintain backward compatibility (default \"structured\"), document all modes clearly, validate mode and ratio values | _Leverage: config/learning_system.yaml | _Requirements: Requirements 5.1, 5.3 (Mode configuration) | Success: Modes configurable via YAML, hybrid ratio works, backward compatible, well-documented | Instructions: Set task to [-], mark [x] when config validated_\n\n## Phase 5: Testing (Tasks 9-11)\n\n- [ ] 9. Write YAML validation and generation unit tests\n  - File: `tests/generators/test_yaml_validation.py`, `test_yaml_to_code_generator.py`\n  - Test YAMLSchemaValidator: valid specs pass, invalid specs rejected with clear errors\n  - Test YAMLToCodeGenerator: all strategy types generate correct code\n  - Test indicator mapping: RSI, MACD, fundamental factors map to correct FinLab API\n  - Test entry/exit condition generation: boolean masks and parameters correct\n  - Coverage target: >90% for both modules\n  - _Leverage: `pytest`, test YAML specs (valid and invalid)_\n  - _Requirements: All validation and generation requirements_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer with expertise in schema validation and code generation testing | Task: Create comprehensive unit tests for YAML validation and code generation following all requirements, testing both success and failure scenarios | Restrictions: Must test all strategy types, all indicator types, edge cases (missing fields, invalid values), achieve >90% coverage | _Leverage: pytest, test YAML specs | _Requirements: All validation and generation requirements | Success: All validation and generation scenarios tested, >90% coverage, edge cases covered | Instructions: Set task to [-], mark [x] when tests pass with >90% coverage_\n\n- [ ] 10. Write integration tests with LLM YAML generation\n  - File: `tests/integration/test_structured_innovation.py`\n  - Test 1: Generate YAML spec via LLM (1 real call), validate and generate code\n  - Test 2: Mock invalid YAML response, verify retry and extraction logic\n  - Test 3: Mock validation failure, verify fallback to full code generation\n  - Test 4: Test hybrid mode (80% YAML, 20% code) over 10 iterations\n  - _Leverage: Real LLM API (1 call), mocks for error scenarios_\n  - _Requirements: All integration requirements_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Integration Test Engineer with expertise in LLM testing and multi-mode validation | Task: Create integration tests for structured innovation following all requirements, testing real LLM YAML generation and error handling scenarios | Restrictions: Limit real API calls to 1 (cost), mock error scenarios, verify fallback works, test hybrid mode distribution | _Leverage: Real LLM API (1 call), mocks for errors | _Requirements: All integration requirements | Success: Real YAML generation works, error handling functional, hybrid mode distributes correctly | Instructions: Set task to [-], mark [x] when integration tests pass_\n\n- [ ] 11. Write success rate comparison tests\n  - File: `tests/integration/test_structured_vs_code_success_rate.py`\n  - Generate 20 strategies via structured mode (YAML), measure success rate\n  - Generate 20 strategies via code mode (full Python), measure success rate\n  - Compare: structured should achieve >90% vs ~60% for code mode\n  - Measure hallucination reduction (syntax errors, invalid API calls)\n  - Purpose: Validate structured innovation value proposition\n  - _Leverage: Mock LLM responses for controlled comparison_\n  - _Requirements: Success rate >90% requirement_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer with expertise in comparative testing and success metrics | Task: Create comparative success rate tests validating structured mode achieves >90% success vs ~60% for code mode, demonstrating hallucination reduction | Restrictions: Must use controlled mocks for fair comparison, measure syntax correctness and API validity, run sufficient iterations (20+) | _Leverage: Mock LLM responses, YAMLToCodeGenerator, existing code generation | _Requirements: Success rate >90% requirement | Success: Structured mode achieves >90% success, code mode ~60%, hallucination reduction demonstrated | Instructions: Set task to [-], mark [x] when success rate comparison validates value prop_\n\n## Phase 6: Documentation (Tasks 12-13)\n\n- [ ] 12. Create user documentation\n  - File: `docs/STRUCTURED_INNOVATION.md`\n  - Document YAML schema and how to write specs manually\n  - Document LLM structured mode usage and configuration\n  - Document when to use structured vs code vs hybrid mode\n  - Provide troubleshooting guide (validation errors, generation failures)\n  - _Leverage: Existing documentation structure_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer with expertise in LLM features and YAML specifications | Task: Create comprehensive structured innovation documentation covering YAML specs, LLM usage, mode selection, and troubleshooting | Restrictions: Must include YAML schema documentation, mode comparison table, clear examples, maintain consistent structure | _Leverage: Existing documentation structure and style | _Requirements: All requirements (complete structured innovation understanding) | Success: Documentation is complete, clear, users understand YAML specs and mode options | Instructions: Set task to [-], mark [x] when documentation review passes_\n\n- [ ] 13. Create YAML schema documentation\n  - File: `schemas/SCHEMA_GUIDE.md`\n  - Document all schema fields with descriptions and examples\n  - Document supported indicator types and parameters\n  - Document entry/exit condition syntax\n  - Provide complete working YAML examples for each strategy type\n  - Purpose: Reference guide for manual YAML spec creation\n  - _Leverage: JSON Schema, YAML examples from Task 6_\n  - _Requirements: 4.1, 4.2, 4.3, 4.4_\n  - _Prompt: Implement the task for spec structured-innovation-mvp, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer with expertise in schema documentation and trading strategies | Task: Create comprehensive schema guide documenting all fields, types, and examples following requirements 4.1-4.4 | Restrictions: Must document all schema fields, provide examples for each field type, include complete strategy examples, maintain clarity | _Leverage: schemas/strategy_schema_v1.json, YAML examples | _Requirements: Requirements 4.1-4.4 (Schema coverage and extensibility) | Success: Schema fully documented, examples for all fields, users can create valid YAML specs | Instructions: Set task to [-], mark [x] when schema guide review passes_\n\n## Summary\n\n**Total Tasks**: 13\n**Estimated Time**: 2-3 days (full-time)\n\n**Phase Breakdown**:\n- Phase 1 (Schema/Validation): Tasks 1-2 → 3-4 hours\n- Phase 2 (Code Generation): Tasks 3-4 → 4-5 hours\n- Phase 3 (Prompts): Tasks 5-6 → 3-4 hours\n- Phase 4 (Integration): Tasks 7-8 → 3-4 hours\n- Phase 5 (Testing): Tasks 9-11 → 6-8 hours\n- Phase 6 (Docs): Tasks 12-13 → 2-3 hours\n\n**Dependencies**:\n- Task 1 is foundational (schema must exist first)\n- Task 2 depends on Task 1 (needs schema)\n- Tasks 3-4 can run in parallel\n- Task 5 depends on Task 1 (needs schema for prompts)\n- Task 6 depends on Task 1 (examples must validate)\n- Task 7 depends on Tasks 2, 4, 5 (needs validation, generation, prompts)\n- Task 8 can run in parallel with Tasks 1-7\n- Tasks 9-11 depend on respective implementation tasks\n- Tasks 12-13 can run in parallel after implementations complete\n\n**Critical Path**: 1→2→4→7→10→12\n\n**Success Metrics**:\n- Primary: >90% generation success rate (vs ~60% for code mode)\n- Coverage: 85% of strategy patterns expressible via YAML\n- Reliability: YAML validation >95% accuracy\n- Performance: YAML → Code generation <200ms\n",
  "fileStats": {
    "size": 19043,
    "lines": 186,
    "lastModified": "2025-10-25T00:27:57.543Z"
  },
  "comments": []
}