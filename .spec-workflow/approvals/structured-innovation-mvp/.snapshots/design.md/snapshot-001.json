{
  "id": "snapshot_1761344570160_zc4oa5h8j",
  "approvalId": "approval_1761344570089_az0b5wc80",
  "approvalTitle": "Structured Innovation MVP - Design Document",
  "version": 1,
  "timestamp": "2025-10-24T22:22:50.160Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Structured Innovation MVP (Phase 2a)\n\n## Overview\n\nImplements YAML/JSON-based structured innovation where LLMs create declarative strategy specifications instead of full code. Templates generate syntactically correct Python code, reducing hallucination risk by 80% while maintaining 85% innovation coverage.\n\n**Architecture Pattern:** Interpreter + Template Method - Parse YAML specs, interpret into Python using Jinja2 templates.\n\n## Architecture\n\n```mermaid\ngraph TD\n    A[LLM] -->|YAML Spec| B[Schema Validator]\n    B -->|Valid| C[YAMLInterpreter]\n    B -->|Invalid| D[Retry / Fallback]\n\n    C --> E[Parse Indicators]\n    C --> F[Parse Entry Conditions]\n    C --> G[Parse Exit Conditions]\n    C --> H[Parse Position Sizing]\n\n    E --> I[Jinja2 Template Engine]\n    F --> I\n    G --> I\n    H --> I\n\n    I --> J[Generate Python Code]\n    J --> K[AST Validation]\n    K -->|Valid| L[Execute Strategy]\n    K -->|Invalid| M[Log Error]\n\n    style C fill:#e6f3ff\n    style I fill:#e6ffe6\n    style M fill:#ffe6e6\n```\n\n## Components and Interfaces\n\n### Component 1: YAMLSchemaValidator\n```python\nclass YAMLSchemaValidator:\n    def validate(self, spec: dict) -> tuple[bool, list[str]]:\n        \"\"\"Validate against schemas/strategy_schema_v1.json\"\"\"\n\n    def _check_required_fields(self, spec: dict) -> list[str]:\n        \"\"\"Verify metadata, indicators, entry_conditions, exit_conditions\"\"\"\n\n    def _validate_indicators(self, indicators: dict) -> list[str]:\n        \"\"\"Check indicator types (technical, fundamental, custom)\"\"\"\n```\n\n### Component 2: YAMLToCodeGenerator\n```python\nclass YAMLToCodeGenerator:\n    def __init__(self, template_path: str = \"src/generators/yaml_to_code_template.py\"):\n        self.jinja_env = jinja2.Environment(...)\n\n    def generate_code(self, spec: dict) -> str:\n        \"\"\"Generate Python code from YAML spec\"\"\"\n\n    def _generate_indicators_section(self, indicators: dict) -> str:\n        \"\"\"Generate: rsi = data.get('RSI_14')\"\"\"\n\n    def _generate_entry_conditions_section(self, conditions: dict) -> str:\n        \"\"\"Generate: (rsi > 30) & (close > ma_50)\"\"\"\n\n    def _generate_position_sizing_section(self, sizing: dict) -> str:\n        \"\"\"Generate: equal_weight, factor_weighted, etc.\"\"\"\n```\n\n### Component 3: StructuredPromptBuilder\n```python\nclass StructuredPromptBuilder:\n    def build_yaml_generation_prompt(self, champion_yaml: dict,\n                                     directive: str) -> str:\n        \"\"\"Build prompt requesting YAML spec modification/creation\"\"\"\n\n    YAML_SCHEMA_EXAMPLE = \"\"\"\nmetadata:\n  name: \"Momentum Strategy\"\n  strategy_type: \"momentum\"\n  rebalancing: \"W-FRI\"\n\nindicators:\n  technical:\n    - name: \"rsi_14\"\n      type: \"RSI\"\n      period: 14\n    - name: \"ma_50\"\n      type: \"SMA\"\n      period: 50\n\nentry_conditions:\n  threshold_rules:\n    - \"rsi_14 > 30\"\n    - \"close > ma_50\"\n  logical_operator: \"AND\"\n\nexit_conditions:\n  stop_loss_pct: 0.10\n  take_profit_pct: 0.20\n\nposition_sizing:\n  type: \"equal_weight\"\n\"\"\"\n```\n\n### Component 4: Integration with InnovationEngine\n```python\n# Extend InnovationEngine\nclass InnovationEngine:\n    def generate_structured(self, champion_yaml: dict, directive: str) -> str:\n        \"\"\"Generate YAML spec instead of full code\"\"\"\n        prompt = structured_prompt_builder.build_yaml_generation_prompt(...)\n        response = llm_provider.generate(prompt)\n        spec_yaml = self._extract_yaml(response)\n\n        # Validate\n        is_valid, errors = yaml_validator.validate(spec_yaml)\n        if not is_valid:\n            raise ValidationError(errors)\n\n        # Generate code from YAML\n        code = yaml_to_code_generator.generate_code(spec_yaml)\n        return code\n```\n\n## Data Models\n\n### StrategySpec\n```python\n@dataclass\nclass StrategySpec:\n    metadata: Metadata\n    indicators: Indicators\n    entry_conditions: EntryConditions\n    exit_conditions: ExitConditions\n    position_sizing: PositionSizing\n\n@dataclass\nclass Metadata:\n    name: str\n    description: str\n    strategy_type: str  # momentum, mean_reversion, factor_combination\n    rebalancing: str    # M, W-FRI\n\n@dataclass\nclass Indicators:\n    technical: list[TechnicalIndicator]\n    fundamental: list[FundamentalFactor]\n    custom_calculations: list[str]\n```\n\n## Error Handling\n\n1. **YAML Parsing Failure**\n   - Extract YAML using regex: ```yaml\\n(.*?)\\n```\n   - Retry once with explicit instruction\n   - Fallback to full code generation\n\n2. **Schema Validation Failure**\n   - Log validation errors, increment `yaml_validation_failure_total`\n   - Fallback to Factor Graph mutation\n\n3. **Code Generation Template Error**\n   - Log Jinja2 error, return empty code\n   - Fallback to Factor Graph\n\n## Testing Strategy\n\n**Unit Tests:**\n- Test schema validation with valid/invalid specs\n- Test code generation for each indicator type\n- Test entry/exit condition generation\n- **Coverage:** >85%\n\n**Integration Tests:**\n- Generate YAML spec → validate → generate code → execute\n- Test 3 strategy types: momentum, mean_reversion, factor_combination\n- Verify >90% success rate vs ~60% for full code generation\n\n## Configuration Example\n\n### schemas/strategy_schema_v1.json\n```json\n{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"type\": \"object\",\n  \"required\": [\"metadata\", \"indicators\", \"entry_conditions\"],\n  \"properties\": {\n    \"metadata\": {\n      \"type\": \"object\",\n      \"required\": [\"name\", \"strategy_type\", \"rebalancing\"],\n      \"properties\": {\n        \"name\": {\"type\": \"string\"},\n        \"strategy_type\": {\"enum\": [\"momentum\", \"mean_reversion\", \"factor_combination\"]},\n        \"rebalancing\": {\"enum\": [\"M\", \"W-FRI\", \"W-MON\"]}\n      }\n    },\n    \"indicators\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"technical\": {\"type\": \"array\", \"items\": {\"type\": \"object\"}},\n        \"fundamental\": {\"type\": \"array\", \"items\": {\"type\": \"object\"}}\n      }\n    }\n  }\n}\n```\n\n### config/learning_system.yaml\n```yaml\nllm:\n  mode: \"structured\"  # structured, code, hybrid\n  hybrid_structured_ratio: 0.80  # 80% YAML, 20% full code\n```\n\n## Performance Considerations\n\n- **YAML Parsing:** <10ms\n- **Schema Validation:** <50ms\n- **Code Generation:** <200ms\n- **End-to-End:** <300ms (vs ~10s for LLM full code generation)\n\n## Future Enhancements\n- **Custom Indicator Plugins:** User-defined indicator types\n- **Multi-condition Expressions:** Complex boolean logic\n- **Backtesting Parameter Grid:** Define parameter ranges for optimization\n",
  "fileStats": {
    "size": 6418,
    "lines": 229,
    "lastModified": "2025-10-24T22:22:39.313Z"
  },
  "comments": []
}