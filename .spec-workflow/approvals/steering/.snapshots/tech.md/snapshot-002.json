{
  "id": "snapshot_1761404821691_t0hv3y489",
  "approvalId": "approval_1761404298826_wr9rg5dit",
  "approvalTitle": "Technical Architecture - Steering Document",
  "version": 2,
  "timestamp": "2025-10-25T15:07:01.691Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Technology Stack\n\n## Project Type\n\n**Command-Line Intelligent Trading System** with autonomous strategy generation and optimization capabilities.\n\nPrimary characteristics:\n- Headless autonomous loop (no GUI required)\n- Batch processing workflow (iteration-based)\n- JSON/YAML-based configuration and persistence\n- CLI tools for data management and monitoring\n- Optional web dashboard for visualization (future)\n\n## Core Technologies\n\n### Primary Language(s)\n- **Language**: Python 3.10+\n- **Runtime**: CPython 3.10.0 or higher\n- **Package Manager**: pip (requirements.txt-based)\n- **Build Tools**:\n  - wheel for distribution\n  - build for packaging\n  - setuptools (implicit)\n\n**Version Policy**: Minimum Python 3.10 for modern type hints, structural pattern matching, and performance improvements.\n\n### Key Dependencies/Libraries\n\n#### Trading & Financial Data\n- **finlab ≥1.5.3**: Core Taiwan market data API, backtesting engine, technical indicators\n- **pandas ≥2.3.2**: DataFrame operations, time series analysis\n- **numpy ≥2.2.0**: Numerical computations, array operations\n- **scipy ≥1.15.0**: Statistical functions, optimization algorithms\n- **scikit-learn ≥1.7.0**: Machine learning utilities, clustering\n- **TA-Lib ≥0.6.7**: Technical analysis indicators (requires system library)\n- **yfinance ≥0.2.60**: Alternative data source for validation\n- **pandas-market-calendars ≥5.1.0**: Trading calendar support\n\n#### AI/LLM Integration\n- **anthropic ≥0.69.0**: Claude API client (primary strategy generation)\n- **google-generativeai ≥0.8.5**: Gemini API (fast parameter generation)\n- **openai ≥2.2.0**: OpenAI API (future: o3, GPT-5 integration)\n- **aiohttp ≥3.12.0**: Async HTTP for concurrent API calls\n- **httpx ≥0.28.0**: Alternative HTTP client with HTTP/2 support\n\n#### Strategy Optimization\n- **deap ≥1.4.3**: Genetic algorithms (DEPRECATED: replaced by LLM-based evolution)\n- **statsmodels ≥0.14.5**: Statistical validation, time series analysis\n- **networkx ≥3.4.0**: Factor graph representation, dependency analysis\n\n#### Configuration & Validation\n- **PyYAML ≥6.0.0**: YAML configuration files (learning_system.yaml)\n- **pydantic ≥2.11.0**: Data validation, settings management\n- **python-dotenv ≥1.1.0**: Environment variable management\n\n#### Data Storage & Caching\n- **SQLAlchemy ≥2.0.43**: ORM for metadata storage (future)\n- **duckdb ≥1.4.0**: Analytical queries on iteration history (future)\n- **redis ≥5.1.0**: Caching layer (future)\n- **JSON**: Primary persistence format (iteration_history.jsonl, hall_of_fame/*.json)\n- **fastparquet ≥2024.11.0**: Parquet format for large datasets\n- **pyarrow ≥21.0.0**: Apache Arrow for columnar data\n\n### Application Architecture\n\n**Layered Monolithic Architecture** with clear separation of concerns:\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                    Autonomous Loop Layer                     │\n│  (iteration_engine.py, autonomous_loop.py)                  │\n└─────────────────┬───────────────────────────────────────────┘\n                  │\n    ┌─────────────┼─────────────┐\n    │             │             │\n┌───▼────┐   ┌───▼────┐   ┌───▼────┐\n│Template│   │Evolution│   │Feedback│\n│ System │   │ System  │   │ System │\n└───┬────┘   └───┬────┘   └───┬────┘\n    │            │            │\n    └────────┬───┴───┬────────┘\n             │       │\n        ┌────▼───┐ ┌▼────────┐\n        │Factor  │ │Validation│\n        │ Graph  │ │ System   │\n        └────┬───┘ └┬─────────┘\n             │      │\n        ┌────▼──────▼───┐\n        │  Backtest      │\n        │  Engine        │\n        │  (finlab)      │\n        └────┬───────────┘\n             │\n        ┌────▼───────────┐\n        │ Data Layer     │\n        │ (Finlab API)   │\n        └────────────────┘\n```\n\n**Key Architectural Patterns**:\n1. **Repository Pattern**: Hall of Fame, Iteration History\n2. **Strategy Pattern**: Template system (Turtle, Mastiff, Factor, Momentum)\n3. **Factory Pattern**: Factor creation, template instantiation\n4. **Observer Pattern**: Monitoring, variance tracking\n5. **Chain of Responsibility**: Metric extraction fallback (DIRECT → SIGNAL → DEFAULT)\n\n### Data Storage (if applicable)\n\n#### Primary Storage\n- **Format**: JSON/JSONL (human-readable, git-friendly)\n- **Locations**:\n  - `iteration_history.jsonl`: Sequential iteration log\n  - `hall_of_fame/*.json`: Champion strategies\n  - `template_analytics.json`: Usage statistics\n  - `rollback_history.json`: Rollback audit trail\n- **Rationale**: Simple, debuggable, no external DB dependencies\n\n#### Caching\n- **Type**: File-based cache (data/ directory)\n- **Scope**: Finlab API responses (price, fundamental data)\n- **Freshness**: 7-day default, configurable\n- **Compression**: lz4, cramjam for large datasets\n\n#### Data Formats\n- **Configuration**: YAML (learning_system.yaml)\n- **Metrics Export**: JSON (human/machine-readable), Prometheus text format\n- **Code Persistence**: Python source code (generated_strategy_*.py)\n- **Checkpoints**: JSON (baseline_checkpoints/, validation_checkpoints/)\n\n### External Integrations (if applicable)\n\n#### APIs\n1. **Finlab API** (Primary)\n   - **Purpose**: Taiwan stock market data, backtesting\n   - **Protocol**: HTTPS/REST\n   - **Authentication**: API token (FINLAB_API_TOKEN env var)\n   - **Rate Limits**: Managed by finlab SDK\n   - **Error Handling**: Exponential backoff (5s, 10s, 20s, 40s)\n\n2. **Claude API** (Anthropic)\n   - **Purpose**: Strategy code generation, parameter optimization\n   - **Protocol**: HTTPS/REST\n   - **Authentication**: API key (CLAUDE_API_KEY env var)\n   - **Models Used**: claude-sonnet-4-5-20250929 (primary)\n   - **Streaming**: Supported for real-time generation feedback\n\n3. **Gemini API** (Google)\n   - **Purpose**: Fast parameter generation, template recommendation\n   - **Protocol**: HTTPS/REST + gRPC\n   - **Authentication**: API key (GOOGLE_API_KEY env var)\n   - **Models Used**: gemini-2.5-flash (fast), gemini-2.5-pro (deep reasoning)\n\n4. **OpenRouter API** (Optional)\n   - **Purpose**: Access to multiple LLM providers (GPT-5, o3, Grok)\n   - **Protocol**: HTTPS/REST\n   - **Authentication**: API key\n\n#### Protocols\n- **HTTP/REST**: Primary API communication\n- **gRPC**: Google APIs (Protocol Buffers)\n- **WebSocket**: Future dashboard real-time updates\n- **JSON-RPC**: Internal module communication (future)\n\n#### Authentication\n- **API Keys**: Environment variables (.env file)\n- **Token Storage**: Never committed to git (.gitignore enforced)\n- **Key Masking**: Automatic in logs (logging.py)\n\n### Monitoring & Dashboard Technologies (if applicable)\n\n#### Current Implementation (CLI-based)\n- **Output Format**: Rich terminal output (rich library)\n- **Progress Tracking**: tqdm progress bars\n- **Logging**: Structured JSON logging (logging.py)\n- **Metrics Export**: JSON + Prometheus text format\n\n#### Future Dashboard (Planned)\n- **Dashboard Framework**: FastAPI + React (or Streamlit for rapid prototype)\n- **Real-time Communication**: Server-Sent Events (SSE) or WebSocket\n- **Visualization Libraries**:\n  - Plotly (interactive charts)\n  - Matplotlib + Seaborn (static reports)\n  - Chart.js (web dashboard)\n- **State Management**: File system as source of truth (iteration_history.jsonl)\n- **Port Management**: Configurable (default: 8000 for API, 3000 for frontend)\n\n## Development Environment\n\n### Build & Development Tools\n- **Build System**: pip + requirements.txt (simple, no complex build)\n- **Package Management**: pip (virtual environment recommended)\n- **Development Workflow**:\n  - Edit code → Run tests → Execute iteration loop\n  - No hot reload (batch processing nature)\n  - Checkpoint/resume for long runs\n\n**Recommended Setup**:\n```bash\npython -m venv venv\nsource venv/bin/activate  # Windows: venv\\Scripts\\activate\npip install -r requirements.txt\npip install -r requirements-dev.txt  # For testing/linting\n```\n\n### Code Quality Tools\n\n#### Static Analysis\n- **mypy ≥1.18.0**: Type checking (strict mode)\n- **flake8 ≥7.3.0**: PEP 8 compliance, style checking\n- **pylint ≥3.3.0**: Code quality, bug detection\n- **vulture ≥2.14.0**: Dead code detection\n\n**Configuration**:\n- `.flake8`: Max line length 100, ignore specific rules\n- `mypy.ini`: Strict mode, disallow untyped defs\n- `pylintrc`: Custom rules aligned with project style\n\n#### Formatting\n- **isort ≥6.0.0**: Import sorting (PEP 8)\n- **black** (optional): Auto-formatting (not currently enforced)\n\n**Style Guidelines**:\n- Line length: 100 characters\n- Indentation: 4 spaces\n- Naming: snake_case for functions/variables, PascalCase for classes\n- Docstrings: Google-style\n\n#### Testing Framework\n- **pytest ≥8.4.0**: Primary test runner\n- **pytest-cov ≥7.0.0**: Coverage reports (target: >80%)\n- **pytest-asyncio ≥1.2.0**: Async test support\n- **pytest-mock ≥3.15.0**: Mocking utilities\n- **pytest-benchmark ≥5.1.0**: Performance benchmarking\n- **approvaltests ≥15.3.0**: Snapshot testing (code generation)\n\n**Test Organization**:\n- `tests/`: 926 tests across all modules\n- Unit tests: Component-level validation\n- Integration tests: End-to-end workflows\n- Performance tests: Benchmark critical paths\n\n#### Documentation\n- **Markdown**: README.md, docs/*.md (中英雙語)\n- **Inline**: Google-style docstrings\n- **API Docs**: Comprehensive in docs/architecture/\n- **Specs**: .claude/specs/*/requirements.md, design.md, tasks.md\n\n### Version Control & Collaboration\n\n#### VCS\n- **System**: Git\n- **Remote**: GitHub (or equivalent)\n- **Ignore**: .gitignore (excludes .env, data/, checkpoints/, logs/)\n\n#### Branching Strategy\n- **Model**: Feature branches + main\n- **Pattern**: `feature/<spec-name>`, `bugfix/<issue>`, `docs/<update>`\n- **Main Branch**: Stable, tested code only\n- **Protection**: No direct commits to main (PR required)\n\n#### Code Review Process\n- **Tool**: GitHub Pull Requests\n- **Requirements**:\n  - All tests passing (926 tests)\n  - Code coverage >80%\n  - No mypy/flake8 errors\n  - Spec completion (requirements → design → tasks)\n- **Reviewers**: Self-review + AI validation (codereview, challenge MCP tools)\n\n### Dashboard Development (if applicable)\n\n**Current**: CLI-only (no dashboard)\n\n**Future Plans**:\n- **Live Reload**: watchdog for file monitoring\n- **Port Management**: Configurable via .env (DASHBOARD_PORT=3456)\n- **Multi-Instance**: Support multiple dashboard instances (different projects)\n- **Tunnel**: ngrok or similar for remote access\n\n## Deployment & Distribution (if applicable)\n\n### Target Platform(s)\n- **Primary**: Linux (Ubuntu 20.04+, WSL2)\n- **Secondary**: macOS (Homebrew for TA-Lib)\n- **Windows**: WSL2 recommended (native support limited by TA-Lib)\n- **Cloud**: Not deployed (personal-use system)\n\n### Distribution Method\n- **Type**: Git clone + pip install\n- **Package**: Not published to PyPI (internal project)\n- **Installation**:\n  ```bash\n  git clone <repo>\n  cd finlab\n  pip install -r requirements.txt\n  cp .env.example .env  # Configure tokens\n  ```\n\n### Installation Requirements\n- **Python**: 3.10+ (CPython)\n- **System Libraries**:\n  - TA-Lib (macOS: `brew install ta-lib`, Ubuntu: `apt-get install ta-lib`)\n  - Build tools: gcc, g++, python3-dev\n- **RAM**: 8GB+ recommended (for large backtests)\n- **Disk**: 10GB+ (data cache, checkpoints, logs)\n\n### Update Mechanism\n- **Method**: Git pull + pip install -r requirements.txt\n- **Migration**: scripts/migrate_to_fixed_system.py (when schema changes)\n- **Backward Compatibility**: Maintained across all phases (100% verified)\n\n## Technical Requirements & Constraints\n\n### Performance Requirements\n- **Attribution Analysis**: <100ms per iteration (measured: ~50ms)\n- **Metric Extraction**: <1s (DIRECT method), fallback <30s (SIGNAL method)\n- **Strategy Validation**: <5s per template (TemplateValidator)\n- **Iteration Throughput**: 20-30 iterations per hour (bottleneck: Finlab backtest)\n- **Memory Usage**: <4GB per iteration (typical), <8GB peak (200-gen runs)\n\n**Bottlenecks**:\n1. Finlab backtest execution: 30-120s per iteration\n2. LLM API calls: 5-30s per generation (network latency)\n3. Data download: First run only (cached afterward)\n\n### Compatibility Requirements\n\n#### Platform Support\n- **Linux**: Ubuntu 20.04+, Debian 11+, Fedora 35+ ✅ Primary\n- **macOS**: 11.0+ (Big Sur), Intel/Apple Silicon ✅ Tested\n- **Windows**: WSL2 recommended, native partial support ⚠️ TA-Lib dependency\n\n#### Dependency Versions\n- **Python**: 3.10.0 minimum (3.11+ recommended)\n- **Finlab**: 1.5.3+ (API compatibility)\n- **Pandas**: 2.3.2+ (modern API features)\n- **Numpy**: 2.2.0+, <3.0.0 (major version constraint)\n\n#### Standards Compliance\n- **PEP 8**: Python style guide (enforced by flake8)\n- **PEP 484**: Type hints (enforced by mypy strict mode)\n- **PEP 517/518**: Modern packaging (pyproject.toml future)\n- **JSON**: RFC 8259 compliant\n- **YAML**: YAML 1.2 specification\n\n### Security & Compliance\n\n#### Security Requirements\n- **API Key Protection**:\n  - Environment variables only (.env file)\n  - Never committed to git (.gitignore enforced)\n  - Automatic masking in logs (logging.py redaction)\n- **Code Execution**:\n  - Sandboxed strategy execution (exec() with limited namespace)\n  - No arbitrary file system access from generated code\n  - Input validation on all LLM outputs\n- **Data Protection**:\n  - Local-only storage (no cloud sync)\n  - No PII collection\n  - Finlab data cached locally (encryption optional)\n\n#### Compliance Standards\n- **N/A**: Personal-use system (no GDPR, HIPAA, SOC2 requirements)\n- **Best Practices**: Follow industry standards for API key management\n\n#### Threat Model\n- **Low Risk**: No internet-facing services, no user authentication\n- **Medium Risk**: LLM code generation (mitigated by validation)\n- **Mitigations**:\n  - TemplateValidator: Syntax and semantic validation\n  - Strategy sandbox: Limited exec() namespace\n  - Metric validator: Numerical sanity checks\n\n### Scalability & Reliability\n\n#### Expected Load\n- **Iterations**: 20-200 per run (typical batch)\n- **Concurrent Users**: 1 (personal use)\n- **Data Volume**:\n  - Taiwan stock universe: ~1700 stocks\n  - Historical data: 2018-2024 (7 years)\n  - Cache size: ~500MB-2GB\n\n#### Availability Requirements\n- **Uptime**: Not applicable (batch processing)\n- **Disaster Recovery**:\n  - Manual backup (git commit)\n  - Automatic checkpoints (every N iterations)\n  - Rollback system (RollbackManager)\n- **Data Persistence**:\n  - Iteration history preserved (JSONL append-only)\n  - Hall of Fame versioned (JSON snapshots)\n\n#### Growth Projections\n- **Iteration Count**: 100 → 1000+ (long-term learning)\n- **Strategy Library**: 100 → 1000+ champions\n- **Factor Library**: 13 → 50+ factors\n- **Market Coverage**: Taiwan → Multi-market (US, HK, etc.)\n\n**Scalability Plan**:\n1. **Phase 1 (Current)**: JSON-based, single market\n2. **Phase 2 (6 months)**: DuckDB for analytics, compressed storage\n3. **Phase 3 (12 months)**: Distributed backtesting, multi-market support\n\n## Technical Decisions & Rationale\n\n### Decision Log\n\n#### 1. **Python 3.10+ as Primary Language**\n**Rationale**:\n- Strong ecosystem for financial analysis (pandas, numpy, scipy)\n- Finlab SDK native support (Python-only)\n- Excellent LLM API client libraries (anthropic, google-generativeai)\n- Personal expertise alignment\n\n**Alternatives Considered**:\n- Julia: Better performance, but weaker financial ecosystem\n- R: Strong stats, but poor LLM integration\n- C++: Maximum performance, but development velocity too slow\n\n**Trade-offs Accepted**:\n- GIL performance limits (acceptable for I/O-bound workload)\n- Type safety weaker than Rust/Go (mitigated by mypy strict mode)\n\n#### 2. **JSON/JSONL for Data Persistence**\n**Rationale**:\n- Human-readable for debugging\n- Git-friendly (easy diff, version control)\n- No external database dependencies\n- Simple backup/restore (file copy)\n\n**Alternatives Considered**:\n- SQLite: Better querying, but overkill for current scale\n- Parquet: Better compression, but not human-readable\n- PostgreSQL: Production-grade, but excessive for personal use\n\n**Trade-offs Accepted**:\n- Query performance (sequential scan vs. indexed)\n- Storage efficiency (text vs. binary)\n- **When to Migrate**: >10,000 iterations or multi-user requirements\n\n#### 3. **Regex-based Parameter Extraction (MVP)**\n**Rationale**:\n- 80/20 solution: Covers 90% of critical parameters\n- Simple implementation (<200 lines)\n- Fast execution (<100ms)\n- AST migration planned for v2.0\n\n**Alternatives Considered**:\n- AST (Abstract Syntax Tree): More accurate, but 5x development time\n- LLM-based extraction: Unreliable, adds API latency\n\n**Trade-offs Accepted**:\n- 10% extraction failure rate (fallback to simple feedback)\n- Cannot handle complex expressions (acceptable for templates)\n- **Migration Trigger**: Extraction failure rate >20%\n\n#### 4. **Template System over Pure LLM Generation**\n**Rationale**:\n- Domain knowledge encoding (Turtle, Mastiff patterns)\n- Validation constraints (parameter bounds, structure)\n- 80% TurtleTemplate success rate (vs. 33% free-form)\n- Faster iteration (no full code generation)\n\n**Alternatives Considered**:\n- Pure LLM: Maximum flexibility, but low success rate\n- Genetic Algorithms: No LLM dependency, but requires large population\n\n**Trade-offs Accepted**:\n- Limited to 4 template patterns (vs. infinite LLM creativity)\n- Manual template maintenance required\n- **Future**: Hybrid approach (templates + LLM mutations)\n\n#### 5. **Multi-Objective Validation (Sharpe + Calmar + Drawdown)**\n**Rationale**:\n- Prevent brittle strategy selection (high Sharpe, poor Calmar)\n- Real-world trading viability (drawdown management)\n- Alignment with risk-adjusted returns goal\n\n**Alternatives Considered**:\n- Sharpe-only: Simpler, but brittle strategies\n- Sortino ratio: Better downside risk, but correlation with Sharpe\n\n**Trade-offs Accepted**:\n- Slower champion updates (stricter criteria)\n- More complex validation logic\n- **Benefit**: Robust strategies, fewer regressions\n\n#### 6. **Hybrid Threshold System (Relative OR Absolute)**\n**Rationale**:\n- Fixed percentage fails at high Sharpe (2.4751 * 1.05 = 2.599 impossible)\n- Absolute threshold enables continuous improvement\n- Balanced update frequency (10-20%)\n\n**Alternatives Considered**:\n- Fixed percentage only: Stagnation at high Sharpe\n- Absolute only: Excessive churn at low Sharpe\n- Adaptive thresholds: Complex, premature optimization\n\n**Trade-offs Accepted**:\n- More complex logic (if/else branches)\n- Two threshold parameters to tune\n- **Validation**: Phase 1 testing confirmed effectiveness\n\n## Known Limitations\n\n### 1. **Regex Parameter Extraction (80% Accuracy)**\n**Impact**:\n- 10-20% of iterations may have failed attribution\n- Fallback to simple feedback (no champion preservation)\n\n**Mitigation**:\n- Comprehensive test coverage (historical strategies)\n- Graceful degradation (simple feedback fallback)\n\n**Future Solution**:\n- Phase 2.0: AST-based extraction (planned)\n- Trigger: Extraction failure rate >20%\n\n### 2. **Single-Market Focus (Taiwan Only)**\n**Impact**:\n- Cannot backtest US, HK, or other markets\n- Taiwan-specific biases (retail participation, TAIEX correlation)\n\n**Mitigation**:\n- Market characteristics documented (70% retail, 0.6-0.7 US correlation)\n- Validation criteria calibrated to Taiwan\n\n**Future Solution**:\n- Multi-market support (Phase 3)\n- Market-specific configuration (learning_system_<market>.yaml)\n\n### 3. **TA-Lib System Dependency**\n**Impact**:\n- Windows native support limited\n- Installation complexity (requires build tools)\n\n**Mitigation**:\n- WSL2 recommended for Windows users\n- Alternative: pandas-ta (pure Python, slower)\n\n**Future Solution**:\n- Migrate to pandas-ta for cross-platform compatibility\n- Trigger: User complaints or Windows market share >30%\n\n### 4. **LLM Compliance Risk (Preservation Directives)**\n**Impact**:\n- No guarantee LLM follows preservation constraints\n- May generate strategies ignoring champion patterns\n\n**Mitigation**:\n- Forced exploration every 5th iteration (diversity)\n- PreservationValidator checks compliance\n- Multi-objective validation catches regressions\n\n**Future Solution**:\n- Stronger prompt engineering (few-shot examples)\n- Fine-tuned LLM for strategy generation\n- Reinforcement learning from validation feedback\n\n### 5. **No Real-Time Data Integration**\n**Impact**:\n- Cannot trade live or paper-trade\n- Backtesting only (historical simulation)\n\n**Mitigation**:\n- Weekly/monthly trading cycle (not time-critical)\n- Manual execution based on backtest results\n\n**Future Solution**:\n- Real-time data streaming (Phase 3)\n- Paper trading mode (Phase 4)\n- Live trading integration (Phase 5+)\n\n### 6. **926 Tests, But No Continuous Integration (CI)**\n**Impact**:\n- Manual test execution before commits\n- Risk of broken tests slipping through\n\n**Mitigation**:\n- Pre-commit hook reminder (manual)\n- QA workflow using MCP tools (codereview, challenge)\n\n**Future Solution**:\n- GitHub Actions CI/CD pipeline\n- Automated testing on every PR\n- Coverage reports on PRs\n\n---\n\n**Document Version**: 1.0\n**Last Updated**: 2025-10-25\n**Status**: Draft - Pending Approval\n**Technical Reviewer**: N/A (personal project)\n",
  "fileStats": {
    "size": 21932,
    "lines": 595,
    "lastModified": "2025-10-25T14:58:11.761Z"
  },
  "comments": []
}