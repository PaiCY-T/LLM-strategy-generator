{
  "id": "snapshot_1761344569970_f2atypqh3",
  "approvalId": "approval_1761344569933_y4b3x95tn",
  "approvalTitle": "Exit Mutation Redesign - Design Document",
  "version": 1,
  "timestamp": "2025-10-24T22:22:49.970Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Exit Mutation Redesign\n\n## Overview\n\nRedesigns exit mutation from brittle AST manipulation (0/41 success rate) to robust parameter-based genetic operators that mutate numerical parameters (stop_loss, take_profit, trailing_stop) within bounded ranges using Gaussian noise.\n\n**Architecture Pattern:** Genetic Algorithm + Template Method - Define mutation framework, specialize for different parameter types.\n\n## Architecture\n\n```mermaid\ngraph TD\n    A[ExitMutationOperator] --> B{Select Parameter}\n    B --> C[stop_loss_pct]\n    B --> D[take_profit_pct]\n    B --> E[trailing_stop_offset]\n    B --> F[holding_period_days]\n\n    C --> G[Apply Gaussian Noise]\n    D --> G\n    E --> G\n    F --> G\n\n    G --> H[Clamp to Bounds]\n    H --> I[Regex Replace in Code]\n    I --> J[Validate with AST]\n    J -->|Valid| K[Return Mutated Code]\n    J -->|Invalid| L[Return Original]\n\n    style G fill:#e6f3ff\n    style H fill:#ffe6cc\n    style L fill:#ffe6e6\n```\n\n## Components and Interfaces\n\n### Component 1: ExitParameterMutator\n```python\nclass ExitParameterMutator:\n    PARAM_BOUNDS = {\n        \"stop_loss_pct\": (0.01, 0.20),\n        \"take_profit_pct\": (0.05, 0.50),\n        \"trailing_stop_offset\": (0.005, 0.05),\n        \"holding_period_days\": (1, 60)\n    }\n\n    def mutate(self, code: str, param_name: str = None) -> tuple[str, dict]:\n        \"\"\"Returns (mutated_code, metadata)\"\"\"\n\n    def _apply_gaussian_noise(self, value: float, std_dev: float = 0.15) -> float:\n        \"\"\"new_value = value * (1 + N(0, std_dev))\"\"\"\n\n    def _clamp_to_bounds(self, value: float, param_name: str) -> float:\n        \"\"\"Enforce PARAM_BOUNDS\"\"\"\n\n    def _regex_replace_parameter(self, code: str, param: str, new_val: float) -> str:\n        \"\"\"Update parameter value using regex\"\"\"\n```\n\n### Component 2: Integration with FactorGraph\n```python\n# Extend src/mutation/factor_graph.py\nclass UnifiedMutationOperator:\n    MUTATION_WEIGHTS = {\n        \"add_factor\": 0.30,\n        \"remove_factor\": 0.20,\n        \"modify_factor\": 0.30,\n        \"exit_param\": 0.20  # NEW\n    }\n\n    def select_mutation(self) -> str:\n        return random.choices(list(self.MUTATION_WEIGHTS.keys()),\n                            weights=list(self.MUTATION_WEIGHTS.values()))[0]\n```\n\n## Data Models\n\n```python\n@dataclass\nclass ExitMutationMetadata:\n    mutation_type: str = \"exit_param\"\n    parameter: str\n    old_value: float\n    new_value: float\n    bounded: bool  # True if clamping occurred\n    success: bool\n```\n\n## Error Handling\n\n1. **Parameter Not Found in Code**\n   - Return original code, log skip, success=False\n\n2. **Regex Replacement Fails**\n   - Return original code, log error, success=False\n\n3. **AST Validation Fails After Mutation**\n   - Return original code, log syntax error, success=False\n\n## Testing Strategy\n\n**Unit Tests:**\n- Test Gaussian noise distribution (68% within Â±15%)\n- Test boundary clamping for each parameter\n- Test regex replacement patterns\n- **Coverage:** >90%\n\n**Integration Tests:**\n- Mutate real strategy code with exit conditions\n- Verify success rate >70% (vs 0% currently)\n- Verify mutated values within bounds\n\n## Configuration Example\n\n```yaml\nmutation:\n  exit_param:\n    enabled: true\n    weight: 0.20\n    gaussian_std_dev: 0.15\n    bounds:\n      stop_loss_pct: [0.01, 0.20]\n      take_profit_pct: [0.05, 0.50]\n      trailing_stop_offset: [0.005, 0.05]\n      holding_period_days: [1, 60]\n```\n",
  "fileStats": {
    "size": 3399,
    "lines": 127,
    "lastModified": "2025-10-24T22:22:12.757Z"
  },
  "comments": []
}