# ============================================================================
# Finlab Docker Sandbox - Production Runtime Image
# ============================================================================
# Purpose: Isolated execution environment for autonomous strategy backtesting
# Security: Multi-layer defense (AST validation + Container isolation + Seccomp)
# Usage: docker build -t finlab-sandbox:latest -f Dockerfile.sandbox .
# ============================================================================

# ----------------------------------------------------------------------------
# Stage 1: Builder - Install dependencies with build tools
# ----------------------------------------------------------------------------
FROM python:3.10-slim AS builder

# Install system dependencies for building Python packages
# - gcc, g++, make: Compilation tools for native extensions
# - wget, tar: Download and extract TA-Lib source
# - python3-dev: Python header files for C extensions
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    make \
    wget \
    tar \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install TA-Lib from source (required for technical analysis)
# Version: 0.4.0 (stable release)
RUN cd /tmp && \
    wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz && \
    tar -xzf ta-lib-0.4.0-src.tar.gz && \
    cd ta-lib && \
    ./configure --prefix=/usr/local && \
    make && \
    make install && \
    cd / && \
    rm -rf /tmp/ta-lib*

# Set library path for TA-Lib
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

# Create requirements-runtime.txt (exclude dev-only tools + missing packages)
# Strategy: Include all runtime dependencies, exclude pure development tools
COPY requirements.txt /tmp/requirements-full.txt
RUN grep -v -E "^(pytest|coverage|flake8|pylint|mypy|isort|vulture|ipython|build|wheel|watchdog|mock|testfixtures|approvaltests|ml4t-finlab-downloader)" /tmp/requirements-full.txt > /tmp/requirements-runtime.txt

# Install Python packages to /install prefix
# - --prefix=/install: Install to custom location for copying to final stage
# - --no-cache-dir: Don't cache packages (reduces layer size)
# - --no-warn-script-location: Suppress warnings about script paths
RUN pip install --prefix=/install --no-cache-dir --no-warn-script-location \
    -r /tmp/requirements-runtime.txt

# ----------------------------------------------------------------------------
# Stage 2: Runtime - Minimal production image
# ----------------------------------------------------------------------------
FROM python:3.10-slim

LABEL maintainer="finlab-team"
LABEL description="Finlab Autonomous Trading System - Secure Sandbox Environment"
LABEL version="1.0.0"

# Install runtime system libraries only
# - libgomp1: OpenMP library (for numpy/scipy parallel operations)
# - libstdc++6: C++ standard library (for compiled extensions)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgomp1 \
    libstdc++6 \
    && rm -rf /var/lib/apt/lists/*

# Copy TA-Lib library from builder
COPY --from=builder /usr/local/lib/libta_lib.* /usr/local/lib/
RUN ldconfig

# Copy Python packages from builder
COPY --from=builder /install /usr/local

# Set library path
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

# Create non-root user for security
# - UID 1000: Matches DockerExecutor configuration (user="1000:1000")
# - No home directory created: Strategies run in /workspace
RUN useradd -m -u 1000 -s /bin/bash finlab

# Set working directory
# Note: Mounted as read-only by DockerExecutor
WORKDIR /workspace

# Switch to non-root user
USER finlab

# Verify installation (fail fast if dependencies missing)
RUN python -c "import pandas, numpy, finlab; print('✓ Core dependencies loaded')" && \
    python -c "import talib; print('✓ TA-Lib loaded')" && \
    python -c "import anthropic, openai, google.generativeai; print('✓ LLM APIs loaded')" && \
    python -c "import networkx, scipy, sklearn; print('✓ Algorithm libraries loaded')"

# Health check (optional - for Docker Compose deployments)
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD python -c "import sys; sys.exit(0)"

# Default command (overridden by DockerExecutor)
CMD ["python", "--version"]

# ----------------------------------------------------------------------------
# Build Instructions
# ----------------------------------------------------------------------------
# Build image:
#   docker build -t finlab-sandbox:latest -f Dockerfile.sandbox .
#
# Test image:
#   docker run --rm finlab-sandbox:latest python -c "import pandas; print(pandas.__version__)"
#
# Check image size:
#   docker images finlab-sandbox:latest
#
# Expected size: 1.5-2.5GB (includes pandas, numpy, finlab, TA-Lib, LLM SDKs)
# Expected build time: 5-10 minutes (first build), <1 minute (cached)
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Security Notes
# ----------------------------------------------------------------------------
# 1. Non-root user: Runs as UID 1000 (principle of least privilege)
# 2. Read-only workspace: /workspace mounted read-only by DockerExecutor
# 3. No privileged mode: Docker caps dropped (cap_drop=['ALL'])
# 4. Network isolation: network_mode=none (no external connectivity)
# 5. Resource limits: 2GB memory, 0.5 CPU, 300s timeout
# 6. Seccomp profile: Dangerous syscalls filtered at kernel level
# ----------------------------------------------------------------------------
