# Quality Value Factor Strategy
# ==============================
# Multi-factor value investing with quality and financial health filters
#
# Strategy Logic:
# - Combine PE ratio, ROE, and Debt/Equity into composite value-quality score
# - Select top stocks by value with quality characteristics
# - Factor-weighted position sizing by composite score
# - Designed for long-term value investing
#
# Expected Performance: Sharpe 1.7-2.4, Annual Return 16-24%, Turnover: Low
# Market Conditions: Best in value cycles, market recoveries
# Risk Level: Low (quality filters reduce downside)

metadata:
  name: "Quality Value Composite"
  description: "Value investing strategy combining low PE ratio with high ROE and low debt, factor-weighted by composite quality-value score for long-term outperformance"
  strategy_type: "factor_combination"
  rebalancing_frequency: "M"  # Monthly rebalancing
  version: "1.0.0"
  author: "FinLab LLM System"
  tags:
    - factor-combination
    - quality
    - value
    - fundamental
    - long-term
    - factor-weighted
  risk_level: "low"

indicators:
  # Fundamental factors (primary drivers)
  fundamental_factors:
    # Value factors
    - name: "pe_ratio"
      field: "PE_ratio"
      source: "data.get('PE_ratio')"

    - name: "pb_ratio"
      field: "PB_ratio"
      source: "data.get('PB_ratio')"

    - name: "ps_ratio"
      field: "PS_ratio"
      source: "data.get('PS_ratio')"

    # Quality factors
    - name: "roe"
      field: "ROE"
      source: "data.get('ROE')"
      transformation: "winsorize"

    - name: "roa"
      field: "ROA"
      source: "data.get('ROA')"
      transformation: "winsorize"

    - name: "operating_margin"
      field: "operating_margin"
      source: "data.get('operating_margin')"

    - name: "net_margin"
      field: "net_margin"
      source: "data.get('net_margin')"

    # Financial health
    - name: "debt_to_equity"
      field: "debt_to_equity"
      source: "data.get('debt_to_equity')"

    - name: "debt_ratio"
      field: "debt_ratio"
      source: "data.get('debt_ratio')"

    - name: "current_ratio"
      field: "current_ratio"
      source: "data.get('current_ratio')"

    # Cash flow
    - name: "cash_flow_to_debt"
      field: "cash_flow_to_debt"
      source: "data.get('cash_flow_to_debt')"

    # Dividend
    - name: "dividend_yield"
      field: "dividend_yield"
      source: "data.get('dividend_yield')"

  # Technical indicators for timing
  technical_indicators:
    # RSI for momentum filter
    - name: "rsi_14"
      type: "RSI"
      period: 14
      source: "data.get('RSI_14')"

    # 50-day MA for trend
    - name: "ma_50"
      type: "SMA"
      period: 50
      source: "data.get('MA_50')"

  # Custom factor calculations
  custom_calculations:
    # Value score (lower is better, so invert)
    - name: "value_score"
      expression: "1.0 / ((pe_ratio + pb_ratio + ps_ratio) / 3.0)"
      description: "Composite value score (inverted average of PE, PB, PS)"

    # Quality score (higher is better)
    - name: "quality_score"
      expression: "(roe + roa) * operating_margin * net_margin"
      description: "Composite quality score (profitability metrics)"

    # Financial health score
    - name: "health_score"
      expression: "current_ratio * cash_flow_to_debt / (1 + debt_to_equity)"
      description: "Financial health (liquidity × cash flow / leverage)"

    # Quality-value composite (primary ranking metric)
    - name: "qv_composite"
      expression: "quality_score * value_score * 10"
      description: "Quality × Value composite factor"

    # Enhanced composite with financial health
    - name: "enhanced_qv"
      expression: "qv_composite * (1 + health_score)"
      description: "Quality-Value composite enhanced with financial health"

    # Yield-adjusted composite
    - name: "yield_adjusted_qv"
      expression: "enhanced_qv * (1 + dividend_yield)"
      description: "Final composite adjusted for dividend yield"

entry_conditions:
  # Ranking-based selection
  ranking_rules:
    # Select top 20% by yield-adjusted composite
    - field: "yield_adjusted_qv"
      method: "top_percent"
      value: 20
      ascending: false

  # Threshold-based quality gates
  threshold_rules:
    # Value filters
    - condition: "pe_ratio > 0"
      description: "Positive earnings (PE >0)"

    - condition: "pe_ratio < 15"
      description: "Attractive valuation (PE <15)"

    - condition: "pb_ratio > 0"
      description: "Positive book value (PB >0)"

    - condition: "pb_ratio < 2.5"
      description: "Reasonable price-to-book (PB <2.5)"

    # Quality filters
    - condition: "roe > 0.12"
      description: "High ROE (>12%)"

    - condition: "roa > 0.06"
      description: "Good ROA (>6%)"

    - condition: "operating_margin > 0.10"
      description: "Strong operating margin (>10%)"

    - condition: "net_margin > 0.05"
      description: "Positive net margin (>5%)"

    # Financial health filters
    - condition: "debt_to_equity < 1.0"
      description: "Low leverage (D/E <1.0)"

    - condition: "debt_ratio < 0.50"
      description: "Low debt ratio (<50%)"

    - condition: "current_ratio > 1.5"
      description: "Strong liquidity (Current Ratio >1.5)"

    - condition: "cash_flow_to_debt > 0.25"
      description: "Strong cash flow (CF/Debt >25%)"

    # Dividend filter (prefer dividend payers)
    - condition: "dividend_yield > 0.01"
      description: "Dividend yield >1%"

    # Momentum filter (avoid falling knives)
    - condition: "rsi_14 > 35"
      description: "Not oversold (RSI >35)"

    - condition: "close > ma_50 * 0.90"
      description: "Within 10% of 50-day MA (price support)"

  # All conditions must be met
  logical_operator: "AND"

  # Liquidity requirements
  min_liquidity:
    average_volume_20d: 60000000  # 60M minimum
    dollar_volume: 4000000        # 4M daily dollar volume

exit_conditions:
  # Wide stop loss for value investing
  stop_loss_pct: 0.18  # 18% stop loss

  # Large take profit target
  take_profit_pct: 0.50  # 50% take profit

  # Conditional exits (value thesis broken)
  conditional_exits:
    # Exit if valuation becomes expensive
    - condition: "pe_ratio > 25"
      description: "PE ratio expensive (>25)"

    - condition: "pb_ratio > 3.5"
      description: "PB ratio expensive (>3.5)"

    # Exit if quality deteriorates
    - condition: "roe < 0.08"
      description: "ROE deteriorated (<8%)"

    - condition: "roa < 0.04"
      description: "ROA deteriorated (<4%)"

    - condition: "operating_margin < 0.06"
      description: "Operating margin weak (<6%)"

    # Exit if financial health weakens
    - condition: "debt_to_equity > 1.5"
      description: "Leverage increased (D/E >1.5)"

    - condition: "current_ratio < 1.2"
      description: "Liquidity weakened (Current Ratio <1.2)"

    - condition: "cash_flow_to_debt < 0.15"
      description: "Cash flow weakened (CF/Debt <15%)"

    # Exit if dividend cut
    - condition: "dividend_yield < 0.005"
      description: "Dividend yield fell below 0.5%"

  # Long holding period for value investing
  holding_period_days: 180  # Up to 6 months

  # Exit if ANY exit condition is met
  exit_operator: "OR"

position_sizing:
  # Factor-weighted by composite score
  method: "factor_weighted"

  # Maximum 25 positions (diversified value portfolio)
  max_positions: 25

  # Maximum 8% per position
  max_position_pct: 0.08

  # Minimum 2% per position
  min_position_pct: 0.02

  # Weight by yield-adjusted composite
  weighting_field: "yield_adjusted_qv"

risk_management:
  # Sector concentration limit
  max_sector_exposure: 0.25

  # Correlation limit (ensure diversification)
  max_correlation: 0.65

  # Rebalance threshold
  rebalance_threshold: 0.12

  # Drawdown limit
  max_drawdown_limit: 0.22

  # Cash reserve
  cash_reserve_pct: 0.05

backtest_config:
  start_date: "2019-01-01"
  end_date: "2023-12-31"
  initial_capital: 5000000  # 5M capital
  transaction_cost: 0.001425
  slippage: 0.001
