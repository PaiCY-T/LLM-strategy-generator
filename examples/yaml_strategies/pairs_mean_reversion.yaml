# Pairs Trading Mean Reversion Strategy
# =======================================
# Statistical arbitrage pairs trading with custom spread calculation
#
# Strategy Logic:
# - Identify correlated pairs trading relationships
# - Calculate normalized spread between pairs
# - Enter when spread diverges (>2 standard deviations)
# - Exit when spread reverts to mean
# - Custom formula position sizing based on spread width
#
# Expected Performance: Sharpe 1.5-2.2, Annual Return 12-20%, Turnover: High
# Market Conditions: Market-neutral, works in all conditions
# Risk Level: Medium (requires correlation stability)

metadata:
  name: "Statistical Pairs Mean Reversion"
  description: "Pairs trading strategy entering on spread divergence >2 std dev, exiting on mean reversion, custom formula sizing based on spread width for market-neutral returns"
  strategy_type: "mean_reversion"
  rebalancing_frequency: "W-MON"  # Weekly Monday rebalancing
  version: "1.0.0"
  author: "FinLab LLM System"
  tags:
    - pairs-trading
    - mean-reversion
    - statistical-arbitrage
    - market-neutral
    - custom-sizing
    - spread
  risk_level: "medium"

indicators:
  # Technical indicators for pairs analysis
  technical_indicators:
    # Moving averages for trend
    - name: "ma_20"
      type: "SMA"
      period: 20
      source: "data.get('MA_20')"

    - name: "ma_50"
      type: "SMA"
      period: 50
      source: "data.get('MA_50')"

    # RSI for confirmation
    - name: "rsi_14"
      type: "RSI"
      period: 14
      source: "data.get('RSI_14')"

    # Bollinger Bands for spread analysis
    - name: "bb_upper"
      type: "BB"
      period: 20
      source: "data.get('BB_UPPER')"
      parameters:
        std_dev: 2.0

    - name: "bb_middle"
      type: "BB"
      period: 20
      source: "data.get('BB_MIDDLE')"
      parameters:
        std_dev: 2.0

    - name: "bb_lower"
      type: "BB"
      period: 20
      source: "data.get('BB_LOWER')"
      parameters:
        std_dev: 2.0

  # Fundamental factors for pair selection
  fundamental_factors:
    # Similar business models (same sector)
    - name: "roe"
      field: "ROE"
      source: "data.get('ROE')"

    - name: "pe_ratio"
      field: "PE_ratio"
      source: "data.get('PE_ratio')"

    # Size similarity
    - name: "revenue_growth"
      field: "revenue_growth"
      source: "data.get('revenue_growth')"

  # Custom calculations for pairs trading
  custom_calculations:
    # Price ratio (simple spread measure)
    # Note: In practice, this would compare to pair stock
    - name: "price_ratio"
      expression: "close / ma_20"
      description: "Price relative to 20-day MA (simplified spread proxy)"

    # Z-score of price ratio (standardized spread)
    - name: "spread_zscore"
      expression: "(price_ratio - 1.0) / 0.05"  # Simplified z-score
      description: "Z-score of spread (simplified for single stock)"

    # Spread volatility
    - name: "spread_volatility"
      expression: "(bb_upper - bb_lower) / bb_middle"
      description: "Spread volatility measure"

    # Mean reversion strength
    - name: "reversion_strength"
      expression: "abs(spread_zscore) * (1 / (1 + spread_volatility))"
      description: "Mean reversion opportunity score"

    # Position size factor (larger when spread is wider)
    - name: "position_factor"
      expression: "1.0 / (1.0 + abs(spread_zscore) * 0.1)"
      description: "Position sizing factor based on spread width"

entry_conditions:
  # Threshold-based entry rules
  threshold_rules:
    # Spread divergence (price significantly below fair value)
    - condition: "price_ratio < 0.95"
      description: "Price 5% below 20-day MA (spread diverged)"

    # Z-score threshold (>2 std dev)
    - condition: "spread_zscore < -2.0"
      description: "Spread >2 std dev below mean (entry signal)"

    # RSI oversold confirmation
    - condition: "rsi_14 < 35"
      description: "RSI oversold (<35)"

    # Price at lower Bollinger Band
    - condition: "close < bb_lower"
      description: "Price at lower Bollinger Band"

    # Quality filters (similar fundamentals for pairs)
    - condition: "roe > 0.10"
      description: "ROE >10% (quality company)"

    - condition: "pe_ratio > 5"
      description: "PE ratio >5 (not distressed)"

    - condition: "pe_ratio < 40"
      description: "PE ratio <40 (not overvalued)"

    # Spread volatility acceptable
    - condition: "spread_volatility > 0.05"
      description: "Spread volatility >5% (sufficient movement)"

    - condition: "spread_volatility < 0.25"
      description: "Spread volatility <25% (not too volatile)"

  # All conditions must be met
  logical_operator: "AND"

  # High liquidity requirements for pairs trading
  min_liquidity:
    average_volume_20d: 150000000  # 150M minimum
    dollar_volume: 8000000         # 8M daily dollar volume

exit_conditions:
  # Stop loss (if correlation breaks)
  stop_loss_pct: 0.08  # 8% stop loss

  # Take profit
  take_profit_pct: 0.10  # 10% take profit

  # Conditional exits (mean reversion signals)
  conditional_exits:
    # Exit when spread reverts to mean
    - condition: "price_ratio > 0.98"
      description: "Spread reverted to within 2% of mean"

    # Exit when z-score normalizes
    - condition: "spread_zscore > -0.5"
      description: "Z-score normalized (spread reverted)"

    # Exit when RSI normalizes
    - condition: "rsi_14 > 55"
      description: "RSI normalized above 55"

    # Exit when price reaches middle Bollinger Band
    - condition: "close > bb_middle"
      description: "Price reached middle Bollinger Band (mean reversion)"

    # Exit if spread volatility increases (correlation breaking)
    - condition: "spread_volatility > 0.30"
      description: "Spread volatility increased (correlation weakening)"

    # Exit if fundamentals diverge
    - condition: "roe < 0.08"
      description: "ROE deteriorated (fundamental divergence)"

  # Holding period for mean reversion
  holding_period_days: 30

  # Exit if ANY exit condition is met
  exit_operator: "OR"

position_sizing:
  # Custom formula sizing based on spread width
  method: "custom_formula"

  # Maximum 15 positions (pairs = 7-8 pairs)
  max_positions: 15

  # Maximum 12% per position
  max_position_pct: 0.12

  # Minimum 4% per position
  min_position_pct: 0.04

  # Custom formula: size inversely to spread z-score
  custom_formula: "1.0 / (1.0 + abs(spread_zscore) * 0.1)"

risk_management:
  # Sector concentration (allow concentration in pairs)
  max_sector_exposure: 0.40

  # Correlation limit (ensure independence of pairs)
  max_correlation: 0.60

  # Rebalance threshold
  rebalance_threshold: 0.12

  # Drawdown limit
  max_drawdown_limit: 0.15

  # Cash reserve
  cash_reserve_pct: 0.10

backtest_config:
  start_date: "2021-01-01"
  end_date: "2023-12-31"
  initial_capital: 1000000
  transaction_cost: 0.001425
  slippage: 0.001
