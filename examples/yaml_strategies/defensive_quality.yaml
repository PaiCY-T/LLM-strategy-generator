# Defensive Quality Strategy
# ===========================
# Low volatility + high dividend + quality for bear market protection
#
# Strategy Logic:
# - Select low-volatility stocks with high dividend yield
# - Filter for quality (high ROE, low debt)
# - Use risk parity sizing to balance portfolio risk
# - Designed for bear markets and risk-off periods
#
# Expected Performance: Sharpe 1.8-2.5, Annual Return 10-16%, Turnover: Low
# Market Conditions: Best in bear markets, high volatility, risk-off periods
# Risk Level: Low (defensive positioning)

metadata:
  name: "Defensive Quality Low Volatility"
  description: "Bear market defensive strategy combining low volatility stocks with high dividend yield and quality metrics, risk parity sizing for stable risk-adjusted returns"
  strategy_type: "factor_combination"
  rebalancing_frequency: "M"  # Monthly rebalancing
  version: "1.0.0"
  author: "FinLab LLM System"
  tags:
    - factor-combination
    - defensive
    - low-volatility
    - quality
    - dividend
    - bear-market
    - risk-parity
  risk_level: "low"

indicators:
  # Fundamental factors
  fundamental_factors:
    # Quality metrics
    - name: "roe"
      field: "ROE"
      source: "data.get('ROE')"
      transformation: "winsorize"

    - name: "roa"
      field: "ROA"
      source: "data.get('ROA')"
      transformation: "winsorize"

    # Dividend metrics
    - name: "dividend_yield"
      field: "dividend_yield"
      source: "data.get('dividend_yield')"

    - name: "payout_ratio"
      field: "payout_ratio"
      source: "data.get('payout_ratio')"

    # Financial health
    - name: "debt_to_equity"
      field: "debt_to_equity"
      source: "data.get('debt_to_equity')"

    - name: "current_ratio"
      field: "current_ratio"
      source: "data.get('current_ratio')"

    - name: "cash_flow_to_debt"
      field: "cash_flow_to_debt"
      source: "data.get('cash_flow_to_debt')"

    # Stability metrics
    - name: "operating_margin"
      field: "operating_margin"
      source: "data.get('operating_margin')"

    - name: "net_margin"
      field: "net_margin"
      source: "data.get('net_margin')"

  # Technical indicators
  technical_indicators:
    # Volatility measures
    - name: "atr_20"
      type: "ATR"
      period: 20
      source: "data.get('ATR_20')"

    - name: "atr_50"
      type: "ATR"
      period: 50
      source: "data.get('ATR_50')"

    # Trend (prefer stability)
    - name: "ma_100"
      type: "SMA"
      period: 100
      source: "data.get('MA_100')"

    - name: "ma_200"
      type: "SMA"
      period: 200
      source: "data.get('MA_200')"

    # Momentum
    - name: "rsi_14"
      type: "RSI"
      period: 14
      source: "data.get('RSI_14')"

  # Custom calculations
  custom_calculations:
    # Normalized volatility (lower is better for defensive)
    - name: "normalized_volatility"
      expression: "atr_20 / close"
      description: "ATR as percentage of price (volatility measure)"

    # Low volatility score (inverted)
    - name: "low_vol_score"
      expression: "1.0 / (1.0 + normalized_volatility * 10)"
      description: "Low volatility score (higher for less volatile stocks)"

    # Dividend quality score
    - name: "dividend_quality"
      expression: "dividend_yield * (1 - payout_ratio)"
      description: "Dividend quality: Yield × (1 - Payout Ratio) for sustainability"

    # Quality score
    - name: "quality_score"
      expression: "roe * roa * operating_margin"
      description: "Composite quality metric"

    # Financial strength score
    - name: "strength_score"
      expression: "current_ratio * cash_flow_to_debt / (1 + debt_to_equity)"
      description: "Financial strength: Liquidity × Cash Flow / Leverage"

    # Defensive composite (primary ranking metric)
    - name: "defensive_score"
      expression: "low_vol_score * dividend_quality * quality_score * 1000"
      description: "Defensive composite: Low Vol × Dividend Quality × Quality"

    # Enhanced defensive (with financial strength)
    - name: "enhanced_defensive"
      expression: "defensive_score * (1 + strength_score)"
      description: "Defensive composite enhanced with financial strength"

entry_conditions:
  # Ranking-based selection
  ranking_rules:
    # Select top 30% by enhanced defensive score
    - field: "enhanced_defensive"
      method: "top_percent"
      value: 30
      ascending: false

  # Threshold-based filters
  threshold_rules:
    # Low volatility requirement
    - condition: "normalized_volatility < 0.025"
      description: "Low volatility (ATR <2.5% of price)"

    # Dividend requirements
    - condition: "dividend_yield > 0.03"
      description: "Attractive dividend yield (>3%)"

    - condition: "dividend_yield < 0.12"
      description: "Sustainable dividend (<12% - not distressed)"

    - condition: "payout_ratio > 0.20"
      description: "Established dividend (payout >20%)"

    - condition: "payout_ratio < 0.75"
      description: "Sustainable payout (<75%)"

    # Quality requirements
    - condition: "roe > 0.12"
      description: "High ROE (>12%)"

    - condition: "roa > 0.05"
      description: "Good ROA (>5%)"

    - condition: "operating_margin > 0.10"
      description: "Strong operating margin (>10%)"

    - condition: "net_margin > 0.05"
      description: "Positive net margin (>5%)"

    # Financial strength requirements
    - condition: "debt_to_equity < 0.8"
      description: "Low leverage (D/E <0.8)"

    - condition: "current_ratio > 1.5"
      description: "Strong liquidity (Current Ratio >1.5)"

    - condition: "cash_flow_to_debt > 0.30"
      description: "Strong cash generation (CF/Debt >30%)"

    # Stability filter (price near long-term MA)
    - condition: "close > ma_200 * 0.92"
      description: "Price within 8% of 200-day MA (stability)"

    # Not extremely oversold (avoid distressed)
    - condition: "rsi_14 > 30"
      description: "Not oversold (RSI >30)"

  # All conditions must be met
  logical_operator: "AND"

  # Liquidity requirements
  min_liquidity:
    average_volume_20d: 70000000  # 70M minimum

exit_conditions:
  # Conservative stop loss
  stop_loss_pct: 0.12  # 12% stop loss

  # Moderate take profit (defensive strategies lower returns)
  take_profit_pct: 0.25  # 25% take profit

  # Conditional exits
  conditional_exits:
    # Exit if volatility increases (losing defensive characteristic)
    - condition: "normalized_volatility > 0.035"
      description: "Volatility increased (ATR >3.5% of price)"

    # Exit if dividend cut
    - condition: "dividend_yield < 0.02"
      description: "Dividend yield fell below 2% (possible cut)"

    # Exit if payout becomes unsustainable
    - condition: "payout_ratio > 0.85"
      description: "Payout ratio unsustainable (>85%)"

    # Exit if quality deteriorates
    - condition: "roe < 0.09"
      description: "ROE deteriorated (<9%)"

    - condition: "roa < 0.03"
      description: "ROA deteriorated (<3%)"

    - condition: "operating_margin < 0.07"
      description: "Operating margin weak (<7%)"

    # Exit if financial health weakens
    - condition: "debt_to_equity > 1.2"
      description: "Leverage increased (D/E >1.2)"

    - condition: "current_ratio < 1.2"
      description: "Liquidity weakened (Current Ratio <1.2)"

    - condition: "cash_flow_to_debt < 0.20"
      description: "Cash flow weakened (CF/Debt <20%)"

    # Exit if price trend breaks down
    - condition: "close < ma_200"
      description: "Price below 200-day MA (long-term support broken)"

  # Long holding period for defensive
  holding_period_days: 180  # Up to 6 months

  # Exit if ANY exit condition is met
  exit_operator: "OR"

position_sizing:
  # Risk parity allocation (volatility-adjusted)
  method: "risk_parity"

  # Maximum 30 positions (well-diversified defensive)
  max_positions: 30

  # Maximum 7% per position (diversified)
  max_position_pct: 0.07

  # Minimum 2% per position
  min_position_pct: 0.02

risk_management:
  # Sector concentration (defensive sectors: utilities, consumer staples)
  max_sector_exposure: 0.30

  # Low portfolio volatility target
  max_portfolio_volatility: 0.15

  # Correlation limit (ensure diversification)
  max_correlation: 0.55

  # Rebalance threshold (less frequent for defensive)
  rebalance_threshold: 0.18

  # Conservative drawdown limit
  max_drawdown_limit: 0.15

  # Higher cash reserve for defensive
  cash_reserve_pct: 0.10

backtest_config:
  start_date: "2019-01-01"
  end_date: "2023-12-31"
  initial_capital: 3000000  # 3M capital
  transaction_cost: 0.001425
  slippage: 0.0008  # Lower slippage for defensive stocks
