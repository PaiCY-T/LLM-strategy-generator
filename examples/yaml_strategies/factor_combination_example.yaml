# Factor Combination Strategy Example
# =====================================
# Multi-factor strategy combining quality, growth, and value factors
#
# Strategy Logic:
# - Construct composite factor: (ROE × Revenue Growth) / PE Ratio
# - Select top 20% stocks by composite factor
# - Filter for financial health (debt ratio <60%)
# - Use factor weighting for position sizing
# - Monthly rebalancing
#
# Expected Performance: Sharpe 1.8-2.5, Annual Return 18-30%

metadata:
  name: "Quality Growth Value Composite"
  description: "Multi-factor strategy selecting top 20% stocks by composite factor (ROE × Revenue Growth / PE), filtering for low debt and strong fundamentals, factor-weighted positions"
  strategy_type: "factor_combination"
  rebalancing_frequency: "M"
  version: "1.0.0"
  author: "FinLab LLM System"
  tags:
    - factor
    - quality
    - growth
    - value
    - fundamental
    - composite
  risk_level: "low"

indicators:
  # Fundamental factors (primary drivers)
  fundamental_factors:
    # Quality: Return on Equity
    - name: "roe"
      field: "ROE"
      source: "data.get('ROE')"
      transformation: "winsorize"  # Remove extreme outliers

    # Growth: Revenue growth rate
    - name: "revenue_growth"
      field: "revenue_growth"
      source: "data.get('revenue_growth')"
      transformation: "winsorize"

    # Value: Price-to-Earnings ratio
    - name: "pe_ratio"
      field: "PE_ratio"
      source: "data.get('PE_ratio')"

    # Financial health: Debt ratio
    - name: "debt_ratio"
      field: "debt_ratio"
      source: "data.get('debt_ratio')"

    # Profitability: Operating margin
    - name: "operating_margin"
      field: "operating_margin"
      source: "data.get('operating_margin')"

    # Cash flow quality
    - name: "cash_flow_to_debt"
      field: "cash_flow_to_debt"
      source: "data.get('cash_flow_to_debt')"

    # Asset efficiency
    - name: "asset_turnover"
      field: "asset_turnover"
      source: "data.get('asset_turnover')"

  # Technical indicators (for timing and risk management)
  technical_indicators:
    # RSI for momentum filter
    - name: "rsi_14"
      type: "RSI"
      period: 14
      source: "data.get('RSI_14')"

    # 50-day MA for trend
    - name: "ma_50"
      type: "SMA"
      period: 50
      source: "data.get('MA_50')"

  # Custom factor calculations
  custom_calculations:
    # Quality score: ROE adjusted for leverage
    - name: "quality_score"
      expression: "roe * (1 - debt_ratio)"
      description: "Quality score: high ROE with low leverage (ROE × (1 - Debt Ratio))"

    # Growth-value score: revenue growth per unit of PE
    - name: "growth_value_score"
      expression: "(1 + revenue_growth) / pe_ratio"
      description: "Growth-adjusted value: (1 + Revenue Growth) / PE Ratio"

    # Profitability efficiency
    - name: "profit_efficiency"
      expression: "operating_margin * asset_turnover"
      description: "Profitability × efficiency: Operating Margin × Asset Turnover"

    # Final composite factor (primary ranking metric)
    - name: "composite_factor"
      expression: "quality_score * growth_value_score * 100"
      description: "Final composite factor combining quality, growth, and value"

    # Enhanced composite with profitability
    - name: "enhanced_composite"
      expression: "composite_factor * (1 + profit_efficiency)"
      description: "Composite factor enhanced with profitability efficiency"

entry_conditions:
  # Ranking-based selection (primary entry method)
  ranking_rules:
    # Select top 20% by enhanced composite factor
    - field: "enhanced_composite"
      method: "top_percent"
      value: 20
      ascending: false  # Higher is better

  # Threshold-based filters (quality gates)
  threshold_rules:
    # Quality filter: ROE above 15%
    - condition: "roe > 0.15"
      description: "High quality (ROE >15%)"

    # Financial health: debt ratio below 60%
    - condition: "debt_ratio < 0.60"
      description: "Strong balance sheet (Debt Ratio <60%)"

    # Growth filter: revenue growth above 5%
    - condition: "revenue_growth > 0.05"
      description: "Positive growth (Revenue Growth >5%)"

    # Profitability filter
    - condition: "operating_margin > 0.08"
      description: "Profitable operations (Operating Margin >8%)"

    # Cash flow quality
    - condition: "cash_flow_to_debt > 0.20"
      description: "Strong cash generation (CF/Debt >20%)"

    # Momentum filter: RSI not oversold
    - condition: "rsi_14 > 30"
      description: "Not oversold (RSI >30)"

    # Trend filter: price above 50-day MA
    - condition: "close > ma_50"
      description: "Uptrend (Price > 50-day MA)"

    # Valuation sanity check: PE ratio reasonable
    - condition: "pe_ratio > 0"
      description: "Positive earnings (PE >0)"

    - condition: "pe_ratio < 50"
      description: "Reasonable valuation (PE <50)"

  # All conditions must be met
  logical_operator: "AND"

  # Liquidity requirements
  min_liquidity:
    average_volume_20d: 50000000  # 50M minimum volume
    dollar_volume: 5000000        # 5M daily dollar volume

exit_conditions:
  # Stop loss at -15% (wider for factor strategies)
  stop_loss_pct: 0.15

  # Take profit at +40% (allow winners to run)
  take_profit_pct: 0.40

  # Conditional exits (deteriorating fundamentals)
  conditional_exits:
    # Exit if ROE deteriorates
    - condition: "roe < 0.10"
      description: "ROE deteriorated below 10%"

    # Exit if leverage increases
    - condition: "debt_ratio > 0.75"
      description: "Leverage increased above 75%"

    # Exit if growth slows significantly
    - condition: "revenue_growth < 0"
      description: "Revenue growth turned negative"

    # Exit if profitability declines
    - condition: "operating_margin < 0.05"
      description: "Operating margin declined below 5%"

    # Exit if cash flow weakens
    - condition: "cash_flow_to_debt < 0.10"
      description: "Cash flow to debt ratio weakened below 10%"

  # Maximum holding period (quarterly rebalancing + buffer)
  holding_period_days: 90

  # Exit if ANY exit condition is met
  exit_operator: "OR"

position_sizing:
  # Factor-weighted allocation (weight by composite factor strength)
  method: "factor_weighted"

  # Maximum 30 positions (well-diversified)
  max_positions: 30

  # Maximum 8% per position
  max_position_pct: 0.08

  # Minimum 2% per position
  min_position_pct: 0.02

  # Weight by enhanced composite factor
  weighting_field: "enhanced_composite"

risk_management:
  # Sector concentration limit (factor strategies need diversification)
  max_sector_exposure: 0.25

  # Correlation limit (avoid crowded positions)
  max_correlation: 0.70

  # Rebalance if position drifts >12%
  rebalance_threshold: 0.12

  # Stop trading if portfolio drawdown >20%
  max_drawdown_limit: 0.20

  # Keep 5% cash reserve
  cash_reserve_pct: 0.05

backtest_config:
  start_date: "2020-01-01"
  end_date: "2023-12-31"
  initial_capital: 10000000  # 10M capital (institutional scale)
  transaction_cost: 0.001425
  slippage: 0.001
