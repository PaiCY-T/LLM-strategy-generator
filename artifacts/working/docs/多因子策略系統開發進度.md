# 多因子交易策略系統開發進度

**專案啟動日期**: 2025-10-10
**最後更新**: 2025-10-10

---

## 📊 專案目標

### 最終目標（長期）
- **Sharpe Ratio**: > 2.0
- **年化報酬率**: > 30%
- **最大回撤 (MDD)**: < 20%
- **流動性限制**: 150M TWD 最低日交易金額

### 開發理念
> **不急於達成目標績效，優先深入了解各因子對系統的影響**

- 系統性測試不同類型因子
- 從多角度探索策略空間
- 不侷限於傳統算法
- 記錄每個因子的表現特徵

---

## 🏗️ 系統架構

### 核心變更：從 OpenRouter API 遷移到 Claude Code

**變更前**:
```
iteration_engine.py → claude_api_client.py → OpenRouter API (Gemini 2.5 Flash)
```

**變更後**:
```
iteration_engine.py → claude_code_strategy_generator.py → Claude Code (本地生成)
```

**優點**:
- ✅ 無需外部 API key
- ✅ 本地化執行
- ✅ 更快的回應時間
- ✅ 完全整合 Claude Code 環境

### 主要模組

| 模組 | 功能 | 狀態 |
|------|------|------|
| `claude_code_strategy_generator.py` | 策略代碼生成 | ✅ 已更新 |
| `iteration_engine.py` | 迭代執行引擎 | ✅ 已整合 |
| `ast_validator.py` | 代碼安全驗證 | ✅ 已修復 |
| `iteration_history.jsonl` | 迭代結果記錄 | ✅ 運作中 |

---

## 📝 Finlab API 模式規範

### 從用戶範本學習的關鍵模式

#### 範本1：基礎多條件篩選策略
```python
# 使用 .average() 而非 .rolling().mean()
sma20 = close.average(20)
sma60 = close.average(60)

# 條件組合與評分加權
cond_all = cond1 & cond2 & cond3
cond_all = cond_all * score_factor  # 乘以評分因子

# 選股
cond_all = cond_all[cond_all > 0].is_largest(10)

# 回測
report = backtest.sim(
    cond_all,
    resample="M",
    fee_ratio=1.425/1000/3,
    stop_loss=0.06,
    take_profit=0.5,
    position_limit=0.125
)

# 輸出指標
print(f"年化報酬率: {report.metrics.annual_return():.2%}")
print(f"夏普比率: {report.metrics.sharpe_ratio():.2f}")
print(f"最大回撤: {report.metrics.max_drawdown():.2%}")
```

#### 範本2：多因子排名組合策略
```python
# 技術指標
atr = data.indicator("ATR", adjust_price=True, timeperiod=10)
rsi = data.indicator("RSI", timeperiod=6)
macd, macd_signal, macd_hist = data.indicator("MACD", fastperiod=7, slowperiod=22, signalperiod=12)

# 排名標準化（百分位排名）
pe_rank = pe.rank(axis=1, ascending=True, pct=True)
rev_growth_rank = rev_growth_ratio.rank(axis=1, ascending=False, pct=True)
roe_rank = roe.rank(axis=1, ascending=False, pct=True)
momentum_rank = momentum_6m.rank(axis=1, ascending=False, pct=True)

# 複合因子（排名相乘）
composite_factor = pe_rank * rev_growth_rank * roe_rank * momentum_rank

# 數據對齊
position = composite_factor[cond_all]\
    .is_smallest(10)\
    .reindex(rev.index_str_to_date().index, method="ffill")

# 回測（直接使用 sim）
report = sim(
    position=position,
    fee_ratio=1.425/1000/3,
    position_limit=0.1,
    stop_loss=0.18,
    trade_at_price="open"
)
```

---

## 🔧 技術問題修復記錄

### ✅ 已解決問題

#### 1. AST Validator 阻擋 backtest 導入
**問題**:
```
Line 5: Unauthorized import from 'finlab': 'backtest'. Allowed: data
```

**解決方案** (`ast_validator.py:24`):
```python
ALLOWED_MODULES = {
    'finlab': {'data', 'backtest'},  # 添加 backtest
}
```

#### 2. Variable `iteration` 未定義
**問題**:
```python
name=f"Momentum_20d_Iter{iteration}"  # iteration 變數不存在
```

**解決方案**:
```python
name="Momentum_20d_Iter0"  # 硬編碼迭代編號
```

#### 3. Missing 'position' Variable
**問題**: iteration_engine 期望 `signal` 或 `position` 變數

**解決方案**:
```python
# 在 backtest.sim() 前添加
position = cond_all
```

#### 4. API 模式錯誤
**問題**: 使用 `.rolling().mean()` 而非 Finlab 的 `.average()`

**解決方案**:
```python
# 修改前:
liquidity_filter = trading_value.rolling(20).mean() > 150_000_000

# 修改後:
liquidity_filter = (close * vol).average(20) > 150_000_000
```

### ⚠️ 待解決問題

#### Iterations 1-4 使用 Fallback Template

**現象**:
- Iteration 0: ✅ 使用生成的20日動量策略
- Iterations 1-4: ❌ 全部使用 champion template fallback

**影響**:
- 無法測試不同動量因子變體
- 系統性測試計劃受阻

**可能原因**:
1. 策略生成器的 `elif 1 <= iteration <= 19:` 分支未正確執行
2. 生成的代碼有 AST 驗證問題
3. 運行時錯誤觸發 fallback

**下一步**:
1. 檢查 `claude_code_strategy_generator.py` 的條件邏輯
2. 手動測試 iterations 1-4 的代碼生成
3. 添加詳細日誌記錄生成過程

---

## 📈 迭代測試進度

### Phase 1: 動量因子測試 (Iterations 0-19)

| Iter | 策略描述 | 狀態 | 年化報酬 | Sharpe | MDD | 備註 |
|------|----------|------|----------|--------|-----|------|
| 0 | 20日動量 | ✅ 完成 | 1.44% | 0.11 | -63.58% | 基礎策略 |
| 1 | 10日短期動量 | ⚠️ Fallback | - | - | - | 需修復 |
| 2 | 40日中期動量 | ⚠️ Fallback | - | - | - | 需修復 |
| 3 | 60日長期動量 | ⚠️ Fallback | - | - | - | 需修復 |
| 4 | 120日趨勢跟隨 | ⚠️ Fallback | - | - | - | 需修復 |
| 5 | SMA20/SMA60 交叉 | ⏳ 待執行 | - | - | - | - |
| 6 | SMA5/SMA20 交叉 | ⏳ 待執行 | - | - | - | - |
| 7 | 20日變化率 | ⏳ 待執行 | - | - | - | - |
| 8 | 60日變化率 | ⏳ 待執行 | - | - | - | - |
| 9 | 20日相對強度 vs 市場 | ⏳ 待執行 | - | - | - | - |
| 10 | 60日相對強度 vs 市場 | ⏳ 待執行 | - | - | - | - |
| 11 | 多時間框架動量 (10d+20d+60d) | ⏳ 待執行 | - | - | - | - |
| 12 | 加權動量 (40% 20d, 30% 40d, 30% 60d) | ⏳ 待執行 | - | - | - | - |
| 13 | 20日動量 + 成交量確認 | ⏳ 待執行 | - | - | - | - |
| 14 | 40日動量 + 成交量趨勢 | ⏳ 待執行 | - | - | - | - |
| 15 | 20日動量/波動率 (Sharpe style) | ⏳ 待執行 | - | - | - | - |
| 16 | 60日動量 + 低波動率篩選 | ⏳ 待執行 | - | - | - | - |
| 17 | 動量加速度 (increasing momentum) | ⏳ 待執行 | - | - | - | - |
| 18 | 動量減速篩選 (steady momentum) | ⏳ 待執行 | - | - | - | - |
| 19 | 20日殘差動量 (vs sector) | ⏳ 待執行 | - | - | - | - |

**進度**: 1/20 完成 (5%)

### Phase 2: 價值因子測試 (Iterations 20+)

**待測試因子**:
- 本益比 (P/E)
- 股價淨值比 (P/B)
- 股利殖利率
- PEG ratio (P/E to Growth)
- 企業價值倍數 (EV/EBITDA)
- 營收成長率
- 淨利成長率
- ROE (股東權益報酬率)

**狀態**: ⏳ 待規劃

### Phase 3: 波動率因子測試

**待測試因子**:
- ATR (Average True Range)
- 歷史波動率
- 低波動異常 (Low Volatility Anomaly)
- Beta 值
- Idiosyncratic volatility
- Sharpe-style 動量 (動量/波動率)

**狀態**: ⏳ 待規劃

### Phase 4: 創新因子測試

**待測試因子**:
- 融資使用率
- 融券變化
- 業外收支營收率
- 董監持股比例變化
- 法人持股變化
- 股票回購
- 內部人交易

**狀態**: ⏳ 待規劃

---

## 📊 Iteration 0 結果分析

### 策略: 20日動量 (Simple Momentum)

**代碼**: `generated_strategy_iter0.py`

**邏輯**:
```python
# 動量因子: 20日報酬率
momentum_20d = (close / close.shift(20) - 1)

# 流動性篩選: 150M TWD 最低日交易金額
liquidity_filter = (close * vol).average(20) > 150_000_000

# 價格篩選: 避免雞蛋水餃股
price_filter = close > 10

# 組合條件
cond_all = liquidity_filter & price_filter
cond_all = cond_all * momentum_20d  # 依動量評分加權

# 選股: 正動量的前10名
cond_all = cond_all[cond_all > 0].is_largest(10)
```

**回測參數**:
```python
report = backtest.sim(
    position,
    resample="M",           # 月度調倉
    fee_ratio=1.425/1000/3, # 0.1425% 交易成本
    stop_loss=0.08,         # 8% 停損
    take_profit=0.5,        # 50% 停利
    position_limit=0.10     # 單檔最多10%
)
```

**績效指標**:
| 指標 | 結果 | 目標 | 達成率 |
|------|------|------|--------|
| 年化報酬率 | 1.44% | 30% | 4.8% |
| 夏普比率 | 0.11 | 2.0 | 5.5% |
| 最大回撤 | -63.58% | -20% | ❌ 超標 |

**觀察**:
1. ⚠️ **極低的 Sharpe Ratio (0.11)**: 表示風險調整後報酬非常差
2. ⚠️ **極大的回撤 (-63.58%)**: 遠超可接受範圍，風險管理失效
3. ⚠️ **低報酬率 (1.44%)**: 幾乎無超額報酬

**可能原因**:
- 單一動量因子不足
- 停損/停利參數可能不適合
- 需要與其他因子組合
- 市場環境可能不適合純動量策略

**後續改進方向**:
1. 測試不同動量時間框架 (iterations 1-4)
2. 加入成交量確認 (iterations 13-14)
3. 加入波動率調整 (iterations 15-16)
4. 多因子組合 (Phase 2+)

---

## 🎯 後續工作計劃

### 短期目標 (1-2天)

#### 1. 修復 Iterations 1-4 Fallback 問題 (最高優先級)
- [ ] 檢查策略生成器條件邏輯
- [ ] 手動測試 iterations 1-4 代碼生成
- [ ] 添加詳細日誌記錄
- [ ] 驗證 AST validator 通過
- [ ] 確認執行無錯誤

#### 2. 完成動量因子測試 Phase 1
- [ ] 成功執行 iterations 1-19
- [ ] 記錄每個迭代的績效指標
- [ ] 分析不同動量因子的特徵
- [ ] 識別最佳動量時間框架

#### 3. 整合範本2模式
- [ ] 實作 `data.indicator()` 技術指標
- [ ] 實作 `.rank()` 排名標準化
- [ ] 實作排名相乘複合因子
- [ ] 實作 `reindex()` 數據對齊

### 中期目標 (1週)

#### 4. 價值因子測試 Phase 2
- [ ] 規劃價值因子測試策略 (iterations 20-39)
- [ ] 實作本益比、股價淨值比等因子
- [ ] 測試不同價值因子組合
- [ ] 分析價值因子與動量因子的互補性

#### 5. 波動率因子測試 Phase 3
- [ ] 規劃波動率因子測試策略 (iterations 40-59)
- [ ] 實作 ATR、歷史波動率等指標
- [ ] 測試低波動異常策略
- [ ] 分析波動率因子的風險調整效果

### 長期目標 (2-4週)

#### 6. 創新因子測試 Phase 4
- [ ] 規劃創新因子測試策略
- [ ] 實作融資、內部人交易等因子
- [ ] 測試非傳統因子的有效性

#### 7. 多因子組合優化
- [ ] 分析各因子相關性
- [ ] 設計多因子組合策略
- [ ] 優化因子權重
- [ ] 回測驗證

#### 8. 績效目標達成
- [ ] Sharpe Ratio > 2.0
- [ ] 年化報酬率 > 30%
- [ ] 最大回撤 < 20%

---

## 📚 技術文檔

### 重要檔案位置

| 檔案 | 路徑 | 用途 |
|------|------|------|
| 策略生成器 | `claude_code_strategy_generator.py` | 生成策略代碼 |
| 迭代引擎 | `iteration_engine.py` | 執行迭代循環 |
| AST 驗證器 | `ast_validator.py` | 代碼安全檢查 |
| 迭代歷史 | `iteration_history.jsonl` | JSONL 格式記錄 |
| 生成策略 | `generated_strategy_iter*.py` | 每次迭代的策略 |
| 專案文檔 | `多因子策略系統開發進度.md` | 本文檔 |

### 執行命令

```bash
# 執行單次迭代
python iteration_engine.py --iterations 1 --start-iter 0

# 執行多次迭代
python iteration_engine.py --iterations 5 --start-iter 0

# 查看迭代歷史
cat iteration_history.jsonl | jq '.'

# 檢查生成的策略
cat generated_strategy_iter0.py
```

### 開發環境

- **Platform**: WSL2 (Linux)
- **Python Version**: 3.x
- **主要依賴**: finlab, pandas, numpy
- **API**: Finlab API (需設置 `FINLAB_API_TOKEN`)

---

## 📌 備註

### 設計原則

1. **系統性測試**: 每個因子類型至少20次迭代
2. **漸進式探索**: 從簡單到複雜
3. **證據驅動**: 基於實際回測結果做決策
4. **風險意識**: 持續監控回撤和 Sharpe ratio
5. **靈活創新**: 不侷限於傳統因子

### 關鍵指標

- **Sharpe Ratio**: 衡量風險調整後報酬
- **Maximum Drawdown**: 衡量最大損失風險
- **Annual Return**: 衡量絕對報酬
- **Win Rate**: 勝率（後續添加）
- **Turnover**: 換手率（後續添加）

### 學習重點

從用戶範本學到的重要概念：
1. 流動性篩選的重要性 (150M TWD)
2. 因子標準化的必要性 (`.rank()`)
3. 複合因子的威力 (排名相乘)
4. 數據對齊的技巧 (`.reindex()`, `.ffill()`)
5. 風險管理參數的設置 (停損、停利、部位限制)

---

**文檔版本**: 1.0
**最後更新**: 2025-10-10
**更新者**: Claude Code
