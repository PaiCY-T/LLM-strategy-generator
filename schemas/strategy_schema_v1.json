{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://finlab.io/schemas/strategy_schema_v1.json",
  "title": "FinLab Strategy Specification Schema",
  "description": "JSON Schema v7 for YAML-based trading strategy specifications. Supports momentum, mean_reversion, and factor_combination strategies with comprehensive validation rules.",
  "version": "1.0.0",
  "type": "object",
  "required": ["metadata", "indicators", "entry_conditions", "exit_conditions"],

  "properties": {
    "metadata": {
      "type": "object",
      "description": "Strategy metadata and identification information",
      "required": ["name", "strategy_type", "rebalancing_frequency"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique strategy name (e.g., 'High ROE Momentum Strategy')",
          "minLength": 5,
          "maxLength": 100,
          "pattern": "^[A-Za-z0-9 _-]+$"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of strategy logic and goals",
          "minLength": 10,
          "maxLength": 500
        },
        "strategy_type": {
          "type": "string",
          "description": "Primary strategy category determining execution pattern",
          "enum": ["momentum", "mean_reversion", "factor_combination"]
        },
        "rebalancing_frequency": {
          "type": "string",
          "description": "Portfolio rebalancing frequency (M=monthly, W-FRI=weekly Friday, W-MON=weekly Monday)",
          "enum": ["M", "W-FRI", "W-MON", "W-TUE", "W-WED", "W-THU", "Q"]
        },
        "version": {
          "type": "string",
          "description": "Strategy version identifier (e.g., '1.0.0')",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "default": "1.0.0"
        },
        "author": {
          "type": "string",
          "description": "Strategy author or system identifier",
          "default": "FinLab LLM System"
        },
        "tags": {
          "type": "array",
          "description": "Categorization tags for strategy organization",
          "items": {
            "type": "string",
            "pattern": "^[a-z0-9._-]+$"
          },
          "minItems": 0,
          "maxItems": 10,
          "uniqueItems": true
        },
        "risk_level": {
          "type": "string",
          "description": "Expected risk level based on strategy characteristics",
          "enum": ["low", "medium", "high", "very_high"],
          "default": "medium"
        }
      },
      "additionalProperties": true
    },

    "indicators": {
      "oneOf": [
        {
          "type": "object",
          "description": "All indicators used in the strategy (structured format with technical, fundamental, custom)",
          "properties": {
            "technical_indicators": {
              "type": "array",
              "description": "Technical analysis indicators (price, volume, momentum)",
              "items": {
                "type": "object",
                "required": ["name", "type"],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Variable name for this indicator (e.g., 'rsi_14')",
                    "pattern": "^[a-z_][a-z0-9_]*$"
                  },
                  "type": {
                    "type": "string",
                    "description": "Technical indicator type",
                    "enum": [
                      "RSI", "MACD", "BB", "SMA", "EMA", "ATR", "ADX",
                      "Stochastic", "CCI", "Williams_R", "MFI", "OBV",
                      "VWAP", "Momentum", "ROC", "TSI"
                    ]
                  },
                  "period": {
                    "type": "integer",
                    "description": "Lookback period for indicator calculation (days)",
                    "minimum": 1,
                    "maximum": 250
                  },
                  "source": {
                    "type": "string",
                    "description": "FinLab API data source (e.g., 'data.get(\"RSI_14\")')",
                    "pattern": "^data\\.get\\(['\"].*['\"]\\)$"
                  },
                  "parameters": {
                    "type": "object",
                    "description": "Additional indicator-specific parameters",
                    "properties": {
                      "fast_period": {
                        "type": "integer",
                        "minimum": 1,
                        "maximum": 100
                      },
                      "slow_period": {
                        "type": "integer",
                        "minimum": 1,
                        "maximum": 250
                      },
                      "signal_period": {
                        "type": "integer",
                        "minimum": 1,
                        "maximum": 100
                      },
                      "std_dev": {
                        "type": "number",
                        "minimum": 0.1,
                        "maximum": 5.0
                      }
                    }
                  }
                },
                "additionalProperties": true
              },
              "minItems": 0,
              "maxItems": 20
            },

            "fundamental_factors": {
              "type": "array",
              "description": "Fundamental analysis factors (financial statement data)",
              "items": {
                "type": "object",
                "required": ["name", "field"],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Variable name for this factor (e.g., 'roe')",
                    "pattern": "^[a-z_][a-z0-9_]*$"
                  },
                  "field": {
                    "type": "string",
                    "description": "Fundamental data field type",
                    "enum": [
                      "ROE", "ROA", "PB_ratio", "PE_ratio", "PS_ratio",
                      "revenue_growth", "earnings_growth", "margin",
                      "operating_margin", "net_margin", "debt_ratio",
                      "debt_to_equity", "current_ratio", "quick_ratio",
                      "cash_flow_to_debt", "dividend_yield", "payout_ratio",
                      "asset_turnover", "inventory_turnover", "receivables_turnover"
                    ]
                  },
                  "source": {
                    "type": "string",
                    "description": "FinLab API data source (e.g., 'data.get(\"ROE\")')",
                    "pattern": "^data\\.get\\(['\"].*['\"]\\)$"
                  },
                  "transformation": {
                    "type": "string",
                    "description": "Optional transformation to apply (log, sqrt, rank, zscore)",
                    "enum": ["none", "log", "sqrt", "rank", "zscore", "winsorize"]
                  }
                },
                "additionalProperties": true
              },
              "minItems": 0,
              "maxItems": 15
            },

            "custom_calculations": {
              "type": "array",
              "description": "Custom calculated indicators using expressions",
              "items": {
                "type": "object",
                "required": ["name", "expression"],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Variable name for this custom indicator",
                    "pattern": "^[a-z_][a-z0-9_]*$"
                  },
                  "expression": {
                    "type": "string",
                    "description": "Mathematical expression using other indicators (e.g., 'roe * (1 + revenue_growth)')",
                    "minLength": 3,
                    "maxLength": 500
                  },
                  "description": {
                    "type": "string",
                    "description": "Human-readable explanation of what this calculation represents"
                  }
                },
                "additionalProperties": true
              },
              "minItems": 0,
              "maxItems": 10
            },

            "volume_filters": {
              "type": "array",
              "description": "Liquidity and volume-based filters",
              "items": {
                "type": "object",
                "required": ["name", "metric"],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Variable name for volume filter",
                    "pattern": "^[a-z_][a-z0-9_]*$"
                  },
                  "metric": {
                    "type": "string",
                    "description": "Volume metric type",
                    "enum": ["average_volume", "dollar_volume", "turnover_ratio", "bid_ask_spread"]
                  },
                  "period": {
                    "type": "integer",
                    "description": "Rolling period for volume calculation (days)",
                    "minimum": 1,
                    "maximum": 250
                  },
                  "threshold": {
                    "type": "number",
                    "description": "Minimum threshold value for the filter"
                  }
                },
                "additionalProperties": true
              }
            }
          },
          "additionalProperties": true,
          "minProperties": 1
        },
        {
          "type": "array",
          "description": "All indicators used in the strategy (simplified flat array format)",
          "items": {
            "type": "object",
            "required": ["name"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Variable name for this indicator",
                "pattern": "^[a-z_][a-z0-9_]*$"
              },
              "type": {
                "type": "string",
                "description": "Indicator type (technical, fundamental, or custom)"
              },
              "field": {
                "type": "string",
                "description": "Data field for fundamental indicators"
              },
              "period": {
                "type": "integer",
                "description": "Lookback period (days)",
                "minimum": 1,
                "maximum": 250
              },
              "source": {
                "type": "string",
                "description": "FinLab API data source"
              },
              "expression": {
                "type": "string",
                "description": "Expression for custom calculations"
              },
              "description": {
                "type": "string",
                "description": "Human-readable description"
              }
            },
            "additionalProperties": true
          },
          "minItems": 1,
          "maxItems": 50
        }
      ]
    },

    "entry_conditions": {
      "oneOf": [
        {
          "type": "object",
          "description": "Conditions that must be met for entering positions (object format with threshold_rules and ranking_rules)",
          "properties": {
            "threshold_rules": {
              "type": "array",
              "description": "Simple threshold-based entry rules (e.g., 'rsi > 30')",
              "items": {
                "type": "object",
                "required": ["condition"],
                "properties": {
                  "condition": {
                    "type": "string",
                    "description": "Boolean condition expression (e.g., 'rsi_14 > 30')",
                    "minLength": 3,
                    "maxLength": 200
                  },
                  "description": {
                    "type": "string",
                    "description": "Human-readable explanation of this rule"
                  }
                },
                "additionalProperties": true
              },
              "minItems": 0,
              "maxItems": 15
            },

            "ranking_rules": {
              "type": "array",
              "description": "Ranking-based selection rules (e.g., 'top 20% by momentum')",
              "items": {
                "type": "object",
                "required": ["field", "method"],
                "properties": {
                  "field": {
                    "type": "string",
                    "description": "Field to rank by (must be defined in indicators)",
                    "pattern": "^[a-z_][a-z0-9_]*$"
                  },
                  "method": {
                    "type": "string",
                    "description": "Ranking method",
                    "enum": ["top_percent", "bottom_percent", "top_n", "bottom_n", "percentile_range"]
                  },
                  "value": {
                    "type": "number",
                    "description": "Threshold value (percent for top_percent, count for top_n, etc.)"
                  },
                  "ascending": {
                    "type": "boolean",
                    "description": "Sort direction (true for ascending, false for descending)",
                    "default": false
                  },
                  "percentile_min": {
                    "type": "number",
                    "description": "Minimum percentile for percentile_range method",
                    "minimum": 0,
                    "maximum": 100
                  },
                  "percentile_max": {
                    "type": "number",
                    "description": "Maximum percentile for percentile_range method",
                    "minimum": 0,
                    "maximum": 100
                  }
                },
                "additionalProperties": true
              },
              "minItems": 0,
              "maxItems": 5
            },

            "logical_operator": {
              "type": "string",
              "description": "How to combine multiple entry conditions",
              "enum": ["AND", "OR"],
              "default": "AND"
            },

            "min_liquidity": {
              "type": "object",
              "description": "Minimum liquidity requirements",
              "properties": {
                "average_volume_20d": {
                  "type": "number",
                  "description": "Minimum 20-day average volume",
                  "minimum": 0
                },
                "dollar_volume": {
                  "type": "number",
                  "description": "Minimum daily dollar volume",
                  "minimum": 0
                }
              }
            }
          },
          "additionalProperties": true,
          "minProperties": 1
        },
        {
          "type": "array",
          "description": "Conditions that must be met for entering positions (array format - simplified list)",
          "items": {
            "type": "object",
            "properties": {
              "condition": {
                "type": "string",
                "description": "Boolean condition expression (e.g., 'rsi_14 > 30')"
              },
              "field": {
                "type": "string",
                "description": "Field name for ranking",
                "pattern": "^[a-z_][a-z0-9_]*$"
              },
              "method": {
                "type": "string",
                "description": "Ranking method",
                "enum": ["top_percent", "bottom_percent", "top_n", "bottom_n", "percentile_range"]
              },
              "value": {
                "type": "number",
                "description": "Threshold value for ranking"
              },
              "description": {
                "type": "string",
                "description": "Human-readable explanation"
              }
            },
            "additionalProperties": true
          },
          "minItems": 1,
          "maxItems": 20
        }
      ]
    },

    "exit_conditions": {
      "oneOf": [
        {
          "type": "object",
          "description": "Conditions for exiting positions (risk management) - object format",
          "properties": {
            "stop_loss_pct": {
              "type": "number",
              "description": "Maximum loss percentage before exit (e.g., 0.10 for 10% loss)",
              "minimum": 0.01,
              "maximum": 0.50,
              "exclusiveMinimum": 0
            },

            "take_profit_pct": {
              "type": "number",
              "description": "Target profit percentage for exit (e.g., 0.25 for 25% gain)",
              "minimum": 0.05,
              "maximum": 2.0
            },

            "trailing_stop": {
              "type": "object",
              "description": "Trailing stop configuration",
              "properties": {
                "trail_percent": {
                  "type": "number",
                  "description": "Trailing stop percentage (e.g., 0.10 for 10% trail)",
                  "minimum": 0.01,
                  "maximum": 0.30
                },
                "activation_profit": {
                  "type": "number",
                  "description": "Minimum profit before trailing stop activates (e.g., 0.05 for 5%)",
                  "minimum": 0,
                  "maximum": 0.50
                }
              },
              "required": ["trail_percent"],
              "additionalProperties": true
            },

            "holding_period_days": {
              "type": "integer",
              "description": "Maximum holding period in days (time-based exit)",
              "minimum": 1,
              "maximum": 365
            },

            "conditional_exits": {
              "type": "array",
              "description": "Indicator-based exit conditions (e.g., 'if rsi < 70')",
              "items": {
                "type": "object",
                "required": ["condition"],
                "properties": {
                  "condition": {
                    "type": "string",
                    "description": "Boolean exit condition expression",
                    "minLength": 3,
                    "maxLength": 200
                  },
                  "description": {
                    "type": "string",
                    "description": "Human-readable explanation of exit condition"
                  }
                },
                "additionalProperties": true
              },
              "minItems": 0,
              "maxItems": 10
            },

            "exit_operator": {
              "type": "string",
              "description": "How to combine multiple exit conditions (OR means exit if any condition met)",
              "enum": ["AND", "OR"],
              "default": "OR"
            }
          },
          "additionalProperties": true
        },
        {
          "type": "array",
          "description": "Conditions for exiting positions (simplified array format)",
          "items": {
            "type": "object",
            "properties": {
              "condition": {
                "type": "string",
                "description": "Exit condition expression (e.g., 'rsi_14 < 70')"
              },
              "stop_loss_pct": {
                "type": "number",
                "description": "Stop loss percentage",
                "minimum": 0.01,
                "maximum": 0.50
              },
              "take_profit_pct": {
                "type": "number",
                "description": "Take profit percentage",
                "minimum": 0.05,
                "maximum": 2.0
              },
              "description": {
                "type": "string",
                "description": "Human-readable explanation"
              }
            },
            "additionalProperties": true
          },
          "minItems": 1,
          "maxItems": 20
        }
      ]
    },

    "position_sizing": {
      "type": "object",
      "description": "Position sizing and portfolio construction rules",
      "required": ["method"],
      "properties": {
        "method": {
          "type": "string",
          "description": "Position sizing method",
          "enum": [
            "equal_weight",
            "factor_weighted",
            "risk_parity",
            "volatility_weighted",
            "custom_formula"
          ]
        },

        "max_positions": {
          "type": "integer",
          "description": "Maximum number of positions in portfolio",
          "minimum": 1,
          "maximum": 100
        },

        "max_position_pct": {
          "type": "number",
          "description": "Maximum percentage per position (e.g., 0.10 for 10%)",
          "minimum": 0.01,
          "maximum": 1.0
        },

        "min_position_pct": {
          "type": "number",
          "description": "Minimum percentage per position (e.g., 0.01 for 1%)",
          "minimum": 0.001,
          "maximum": 0.50
        },

        "weighting_field": {
          "type": "string",
          "description": "Field to use for factor_weighted method (must be in indicators)",
          "pattern": "^[a-z_][a-z0-9_]*$"
        },

        "custom_formula": {
          "type": "string",
          "description": "Custom position sizing formula (for custom_formula method)",
          "minLength": 3,
          "maxLength": 500
        }
      },
      "additionalProperties": true
    },

    "risk_management": {
      "type": "object",
      "description": "Portfolio-level risk management rules",
      "properties": {
        "max_portfolio_volatility": {
          "type": "number",
          "description": "Maximum portfolio volatility threshold",
          "minimum": 0.01,
          "maximum": 1.0
        },

        "max_sector_exposure": {
          "type": "number",
          "description": "Maximum exposure to any single sector (e.g., 0.30 for 30%)",
          "minimum": 0.05,
          "maximum": 1.0
        },

        "max_correlation": {
          "type": "number",
          "description": "Maximum average correlation between positions",
          "minimum": -1.0,
          "maximum": 1.0
        },

        "rebalance_threshold": {
          "type": "number",
          "description": "Minimum deviation to trigger rebalancing (e.g., 0.15 for 15%)",
          "minimum": 0.01,
          "maximum": 0.50
        },

        "max_drawdown_limit": {
          "type": "number",
          "description": "Maximum drawdown before reducing positions (e.g., 0.20 for 20%)",
          "minimum": 0.05,
          "maximum": 0.50
        },

        "cash_reserve_pct": {
          "type": "number",
          "description": "Minimum cash reserve as percentage of portfolio",
          "minimum": 0,
          "maximum": 0.50,
          "default": 0
        }
      },
      "additionalProperties": true
    },

    "backtest_config": {
      "type": "object",
      "description": "Backtesting configuration parameters",
      "properties": {
        "start_date": {
          "type": "string",
          "description": "Backtest start date (YYYY-MM-DD format)",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
        },

        "end_date": {
          "type": "string",
          "description": "Backtest end date (YYYY-MM-DD format)",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
        },

        "initial_capital": {
          "type": "number",
          "description": "Initial capital for backtest",
          "minimum": 1000,
          "default": 1000000
        },

        "transaction_cost": {
          "type": "number",
          "description": "Transaction cost per trade (percentage)",
          "minimum": 0,
          "maximum": 0.10,
          "default": 0.001425
        },

        "slippage": {
          "type": "number",
          "description": "Expected slippage per trade (percentage)",
          "minimum": 0,
          "maximum": 0.05,
          "default": 0.001
        }
      },
      "additionalProperties": true
    }
  },

  "additionalProperties": true,

  "definitions": {
    "indicator_reference": {
      "type": "string",
      "description": "Reference to an indicator name defined in the indicators section",
      "pattern": "^[a-z_][a-z0-9_]*$"
    },

    "percentage": {
      "type": "number",
      "description": "Percentage value (0.0 to 1.0)",
      "minimum": 0,
      "maximum": 1.0
    },

    "trading_frequency": {
      "type": "string",
      "description": "Trading/rebalancing frequency",
      "enum": ["D", "W-MON", "W-TUE", "W-WED", "W-THU", "W-FRI", "M", "Q"]
    }
  },

  "examples": [
    {
      "metadata": {
        "name": "High ROE Momentum Strategy",
        "description": "Select top 20% stocks by ROE, filter by momentum, equal weight",
        "strategy_type": "factor_combination",
        "rebalancing_frequency": "M",
        "version": "1.0.0",
        "author": "FinLab LLM System",
        "tags": ["momentum", "quality", "factor"],
        "risk_level": "medium"
      },
      "indicators": {
        "fundamental_factors": [
          {
            "name": "roe",
            "field": "ROE",
            "source": "data.get('ROE')"
          },
          {
            "name": "revenue_growth",
            "field": "revenue_growth",
            "source": "data.get('revenue_growth')"
          }
        ],
        "technical_indicators": [
          {
            "name": "rsi_14",
            "type": "RSI",
            "period": 14,
            "source": "data.get('RSI_14')"
          },
          {
            "name": "ma_50",
            "type": "SMA",
            "period": 50,
            "source": "data.get('MA_50')"
          }
        ],
        "custom_calculations": [
          {
            "name": "quality_score",
            "expression": "roe * (1 + revenue_growth)",
            "description": "Combined quality and growth score"
          }
        ]
      },
      "entry_conditions": {
        "ranking_rules": [
          {
            "field": "quality_score",
            "method": "top_percent",
            "value": 20,
            "ascending": false
          }
        ],
        "threshold_rules": [
          {
            "condition": "rsi_14 > 30",
            "description": "RSI not oversold"
          },
          {
            "condition": "close > ma_50",
            "description": "Price above 50-day MA"
          }
        ],
        "logical_operator": "AND",
        "min_liquidity": {
          "average_volume_20d": 150000000
        }
      },
      "exit_conditions": {
        "stop_loss_pct": 0.10,
        "take_profit_pct": 0.25,
        "trailing_stop": {
          "trail_percent": 0.10,
          "activation_profit": 0.05
        },
        "holding_period_days": 30,
        "exit_operator": "OR"
      },
      "position_sizing": {
        "method": "equal_weight",
        "max_positions": 20,
        "max_position_pct": 0.10
      },
      "risk_management": {
        "max_sector_exposure": 0.30,
        "rebalance_threshold": 0.15
      }
    }
  ]
}
