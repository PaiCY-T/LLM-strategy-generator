{
  "records": [
    {
      "iteration_num": 0,
      "timestamp": "2025-11-01T15:20:45.676429",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\nrsi = data.indicator('RSI') # Technical indicator for filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Use .ffill() to align quarterly data to daily frequency\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Use .ffill() to align monthly data to daily frequency\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market capitalization filter: Market cap > 10 Billion TWD for larger companies\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select top N stocks (typically 8-15)\n# Select top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:20:25.397639",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-01T15:20:25.415584",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-01T15:21:14.192247",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy for institutional flow\nadx = data.indicator('ADX') # Average Directional Index for trend strength\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill for monthly/quarterly data, then rolling mean, then shift\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# ffill for monthly data, then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\ninst_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Trend Strength (ADX)\nadx_strength = adx.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\ninst_flow_rank = inst_flow.rank(axis=1, pct=True)\nadx_strength_rank = adx_strength.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   inst_flow_rank * 0.15 +\n                   adx_strength_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# ADX Trend filter: Only consider stocks with a strong trend (ADX > 25)\nadx_filter = adx_strength > 25\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & adx_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:20:46.768255",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-01T15:21:36.665911",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical filter\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Use .ffill() to align quarterly data to daily frequency\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, aligned to daily)\n# Use .ffill() to align monthly data to daily frequency\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights\n# Momentum often has a higher weight, followed by quality/growth and flow\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market capitalization filter: Market cap > 10 Billion TWD for larger, more stable companies\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:21:15.875644",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-01T15:22:02.132228",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # For market cap filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Captures medium-term price trends.\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is a quarterly fundamental, so ffill to daily and then apply a 4-period rolling mean\n# to smooth out quarterly fluctuations and capture underlying profitability.\nquality = roe.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Monthly revenue YoY, forward-filled to daily frequency to align with price data.\n# Indicates company's top-line growth.\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\n# Summing foreign net buy over 20 days to identify sustained institutional interest,\n# which often precedes price movements.\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] across all stocks for each day.\n# This ensures factors with different scales contribute equally based on their relative strength.\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine factors with weighted average. Weights sum to 1.0.\n# Prioritizing momentum and quality, with good contributions from growth and institutional flow.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.30 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be > 50M TWD.\n# This ensures sufficient liquidity for entry and exit without significant price impact.\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price must be > 20 TWD to avoid very low-priced, potentially volatile stocks.\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization must be > 5 Billion TWD.\n# Focuses on mid-to-large cap stocks, which tend to be more stable and liquid.\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters to the combined factor. Only stocks passing all filters are considered.\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select the top 10 stocks with the highest combined factor score for portfolio inclusion.\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing (resample=\"Q\"), no upload, and an 8% stop loss.\n# Quarterly rebalancing balances transaction costs with factor decay.\n# Stop loss helps manage downside risk.\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:21:37.697943",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-01T15:22:28.850314",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Institutional flow\nrsi = data.indicator('RSI')  # Technical indicator for filter\nmarket_cap = data.get('etl:market_value') # Market capitalization for size filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing, forward-filled)\n# Use min_periods=1 to allow calculation with fewer data points at the start\nquality = roe.rolling(4, min_periods=1).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily, forward-filled)\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Accumulation (20-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(20, min_periods=1).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 5 Billion TWD\nmarket_cap_filter = market_cap.shift(1) > 5_000_000_000\n# RSI filter: Avoid extreme overbought (>70) or oversold (<30) conditions\nrsi_mid_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Combine all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & rsi_mid_range_filter\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:22:03.163722",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-01T15:22:54.134335",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Use adjusted data\ntrading_value = data.get('price:成交金額')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\nmarket_cap = data.get('etl:market_value')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Ffill to daily frequency, then shift\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Ffill to daily frequency, then shift\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Value (Inverse of P/E ratio)\n# Ffill to daily frequency, then shift\nvalue_pe = (1 / pe_ratio).ffill().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_roe_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_revenue_rank = growth_revenue.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_pe_rank = value_pe.rank(axis=1, pct=True)\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_roe_rank * 0.20 +\n                   growth_revenue_rank * 0.20 +\n                   institutional_flow_rank * 0.15 +\n                   value_pe_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 50M TWD over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 10 Billion TWD\nmarket_cap_filter = market_cap.shift(1) > 10_000_000_000\n# P/E Ratio filter: P/E between 5 and 30 (avoid extremely cheap/expensive or negative P/E)\npe_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 30)\n# Combine all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & pe_filter\n# Apply filters to the combined factor\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Use adjusted data\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Use adjusted data\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:22:29.887173",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-01T15:23:18.225045",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Use adjusted data\ntrading_value = data.get('price:成交金額')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\nmarket_cap = data.get('etl:market_value')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (ROE and Monthly Revenue YoY)\nroe_smoothed = roe.rolling(4).mean().ffill().shift(1)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth, giving more weight to ROE for stability\nquality_growth = roe_smoothed * 0.6 + revenue_growth * 0.4\n# Factor 3: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Value (Inverse of P/E Ratio)\nvalue_factor = (1 / pe_ratio).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_growth_rank * 0.30 +\n                   flow_rank * 0.25 +\n                   value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 5 and 30 (avoid extremely high/low/negative P/E)\npe_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 30)\n# Market Cap filter: Market capitalization > 10 Billion TWD\nmarket_cap_filter = market_cap.shift(1) > 10_000_000_000\n# Apply all filters\nall_filters = liquidity_filter & price_filter & pe_filter & market_cap_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks (top 10 stocks)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Use adjusted data\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Use adjusted data\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:22:55.167013",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-01T15:23:35.771163",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill then take rolling mean\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI (as a short-term momentum/strength indicator)\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_rank = quality_roe.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI range filter: Avoid extreme overbought/oversold conditions\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:23:19.258391",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-01T15:23:54.535215",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market Capitalization\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign Buying Strength\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY\nrsi = data.indicator('RSI') # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Foreign Buying Strength (5-day average)\n# Higher strength indicates stronger foreign buying conviction\nforeign_flow = foreign_strength.rolling(5).mean().shift(1)\n# Factor 3: Quality/Profitability (4-quarter smoothed ROE)\n# Forward-fill monthly/quarterly data to daily frequency\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 4: Revenue Growth (Monthly Revenue YoY)\n# Forward-fill monthly data to daily frequency\ngrowth = revenue_yoy.ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\n# Combine with intelligent weights (summing to 1.0)\n# Emphasize momentum and quality, with good support from foreign flow and growth\ncombined_factor = (momentum_rank * 0.35 +\n                   foreign_flow_rank * 0.25 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 50M TWD over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 10 Billion TWD (focus on mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined and filtered factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:23:36.804877",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-01T15:24:12.604141",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical momentum\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then smooth\nquality = roe.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Revenue YoY is monthly, so ffill to daily\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (10-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# Factor 5: RSI Momentum (direct RSI value)\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 5 Billion TWD (to focus on mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks (top 10 stocks based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:23:55.574388",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 10,
      "timestamp": "2025-11-01T15:24:41.748994",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill for quarterly data, then calculate rolling mean, then shift\nroe_smoothed = roe.ffill().rolling(4).mean()\nquality = roe_smoothed.shift(1)\n# Factor 3: Growth (Monthly Revenue YoY aligned to daily)\n# ffill for monthly data, then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (Foreign Net Buy 20-day sum)\n# Calculate rolling sum, then shift\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD\nprice_filter = close.shift(1) > 15\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:24:13.642923",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 11,
      "timestamp": "2025-11-01T15:25:00.260365",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing, forward-filled)\n# ROE is quarterly, so ffill to daily frequency\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Institutional Flow (5-day average of foreign buying strength)\ninstitutional_flow = foreign_strength.rolling(5).mean().shift(1)\n# Factor 4: Value (Inverse of P/E ratio, lower P/E is better)\n# Cap P/E to avoid extreme values, then invert.\n# A high P/E indicates overvaluation, so we want low P/E.\n# Let's cap P/E at 50 and floor at 5 to avoid division by zero or extreme values.\npe_ratio_capped = pe_ratio.clip(lower=5, upper=50)\nvalue_factor = (1 / pe_ratio_capped).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True) # Higher inverse P/E is better, so rank directly\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   flow_rank * 0.25 +\n                   value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:24:42.812066",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 12,
      "timestamp": "2025-11-01T15:25:13.408411",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE - 4-quarter average, forward-filled)\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (Monthly YoY, forward-filled)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Foreign Investor Flow (20-day sum)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000  # Average daily trading value > 50M TWD\nprice_filter = close.shift(1) > 20  # Stock price > 20 TWD\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70) # RSI not in extreme overbought/oversold regions\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\nposition = filtered_factor.is_largest(10) # Select top 10 stocks\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:25:01.302129",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 13,
      "timestamp": "2025-11-01T15:25:33.650747",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market Cap for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor flow\npe_ratio = data.get('price_earning_ratio:本益比') # P/E Ratio for value\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Use .ffill() to align quarterly data to daily frequency\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Use .ffill() to align monthly data to daily frequency\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Value (Inverse of P/E Ratio)\n# Use .ffill() to align quarterly data to daily frequency, handle division by zero/negative P/E\nvalue_pe = (1 / pe_ratio).replace([float('inf'), -float('inf')], 0).ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_roe_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_revenue_rank = growth_revenue.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_pe_rank = value_pe.rank(axis=1, pct=True)\n# Combine with meaningful weights. Sum of weights should be 1.0.\ncombined_factor = (momentum_rank * 0.25 +\n                   quality_roe_rank * 0.20 +\n                   growth_revenue_rank * 0.20 +\n                   institutional_flow_rank * 0.20 +\n                   value_pe_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 5 Billion TWD for mid-large caps\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select top N stocks (e.g., top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:25:14.448889",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 14,
      "timestamp": "2025-11-01T15:25:50.807289",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() to align quarterly data to daily, then shift(1)\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# ffill() to align monthly data to daily, then shift(1)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:25:34.697727",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 15,
      "timestamp": "2025-11-01T15:26:11.075052",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, forward-filled)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Valuation filter: P/E ratio between 5 and 25 (forward-fill quarterly P/E)\npe_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 25)\n# Quality filter: Positive ROE (4-quarter rolling mean)\npositive_roe_filter = quality > 0\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter & positive_roe_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:25:51.850629",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 16,
      "timestamp": "2025-11-01T15:26:30.826492",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily frequency before shifting\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, aligned to daily)\n# Monthly revenue, so ffill to daily frequency before shifting\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:26:12.119229",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 17,
      "timestamp": "2025-11-01T15:26:55.534956",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy for institutional flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, aligned to daily)\n# Monthly revenue data, so ffill to daily\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD to focus on mid-large caps\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: RSI between 35 and 65 to avoid extreme overbought/oversold conditions\nrsi_filter = (rsi.shift(1) > 35) & (rsi.shift(1) < 65)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:26:31.869387",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 18,
      "timestamp": "2025-11-01T15:27:15.397300",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then smooth\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI (Relative Strength Index)\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_rank = quality_roe.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: RSI between 30 and 80 (avoiding extreme overbought/oversold)\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 80)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:26:56.603036",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 19,
      "timestamp": "2025-11-01T15:27:33.014883",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily, then take 4-period rolling mean\nquality = roe.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10 stocks)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:27:16.449334",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 20,
      "timestamp": "2025-11-01T15:27:51.557691",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily frequency before shifting\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Monthly revenue, so ffill to daily frequency before shifting\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI Reversal (Inverse of RSI, lower RSI means higher score)\n# A higher value indicates a more oversold condition, potential for reversal\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI health filter: Avoid stocks in extreme overbought/oversold conditions (30 < RSI < 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:27:34.059292",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 21,
      "timestamp": "2025-11-01T15:28:12.480172",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\nrsi = data.indicator('RSI') # Technical indicator for momentum/reversal filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Revenue YoY is monthly, so ffill to daily\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 75M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Adjusted close price > 20 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (focus on mid-large cap)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: RSI between 30 and 70 (avoid extreme overbought/oversold conditions)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 12 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:27:52.641963",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 22,
      "timestamp": "2025-11-01T15:28:27.532635",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Mid-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE smoothed over 4 quarters)\n# Use .ffill() for quarterly data, then .rolling() for smoothing\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (Monthly YoY aligned to daily)\n# Use .ffill() for monthly data\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Foreign Institutional Flow (20-day sum)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with intelligent weights (sum to 1.0)\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:28:13.538291",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 23,
      "timestamp": "2025-11-01T15:28:57.831229",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily, then shift to avoid look-ahead\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, aligned to daily)\n# Monthly revenue, so ffill to daily, then shift to avoid look-ahead\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day cumulative foreign buying)\n# Daily institutional data, so rolling sum then shift\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Value (Inverse of P/E Ratio)\n# P/E is typically daily/weekly, ffill to ensure no NaNs, then shift\nvalue_pe = (1 / pe_ratio).ffill().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_roe_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_revenue_rank = growth_revenue.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_pe_rank = value_pe.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_roe_rank * 0.20 +\n                   growth_revenue_rank * 0.20 +\n                   institutional_flow_rank * 0.15 +\n                   value_pe_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 5 and 30 (avoiding extreme value/growth traps)\n# Ensure P/E is ffilled and shifted for the filter\npe_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 30)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter]\n# 5. Select stocks\n# Select top 12 stocks based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:28:28.590488",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 24,
      "timestamp": "2025-11-01T15:29:19.943432",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy\nrsi = data.indicator('RSI') # Relative Strength Index for technical signal\n# 2. Calculate factors\n# Factor 1: Medium-Term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() to align quarterly data to daily, then shift(1)\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# ffill() to align monthly data to daily, then shift(1)\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Conviction (20-day sum of Foreign Net Buy)\n# rolling sum for institutional flow, then shift(1)\nforeign_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Short-term Reversal (RSI - lower RSI is better for reversal)\n# Shift(1) for RSI\nrsi_reversal = rsi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow.rank(axis=1, pct=True)\n# For RSI reversal, lower RSI values should get higher ranks, so we use (1 - rank)\nrsi_reversal_rank = (1 - rsi_reversal.rank(axis=1, pct=True))\n# Combine with intelligent weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   growth_rank * 0.20 +\n                   foreign_flow_rank * 0.20 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 5 Billion TWD for mid-large cap stocks\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# RSI range filter: Avoid extreme overbought/oversold for general selection (separate from reversal factor)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select top N stocks (typically 8-15)\n# Select top 10 stocks based on the filtered combined factor\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:28:58.887981",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 25,
      "timestamp": "2025-11-01T15:29:35.998074",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market Cap for size filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor\nrevenue_mom = data.get('monthly_revenue:上月比較增減(%)') # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE smoothed over 4 quarters, forward-filled to daily)\n# Ensure ROE is forward-filled before shifting to align quarterly data to daily\nquality = roe.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 3: Revenue Momentum (Monthly Revenue MoM, forward-filled to daily)\nrevenue_growth = revenue_mom.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI Reversal (Inverse RSI for oversold conditions, lower RSI is better)\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:29:21.005893",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 26,
      "timestamp": "2025-11-01T15:30:02.396481",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Higher momentum is better\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth\n# ROE needs ffill for quarterly data, then 4-quarter rolling average for smoothing\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Revenue YoY needs ffill for monthly data\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Combine quality and growth. Simple average for now.\nquality_growth = (quality_roe + growth_revenue) / 2\n# Factor 3: Institutional Flow (20-day sum of Foreign Net Buy)\n# Higher net buy volume from foreign investors is better\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI Reversal (Inverse of RSI to favor oversold conditions)\n# RSI is 0-100. (100 - RSI) makes lower RSI values (oversold) result in higher factor values.\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks (0 to 1) across all stocks for each day\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine factors with meaningful weights. Total weights should sum to 1.0.\n# Momentum is often a strong driver. Quality/Growth provides fundamental strength.\n# Institutional flow indicates smart money interest. RSI reversal adds a mean-reversion component.\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_growth_rank * 0.25 +\n                   flow_rank * 0.20 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price must be > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:29:38.470073",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 27,
      "timestamp": "2025-11-01T15:30:21.079608",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Medium-Term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then shift\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Monthly revenue, so ffill to daily and then shift\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Pressure (20-day sum of foreign net buy)\n# Sum foreign net buy over 20 days to capture sustained interest\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_rank = growth_revenue.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights. Sum of weights should be 1.0.\n# Prioritize momentum and quality, with solid contributions from growth and institutional flow.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extremely overbought stocks (RSI < 80)\nrsi_filter = rsi.shift(1) < 80\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing, no upload, and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:30:03.462109",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 28,
      "timestamp": "2025-11-01T15:30:40.942998",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then shift\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, aligned to daily)\n# Revenue YoY is monthly, so ffill to daily and then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (10-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with intelligent weights\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extremely overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 31, in <module>\n    close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\nAttributeError: 'Data' object has no attribute 'get'\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-01T23:30:22.146825",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 0,
      "timestamp": "2025-11-01T16:01:43.490592",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Fundamental quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Fundamental growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\nrsi = data.indicator('RSI')  # Technical indicator\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\n# Higher momentum is better.\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly data, so ffill to daily frequency then shift. Higher ROE is better.\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly revenue data, so ffill to daily frequency then shift. Higher growth is better.\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (10-day sum of Foreign Net Buy)\n# Positive net buy indicates institutional interest. Higher flow is better.\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# Factor 5: Inverse RSI (Mean Reversion / Oversold)\n# Lower RSI suggests oversold conditions, potentially good for mean reversion.\n# We use (100 - RSI) so that higher values indicate more oversold conditions (better for buying).\ninverse_rsi = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] across all stocks for each day.\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_rank = growth_revenue.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\ninverse_rsi_rank = inverse_rsi.rank(axis=1, pct=True)\n# Combine factors with weighted average. Weights sum to 1.0.\n# Emphasize momentum and quality, with contributions from growth, institutional flow, and mean reversion.\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   inverse_rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be > 50M TWD.\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price must be > 20 TWD to avoid penny stocks.\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value must be > 10 Billion TWD to focus on mid-large caps.\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# Combine all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter\n# Apply filters to the combined factor\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks\n# Select the top 10 stocks with the highest combined factor score after filtering.\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing, no upload, and an 8% stop loss.\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 88, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 88, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:01:15.343868",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-01T16:01:15.369816",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-01T16:02:01.725862",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # For market cap filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow factor\nrsi = data.indicator('RSI') # Technical indicator for filtering\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Using .shift(1) to avoid look-ahead bias\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# .ffill() to align quarterly data to daily, then .shift(1)\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# .ffill() to align monthly data to daily, then .shift(1)\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\n# Using .shift(1) to avoid look-ahead bias\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with intelligent weights\n# Higher weight for momentum and quality, balanced with growth and institutional flow\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (focus on mid to large caps)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: RSI between 30 and 70 (avoid extreme overbought/oversold, focus on trending)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:01:44.634731",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-01T16:02:19.672001",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() for monthly/quarterly data, then rolling average, then shift(1)\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (Monthly YoY aligned to daily)\n# ffill() for monthly data, then shift(1)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Foreign Investor Flow (20-day sum)\n# Summing institutional buying over 20 days, then shift(1)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 82, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 82, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:02:02.791863",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-01T16:02:42.537749",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() to convert quarterly data to daily, then shift(1)\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# ffill() to convert monthly data to daily, then shift(1)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (10-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with intelligent weights\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:02:20.741988",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-01T16:03:15.172275",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE - 4-quarter average)\n# ffill for quarterly data, then shift to avoid look-ahead bias\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# ffill for monthly data, then shift to avoid look-ahead bias\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\n# Shift to avoid look-ahead bias\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Value (Inverse P/E Ratio)\n# ffill for P/E, then shift to avoid look-ahead bias\nvalue = (1 / pe_ratio).ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\n# Weights: Momentum (0.3), Quality (0.2), Growth (0.2), Institutional Flow (0.15), Value (0.15)\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 5 and 30 (avoiding negative/extremely high P/E and very cheap value traps)\npe_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 30)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:02:43.611988",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-01T16:04:08.188101",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quarterly fundamental\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly fundamental\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Daily institutional flow\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily frequency before shifting\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Monthly revenue, so ffill to daily frequency before shifting\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:03:16.233283",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-01T16:04:40.238278",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy for institutional flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical filter\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing, forward-filled)\n# ROE is quarterly data, ffill to daily, then calculate 1-year (approx 4-quarter) rolling mean\nquality = roe.ffill().rolling(window=252, min_periods=1).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks (top 10 stocks based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:04:09.269712",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-01T16:04:59.379210",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily, then apply rolling mean for smoothing\nquality = roe.ffill().rolling(4*20).mean().shift(1) # Approx 4 quarters (assuming ~20 trading days/month)\n# Factor 3: Growth (Monthly Revenue YoY, aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 79, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 79, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:04:41.313983",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-01T16:05:23.836117",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Combine Quality and Growth into a single factor\nroe_smoothed = roe.rolling(4).mean().ffill().shift(1)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Value (Inverse of P/E Ratio)\nvalue_factor = (1 / pe_ratio).ffill().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nroe_rank = roe_smoothed.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine Quality and Growth ranks\nquality_growth_rank = (roe_rank * 0.5 + revenue_growth_rank * 0.5)\n# Combine all factors with meaningful weights\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_growth_rank * 0.30 +\n                   institutional_flow_rank * 0.20 +\n                   value_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average 20-day trading value > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 0 and 30 (avoid negative P/E and extremely high P/E)\npe_filter = (pe_ratio.ffill().shift(1) > 0) & (pe_ratio.ffill().shift(1) < 30)\n# ROE filter: Positive ROE\nroe_filter = roe.ffill().shift(1) > 0\n# Apply all filters\nall_filters = liquidity_filter & price_filter & pe_filter & roe_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks (top 12 stocks)\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:05:00.496926",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-01T16:05:41.908034",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily, then apply rolling mean\nquality = roe.ffill().rolling(4*20).mean().shift(1) # Approx 4 quarters of daily data\n# Factor 3: Growth (Monthly Revenue YoY aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10 stocks based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 79, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 79, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:05:24.904010",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 10,
      "timestamp": "2025-11-01T16:06:05.432016",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後') # Fundamental quality: Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor: Monthly Revenue YoY\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow: Foreign Net Buy\nrsi = data.indicator('RSI') # Technical indicator: Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Higher momentum is generally preferred.\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Use a 4-period rolling mean for ROE to smooth out quarterly fluctuations, then forward-fill.\n# Higher ROE indicates better profitability.\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Forward-fill monthly revenue growth to daily frequency.\n# Higher growth rate is desirable.\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\n# Sum foreign net buying over 20 days to capture sustained institutional interest.\n# Positive net buying indicates institutional accumulation.\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] across all stocks for each day.\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine factors with meaningful weights. Weights sum to 1.0.\n# Emphasize momentum and quality, with strong support from growth and institutional flow.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be greater than 50M TWD.\n# This ensures sufficient tradability and avoids illiquid stocks.\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price must be greater than 20 TWD.\n# This avoids penny stocks which can be highly volatile and risky.\nprice_filter = close.shift(1) > 20\n# RSI filter: Relative Strength Index must be less than 70.\n# This helps to avoid stocks that are extremely overbought, potentially due for a pullback.\nrsi_filter = rsi.shift(1) < 70\n# Apply all filters to the combined factor.\n# Only stocks that pass all filters will be considered for selection.\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on their combined factor score after filtering.\n# is_largest(N) returns a boolean DataFrame indicating the top N stocks for each day.\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Execute the backtest with quarterly rebalancing, no upload, and an 8% stop loss.\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 86, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 86, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:05:42.985230",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 11,
      "timestamp": "2025-11-01T16:06:32.538423",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy for institutional flow\nrsi = data.indicator('RSI') # Relative Strength Index for short-term reversal\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum_factor = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined Fundamental)\n# ROE: 4-quarter average, forward-filled, shifted\nroe_smoothed = roe.ffill().rolling(4).mean().shift(1)\n# Revenue Growth: forward-filled, shifted\nrevenue_growth_ffill = revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth into a single fundamental factor\n# Give more weight to ROE for stability, but include growth\nfundamental_factor = roe_smoothed * 0.6 + revenue_growth_ffill * 0.4\n# Factor 3: Institutional Flow (20-day sum of foreign net buy)\n# Sum foreign net buy over 20 days, shifted\ninstitutional_flow_factor = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Short-term Reversal (RSI)\n# Use RSI as a reversal signal; lower RSI indicates oversold conditions\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum_factor.rank(axis=1, pct=True)\nfundamental_rank = fundamental_factor.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow_factor.rank(axis=1, pct=True)\n# For RSI, lower values are better for reversal, so we rank and then subtract from 1\nrsi_reversal_rank = 1 - rsi_factor.rank(axis=1, pct=True)\n# Combine normalized factors with chosen weights\n# Weights: Momentum (0.30), Fundamental (0.30), Institutional Flow (0.25), RSI Reversal (0.15)\ncombined_factor = (momentum_rank * 0.30 +\n                   fundamental_rank * 0.30 +\n                   institutional_flow_rank * 0.25 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 75M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Close price > 25 TWD\nprice_filter = close.shift(1) > 25\n# Market Cap filter: Market value > 15B TWD (focus on mid-large cap)\nmarket_cap_filter = market_value.shift(1) > 15_000_000_000\n# RSI health filter: Avoid extreme overbought/oversold conditions for general health\nrsi_health_filter = (rsi.shift(1) > 20) & (rsi.shift(1) < 80)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_health_filter]\n# 5. Select stocks\n# Select the top 15 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 88, in <module>\n    momentum_rank = momentum_factor.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 88, in <module>\n    momentum_rank = momentum_factor.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:06:06.527978",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 12,
      "timestamp": "2025-11-01T16:07:26.361457",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nmarket_value = data.get('etl:market_value') # Market Cap for size filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily frequency before shifting\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly revenue, so ffill to daily frequency before shifting\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 5 Billion TWD (5_000_000_000)\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks (top 10 stocks)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:06:33.626927",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 13,
      "timestamp": "2025-11-01T16:07:41.611233",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_cap = data.get('etl:market_value')  # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Foreign investor net buy\nrsi = data.indicator('RSI')  # Relative Strength Index for technical filtering\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD for mid/large caps\nmarket_cap_filter = market_cap.shift(1) > 10_000_000_000\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:07:27.519544",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 14,
      "timestamp": "2025-11-01T16:08:05.015925",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Institutional flow\nmarket_value = data.get('etl:market_value')  # Market capitalization for size filter\nrsi = data.indicator('RSI')  # Technical indicator for filter\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(4*20).mean().shift(1) # Approximate 4 quarters with 4*20 trading days\n# Factor 3: Revenue Growth (Monthly Revenue YoY, forward-filled)\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0.\n# Emphasize momentum and quality, with growth and institutional flow as supporting signals.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.30 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD to focus on mid-to-large caps\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: Avoid extreme overbought (>70) or oversold (<30) conditions\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Combine all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & rsi_filter\n# Apply filters to the combined factor\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:07:44.042021",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 15,
      "timestamp": "2025-11-01T16:08:24.873065",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then smooth\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly data, so ffill to daily\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:08:06.095863",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 16,
      "timestamp": "2025-11-01T16:08:50.795986",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後')  # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\nrsi = data.indicator('RSI') # Technical momentum indicator\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily, then apply rolling mean, then shift\nquality = roe.ffill().rolling(window=4*21, min_periods=4*21).mean().shift(1) # Approx 4 quarters (21 trading days/month * 3 months/quarter)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Conviction (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI Strength (higher RSI indicates stronger momentum)\nrsi_strength = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_strength.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 75M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI range filter: Avoid extreme overbought/oversold conditions\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks (top 10 stocks)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 82, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 82, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:08:25.966952",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 17,
      "timestamp": "2025-11-01T16:09:09.780065",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy\nrsi = data.indicator('RSI') # Relative Strength Index for technical signal\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then smooth\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI Mean Reversion (lower RSI is better, so invert)\nrsi_mean_reversion = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_mean_reversion.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 15 stocks based on the combined factor score\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 83, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 83, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:08:51.875735",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 18,
      "timestamp": "2025-11-01T16:09:34.944453",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value')  # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity for quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY for growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Foreign investor net buy for institutional flow\nrsi = data.indicator('RSI')  # Relative Strength Index for technical filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Fundamental Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(4 * 21).mean().shift(1) # Approx 4 quarters (4*21 trading days per quarter)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market capitalization filter: Market cap > 10B TWD for mid-large caps\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:09:10.875124",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 19,
      "timestamp": "2025-11-01T16:09:58.449109",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Institutional flow\nrsi = data.indicator('RSI')  # Technical indicator for filter\nmarket_value = data.get('etl:market_value') # Market capitalization for filter\n# 2. Calculate factors (apply .shift(1) to ALL factors to prevent look-ahead bias)\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing, then forward-fill and shift)\n# ffill() first to align quarterly data to daily, then rolling, then shift\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily, then shift)\n# ffill() first to align monthly data to daily, then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying, then shift)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] for each day\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.20)\n# 4. Apply filters (MANDATORY: liquidity and price filters)\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Market Cap filter: Select medium to large cap stocks (> 10 Billion TWD)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter & market_cap_filter]\n# 5. Select top N stocks (typically 8-15)\n# Select top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 82, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 82, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:09:36.029578",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 20,
      "timestamp": "2025-11-01T16:10:27.981663",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_cap = data.get('etl:market_value')  # For market cap filter\nroe = data.get('fundamental_features:ROE稅後')  # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Institutional flow factor\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then take rolling mean\nquality = roe.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, aligned to daily)\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\nflow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = flow.rank(axis=1, pct=True)\n# Combine with meaningful weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 5 Billion TWD for mid-large caps\nmarket_cap_filter = market_cap.shift(1) > 5_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select top N stocks (typically 8-15)\n# Select top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:09:59.549675",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 21,
      "timestamp": "2025-11-01T16:10:59.953849",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # For market cap filter\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign buying strength\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY\nrsi = data.indicator('RSI') # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Medium-Term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Foreign Buying Strength (forward-fill and shift)\n# This factor captures institutional conviction.\nforeign_strength_factor = foreign_strength.ffill().shift(1)\n# Factor 3: Quality (ROE, 4-quarter rolling average, forward-fill and shift)\n# ROE is a key profitability metric, smoothed over 4 quarters to reduce noise.\nquality_factor = roe.rolling(4).mean().ffill().shift(1)\n# Factor 4: Revenue Growth (forward-fill and shift)\n# Monthly revenue year-over-year growth indicates business expansion.\ngrowth_factor = revenue_yoy.ffill().shift(1)\n# Factor 5: RSI Reversal (lower RSI is better for reversal, shift)\n# We aim to identify relatively oversold stocks that might be due for a bounce.\n# (100 - RSI) gives a higher score for lower RSI values.\nrsi_reversal_factor = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] across all stocks for each day.\nmomentum_rank = momentum.rank(axis=1, pct=True)\nforeign_strength_rank = foreign_strength_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\ngrowth_rank = growth_factor.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal_factor.rank(axis=1, pct=True)\n# Combine normalized factors with intelligent weights.\n# Weights reflect the perceived importance and contribution of each factor.\ncombined_factor = (momentum_rank * 0.30 +\n                   foreign_strength_rank * 0.25 +\n                   quality_rank * 0.20 +\n                   growth_rank * 0.15 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be above 75M TWD.\n# This ensures we only trade sufficiently liquid stocks.\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Stock price must be greater than 15 TWD.\n# This helps avoid very low-priced, often speculative, stocks.\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Market capitalization must be greater than 5 Billion TWD.\n# This focuses on mid-to-large cap stocks, reducing exposure to micro-caps.\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters to the combined factor score.\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select the top 12 stocks based on their filtered combined factor scores.\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\n# Execute the backtest with quarterly rebalancing and an 8% stop loss.\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 87, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 87, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:10:29.101229",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 22,
      "timestamp": "2025-11-01T16:11:23.915167",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(4*20).mean().shift(1) # Approx 4 quarters (assuming 20 trading days/month)\n# Factor 3: Growth (Monthly Revenue YoY, forward-filled)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI (Mean Reversion / Momentum confirmation)\n# Using RSI directly as a factor, lower RSI might indicate undervaluation or oversold conditions\n# Higher RSI might indicate strong momentum. We'll let ranking handle the direction.\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with weights. Higher weight for momentum and fundamental quality/growth.\n# RSI is given a moderate weight, assuming it can capture both momentum and potential reversal.\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select stocks (top 10 stocks)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 83, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 83, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:11:01.044385",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 23,
      "timestamp": "2025-11-01T16:11:43.655851",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market Cap for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Higher momentum is better\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Higher ROE is better\nquality = roe.ffill().rolling(4, min_periods=1).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Higher revenue growth is better\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\n# Positive and sustained foreign buying is better\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\n# Weights are chosen to balance different factor types\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 15 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Market value > 5 Billion TWD (focus on mid to large cap)\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# RSI filter: RSI between 30 and 70 (avoiding extreme overbought/oversold conditions)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined and filtered factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:11:24.997328",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 24,
      "timestamp": "2025-11-01T16:12:05.586291",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nmonthly_revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (ROE 4-quarter average + Monthly Revenue YoY)\n# Use .ffill() for quarterly/monthly data to align to daily frequency\nquality_growth = (roe.rolling(4).mean().ffill() + monthly_revenue_yoy.ffill()).shift(1)\n# Factor 3: Institutional Flow (10-day sum of Foreign Buying Strength)\ninstitutional_flow = foreign_strength.rolling(10).sum().shift(1)\n# Factor 4: Value (Inverse P/E Ratio)\n# Handle potential division by zero or negative P/E by setting to NaN or a small value later\ninverse_pe = (1 / pe_ratio).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\ninverse_pe_rank = inverse_pe.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_growth_rank * 0.30 +\n                   flow_rank * 0.25 +\n                   inverse_pe_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 5 and 30 to exclude extreme values and negative earnings\npe_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 30)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter]\n# 5. Select stocks (top 12 stocks based on combined factor score)\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:11:44.744898",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 25,
      "timestamp": "2025-11-01T16:12:30.109046",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Fundamental quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Fundamental growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\npb_ratio = data.get('price_earning_ratio:股價淨值比') # Price-to-Book ratio for value\n# 2. Calculate factors\n# Factor 1: Short-term Price Momentum (20-day returns)\nmomentum = close.pct_change(20).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing, forward-filled)\n# ROE is quarterly, so ffill to daily and then smooth\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Strength (10-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# Factor 5: Value (Inverse Price-to-Book ratio, forward-filled)\n# Lower P/B is better, so use 1/P/B. Handle division by zero or NaN.\nvalue_factor = (1 / pb_ratio.ffill()).replace([float('inf'), -float('inf')], 0).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with meaningful weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   value_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 50M TWD over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD\nprice_filter = close.shift(1) > 15\n# Market capitalization filter: Market cap > 5 Billion TWD\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:12:06.682288",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 26,
      "timestamp": "2025-11-01T16:13:08.867933",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後') # Quarterly fundamental\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly fundamental\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Daily institutional flow\nrsi_raw = data.indicator('RSI') # Daily technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Fundamental Quality & Growth (Smoothed ROE and Monthly Revenue YoY)\n# ROE is quarterly, so ffill() to daily, then shift(1)\nroe_smoothed = roe.rolling(4).mean().ffill().shift(1)\n# Revenue YoY is monthly, so ffill() to daily, then shift(1)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth into one fundamental factor (simple average)\nfundamental_factor = (roe_smoothed + revenue_growth) / 2\n# Factor 3: Institutional Buying Pressure (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI Reversal (Inverse of RSI, higher score for lower RSI indicating oversold)\n# RSI is daily, shift(1)\nrsi_reversal = (100 - rsi_raw).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nfundamental_rank = fundamental_factor.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   fundamental_rank * 0.30 +\n                   flow_rank * 0.25 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI range filter: Avoid extreme overbought/oversold conditions for general health\n# Use the raw RSI shifted by 1 for this filter\nrsi_filter = (rsi_raw.shift(1) > 20) & (rsi_raw.shift(1) < 80)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 12 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:12:31.208585",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 27,
      "timestamp": "2025-11-01T16:13:39.367463",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign Investor Net Buy\nrsi = data.indicator('RSI') # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Fundamental Quality (4-quarter smoothed ROE)\n# Fill monthly/quarterly data to daily frequency and shift\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Fill monthly data to daily frequency and shift\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Pressure (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI for momentum confirmation (higher RSI indicates stronger momentum)\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks (0 to 1)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_roe_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_revenue_rank = growth_revenue.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True) # Higher RSI is better for momentum\n# Combine with weights summing to 1.0\n# Weights: Momentum (0.3), Quality (0.2), Growth (0.2), Institutional Flow (0.2), RSI (0.1)\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_roe_rank * 0.20 +\n                   growth_revenue_rank * 0.20 +\n                   institutional_flow_rank * 0.20 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI range filter: Avoid extreme overbought/oversold conditions for more stable momentum\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 83, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 83, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:13:10.102712",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 28,
      "timestamp": "2025-11-01T16:13:58.402082",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Use adjusted data\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\nmarket_cap = data.get('etl:market_value')\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (4-quarter average ROE)\n# Use .ffill() for quarterly data, then .shift(1)\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Use .ffill() for monthly data, then .shift(1)\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI (as a short-term momentum/overbought-oversold indicator)\n# Higher RSI values indicate stronger momentum or overbought conditions\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_rank = growth_revenue.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with intelligent weights\n# Momentum (0.3), Quality (0.25), Growth (0.2), Institutional Flow (0.2), RSI (0.05)\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   rsi_rank * 0.05)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 5 Billion TWD\nmarket_cap_filter = market_cap.shift(1) > 5_000_000_000\n# RSI range filter: Avoid extreme overbought/oversold conditions\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_range_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:13:40.501461",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 29,
      "timestamp": "2025-11-01T16:14:26.312473",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後')  # Quarterly fundamental data\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly fundamental data\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\npe_ratio = data.get('price_earning_ratio:本益比') # Valuation data\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily frequency before shifting\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (Monthly Revenue YoY)\n# Monthly revenue, so ffill to daily frequency before shifting\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Value (Inverse of P/E Ratio)\n# Lower P/E is better, so use 1/PE. Shift to avoid look-ahead.\nvalue_factor = (1 / pe_ratio).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   value_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 5 Billion TWD to focus on mid-large caps\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select top N stocks (typically 8-15)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:14:00.245246",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 0,
      "timestamp": "2025-11-01T16:27:11.767922",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Foreign investor net buy\npb_ratio = data.get('price_earning_ratio:股價淨值比')  # Price-to-Book Ratio\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily frequency, then smooth, then shift\nquality = roe.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Revenue YoY is monthly, so ffill to daily frequency, then shift\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (10-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(window=10, min_periods=1).sum().shift(1)\n# Factor 5: Value (Inverse Price-to-Book Ratio)\n# P/B is quarterly, so ffill to daily frequency, then inverse, then shift\n# Add a small epsilon to avoid division by zero if PB is 0\nvalue = (1 / (pb_ratio.ffill() + 1e-6)).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks (0 to 1)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value.rank(axis=1, pct=True)\n# Combine with weighted average (weights sum to 1.0)\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   value_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(window=20, min_periods=1).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:26:48.297508",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-01T16:26:48.322148",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-01T16:27:29.939471",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator for filtering\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing, forward-filled)\n# Use .ffill() to convert quarterly data to daily frequency\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Foreign Institutional Buying Strength (20-day sum)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extremely overbought (>70) or oversold (<30) conditions\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:27:12.932714",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-01T16:27:53.296642",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity (quarterly)\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Foreign Investor Net Buy\nrsi = data.indicator('RSI')  # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\n# Shift by 1 to avoid look-ahead bias\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Forward-fill quarterly data to daily frequency, then shift by 1\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Forward-fill monthly data to daily frequency, then shift by 1\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Strength (20-day sum of foreign net buy)\n# Calculate rolling sum, then shift by 1\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] for each day\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_rank = growth_revenue.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine factors with meaningful weights.\n# Weights sum to 1.0. Prioritize momentum and quality/growth.\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\n# Shift by 1 to avoid look-ahead bias\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\n# Shift by 1 to avoid look-ahead bias\nprice_filter = close.shift(1) > 20\n# RSI filter: RSI between 30 and 70 to avoid extreme overbought/oversold conditions\n# Shift by 1 to avoid look-ahead bias\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 83, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 83, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:27:31.156191",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-01T16:28:12.958066",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() for quarterly data to daily, then shift\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# ffill() for monthly data to daily, then shift\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Strength (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks: Top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:27:54.516346",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-01T16:28:45.213139",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Smoothed ROE and Monthly Revenue YoY)\n# ROE: 4-quarter rolling average, forward-filled to daily, then shifted\nroe_smoothed = roe.rolling(4).mean().ffill().shift(1)\n# Revenue YoY: forward-filled to daily, then shifted\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth. Handle potential NaNs by taking mean.\nquality_growth = (roe_smoothed + revenue_growth) / 2\n# Factor 3: Institutional Buying Pressure (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Short-term Reversal (RSI-based, favoring lower RSI values)\n# Scores higher for RSI below 50, clipped at 0 for RSI >= 50\nrsi_reversal = (50 - rsi).clip(lower=0).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_growth_rank * 0.30 +\n                   institutional_flow_rank * 0.25 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI range filter: Avoid extreme overbought/oversold conditions\nrsi_range_filter = (rsi.shift(1) > 25) & (rsi.shift(1) < 75)\n# Combine all filters\nall_filters = liquidity_filter & price_filter & rsi_range_filter\n# Apply filters to the combined factor\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks (top 15 based on combined factor score)\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:28:14.162904",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-01T16:29:04.960532",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Institutional flow\nrsi = data.indicator('RSI') # Technical indicator for filtering\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() to align quarterly data to daily, then rolling mean for smoothing\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# ffill() to align monthly data to daily\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0.\n# Prioritize momentum and quality, then growth and institutional flow.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.30 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought (>70) or oversold (<30) conditions\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing, no upload, and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:28:46.389887",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-01T16:29:29.459976",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (ROE and Monthly Revenue YoY)\n# ROE: Use 4-quarter rolling average, then ffill to daily\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Revenue Growth: ffill to daily\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Combine quality and growth with a simple average\nquality_growth_factor = (quality_roe + growth_revenue) / 2\n# Factor 3: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Short-term Sentiment/Momentum (RSI)\n# RSI is already a daily indicator, just shift to avoid look-ahead bias\nsentiment_rsi = rsi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth_factor.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nsentiment_rank = sentiment_rsi.rank(axis=1, pct=True) # Higher RSI implies stronger short-term momentum\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_growth_rank * 0.30 +\n                   flow_rank * 0.25 +\n                   sentiment_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:29:07.447812",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-01T16:29:55.329967",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_cap = data.get('etl:market_value') # For market cap filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Mid-term Price Momentum (60-day returns)\n# Higher momentum is better\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (ROE and Monthly Revenue YoY)\n# ROE needs ffill for daily alignment, then 4-quarter rolling mean for smoothing\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Revenue YoY needs ffill for daily alignment\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Combine quality and growth metrics\nquality_growth = (quality_roe + growth_revenue) / 2\n# Factor 3: Institutional Buying Strength (Foreign Investor Net Buy)\n# Sum foreign net buy over 20 days to capture sustained interest\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI Reversal/Non-Overbought (Inverse of RSI)\n# We want to favor stocks that are not extremely overbought.\n# A lower RSI (e.g., 30-50) can indicate potential for upward movement or less risk of immediate pullback.\n# Using (70 - RSI) as a factor means higher values are preferred (RSI is lower, less overbought).\nrsi_non_overbought = (70 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_non_overbought_rank = rsi_non_overbought.rank(axis=1, pct=True)\n# Combine with weights. Total weights sum to 1.0.\n# Momentum is often a strong driver, balanced by quality/growth for stability,\n# institutional flow for conviction, and RSI to avoid highly extended stocks.\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_growth_rank * 0.25 +\n                   institutional_flow_rank * 0.20 +\n                   rsi_non_overbought_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 50M TWD over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD to focus on mid-large caps\nmarket_cap_filter = market_cap.shift(1) > 10_000_000_000\n# RSI range filter: RSI between 30 and 70 to avoid extreme overbought/oversold conditions\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_range_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 89, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 89, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:29:30.679063",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-01T16:30:17.285781",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quarterly fundamental data\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly fundamental data\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Daily institutional flow\nrsi = data.indicator('RSI') # Daily technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day adjusted close return)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (4-quarter average ROE)\n# ROE is quarterly, so ffill to daily frequency, then calculate rolling mean\nquality = roe.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Revenue YoY is monthly, so ffill to daily frequency\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Conviction (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD (avoiding penny stocks)\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:29:56.552093",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-01T16:30:35.658642",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\nmarket_value = data.get('etl:market_value')\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(4, min_periods=1).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Revenue YoY is monthly, so ffill to daily\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.30 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average 20-day trading value > 75M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Adjusted close price > 20 TWD (avoiding penny stocks)\nprice_filter = close.shift(1) > 20\n# Valuation filter: P/E Ratio < 25 (avoiding extremely overvalued stocks, ffill for quarterly data)\npe_filter = pe_ratio.ffill().shift(1) < 25\n# Market Cap filter: Market value > 10 Billion TWD (focus on mid-large cap)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 15 stocks based on the combined factor score\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:30:18.461296",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 10,
      "timestamp": "2025-11-01T16:31:02.566552",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily frequency before shifting\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Monthly revenue, so ffill to daily frequency before shifting\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Value (Inverse P/E Ratio)\n# P/E is typically quarterly/annual, so ffill to daily frequency before shifting\n# Add a small epsilon to avoid division by zero for P/E = 0\nvalue_factor = (1 / (pe_ratio.ffill() + 1e-6)).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: Avoid extremely high P/E (overvalued) or negative P/E (loss-making)\n# P/E is quarterly/annual, so ffill before shifting\npe_filter = (pe_ratio.ffill().shift(1) > 0) & (pe_ratio.ffill().shift(1) < 30)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:30:36.884439",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 0,
      "timestamp": "2025-11-01T16:32:00.443463",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Use .ffill() to align quarterly data to daily frequency\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Use .ffill() to align monthly data to daily frequency\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_roe_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_revenue_rank = growth_revenue.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_roe_rank * 0.20 +\n                   growth_revenue_rank * 0.20 +\n                   institutional_flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days > 75M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Adjusted close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 40 and 80)\nrsi_filter = (rsi.shift(1) > 40) & (rsi.shift(1) < 80)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 12 stocks based on combined factor score)\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:31:34.335760",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-01T16:31:34.352059",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-01T16:32:27.528238",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\nmarket_cap = data.get('etl:market_value') # For market capitalization filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined ROE and Monthly Revenue YoY)\n# Smooth ROE over 4 quarters and forward-fill\nroe_smoothed = roe.rolling(4).mean().ffill()\n# Forward-fill monthly revenue YoY\nrevenue_growth = revenue_yoy.ffill()\n# Combine ROE and Revenue Growth, then shift\nquality_growth = (roe_smoothed + revenue_growth).shift(1)\n# Factor 3: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI Reversal (Lower RSI indicates oversold, higher score)\n# We want to favor stocks that are relatively oversold but not extremely so.\n# (100 - RSI) gives a higher score for lower RSI values.\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_growth_rank * 0.30 +\n                   flow_rank * 0.20 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market capitalization filter: Market cap > 5 Billion TWD\nmarket_cap_filter = market_cap.shift(1) > 5_000_000_000\n# RSI filter: RSI between 30 and 70 (avoid extreme overbought/oversold for general health)\nrsi_health_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & rsi_health_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 86, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 86, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:32:01.749192",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-01T16:32:49.945177",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor flow\npe_ratio = data.get('price_earning_ratio:本益比') # P/E Ratio for valuation\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE, 4-quarter average)\n# Use ffill to align quarterly data to daily, then shift\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Use ffill to align monthly data to daily, then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Value (Inverse of P/E ratio)\n# Add a small epsilon to avoid division by zero if P/E is 0\nvalue = (1 / (pe_ratio + 1e-6)).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   value_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average 20-day trading value > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 5 Billion TWD (focus on mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# P/E Ratio filter: P/E Ratio < 25 (avoid extremely overvalued stocks, but allow for growth)\npe_filter = pe_ratio.shift(1) < 25\n# Basic profitability filter: ROE > 0 (ensure positive return on equity)\nroe_positive_filter = roe.ffill().shift(1) > 0\n# Apply all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & pe_filter & roe_positive_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:32:28.755585",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-01T16:33:13.435894",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nroe = data.get('fundamental_features:ROE稅後')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily frequency before rolling mean\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Institutional Flow (20-day sum of foreign net buy)\nforeign_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 5: RSI Reversal (Inverse RSI to favor oversold conditions)\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_roe_rank = quality_roe.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_roe_rank * 0.25 +\n                   foreign_flow_rank * 0.20 +\n                   revenue_growth_rank * 0.15 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Close price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter]\n# 5. Select stocks (top 12 based on combined factor score)\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:32:51.171067",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-01T16:33:29.700202",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Institutional flow\nrsi = data.indicator('RSI')  # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined ROE and Revenue YoY)\n# ROE: 4-quarter rolling mean, then forward-fill to daily\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Revenue YoY: forward-fill to daily\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Combine quality and growth (simple average)\nquality_growth = (quality_roe + growth_revenue) / 2\n# Factor 3: Institutional Buying Strength (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI Reversal (Inverse of RSI, lower RSI implies more oversold)\n# We want to buy stocks that are not extremely overbought, so a lower RSI is better for this factor.\n# Normalizing 100-RSI means higher values are better (more oversold/less overbought)\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_growth_rank * 0.30 +\n                   institutional_flow_rank * 0.25 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI range filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:33:14.646745",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-01T16:33:47.901674",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Institutional flow\nrsi = data.indicator('RSI')  # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Forward-fill monthly/quarterly data to daily frequency, then apply rolling mean\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (Monthly Revenue YoY, forward-filled)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow_20d = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI (as a momentum confirmation, higher RSI is better for momentum)\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_rank = quality_roe.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow_20d.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15 +\n                   rsi_rank * 0.05)\n# 4. Apply filters\n# Liquidity filter: 20-day average trading value > 75M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Adjusted close price > 20 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extremely overbought/oversold conditions (RSI between 30 and 70)\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select stocks (top 15 stocks based on combined factor score)\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum_60d.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:33:30.947017",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-01T16:34:11.714281",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly revenue growth\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Revenue Growth (monthly data aligned to daily, forward-filled)\n# Use .ffill() for monthly data to align with daily frequency\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 3: Quality (ROE with 4-quarter smoothing, forward-filled)\n# ROE is quarterly, so ffill then apply rolling mean for smoothing\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] for each day\nmomentum_rank = momentum.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine factors with meaningful weights\n# Weights sum to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   revenue_rank * 0.25 +\n                   quality_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 25 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 25\n# Market capitalization filter: Market cap > 15 Billion TWD for mid-large caps\nmarket_cap_filter = market_value.shift(1) > 15_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select top N stocks (typically 8-15)\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:33:49.876766",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-01T16:34:36.266512",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quarterly fundamental data\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly fundamental data\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Daily institutional flow\nrsi = data.indicator('RSI') # Daily technical indicator\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined ROE and Monthly Revenue YoY)\n# ROE: Forward-fill quarterly data, then 4-quarter rolling mean, then shift\nroe_smoothed = roe.ffill().rolling(4).mean().shift(1)\n# Revenue Growth: Forward-fill monthly data, then shift\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth for a fundamental factor\nfundamental_factor = (roe_smoothed * 0.6 + revenue_growth * 0.4)\n# Factor 3: Institutional Buying Strength (20-day sum of Foreign Net Buy)\n# Sum foreign net buy over 20 days, then shift\nforeign_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI (as a sentiment/momentum confirmation)\n# Use RSI directly, then shift\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nfundamental_rank = fundamental_factor.rank(axis=1, pct=True)\nflow_rank = foreign_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.35 +\n                   fundamental_rank * 0.30 +\n                   flow_rank * 0.25 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_val_for_filter = rsi.shift(1)\nrsi_range_filter = (rsi_val_for_filter > 30) & (rsi_val_for_filter < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 85, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:34:12.971191",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-01T16:34:52.345374",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then smooth\nquality = roe.ffill().rolling(4*20).mean().shift(1) # Approx 4 quarters, assuming ~20 trading days per month\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Pressure (10-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10 stocks)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 79, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 79, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:34:37.524757",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-01T16:35:13.924748",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (20-day returns)\nmomentum = close.pct_change(20).shift(1)\n# Factor 2: Quality (ROE smoothed over 4 quarters)\n# ffill() for quarterly data, then shift(1)\nquality = roe.rolling(4, min_periods=1).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# ffill() for monthly data, then shift(1)\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (5-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(5).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   institutional_flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 15 TWD\nprice_filter = close.shift(1) > 15\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 12 based on combined factor score)\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 80, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:34:53.648420",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 10,
      "timestamp": "2025-11-01T16:35:33.407620",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Use .ffill() to align quarterly data to daily frequency\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Use .ffill() to align monthly data to daily frequency\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI (as a momentum confirmation, higher is better but not overbought)\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.10 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions, focus on trending stocks\nrsi_range_filter = (rsi.shift(1) > 40) & (rsi.shift(1) < 80)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 82, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 82, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:35:15.178556",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 11,
      "timestamp": "2025-11-01T16:36:00.283041",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity (quarterly)\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign Investor Net Buy (daily)\nrsi = data.indicator('RSI') # Relative Strength Index (daily)\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\n# Calculate 60-day percentage change and shift by 1 day to avoid look-ahead bias\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly data, so forward-fill to daily frequency, then calculate 4-quarter rolling average, then shift\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Monthly Revenue YoY is monthly data, so forward-fill to daily frequency, then shift\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (10-day sum of foreign net buy)\n# Foreign net buy is daily data, so calculate 10-day rolling sum, then shift\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] across all stocks for each day\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine normalized factors with meaningful weights (summing to 1.0)\n# Weights: Momentum (0.30), Quality (0.25), Revenue Growth (0.25), Institutional Flow (0.20)\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be greater than 50M TWD\n# Shift by 1 day to avoid look-ahead bias\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price must be greater than 20 TWD to avoid penny stocks\n# Shift by 1 day to avoid look-ahead bias\nprice_filter = close.shift(1) > 20\n# RSI filter: RSI between 40 and 70 to select stocks with healthy momentum, avoiding extreme overbought/oversold conditions\n# Shift by 1 day to avoid look-ahead bias\nrsi_filter = (rsi.shift(1) > 40) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\n# Stocks must pass all filters to be considered for selection\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select top N stocks\n# Select the top 10 stocks with the highest combined factor score on each rebalancing date\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Execute the backtest with quarterly rebalancing, no upload, and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 83, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 83, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:35:34.680309",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 12,
      "timestamp": "2025-11-01T16:36:17.175656",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then smooth\nquality = roe.ffill().rolling(4*21).mean().shift(1) # Approx 4 quarters of daily data\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 79, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 79, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:36:01.549463",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 13,
      "timestamp": "2025-11-01T16:36:45.512583",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Use adjusted data\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nroe = data.get('fundamental_features:ROE稅後')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth Score\n# ROE (4-quarter rolling average, forward-filled)\nroe_4q_avg = roe.rolling(4).mean().ffill().shift(1)\n# Monthly Revenue YoY (forward-filled)\nrevenue_yoy_ffill = revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth\nfund_score = roe_4q_avg * 0.6 + revenue_yoy_ffill * 0.4\n# Factor 3: Institutional Flow (20-day sum of foreign net buy)\nforeign_flow_20d_sum = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Short-term Reversal (Inverse of RSI, favoring oversold)\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nfund_score_rank = fund_score.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow_20d_sum.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\ncombined_factor = (momentum_rank * 0.30 +\n                   fund_score_rank * 0.30 +\n                   foreign_flow_rank * 0.25 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 10B TWD (mid-large cap)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 84, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:36:18.444064",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 14,
      "timestamp": "2025-11-01T16:37:07.097377",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly revenue growth\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy\nrsi = data.indicator('RSI') # Relative Strength Index for technical filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Revenue Growth (monthly data aligned to daily, forward-filled)\n# Use .ffill() to propagate monthly data to daily frequency\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 3: Quality (ROE with 4-quarter smoothing, forward-filled)\n# Use .ffill() to propagate quarterly data to daily frequency\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] for each day\nmomentum_rank = momentum.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   revenue_rank * 0.25 +\n                   quality_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10B TWD for mid-large caps\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: RSI between 30 and 70 to avoid extreme overbought/oversold conditions\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 12 stocks based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 82, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 82, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:36:46.786426",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 15,
      "timestamp": "2025-11-01T16:37:23.287836",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill and then shift\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly revenue, so ffill and then shift\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD\nprice_filter = close.shift(1) > 15\n# Valuation filter: P/E Ratio < 25 (avoiding extremely overvalued stocks)\npe_filter = pe_ratio.ffill().shift(1) < 25\n# RSI filter: RSI between 30 and 70 (avoiding extreme overbought/oversold)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter & rsi_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 579, in _get_axis_number\n    return cls._AXIS_TO_AXIS_NUMBER[axis]\nKeyError: 1\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 81, in <module>\n    momentum_rank = momentum.rank(axis=1, pct=True)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 10121, in rank\n    axis_int = self._get_axis_number(axis)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 581, in _get_axis_number\n    raise ValueError(f\"No axis named {axis} for object type {cls.__name__}\")\nValueError: No axis named 1 for object type Series\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:37:08.301631",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 0,
      "timestamp": "2025-11-01T16:41:08.305145",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill for quarterly data, then calculate rolling mean, then shift\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# ffill for monthly data, then shift\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Foreign Investor Buying Strength (20-day sum)\n# Calculate rolling sum of net buys, then shift\nforeign_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = foreign_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid stocks in extreme overbought/oversold conditions (30 < RSI < 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing, no upload, and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:40:43.644424",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-01T16:40:43.675596",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-01T16:41:28.703726",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical signal\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined ROE and Monthly Revenue YoY)\n# Forward-fill monthly/quarterly data to daily frequency\nroe_ffill = roe.ffill()\nrevenue_yoy_ffill = revenue_yoy.ffill()\n# Calculate 4-quarter rolling average for ROE and combine with revenue growth\nquality_growth = (roe_ffill.rolling(4).mean() + revenue_yoy_ffill).shift(1)\n# Factor 3: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI Reversal (Favoring oversold conditions)\n# Higher value means more oversold (e.g., RSI 20 -> 80, RSI 80 -> 20)\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_growth_rank * 0.30 +\n                   institutional_flow_rank * 0.25 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (focus on mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:41:09.625966",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-01T16:41:51.833068",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum_factor = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Use .ffill() for quarterly data to align to daily frequency\nquality_factor = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow_factor = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Value (Inverse of P/E Ratio)\n# Use .ffill() for monthly/quarterly data to align to daily frequency\n# Add a small epsilon to avoid division by zero if P/E is exactly 0\nvalue_factor = (1 / (pe_ratio.ffill() + 1e-6)).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\nflow_rank = institutional_flow_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   flow_rank * 0.25 +\n                   value_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 5 and 30 (avoid extremely high/low/negative P/E)\npe_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 30)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter]\n# 5. Select stocks (top 10 stocks based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:41:29.954214",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-01T16:42:11.547176",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then shift\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly revenue, so ffill to daily and then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\nflow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:41:53.072436",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-01T16:42:30.639569",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Quarterly fundamental\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly fundamental\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Daily institutional flow\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then shift\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly revenue, so ffill to daily and then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI Reversal (Inverse of RSI, lower RSI is better)\n# (100 - RSI) means higher value for oversold conditions\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights. Sum of weights should be 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI range filter: Avoid extreme overbought/oversold for general selection\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined and filtered factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:42:12.801122",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-01T16:42:59.473195",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum_factor = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then shift\nquality_factor = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly revenue, so ffill to daily and then shift\ngrowth_factor = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (10-day sum of Foreign Net Buy)\ninstitutional_flow_factor = foreign_net_buy.rolling(10).sum().shift(1)\n# Factor 5: Value (Inverse P/E Ratio)\n# P/E ratio is often monthly/quarterly, so ffill to daily and then shift\nvalue_factor = (1 / pe_ratio).ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nmomentum_rank = momentum_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\ngrowth_rank = growth_factor.rank(axis=1, pct=True)\nflow_rank = institutional_flow_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.25 +\n                   quality_rank * 0.20 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 0 and 30 (avoid negative P/E and extremely high P/E)\npe_filter = (pe_ratio.ffill().shift(1) > 0) & (pe_ratio.ffill().shift(1) < 30)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:42:31.925703",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-01T16:43:29.945435",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Foreign Net Buy\npe_ratio = data.get('price_earning_ratio:本益比')  # Price-to-Earnings Ratio\nmarket_value = data.get('etl:market_value')  # Market Capitalization for size filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum_factor = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined ROE and Monthly Revenue YoY)\n# Smooth ROE over 4 quarters and forward-fill to daily, then shift\nroe_shifted = roe.rolling(4).mean().ffill().shift(1)\n# Forward-fill monthly revenue YoY to daily, then shift\nrevenue_shifted = revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth into one factor by averaging their ranks\n# We will rank this combined factor later\nquality_growth_factor_raw = (roe_shifted + revenue_shifted) / 2\n# Factor 3: Institutional Flow (20-day sum of foreign net buy)\nflow_factor = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Value (Inverse of P/E Ratio)\nvalue_factor = (1 / pe_ratio).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nmomentum_rank = momentum_factor.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth_factor_raw.rank(axis=1, pct=True)\nflow_rank = flow_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_growth_rank * 0.30 +\n                   flow_rank * 0.25 +\n                   value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 5 and 25 (avoid extremely high/low/negative P/E)\npe_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 25)\n# Market Cap filter: Market capitalization > 5 Billion TWD (focus on larger companies)\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Combine all filters\nall_filters = liquidity_filter & price_filter & pe_filter & market_cap_filter\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:43:00.854594",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-01T16:44:06.782378",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor (quarterly)\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor (monthly)\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow (daily)\nrsi = data.indicator('RSI') # Technical indicator (daily)\nmarket_value = data.get('etl:market_value') # Market Cap for filter (daily)\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined ROE and Monthly Revenue YoY)\n# ROE is quarterly, Revenue YoY is monthly. Both need ffill to daily frequency.\n# Normalize revenue_yoy by dividing by 100 to make it comparable to ROE (percentage).\nroe_ffill = roe.ffill()\nrevenue_yoy_ffill = revenue_yoy.ffill()\n# Combine ROE (4-quarter rolling average) and Revenue YoY\nquality_growth = (roe_ffill.rolling(4).mean() + revenue_yoy_ffill / 100).shift(1)\n# Factor 3: Institutional Buying Strength (20-day sum of foreign net buy)\nforeign_flow_20d = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Technical Strength (RSI)\n# Higher RSI indicates stronger momentum.\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow_20d.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_growth_rank * 0.30 +\n                   foreign_flow_rank * 0.25 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: 20-day average trading value > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Market Cap filter: Market value > 5 Billion TWD (focus on mid to large cap)\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:43:31.355733",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-01T16:44:30.757761",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nmonthly_revenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign institutional flow\npe_ratio = data.get('price_earning_ratio:本益比') # P/E Ratio for value\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE smoothed over 4 quarters)\n# Use .ffill() to convert quarterly data to daily frequency\nroe_smoothed = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Use .ffill() to convert monthly data to daily frequency\nrevenue_growth = monthly_revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Value (Inverse P/E Ratio)\n# Handle potential division by zero or negative P/E by setting them to NaN or a very low value\n# For ranking, NaN values will be handled by pandas.\nvalue_factor = (1 / pe_ratio).replace([float('inf'), -float('inf')], pd.NA).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nroe_rank = roe_smoothed.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine Quality and Growth ranks\nquality_growth_rank = (roe_rank * 0.6 + revenue_growth_rank * 0.4)\n# Combine all normalized factors with meaningful weights\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_growth_rank * 0.30 +\n                   institutional_flow_rank * 0.25 +\n                   value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: 20-day average trading value > 50 million TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market capitalization filter: Market cap > 10 billion TWD\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# P/E Ratio filter: P/E between 5 and 30 to avoid extreme values (negative or very high)\npe_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 30)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pe_filter]\n# 5. Select stocks (top 10 stocks)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:44:08.226121",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-01T16:44:48.867753",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Mid-term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() to convert quarterly data to daily, then rolling mean for smoothing\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (Monthly Revenue YoY)\n# ffill() to convert monthly data to daily\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Pressure (10-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# Factor 5: RSI Reversal (Inverse RSI for oversold signal)\n# Lower RSI values are better for reversal, so we invert it.\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_rank = growth_revenue.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0.\n# Emphasize momentum and quality, with supporting growth, institutional flow, and a touch of reversal.\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price must be > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI range filter: Avoid extremely overbought/oversold conditions for general stability\n# This is separate from the RSI_reversal factor, acting as a general health check.\nrsi_health_filter = (rsi.shift(1) > 25) & (rsi.shift(1) < 75)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_health_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:44:32.044911",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 10,
      "timestamp": "2025-11-01T16:45:20.288414",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity (quarterly)\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign Investor Net Buy\nrsi = data.indicator('RSI') # Relative Strength Index (technical indicator)\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\n# Captures trending stocks over a 3-month period.\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly data, so forward-fill to daily, then take a rolling 4-period mean\n# to smooth out quarterly fluctuations and capture underlying profitability.\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (Monthly Revenue YoY)\n# Monthly revenue data is forward-filled to daily frequency to align with other data.\n# This factor captures companies with strong top-line growth.\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Strength (10-day sum of foreign net buy)\n# Accumulates foreign investor net buying over a 10-day window, indicating smart money conviction.\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] for each day.\n# This ensures factors with different scales contribute equally after weighting.\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine normalized factors with meaningful weights.\n# Higher weights for momentum and fundamental quality/growth, moderate for institutional flow.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be > 50M TWD.\n# This avoids illiquid stocks that are hard to trade.\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price must be > 15 TWD.\n# This avoids very low-priced \"penny stocks\" which can be highly volatile and risky.\nprice_filter = close.shift(1) > 15\n# RSI filter: Relative Strength Index must be between 30 and 70.\n# This avoids stocks that are extremely overbought or oversold, focusing on healthier trends.\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor.\n# Only stocks passing all filters will be considered for selection.\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select top N stocks\n# Select the top 12 stocks based on the filtered combined factor score.\n# This forms the portfolio for the next period.\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\n# Backtest the strategy with quarterly rebalancing, no upload to Finlab platform,\n# and an 8% stop loss to manage downside risk.\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:44:50.242695",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 11,
      "timestamp": "2025-11-01T16:45:40.434758",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_cap = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy\nrsi = data.indicator('RSI') # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily, then apply rolling mean\nquality = roe.ffill().rolling(4*21).mean().shift(1) # Approx 4 quarters (4*21 trading days per quarter)\n# Factor 3: Growth (Monthly Revenue YoY, forward-filled)\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI (as a short-term momentum confirmation)\n# Higher RSI (but not overbought) indicates stronger recent buying pressure\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0.\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Current adjusted close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 5 Billion TWD\nmarket_cap_filter = market_cap.shift(1) > 5_000_000_000\n# RSI range filter: Avoid extremely overbought/oversold conditions\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 75)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_range_filter]\n# 5. Select stocks (top 15 stocks based on combined factor score)\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:45:21.659254",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 12,
      "timestamp": "2025-11-01T16:45:57.954183",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nmarket_value = data.get('etl:market_value') # Market Cap for an optional filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily frequency before shifting\nquality = roe.rolling(4, min_periods=1).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, aligned to daily)\n# Monthly data, so ffill to daily frequency before shifting\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20, min_periods=1).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] for each day\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights summing to 1.0\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Market value > 5 Billion TWD (optional, but good for robustness)\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select top N stocks (typically 8-15)\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:45:41.710488",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 13,
      "timestamp": "2025-11-01T16:46:14.424245",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign Investor Net Buy\nrsi = data.indicator('RSI') # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Higher momentum is better\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Higher ROE is better\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Higher revenue growth is better\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Conviction (20-day sum of Foreign Net Buy)\n# Higher net buying by foreign investors is better\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0.\n# Emphasize momentum and fundamental strength.\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price must be > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid stocks with extremely low RSI (potentially oversold/weak)\n# We want stocks that are not extremely weak, so RSI > 30\nrsi_filter = rsi.shift(1) > 30\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:45:59.449326",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 14,
      "timestamp": "2025-11-01T16:46:33.360398",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\npb_ratio = data.get('price_earning_ratio:股價淨值比')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Value (ROE combined with inverse P/B)\n# ROE is quarterly, so forward-fill to daily and smooth with 4-quarter rolling mean\nroe_smoothed = roe.ffill().rolling(4).mean()\n# Inverse P/B ratio for value component\ninverse_pb = 1 / pb_ratio\n# Combine quality and value, then shift\nquality_value = (roe_smoothed * inverse_pb).shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly data, so forward-fill to daily, then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\n# Sum institutional buying over a 20-day window, then shift\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks (0 to 1)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_value_rank = quality_value.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0.\n# Prioritize momentum and quality/value, then growth and institutional flow.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_value_rank * 0.30 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 60M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 60_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 8 Billion TWD for mid-large cap focus\nmarket_cap_filter = market_value.shift(1) > 8_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select the top 15 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:46:15.872843",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 15,
      "timestamp": "2025-11-01T16:46:56.836156",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # Adjusted Close Price\ntrading_value = data.get('price:成交金額')  # Trading Value for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY Growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign Investor Net Buy\nrsi = data.indicator('RSI') # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined ROE and Revenue Growth)\n# ROE: Use 4-quarter rolling average, then forward-fill and shift\nroe_smoothed = roe.rolling(4, min_periods=1).mean().ffill().shift(1)\n# Revenue Growth: Forward-fill monthly data to daily, then shift\nrevenue_growth_ffill = revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth (simple average for now, will rank later)\nquality_growth_factor = (roe_smoothed + revenue_growth_ffill) / 2\n# Factor 3: Institutional Buying Pressure (20-day sum of foreign net buy)\n# Sum foreign net buy over 20 days, then shift\ninstitutional_flow = foreign_net_buy.rolling(20, min_periods=1).sum().shift(1)\n# Factor 4: Inverse RSI (Mean Reversion / Oversold Signal)\n# Lower RSI indicates oversold, so inverse it to make higher values better\ninverse_rsi = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth_factor.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\ninverse_rsi_rank = inverse_rsi.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_growth_rank * 0.30 +\n                   institutional_flow_rank * 0.25 +\n                   inverse_rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20, min_periods=1).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:46:34.719839",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 0,
      "timestamp": "2025-11-01T16:49:08.914477",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Smoothed ROE and Monthly Revenue YoY)\n# ROE is quarterly, revenue_yoy is monthly. Both need ffill and shift.\nsmoothed_roe = roe.rolling(4).mean().ffill().shift(1)\ngrowth = revenue_yoy.ffill().shift(1)\n# Combine quality and growth into a single factor\nquality_growth = smoothed_roe * 0.5 + growth * 0.5\n# Factor 3: Institutional Flow (20-day sum of Foreign Net Buy)\nflow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI Strength (as a technical confirmation)\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\nflow_rank = flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with weighted average\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_growth_rank * 0.30 +\n                   flow_rank * 0.25 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI range filter: Avoid extreme overbought/oversold conditions\nrsi_range_filter = (rsi.shift(1) > 35) & (rsi.shift(1) < 75)\n# Apply all filters\nall_filters = liquidity_filter & price_filter & rsi_range_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 140, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 140, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:48:42.412257",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-01T16:48:42.431011",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-01T16:49:23.648266",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical momentum\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, forward-filled)\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Strength (20-day sum of foreign net buy)\n# Normalize by market value to account for stock size\ninstitutional_flow = (foreign_net_buy.rolling(20).sum() / market_value).shift(1)\n# Factor 5: RSI Reversal (Lower RSI is better, so 100 - RSI)\n# This factor aims to pick stocks that are not overbought\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_rank = growth_revenue.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with meaningful weights\n# Emphasize momentum and quality, balance with growth, flow, and a touch of reversal\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 5 Billion TWD to focus on mid-large caps\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# RSI filter: Avoid extremely overbought or oversold conditions (RSI between 20 and 80)\nrsi_range_filter = (rsi.shift(1) > 20) & (rsi.shift(1) < 80)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_range_filter]\n# 5. Select stocks (top 10 stocks)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 145, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 145, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:49:10.335866",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-01T16:49:42.085107",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Mid-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then smooth\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Strength (10-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select top N stocks (e.g., top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 136, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 136, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:49:24.872309",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-01T16:50:03.162363",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator for filtering\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Use .ffill() to align quarterly data to daily frequency, then .shift(1)\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Use .ffill() to align monthly data to daily frequency, then .shift(1)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] across stocks for each day\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine normalized factors with weighted average\n# Weights chosen to emphasize momentum and fundamental quality/growth\ncombined_factor = (momentum_rank * 0.40 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select top N stocks (e.g., top 10) based on the filtered combined factor\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 138, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 138, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:49:43.419978",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-01T16:50:26.326241",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quarterly fundamental data\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly fundamental data\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Daily institutional flow\nrsi = data.indicator('RSI')  # Daily technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth\n# Sub-factor 2a: ROE (4-quarter average, forward-filled to daily)\nroe_smoothed = roe.rolling(4).mean().ffill().shift(1)\n# Sub-factor 2b: Monthly Revenue YoY (forward-filled to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 3: Institutional Flow (20-day sum of foreign net buy)\nforeign_flow_20d = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI Reversal (Lower RSI implies relatively oversold, higher rank)\nrsi_val = rsi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nroe_rank = roe_smoothed.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow_20d.rank(axis=1, pct=True)\n# For RSI, we want lower values to rank higher (reversal), so inverse rank\nrsi_reversal_rank = (1 - rsi_val.rank(axis=1, pct=True))\n# Combine Quality & Growth sub-factors\nquality_growth_rank = roe_rank * 0.6 + revenue_rank * 0.4\n# Combine all normalized factors with weighted average\n# Weights: Momentum (0.35), Quality/Growth (0.30), Institutional Flow (0.25), RSI Reversal (0.10)\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_growth_rank * 0.30 +\n                   foreign_flow_rank * 0.25 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI range filter: Avoid extreme overbought/oversold conditions for selection\nrsi_range_filter = (rsi_val > 30) & (rsi_val < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select stocks (top 10 based on filtered combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 143, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 143, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:50:04.440961",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-01T16:50:48.447000",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign buying strength\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY\nrsi = data.indicator('RSI') # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Short-term Price Momentum (20-day returns)\nmomentum_20d = close.pct_change(20).shift(1)\n# Factor 2: Foreign Buying Strength (smoothed)\n# Using a 5-day rolling sum to smooth out daily fluctuations\nforeign_flow_strength = foreign_strength.rolling(5).mean().shift(1)\n# Factor 3: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily, then apply rolling mean for stability\nquality_roe = roe.ffill().rolling(4, min_periods=1).mean().shift(1)\n# Factor 4: Revenue Growth (Monthly YoY, forward-filled)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_20d.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow_strength.rank(axis=1, pct=True)\nquality_roe_rank = quality_roe.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   foreign_flow_rank * 0.25 +\n                   quality_roe_rank * 0.25 +\n                   revenue_growth_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10 stocks based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 136, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 136, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:50:27.634377",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-01T16:51:16.390441",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Foreign Investor Net Buy\nrsi = data.indicator('RSI')  # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE) - 4-quarter average, forward-filled to daily frequency\nroe_smoothed = roe.rolling(4).mean().ffill()\nroe_factor = roe_smoothed.shift(1)\n# Factor 3: Growth (Monthly Revenue YoY) - forward-filled to daily frequency\nrevenue_growth_factor = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Buying Strength (20-day sum of Foreign Net Buy)\nforeign_flow_20d = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI Momentum (14-day RSI)\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] for each day\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nroe_rank = roe_factor.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth_factor.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow_20d.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine factors with intelligent weights summing to 1.0\n# Weights: Momentum (0.30), Quality (0.20), Growth (0.20), Institutional Flow (0.20), RSI (0.10)\ncombined_factor = (momentum_rank * 0.30 +\n                   roe_rank * 0.20 +\n                   revenue_rank * 0.20 +\n                   foreign_flow_rank * 0.20 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI range filter: Avoid extreme overbought (>75) or oversold (<35) conditions\nrsi_range_filter = (rsi.shift(1) > 35) & (rsi.shift(1) < 75)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select top N stocks (e.g., top 10 stocks with the highest combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 141, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 141, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:50:49.728707",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-01T16:51:36.697672",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Smoothed Foreign Buying Strength (5-day average)\nforeign_flow_strength = foreign_strength.rolling(5).mean().shift(1)\n# Factor 3: Quality & Growth (4-quarter avg ROE * Monthly Revenue YoY)\n# Ensure ROE and Revenue YoY are forward-filled to daily frequency\nquality_growth = (roe.rolling(4).mean().ffill() * revenue_yoy.ffill()).shift(1)\n# Factor 4: RSI (Relative Strength Index) - direct use for momentum/reversal signal\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow_strength.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   foreign_flow_rank * 0.25 +\n                   quality_growth_rank * 0.30 +\n                   rsi_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 135, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 135, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:51:17.677782",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-01T16:52:05.478981",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # Adjusted close price\ntrading_value = data.get('price:成交金額')  # Trading value for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy\nrsi = data.indicator('RSI') # Relative Strength Index\nmarket_cap = data.get('etl:market_value') # Market capitalization\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Smoothed ROE and Revenue YoY)\n# ROE is quarterly, so ffill and then smooth over 4 quarters\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Revenue YoY is monthly, so ffill to daily frequency\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Combine quality and growth with equal weight\nquality_growth_factor = quality_roe * 0.5 + growth_revenue * 0.5\n# Factor 3: Institutional Flow (20-day sum of foreign net buying, normalized by market cap)\n# Normalize foreign net buy by market cap to account for size differences\n# Replace 0 market caps with NA to avoid division by zero\nforeign_flow_normalized = (foreign_net_buy / market_cap.replace(0, pd.NA)).rolling(20).sum().shift(1)\n# Factor 4: RSI Reversal (Inverse RSI to favor oversold conditions)\n# A lower RSI suggests potential for reversal upwards, so (100 - RSI) will be higher for lower RSI values\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth_factor.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow_normalized.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights. Total weights should sum to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_growth_rank * 0.30 +\n                   foreign_flow_rank * 0.25 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 10 Billion TWD for larger, more stable companies\nmarket_cap_filter = market_cap.shift(1) > 10_000_000_000\n# RSI range filter: Avoid extreme overbought/oversold conditions for the selected stocks\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 146, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 146, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:51:38.041748",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-01T16:52:29.657603",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy\nrsi = data.indicator('RSI') # Relative Strength Index for technical momentum\n# 2. Calculate factors\n# Factor 1: Long-Term Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Smoothed ROE + Monthly Revenue YoY)\n# ROE is quarterly, so forward-fill and smooth over 4 quarters\nroe_smoothed = roe.ffill().rolling(4).mean()\n# Revenue YoY is monthly, so forward-fill\nrevenue_growth = revenue_yoy.ffill()\n# Combine ROE and Revenue Growth, then shift\nquality_growth_factor = (roe_smoothed + revenue_growth).shift(1)\n# Factor 3: Institutional Buying Strength (20-day cumulative foreign net buy)\n# Sum foreign net buy over 20 days to capture sustained interest\nforeign_flow_strength = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI Momentum (RSI value itself, not overbought/oversold)\n# Higher RSI (but not extreme) indicates stronger momentum\nrsi_momentum_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth_factor.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow_strength.rank(axis=1, pct=True)\nrsi_momentum_rank = rsi_momentum_factor.rank(axis=1, pct=True)\n# Combine with weighted average (weights sum to 1.0)\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_growth_rank * 0.30 +\n                   foreign_flow_rank * 0.25 +\n                   rsi_momentum_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 10 Billion TWD (focus on mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI range filter: Avoid extremely oversold (<30) or extremely overbought (>80) conditions\n# This helps to filter out potential reversals or highly speculative stocks\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 80)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_range_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined and filtered factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 147, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 147, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:52:06.810786",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 10,
      "timestamp": "2025-11-01T16:52:58.615624",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Use adjusted data\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value')\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Institutional Buying Strength (10-day average)\n# Foreign buying strength, smoothed to reduce noise\ninst_strength = foreign_strength.rolling(10).mean().shift(1)\n# Factor 3: Fundamental Quality (4-quarter average ROE)\n# Forward-fill monthly/quarterly data to daily frequency\nroe_factor = roe.rolling(4).mean().ffill().shift(1)\n# Factor 4: Fundamental Growth (Monthly Revenue YoY)\n# Forward-fill monthly/quarterly data to daily frequency\nrevenue_factor = revenue_yoy.ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\ninst_strength_rank = inst_strength.rank(axis=1, pct=True)\nroe_rank = roe_factor.rank(axis=1, pct=True)\nrevenue_rank = revenue_factor.rank(axis=1, pct=True)\n# Combine factors with weighted average\n# Weights chosen to emphasize momentum and institutional flow, balanced with fundamentals\ncombined_factor = (momentum_rank * 0.35 +\n                   inst_strength_rank * 0.30 +\n                   roe_rank * 0.20 +\n                   revenue_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market capitalization filter: Market cap > 10B TWD for larger, more stable companies\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Combine all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & rsi_range_filter\n# Apply filters to the combined factor\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 145, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 145, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:52:31.052881",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 11,
      "timestamp": "2025-11-01T16:53:20.144467",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() to align quarterly data to daily, then shift(1)\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# ffill() to align monthly data to daily, then shift(1)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI Contrarian (Lower RSI implies oversold, potential rebound)\n# We want lower RSI to rank higher, so we rank (100 - RSI)\nrsi_contrarian = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_contrarian_rank = rsi_contrarian.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   rsi_contrarian_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: 20-day average trading value > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI range filter: Avoid extreme overbought/oversold conditions for general strategy\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 12 stocks)\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 141, in <module>\n    position = filtered_factor.is_largest(12)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 141, in <module>\n    position = filtered_factor.is_largest(12)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:52:59.919150",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 12,
      "timestamp": "2025-11-01T16:53:49.437528",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity\nmonthly_revenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy\nrsi = data.indicator('RSI', 14) # Relative Strength Index (14-period)\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum_factor = close.pct_change(60).shift(1)\n# Factor 2: Quality (4-quarter average ROE)\n# ffill() for quarterly data, then shift(1) to avoid look-ahead\nroe_factor = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# ffill() for monthly data, then shift(1) to avoid look-ahead\nrevenue_growth_factor = monthly_revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\nforeign_flow_factor = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Short-term Reversal (Inverse RSI)\n# Higher value means lower RSI, indicating oversold condition. Shift(1) for look-ahead.\nrsi_reversal_factor = (100 - rsi).shift(1)\n# 3. Factor Normalization and Combination\n# Normalize each factor to percentile ranks [0, 1] for each day\nmomentum_rank = momentum_factor.rank(axis=1, pct=True)\nroe_rank = roe_factor.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth_factor.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow_factor.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal_factor.rank(axis=1, pct=True)\n# Combine factors with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.25 +\n                   roe_rank * 0.20 +\n                   revenue_growth_rank * 0.20 +\n                   foreign_flow_rank * 0.20 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 5 Billion TWD (focus on mid-to-large caps)\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# RSI health filter: Avoid extremely overbought/oversold conditions for overall stock health\n# Even though we use inverse RSI, this filter helps exclude highly volatile or illiquid stocks.\nrsi_health_filter = (rsi.shift(1) > 20) & (rsi.shift(1) < 80)\n# Apply all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & rsi_health_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select top N stocks (e.g., top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 147, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 147, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:53:21.386696",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 13,
      "timestamp": "2025-11-01T16:54:17.022471",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後') # Core profitability\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # High-frequency growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\nrsi = data.indicator('RSI') # Technical indicator for momentum/reversal\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\n# Higher returns over 60 days indicate strong momentum\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so forward-fill to daily frequency, then apply a 4-period rolling mean, then shift\n# Higher ROE indicates better profitability and quality\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly revenue, so forward-fill to daily frequency, then shift\n# Higher YoY revenue growth indicates business expansion\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Accumulation (20-day sum of Foreign Net Buy)\n# Sum of foreign investor net buying over 20 days, then shift\n# Positive and sustained institutional buying indicates smart money interest\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] across all stocks for each day\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_rank = growth_revenue.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine factors with meaningful weights.\n# Momentum and Quality/Growth are often strong drivers, Institutional Flow provides confirmation.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be above 50M TWD\n# This ensures sufficient liquidity for entry/exit without significant price impact\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price must be above 15 TWD\n# Avoids penny stocks which can be highly volatile and illiquid\nprice_filter = close.shift(1) > 15\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\n# Focuses on stocks that are not at immediate reversal points, suggesting a more stable trend\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select top N stocks (e.g., top 10 stocks with the highest combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 146, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 146, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:53:50.691915",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 14,
      "timestamp": "2025-11-01T16:54:37.963265",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Use adjusted data\ntrading_value = data.get('price:成交金額')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\nmarket_value = data.get('etl:market_value')\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Ffill monthly/quarterly data to daily, then apply rolling mean, then shift\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Ffill monthly data to daily, then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Market Cap filter: Market capitalization > 5 Billion TWD (avoid small caps)\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters\nall_filters = liquidity_filter & price_filter & rsi_filter & market_cap_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 140, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 140, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:54:18.333336",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 15,
      "timestamp": "2025-11-01T16:54:57.768201",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly revenue growth\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor net buy\nrsi = data.indicator('RSI') # Relative Strength Index for technical signal\n# 2. Calculate factors\n# Factor 1: Price Momentum (20-day returns)\nmomentum = close.pct_change(20).shift(1)\n# Factor 2: Revenue Growth (monthly data aligned to daily)\n# Use .ffill() to forward-fill monthly data to daily frequency\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 3: Quality (ROE with 4-quarter smoothing)\n# Use .ffill() for quarterly data and then rolling mean for smoothing\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 4: Institutional Flow (10-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# Factor 5: RSI Reversal (Inverted RSI for oversold conditions)\n# Lower RSI values (e.g., <30) indicate oversold, so we invert it to give higher scores\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   revenue_rank * 0.20 +\n                   quality_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (focus on mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: Avoid overly overbought stocks, allowing for oversold to neutral range\n# We want RSI to be below 60, as we are looking for potential reversals from oversold/neutral\nrsi_filter = rsi.shift(1) < 60\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks (top 15 based on combined factor score)\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 145, in <module>\n    position = filtered_factor.is_largest(15)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 145, in <module>\n    position = filtered_factor.is_largest(15)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:54:40.556701",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 16,
      "timestamp": "2025-11-01T16:55:21.527782",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Use .ffill() to align quarterly data to daily frequency\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Use .ffill() to align monthly data to daily frequency\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: 20-day average trading value > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Adjusted close price > 20 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select top N stocks (e.g., top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 137, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 137, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:54:59.116516",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 17,
      "timestamp": "2025-11-01T16:55:55.682235",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Foreign Net Buy\npe_ratio = data.get('price_earning_ratio:本益比')  # Price-to-Earnings Ratio\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined ROE and Revenue YoY)\n# ROE: 4-quarter rolling mean, then forward fill to daily\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Revenue YoY: forward fill to daily\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Combine quality and growth (simple average)\nquality_growth = (quality_roe + growth_revenue) / 2\n# Factor 3: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Value (Inverse of P/E Ratio)\n# Replace non-positive P/E ratios with NaN to avoid division by zero or negative values\npe_ratio_adjusted = pe_ratio.ffill().shift(1).mask(pe_ratio.ffill().shift(1) <= 0)\nvalue_factor = 1 / pe_ratio_adjusted\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_growth_rank * 0.30 +\n                   flow_rank * 0.25 +\n                   value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 50M TWD over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 5 and 25 (avoid distressed and extremely overvalued)\npe_filter = (pe_ratio.ffill().shift(1) < 25) & (pe_ratio.ffill().shift(1) > 5)\n# Quality filter: Positive 4-quarter average ROE\nroe_filter = roe.rolling(4).mean().ffill().shift(1) > 0\n# Combine all filters\nall_filters = liquidity_filter & price_filter & pe_filter & roe_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks\n# Select top 10 stocks based on the combined and filtered factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 145, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 145, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:55:22.904043",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 18,
      "timestamp": "2025-11-01T16:56:20.295674",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quarterly fundamental\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly fundamental\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Daily institutional flow\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Using a slightly longer momentum window for robustness\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily frequency before shifting\nquality = roe.rolling(4, min_periods=1).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (Monthly Revenue YoY)\n# Monthly data, so ffill to daily frequency before shifting\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (10-day sum of foreign net buy)\n# Summing up daily foreign net buy over 10 days\ninstitutional_flow = foreign_net_buy.rolling(10, min_periods=1).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with meaningful weights summing to 1.0\n# Emphasize momentum and quality, with good contribution from growth and institutional flow\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be > 50M TWD\nliquidity_filter = trading_value.rolling(20, min_periods=1).mean().shift(1) > 50_000_000\n# Price filter: Stock price must be > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter]\n# 5. Select stocks\n# Select the top 12 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 138, in <module>\n    position = filtered_factor.is_largest(12)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 138, in <module>\n    position = filtered_factor.is_largest(12)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:55:56.993766",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 19,
      "timestamp": "2025-11-01T16:56:38.205392",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator for filtering\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(4, min_periods=1).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, aligned to daily)\n# Monthly revenue, so ffill to daily\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 60M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 60_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 12 stocks based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 138, in <module>\n    position = filtered_factor.is_largest(12)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 138, in <module>\n    position = filtered_factor.is_largest(12)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:56:21.520748",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 20,
      "timestamp": "2025-11-01T16:57:01.446821",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign buying strength\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY\nrsi = data.indicator('RSI') # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() to align quarterly data to daily, then rolling mean for smoothing\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Institutional Flow (10-day smoothed Foreign Buying Strength)\ninstitutional_flow = foreign_strength.rolling(10).mean().shift(1)\n# Factor 4: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   flow_rank * 0.25 +\n                   revenue_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 136, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n",
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: Container exited with code 1:\nTraceback (most recent call last):\n  File \"/code/strategy.py\", line 136, in <module>\n    position = filtered_factor.is_largest(10)\n  File \"/usr/local/lib/python3.10/site-packages/pandas/core/generic.py\", line 6321, in __getattr__\n    return object.__getattribute__(self, name)\nAttributeError: 'DataFrame' object has no attribute 'is_largest'. Did you mean: 'nlargest'?\n\n\nLikely cause: Calling method on wrong data type\nVerify DataFrame operations match finlab data structure\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T00:56:39.491260",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "gemini",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    }
  ]
}