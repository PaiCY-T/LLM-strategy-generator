# Exit Mutation Configuration
# Purpose: Centralized configuration for exit parameter mutation system
# Spec: exit-mutation-redesign (Task 2)
# Requirements: 2.1, 2.2, 2.3, 2.4
#
# This configuration defines parameter bounds, mutation probabilities, and validation
# settings for the parameter-based exit mutation system that replaced failed AST approach.
#
# Financial Context:
#   Exit strategies (stop-loss, take-profit, trailing stops) are critical for risk management
#   and return optimization. This configuration ensures mutations explore realistic parameter
#   ranges based on trading best practices and empirical evidence from quantitative finance.
#
# Environment Variable Support:
#   All settings support override via environment variables using ${VAR_NAME:default}
#   Example: gaussian_stddev: ${EXIT_MUTATION_STDDEV:0.15}

# === GAUSSIAN MUTATION CONFIGURATION ===
# Controls the statistical properties of parameter mutations
# Uses Gaussian (normal) distribution for parameter perturbation
gaussian_mutation:
  # Standard deviation for Gaussian noise (mean = 0)
  # Controls mutation magnitude: new_value = old_value * (1 + N(0, stddev))
  #
  # Statistical Properties:
  #   - stddev=0.15 → 68% of mutations within ±15% of original value
  #   - stddev=0.15 → 95% of mutations within ±30% of original value
  #   - stddev=0.15 → 99.7% of mutations within ±45% of original value
  #
  # Trading Rationale:
  #   - 15% typical change allows meaningful exploration without excessive disruption
  #   - Balances exploitation (small changes) vs exploration (larger jumps)
  #   - Occasional large mutations (>30%) enable escape from local optima
  #
  # Tuning Guidance:
  #   - Lower (0.05-0.10): Conservative, incremental optimization
  #   - Medium (0.15-0.20): Balanced exploration/exploitation (RECOMMENDED)
  #   - Higher (0.25-0.35): Aggressive exploration, risk of instability
  #
  # Override: Set EXIT_MUTATION_STDDEV environment variable
  stddev: ${EXIT_MUTATION_STDDEV:0.15}

  # Distribution verification settings (for testing)
  # Used by unit tests to statistically verify Gaussian properties
  verification:
    # Sample size for statistical tests (chi-square, KS test)
    sample_size: 1000

    # Confidence level for distribution tests (0.0-1.0)
    # 0.95 = 95% confidence that distribution is Gaussian
    confidence_level: 0.95

# === PARAMETER BOUNDS CONFIGURATION ===
# Defines min/max ranges for each exit parameter
# Values are clamped to these bounds after Gaussian mutation
# Bounds based on trading best practices and empirical backtest performance
parameter_bounds:
  # === STOP LOSS PERCENTAGE ===
  # Maximum acceptable loss before exiting position (risk control)
  #
  # Range: [0.01, 0.20] = [1%, 20%]
  #
  # Financial Rationale:
  #   - Min (1%): Prevents premature exits from normal volatility
  #     · Tighter stops → higher turnover → transaction costs erode profits
  #     · Daily volatility for many stocks is 1-2%, need buffer
  #   - Max (20%): Limits catastrophic losses while allowing trend development
  #     · Wider stops → capture larger trends but risk bigger drawdowns
  #     · Risk management principle: Never risk >2% of portfolio per trade
  #
  # Typical Values:
  #   - Day trading: 1-3% (tight stops, high turnover)
  #   - Swing trading: 5-10% (medium-term trends)
  #   - Position trading: 10-20% (long-term trends, wider volatility tolerance)
  #
  # Evidence:
  #   - Empirical studies show optimal stop-loss ranges: 8-12% for weekly strategies
  #   - Too tight (<5%): Win rate drops, whipsawed by noise
  #   - Too wide (>20%): Risk-adjusted returns degrade (Sharpe, Calmar suffer)
  #
  # Override: EXIT_STOP_LOSS_MIN, EXIT_STOP_LOSS_MAX
  stop_loss_pct:
    min: ${EXIT_STOP_LOSS_MIN:0.01}
    max: ${EXIT_STOP_LOSS_MAX:0.20}
    default: 0.10  # 10% default (balanced risk/reward)

    # Parameter interpretation
    description: "Maximum loss percentage before exit (risk control)"
    units: "percentage"
    example_values:
      - value: 0.03
        context: "Tight stop for volatile stocks (day trading)"
      - value: 0.10
        context: "Balanced stop for weekly strategies (RECOMMENDED)"
      - value: 0.18
        context: "Wide stop for trend-following (position trading)"

  # === TAKE PROFIT PERCENTAGE ===
  # Target profit level for exiting winning positions (reward capture)
  #
  # Range: [0.05, 0.50] = [5%, 50%]
  #
  # Financial Rationale:
  #   - Min (5%): Ensures minimum reward/risk ratio of 0.5:1 (with 10% stop)
  #     · Profit target must exceed transaction costs + slippage (~0.2-0.5%)
  #     · Below 5%, frequent small wins eroded by costs
  #   - Max (50%): Allows capture of large trends without unrealistic expectations
  #     · Higher targets → lower win rate but larger average wins
  #     · Above 50%, probability of hitting target decreases exponentially
  #
  # Typical Values:
  #   - Mean reversion: 5-15% (quick profits, high win rate)
  #   - Momentum: 15-30% (ride trends, lower win rate)
  #   - Breakout: 30-50% (capture explosive moves, lowest win rate)
  #
  # Risk/Reward Ratios:
  #   - Conservative (R:R 1:1): stop=10%, take_profit=10%
  #   - Balanced (R:R 2:1): stop=10%, take_profit=20% (RECOMMENDED)
  #   - Aggressive (R:R 3:1): stop=10%, take_profit=30%
  #
  # Evidence:
  #   - Studies show optimal take-profit ranges: 15-25% for weekly momentum
  #   - Too low (<10%): Frequent exits miss trend continuation
  #   - Too high (>40%): Win rate collapses, expectancy turns negative
  #
  # Override: EXIT_TAKE_PROFIT_MIN, EXIT_TAKE_PROFIT_MAX
  take_profit_pct:
    min: ${EXIT_TAKE_PROFIT_MIN:0.05}
    max: ${EXIT_TAKE_PROFIT_MAX:0.50}
    default: 0.20  # 20% default (2:1 reward/risk with 10% stop)

    description: "Target profit percentage for exit (reward capture)"
    units: "percentage"
    example_values:
      - value: 0.08
        context: "Quick profits for mean reversion strategies"
      - value: 0.20
        context: "Balanced target for momentum strategies (RECOMMENDED)"
      - value: 0.40
        context: "Large targets for breakout/trend-following"

  # === TRAILING STOP OFFSET ===
  # Distance (in %) from peak price where trailing stop triggers
  # Locks in profits while allowing trend to continue
  #
  # Range: [0.005, 0.05] = [0.5%, 5%]
  #
  # Financial Rationale:
  #   - Min (0.5%): Very tight trailing for highly liquid, low-volatility assets
  #     · Minimizes profit give-back but may exit prematurely on noise
  #     · Suitable for: Large-cap stocks, indices, forex majors
  #   - Max (5%): Wide trailing for volatile or lower-liquidity assets
  #     · Allows breathing room for trends to develop
  #     · Suitable for: Small-cap stocks, commodities, cryptocurrencies
  #
  # Typical Values:
  #   - Low volatility: 0.5-1.5% (tight trailing, minimize give-back)
  #   - Medium volatility: 1.5-3.0% (balanced, accommodate swings)
  #   - High volatility: 3.0-5.0% (wide, avoid whipsaws)
  #
  # Trailing Stop Mechanics:
  #   1. Position enters at price P0
  #   2. Price rises to peak Pmax
  #   3. Trailing stop set at: Pmax * (1 - trailing_stop_offset)
  #   4. Exit if price drops below trailing stop
  #
  # Example (offset=2%):
  #   - Entry: $100
  #   - Peak: $120
  #   - Trailing stop: $120 * 0.98 = $117.60
  #   - Exit if price < $117.60 (locked in 17.6% profit)
  #
  # Evidence:
  #   - Empirical studies: 2-3% optimal for weekly momentum strategies
  #   - Too tight (<1%): Frequent exits, transaction costs accumulate
  #   - Too wide (>4%): Give back too much profit, Sharpe deteriorates
  #
  # Override: EXIT_TRAILING_STOP_MIN, EXIT_TRAILING_STOP_MAX
  trailing_stop_offset:
    min: ${EXIT_TRAILING_STOP_MIN:0.005}
    max: ${EXIT_TRAILING_STOP_MAX:0.05}
    default: 0.025  # 2.5% default (balanced for medium volatility)

    description: "Distance from peak price for trailing stop trigger"
    units: "percentage"
    example_values:
      - value: 0.01
        context: "Tight trailing for low-volatility large-caps"
      - value: 0.025
        context: "Balanced trailing for weekly strategies (RECOMMENDED)"
      - value: 0.04
        context: "Wide trailing for high-volatility small-caps"

  # === HOLDING PERIOD (DAYS) ===
  # Maximum time to hold position regardless of price action
  # Time-based exit for mean reversion or regime-specific strategies
  #
  # Range: [1, 60] = [1 day, 2 months]
  #
  # Financial Rationale:
  #   - Min (1 day): Intraday/overnight strategies
  #     · Minimize overnight gap risk
  #     · Suitable for: High-frequency, news-driven strategies
  #   - Max (60 days): Medium-term position trading
  #     · Capture multi-week trends and seasonal effects
  #     · Suitable for: Quarterly earnings cycles, sector rotation
  #
  # Typical Values:
  #   - Day trading: 1 day (close before market close)
  #   - Swing trading: 5-10 days (capture weekly trends)
  #   - Position trading: 20-60 days (capture monthly/quarterly trends)
  #
  # Time-Based Exit Rationale:
  #   - Prevents capital from being tied up in stagnant positions
  #   - Enforces discipline: exit if thesis doesn't play out in expected timeframe
  #   - Reduces exposure to regime changes (bull→bear market transitions)
  #
  # Example Application:
  #   - Mean reversion: 3-7 days (expect quick snapback)
  #   - Momentum: 10-30 days (ride trends until exhaustion)
  #   - Seasonal: 30-60 days (capture quarterly effects)
  #
  # Evidence:
  #   - Studies show optimal holding periods: 7-14 days for weekly rebalance
  #   - Too short (<3 days): Miss trend development, transaction costs high
  #   - Too long (>45 days): Exposure to regime changes, returns mean-revert
  #
  # Override: EXIT_HOLDING_PERIOD_MIN, EXIT_HOLDING_PERIOD_MAX
  holding_period_days:
    min: ${EXIT_HOLDING_PERIOD_MIN:1}
    max: ${EXIT_HOLDING_PERIOD_MAX:60}
    default: 10  # 10 days default (weekly strategy)

    description: "Maximum holding period before forced exit"
    units: "days"
    example_values:
      - value: 1
        context: "Intraday strategies (close before market close)"
      - value: 10
        context: "Weekly strategies (RECOMMENDED for weekly rebalance)"
      - value: 30
        context: "Monthly strategies (capture longer trends)"

# === MUTATION PROBABILITIES ===
# Controls frequency of different mutation operations
# Ensures balanced exploration across parameter space
mutation_probabilities:
  # Probability of selecting each parameter for mutation
  # Must sum to 1.0 (uniform distribution by default)
  #
  # Tuning Guidance:
  #   - Equal weights (0.25 each): Balanced exploration (RECOMMENDED)
  #   - Higher weight: Focus on specific parameter (e.g., stop_loss=0.40 for risk control)
  #   - Lower weight: De-emphasize less critical parameters
  #
  # Override: Set individual EXIT_PROB_* environment variables
  parameter_selection:
    stop_loss_pct: ${EXIT_PROB_STOP_LOSS:0.25}
    take_profit_pct: ${EXIT_PROB_TAKE_PROFIT:0.25}
    trailing_stop_offset: ${EXIT_PROB_TRAILING:0.25}
    holding_period_days: ${EXIT_PROB_HOLDING:0.25}

  # Probability of exit mutation vs other mutation types (add/remove/modify factors)
  # Set in main learning_system.yaml under exit_mutation.exit_mutation_probability
  # Typical: 0.2-0.3 (20-30% of mutations are exit mutations)
  exit_mutation_weight: 0.30

# === VALIDATION SETTINGS ===
# Controls validation behavior after mutation
validation:
  # Enable AST validation after regex replacement
  # Ensures mutated code is syntactically valid Python
  # CRITICAL: Must be enabled to prevent invalid code from entering population
  #
  # When disabled: Mutations may produce syntax errors (UNSAFE)
  # When enabled: All mutations validated with ast.parse() before acceptance
  #
  # Override: EXIT_VALIDATION_ENABLED
  ast_validation_enabled: ${EXIT_VALIDATION_ENABLED:true}

  # Maximum retry attempts if mutation validation fails
  # If mutation produces invalid code, retry with new Gaussian sample
  #
  # Rationale: Occasionally, extreme Gaussian values can produce invalid code
  #            (e.g., negative values, values that break string formatting)
  #            Retries allow system to recover without failing entire mutation
  #
  # Recommended: 3 retries (balance between robustness and performance)
  # Higher retries: More robust but slower
  # Lower retries: Faster but may skip valid mutations
  #
  # Override: EXIT_MAX_RETRIES
  max_retries: ${EXIT_MAX_RETRIES:3}

  # Timeout for validation checks (seconds)
  # Prevents hanging on pathological code that takes forever to parse
  #
  # Typical AST parse time: <10ms
  # Timeout exists to prevent DoS from malformed code
  #
  # Recommended: 5 seconds (extremely generous, most validations <100ms)
  #
  # Override: EXIT_VALIDATION_TIMEOUT
  validation_timeout: ${EXIT_VALIDATION_TIMEOUT:5}

  # Skip mutation if parameter not found in code
  # When true: Return original code if regex doesn't match parameter
  # When false: Log error and fail mutation
  #
  # Rationale: Not all strategies have all exit parameters
  #            (e.g., some may have stop_loss but no trailing_stop)
  #            Graceful skip allows mutation system to continue
  #
  # Recommended: true (backward compatible with existing strategies)
  #
  # Override: EXIT_SKIP_MISSING
  skip_missing_parameters: ${EXIT_SKIP_MISSING:true}

# === LOGGING CONFIGURATION ===
# Controls verbosity and detail of mutation logging
logging:
  # Enable detailed mutation logging
  # Logs: parameter name, old value, new value, clamping, success/failure
  #
  # When enabled: Full mutation audit trail in logs
  # When disabled: Only errors logged
  #
  # Recommended: true (CRITICAL for debugging and monitoring)
  #
  # Override: EXIT_LOG_MUTATIONS
  log_mutations: ${EXIT_LOG_MUTATIONS:true}

  # Log level for mutation operations
  # Options: DEBUG, INFO, WARNING, ERROR
  #
  # DEBUG: Log every mutation attempt (verbose)
  # INFO: Log successful mutations and failures (recommended)
  # WARNING: Log only failures and clamping
  # ERROR: Log only errors
  #
  # Override: EXIT_LOG_LEVEL
  log_level: ${EXIT_LOG_LEVEL:INFO}

  # Log clamping events separately
  # When parameter is clamped to bounds, log with special marker
  # Useful for identifying if bounds are too restrictive
  #
  # Override: EXIT_LOG_CLAMPING
  log_clamping: ${EXIT_LOG_CLAMPING:true}

  # Log parameter distribution statistics (for analysis)
  # Every N mutations, log:
  #   - Mean/median/std of mutated values
  #   - Clamping frequency per parameter
  #   - Success rate per parameter
  #
  # Useful for: Identifying if bounds need adjustment
  #
  # Override: EXIT_LOG_STATS_INTERVAL (0 = disabled)
  statistics_interval: ${EXIT_LOG_STATS_INTERVAL:100}

# === MONITORING & METRICS ===
# Prometheus metrics and observability
monitoring:
  # Enable Prometheus metrics export
  # Exports counters and gauges for mutation success/failure
  #
  # Metrics exported:
  #   - exit_mutations_total{parameter, result} (counter)
  #   - exit_mutation_success_rate (gauge)
  #   - exit_mutations_clamped_total{parameter} (counter)
  #   - exit_mutation_latency_seconds (histogram)
  #
  # Override: EXIT_METRICS_ENABLED
  metrics_enabled: ${EXIT_METRICS_ENABLED:true}

  # Export mutation metadata to JSON logs
  # Structured logging for downstream analysis
  #
  # JSON fields:
  #   - timestamp, parameter, old_value, new_value, clamped, success
  #
  # Override: EXIT_JSON_LOGGING
  json_logging_enabled: ${EXIT_JSON_LOGGING:true}

  # Track mutation type distribution
  # Counts how often each parameter is mutated
  # Useful for verifying uniform selection probability
  #
  # Override: EXIT_TRACK_DISTRIBUTION
  track_distribution: ${EXIT_TRACK_DISTRIBUTION:true}

# === PERFORMANCE TUNING ===
# Optimization settings for high-throughput scenarios
performance:
  # Cache compiled regex patterns
  # Pre-compile patterns at initialization rather than per-mutation
  # Reduces latency from ~20ms to ~10ms per parameter
  #
  # Recommended: true (2x speedup)
  #
  # Override: EXIT_CACHE_REGEX
  cache_regex_patterns: ${EXIT_CACHE_REGEX:true}

  # Maximum mutation latency target (milliseconds)
  # Target: <100ms per mutation (requirements)
  # Used for performance benchmarking and alerts
  #
  # Override: EXIT_MAX_LATENCY_MS
  max_latency_ms: ${EXIT_MAX_LATENCY_MS:100}

  # Enable performance profiling
  # Track time spent in each mutation phase:
  #   - Regex matching, value mutation, validation, clamping
  #
  # When enabled: Detailed timing logged at DEBUG level
  # When disabled: Only total mutation time logged
  #
  # Override: EXIT_PROFILE_ENABLED
  profiling_enabled: ${EXIT_PROFILE_ENABLED:false}

# === ADVANCED CONFIGURATION ===
# Expert-level settings (modify with caution)
advanced:
  # Custom regex patterns (override defaults)
  # Only modify if using non-standard parameter naming conventions
  # Format: parameter_name -> regex pattern
  #
  # Default patterns (from ExitParameterMutator):
  #   stop_loss_pct: r'stop_loss_pct\s*=\s*([\d.]+)'
  #   take_profit_pct: r'take_profit_pct\s*=\s*([\d.]+)'
  #   trailing_stop_offset: r'trailing_stop[_\w]*\s*=\s*([\d.]+)'
  #   holding_period_days: r'holding_period[_\w]*\s*=\s*(\d+)'
  #
  # Override with caution: Incorrect patterns will break parameter detection
  #
  # Example custom patterns:
  # custom_regex_patterns:
  #   stop_loss_pct: 'sl_pct\s*=\s*([\d.]+)'
  #   take_profit_pct: 'tp_pct\s*=\s*([\d.]+)'

  # Adaptive bounds (future feature - not yet implemented)
  # Automatically adjust bounds based on performance feedback
  # When enabled, bounds narrow/expand based on successful mutations
  #
  # EXPERIMENTAL: Set to true to enable adaptive bounds
  # Default: false (static bounds only)
  adaptive_bounds_enabled: false

  # Correlation-aware mutation (future feature - not yet implemented)
  # Mutate multiple parameters simultaneously while respecting correlations
  # Example: Increase stop_loss and take_profit together (maintain R:R ratio)
  #
  # EXPERIMENTAL: Set to true to enable correlated mutations
  # Default: false (independent parameter mutations only)
  correlation_aware_mutation: false

# === CONFIGURATION VALIDATION ===
# Automatic validation on config load
config_validation:
  # Validate bounds are within acceptable ranges
  # Ensures min < max for all parameters
  # Ensures values are positive and realistic
  validate_on_load: true

  # Strict mode: Fail on invalid configuration
  # When true: Raise exception if config is invalid
  # When false: Log warnings and use defaults
  #
  # Recommended: true (fail-fast)
  strict_mode: true
