# Phase 1 Dry-Run Test Configuration
# =====================================
# Purpose: Test Gemini 2.5 Flash Lite LLM innovation with dry-run protection
# Date: 2025-10-30
# Expected: 20 iterations, ~4 LLM innovations, Champion unchanged

# Import base configuration
# (This is a symbolic representation - actual implementation uses inheritance)
# base: learning_system.yaml

# ============================================================================
# LLM Configuration - Flash Lite Dry-Run Test
# ============================================================================
llm:
  # ✅ ENABLE LLM INNOVATION
  enabled: true

  # Provider: Use Google Gemini
  provider: gemini

  # Model: Gemini 2.5 Flash Lite (nearly free, 90% success rate validated)
  model: gemini-2.5-flash-lite

  # Innovation rate: 20% (4 out of 20 iterations)
  innovation_rate: 0.20

  # Dry-run mode: DO NOT UPDATE CHAMPION with LLM strategies
  # This allows us to evaluate strategy quality without risk
  dry_run: true

  # Fallback configuration
  fallback:
    enabled: true      # Auto-fallback to Factor Graph on LLM failure
    max_retries: 3     # Retry 3 times before fallback
    retry_delay: 2     # 2s initial delay

  # Generation settings
  generation:
    max_tokens: 2000   # Sufficient for YAML strategy generation
    temperature: 0.7   # Balanced creativity/reliability
    timeout: 60        # 60s timeout per generation

  # Google Gemini specific
  gemini:
    api_key: ${GOOGLE_API_KEY}
    model: gemini-2.5-flash-lite
    safety:
      block_none: false

  # Generation mode: structured YAML (90% success rate)
  mode: structured

# ============================================================================
# Autonomous Loop Configuration
# ============================================================================
autonomous:
  # Maximum iterations for this test
  max_iterations: 20

  # Enable iteration history tracking
  history:
    enabled: true
    save_interval: 1  # Save after every iteration
    path: artifacts/data/phase1_dryrun_flashlite_history.jsonl

  # Enable innovation tracking
  innovation_tracking:
    enabled: true
    save_path: artifacts/data/phase1_dryrun_flashlite_innovations.jsonl

# ============================================================================
# Validation Configuration
# ============================================================================
validation:
  # Comprehensive validation for LLM-generated strategies
  backtesting:
    enabled: true
    train_period:
      start: "2020-01-01"
      end: "2023-12-31"
    validation_period:
      start: "2024-01-01"
      end: "2024-06-30"
    test_period:
      start: "2024-07-01"
      end: "2024-10-08"

  # Baseline comparison (0050 Buy-and-Hold)
  baseline:
    enabled: true
    symbol: "0050"

  # Multi-objective validation
  metrics:
    sharpe_ratio:
      enabled: true
      min_threshold: 0.5  # Minimum acceptable Sharpe
    max_drawdown:
      enabled: true
      max_threshold: 0.30  # Maximum acceptable drawdown (30%)
    win_rate:
      enabled: true
      min_threshold: 0.45  # Minimum win rate (45%)

# ============================================================================
# Champion Management - DRY RUN MODE
# ============================================================================
champion:
  # ⚠️ DRY-RUN: Do not update champion with LLM strategies
  # This protects the current champion (2.4751 Sharpe) during testing
  update_strategy: "dry_run"  # Options: "always", "if_better", "dry_run"

  # Preserve current champion
  preserve_current: true

  # Log LLM strategy comparisons for quality analysis
  log_comparisons: true
  comparison_log_path: artifacts/data/phase1_dryrun_flashlite_comparisons.json

# ============================================================================
# Logging Configuration
# ============================================================================
logging:
  level: INFO

  # Detailed LLM innovation logging
  llm_innovation:
    enabled: true
    level: DEBUG
    log_prompt: true      # Log prompts sent to LLM
    log_response: true    # Log raw LLM responses
    log_yaml: true        # Log extracted YAML
    log_code: true        # Log generated Python code
    log_validation: true  # Log validation results

  # Strategy quality metrics logging
  strategy_quality:
    enabled: true
    save_path: artifacts/data/phase1_dryrun_flashlite_quality_metrics.jsonl

# ============================================================================
# Sandbox Configuration (Docker enabled by default)
# ============================================================================
sandbox:
  enabled: true
  docker:
    enabled: true
    image: finlab-sandbox:latest
    timeout: 30
    memory_limit: "512m"
    cpu_limit: 1.0

# ============================================================================
# Strategy Quality Evaluation
# ============================================================================
quality_evaluation:
  # Enable comprehensive quality scoring
  enabled: true

  # Metrics for quality evaluation
  metrics:
    # Performance metrics (40% weight)
    performance:
      sharpe_ratio: 0.20
      annual_return: 0.10
      calmar_ratio: 0.10

    # Risk metrics (30% weight)
    risk:
      max_drawdown: 0.15
      volatility: 0.05
      var_95: 0.10

    # Practical metrics (30% weight)
    practical:
      win_rate: 0.10
      position_count: 0.05
      turnover_rate: 0.05
      holding_period_avg: 0.05
      diversification: 0.05

  # Innovation metrics (bonus points)
  innovation:
    # Bonus for using non-predefined factor combinations
    novel_factor_bonus: 0.10
    # Bonus for structural innovation (custom calculations)
    structural_innovation_bonus: 0.05

# ============================================================================
# Test Success Criteria
# ============================================================================
test_success_criteria:
  # Must complete all iterations
  iterations_completed: 20

  # Expected LLM usage
  llm_innovations_expected: 4  # 20% of 20 iterations
  llm_innovations_min: 3       # At least 3 LLM strategies generated

  # LLM success rate
  llm_success_rate_min: 0.75   # At least 75% of LLM attempts succeed

  # Strategy quality (average across all LLM strategies)
  avg_sharpe_min: 0.5          # Average Sharpe ≥ 0.5
  best_sharpe_min: 1.0         # At least one strategy with Sharpe ≥ 1.0

  # Diversity maintenance
  diversity_min: 0.30          # Population diversity ≥ 30%

  # Champion preservation
  champion_unchanged: true     # Current champion (2.4751) must remain unchanged
