{
  "iteration_num": 6,
  "code": "# 1. Load data\nclose = data.get('price:\u6536\u76e4\u50f9')\nvolume = data.get('price:\u6210\u4ea4\u80a1\u6578')\nrevenue_yoy = data.get('monthly_revenue:\u53bb\u5e74\u540c\u6708\u589e\u6e1b(%)')\nroe = data.get('fundamental_features:ROE\u7a05\u5f8c')\npe_ratio = data.get('price_earning_ratio:\u672c\u76ca\u6bd4')\n\n# 2. Calculate factors\n# Momentum factor (20-day return)\nreturns_20d = close.pct_change(20).shift(1)\n\n# Revenue growth factor (YoY)\nrevenue_growth_factor = revenue_yoy.shift(1)\n\n# ROE factor\nroe_factor = roe.shift(1)\n\n# Inverse P/E ratio factor (lower P/E is better)\n# Handle potential division by zero or negative P/E\ninverse_pe_factor = (1 / pe_ratio).replace([float('inf'), -float('inf')], 0).shift(1)\n\n# 3. Combine factors\n# Normalize factors (simple min-max normalization for illustration, though Finlab often handles this implicitly)\n# For simplicity, we'll combine directly, assuming relative ranking is what matters.\n# Higher returns, higher revenue growth, higher ROE, lower PE are generally better.\ncombined_factor = (\n    returns_20d * 0.3 +\n    revenue_growth_factor * 0.3 +\n    roe_factor * 0.2 +\n    inverse_pe_factor * 0.2\n)\n\n# 4. Apply filters\n# Liquidity filter: average daily trading value over 20 days > 50 million TWD\ntrading_value = data.get('price:\u6210\u4ea4\u91d1\u984d')\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n\n# Price filter: stock price > 10 TWD\nprice_filter = close.shift(1) > 10\n\n# Combine filters\nfinal_filter = liquidity_filter & price_filter\n\n# 5. Select stocks\n# Apply filters and select the top 10 stocks based on the combined factor\nposition = combined_factor[final_filter].is_largest(10)\n\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
  "parameters": {
    "datasets": [
      "fundamental_features:ROE\u7a05\u5f8c",
      "monthly_revenue:\u53bb\u5e74\u540c\u6708\u589e\u6e1b(%)",
      "price:\u6210\u4ea4\u80a1\u6578",
      "price:\u6210\u4ea4\u91d1\u984d",
      "price:\u6536\u76e4\u50f9",
      "price_earning_ratio:\u672c\u76ca\u6bd4"
    ],
    "liquidity_threshold": 50,
    "roe_smoothing_window": 1,
    "roe_type": "raw",
    "revenue_handling": "simple_shift",
    "value_factor": "pe_ratio",
    "price_filter": 10,
    "volume_filter": null,
    "factor_combination": "returns_20d * 0.3 +     revenue_growth_factor * 0.3 +     roe_factor * 0.2 +     inverse_pe_factor * 0.2"
  },
  "metrics": {
    "total_return": 0.43943126047094666,
    "annual_return": 0.11953852782851668,
    "sharpe_ratio": 2.4751337704804173,
    "max_drawdown": -0.15238839675266508,
    "win_rate": 0.31606829325386526,
    "position_count": 3277
  },
  "success_patterns": [
    "price > 10 TWD - Filters penny stocks"
  ],
  "timestamp": "2025-10-08T12:40:12.725776"
}