{
  "iteration_num": 2,
  "code": "# 1. Load data\nclose = data.get('price:\u6536\u76e4\u50f9')\nvolume = data.get('price:\u6210\u4ea4\u80a1\u6578')\nrevenue_yoy = data.get('monthly_revenue:\u53bb\u5e74\u540c\u6708\u589e\u6e1b(%)')\nroe = data.get('fundamental_features:ROE\u7a05\u5f8c')\npe_ratio = data.get('price_earning_ratio:\u672c\u76ca\u6bd4')\ntrading_value = data.get('price:\u6210\u4ea4\u91d1\u984d')\n\n# 2. Calculate factors\n# Factor 1: Momentum (20-day return)\nmomentum = close.pct_change(20).shift(1)\n\n# Factor 2: Revenue Growth (YoY)\n# Use the latest available monthly revenue YoY for the current trading day\n# Finlab's data handling usually aligns monthly data to daily, so a simple shift should work\nrevenue_growth_factor = revenue_yoy.shift(1)\n\n# Factor 3: Return on Equity (ROE)\n# Use the latest available ROE\nroe_factor = roe.shift(1)\n\n# Factor 4: Valuation (Inverse P/E ratio)\n# Lower P/E is generally better, so we take the inverse\n# Add a small epsilon to avoid division by zero for P/E values of 0\npe_inverse_factor = (1 / (pe_ratio + 0.001)).shift(1)\n\n# 3. Combine factors\n# Normalize factors to a 0-1 range (or similar) if their scales are vastly different,\n# but for simplicity, we'll combine them directly with weights.\n# We want high momentum, high revenue growth, high ROE, and low P/E.\ncombined_factor = (momentum * 0.3) + \\\n                  (revenue_growth_factor * 0.3) + \\\n                  (roe_factor * 0.2) + \\\n                  (pe_inverse_factor * 0.2)\n\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over the last 20 days must be above 100 million TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 100_000_000\n\n# Volume filter: Average daily volume over the last 20 days must be above 1,000,000 shares\navg_volume = volume.rolling(20).mean().shift(1)\nvolume_filter = avg_volume > 1_000_000\n\n# Price filter: Close price must be above 10 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 10\n\n# Combine all filters\nall_filters = liquidity_filter & volume_filter & price_filter\n\n# 5. Select stocks\n# Apply filters to the combined factor and then select the top 10 stocks\nposition = combined_factor[all_filters].is_largest(10)\n\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
  "parameters": {
    "datasets": [
      "fundamental_features:ROE\u7a05\u5f8c",
      "monthly_revenue:\u53bb\u5e74\u540c\u6708\u589e\u6e1b(%)",
      "price:\u6210\u4ea4\u80a1\u6578",
      "price:\u6210\u4ea4\u91d1\u984d",
      "price:\u6536\u76e4\u50f9",
      "price_earning_ratio:\u672c\u76ca\u6bd4"
    ],
    "liquidity_threshold": 100000000,
    "roe_smoothing_window": 1,
    "roe_type": "raw",
    "revenue_handling": "simple_shift",
    "value_factor": "pe_ratio",
    "price_filter": 10,
    "volume_filter": 1000000,
    "factor_combination": "momentum * 0.3"
  },
  "metrics": {
    "total_return": 0.5246724811011767,
    "annual_return": -0.13813429612717812,
    "sharpe_ratio": 1.5756534471234689,
    "max_drawdown": -0.39065437781505674,
    "win_rate": 0.34239537709104495,
    "position_count": 3277
  },
  "success_patterns": [
    "liquidity_filter > 100,000,000 TWD - Selects stable, high-volume stocks",
    "price > 10 TWD - Filters penny stocks",
    "volume > 1,000,000 shares - Ensures adequate trading volume"
  ],
  "timestamp": "2025-10-08T09:15:05.276920"
}