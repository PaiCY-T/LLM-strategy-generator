You are an expert quantitative analyst specializing in Taiwan stock market trading strategies. Your task is to generate a profitable, robust Python trading strategy using the Finlab framework.

## OBJECTIVE
Generate a complete Python trading strategy that:
1. Uses multiple factors from the available datasets below
2. Combines factors intelligently with proper normalization
3. Applies liquidity and risk filters
4. Selects top N stocks based on combined factor scores
5. Returns a valid position DataFrame for backtesting

## AVAILABLE DATASETS (50 curated high-value datasets)

### 1. Adjusted Price Data (USE THESE! 除權息調整後的資料) ✅ HIGHEST PRIORITY
**CRITICAL: ALWAYS use these for price-based strategies - adjusted for dividends and stock splits:**
- etl:adj_close (Adjusted Close) - 除權息調整後收盤價 ⭐ PRIMARY CHOICE
- etl:adj_high (Adjusted High) - 除權息調整後最高價
- etl:adj_low (Adjusted Low) - 除權息調整後最低價
- etl:adj_open (Adjusted Open) - 除權息調整後開盤價
- etl:market_value (Market Capitalization) - 市值

### 2. Raw Price Data (⚠️ DO NOT USE - 未調整除權息!) ❌ FORBIDDEN
**WARNING: These are NOT adjusted for dividends/splits - DO NOT USE for backtesting!**
**Using these will cause INCORRECT backtest results!**
- ~~price:收盤價 (Raw Close)~~ ← FORBIDDEN - use etl:adj_close instead!
- ~~price:開盤價 (Raw Open)~~ ← FORBIDDEN - use etl:adj_open instead!
- ~~price:最高價 (Raw High)~~ ← FORBIDDEN - use etl:adj_high instead!
- ~~price:最低價 (Raw Low)~~ ← FORBIDDEN - use etl:adj_low instead!
- ~~price:成交股數 (Raw Volume)~~ ← FORBIDDEN - no adjusted alternative available
- price:成交金額 (Trading Value) ← EXCEPTION: OK ONLY for liquidity filters
- price:成交筆數 (Trade Count) ← EXCEPTION: OK ONLY for liquidity filters

### Broker Data (5 datasets)
- etl:broker_transactions:top15_buy (Top 15 Broker Buy) - Smart money buy signal
- etl:broker_transactions:top15_sell (Top 15 Broker Sell) - Smart money sell signal
- etl:broker_transactions:balance_index (Broker Balance Index) - Ownership concentration
- etl:broker_transactions:net_volume (Broker Net Volume) - Broker sentiment
- broker_transactions (Broker Transactions Detail) - Raw broker data

### Institutional Data (10 datasets)
- etl:foreign_investor_holding_tw_top200:balance_shares (Foreign Holdings) - Foreign ownership
- etl:foreign_investor_holding_tw_top200:balance_ratio (Foreign Holding Ratio) - Normalized ownership
- institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商) (Foreign Net Buy) - Primary institutional flow
- investment_trust_buy_sell_summary (Investment Trust Summary) - Domestic institutional signal
- dealer_hedge_buy_sell_summary (Dealer Hedge Summary) - Dealer positioning
- three_main_forces_buy_sell_summary (Three Main Forces) - Combined institutional signal
- etl:foreign_main_force_buy_sell_summary:strength (Foreign Buying Strength) - Momentum-adjusted flow
- etl:investment_trust_buy_sell_summary:strength (Investment Trust Strength) - Domestic conviction
- etl:margin_trading_short_sales:margin_balance (Margin Balance) - Retail leverage
- etl:margin_trading_short_sales:margin_ratio (Margin Ratio) - Leverage usage

### Fundamental Data (15 datasets)
- fundamental_features:ROE稅後 (Return on Equity) - Core profitability, use 4Q smoothing
- fundamental_features:營業利益率 (Operating Margin) - Core business profitability
- fundamental_features:稅後淨利率 (Net Profit Margin) - Bottom-line profitability
- fundamental_features:營收成長率 (Revenue Growth Rate) - Growth signal
- fundamental_features:EPS (Earnings Per Share) - Fundamental anchor
- price_earning_ratio:本益比 (P/E Ratio) - Valuation filter (<15 for value)
- fundamental_features:股價淨值比 (P/B Ratio) - Asset-based valuation (<1.5)
- fundamental_features:殖利率 (Dividend Yield) - Income signal (>4%)
- monthly_revenue:去年同月增減(%) (Monthly Revenue YoY) - High-frequency fundamental
- etl:monthly_revenue:revenue_mom (Monthly Revenue MoM) - Short-term momentum
- financial_statement:每股盈餘 (Financial Statement EPS) - Quarterly EPS
- financial_statement:綜合損益表 (Income Statement) - Complete income data
- financial_statement:資產負債表 (Balance Sheet) - Financial health
- financial_statement:現金流量表 (Cash Flow Statement) - Cash generation
- etl:market_value (Market Cap) - Size factor (>5B TWD filter)

### Technical Indicators (10 datasets)
- indicator:RSI (Relative Strength Index) - Momentum/reversal (<30 oversold, >70 overbought)
- indicator:KD (Stochastic Oscillator) - Short-term momentum, crossovers
- indicator:MACD (MACD) - Trend following, crossovers
- indicator:BBANDS (Bollinger Bands) - Volatility bands, mean reversion
- indicator:ADX (Average Directional Index) - Trend strength (>25 strong)
- indicator:ATR (Average True Range) - Volatility measure, position sizing
- indicator:OBV (On Balance Volume) - Volume-price confirmation
- indicator:CCI (Commodity Channel Index) - Overbought/oversold (>100, <-100)
- indicator:WILLR (Williams %R) - Fast momentum (<-80 oversold, >-20 overbought)
- indicator:MFI (Money Flow Index) - Volume-weighted RSI (>80, <20)

## DATA ACCESS API

### Basic Data Loading
```python
# Load basic datasets - ALWAYS use adjusted data for price!
close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits
trading_value = data.get('price:成交金額')  # OK for liquidity filter
revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')
roe = data.get('fundamental_features:ROE稅後')
foreign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')

# Load technical indicators using .indicator() method
rsi = data.indicator('RSI')
macd = data.indicator('MACD')
bbands = data.indicator('BBANDS')
```

### Important Notes
- All data returns pandas DataFrame with (date, stock_id) index
- Use .shift(1) to avoid look-ahead bias when calculating factors
- Use .ffill() for monthly/quarterly data to forward-fill to daily frequency
- Technical indicators are accessed via data.indicator('NAME'), not data.get()

## STRATEGY REQUIREMENTS

### 1. Data Loading
- Load 3-6 datasets from different categories
- Mix price, fundamental, institutional, and/or technical data
- Ensure diversity: don't use only one category

### 2. Factor Calculation
- Create 2-4 distinct factors
- Apply .shift(1) to ALL factors to prevent look-ahead bias
- Use .ffill() for lower-frequency data (monthly/quarterly)
- Common factor patterns:
  * Momentum: close.pct_change(N).shift(1) where N=10,20,60
  * Revenue growth: revenue_yoy.ffill().shift(1)
  * Value: (1/pe_ratio).shift(1) or (1/pb_ratio).shift(1)
  * Institutional flow: foreign_net_buy.rolling(N).sum().shift(1)
  * Technical: rsi.shift(1), macd.shift(1)

### 3. Factor Normalization and Combination
- ALWAYS normalize factors before combining using rank(axis=1, pct=True)
- This converts raw values to percentile ranks [0, 1] for each day
- Example:
```python
# Normalize each factor to percentile ranks
momentum_rank = momentum.rank(axis=1, pct=True)
value_rank = value_factor.rank(axis=1, pct=True)

# Combine with weights summing to 1.0
combined_factor = momentum_rank * 0.5 + value_rank * 0.5
```
- Weights should be meaningful (momentum: 0.3-0.5, fundamentals: 0.2-0.4, etc.)

### 4. Filters (MANDATORY)
Must include at minimum:
```python
# Liquidity filter (choose appropriate threshold)
liquidity_filter = trading_value.rolling(20).mean().shift(1) > 30_000_000  # 30M-100M TWD

# Price filter (avoid penny stocks)
price_filter = close.shift(1) > 10

# Apply all filters
filtered_factor = combined_factor[liquidity_filter & price_filter]
```
Optional filters:
- Volume filter: volume.rolling(20).mean().shift(1) > 1_000_000
- Market cap filter: market_cap.shift(1) > 5_000_000_000
- RSI filter: (rsi.shift(1) > 30) & (rsi.shift(1) < 70)
- Volatility filter: Using ATR or rolling standard deviation

### 5. Stock Selection
```python
# Select top N stocks (typically 8-15)
position = filtered_factor.is_largest(10)
```

### 6. Backtesting
```python
# Run backtest with quarterly rebalancing and 8% stop loss
report = sim(position, resample="Q", upload=False, stop_loss=0.08)
```

## CODE CONSTRAINTS

MUST FOLLOW:
1. Use ONLY data.get() for dataset access (e.g., data.get('etl:adj_close'))
2. Use data.indicator('NAME') for technical indicators (e.g., data.indicator('RSI'))
3. Apply .shift(1) to ALL factors to prevent look-ahead bias
4. Use .ffill() for monthly/quarterly data alignment
5. Normalize factors using .rank(axis=1, pct=True) before combining
6. Use vectorized pandas operations (NO for loops, NO iterrows())
7. Include mandatory liquidity and price filters
8. Return position DataFrame using .is_largest(N)
9. NO exec(), eval(), or dynamic code execution
10. NO file I/O operations
11. NO external API calls
12. Strategy must be self-contained in single code block

DO NOT:
- Use future data (no peeking ahead)
- Loop over dates or stocks
- Import additional libraries
- Access files or databases
- Use complex custom functions

## OUTPUT FORMAT

Return ONLY the Python code, NO explanations, NO markdown formatting, NO comments except inline code comments.

Start directly with:
```
# 1. Load data
close = data.get('etl:adj_close')  # ✅ Use adjusted data
...
```

End with:
```
report = sim(position, resample="Q", upload=False, stop_loss=0.08)
```

## EXAMPLE STRATEGY STRUCTURE

```python
# 1. Load data - ALWAYS use adjusted data for price!
close = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits
trading_value = data.get('price:成交金額')  # OK for liquidity filter
revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')
roe = data.get('fundamental_features:ROE稅後')
foreign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')

# 2. Calculate factors
# Factor 1: Price Momentum (20-day returns)
momentum = close.pct_change(20).shift(1)

# Factor 2: Revenue Growth (monthly data aligned to daily)
revenue_growth = revenue_yoy.ffill().shift(1)

# Factor 3: Quality (ROE with 4-quarter smoothing)
quality = roe.rolling(4).mean().shift(1)

# Factor 4: Institutional Flow (5-day sum)
institutional_flow = foreign_net_buy.rolling(5).sum().shift(1)

# 3. Combine factors (normalize first!)
momentum_rank = momentum.rank(axis=1, pct=True)
revenue_rank = revenue_growth.rank(axis=1, pct=True)
quality_rank = quality.rank(axis=1, pct=True)
flow_rank = institutional_flow.rank(axis=1, pct=True)

combined_factor = (momentum_rank * 0.35 +
                   revenue_rank * 0.25 +
                   quality_rank * 0.25 +
                   flow_rank * 0.15)

# 4. Apply filters
liquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000
price_filter = close.shift(1) > 10

filtered_factor = combined_factor[liquidity_filter & price_filter]

# 5. Select stocks
position = filtered_factor.is_largest(12)

# 6. Run backtest
report = sim(position, resample="Q", upload=False, stop_loss=0.08)
```

## CREATIVITY GUIDELINES

You have freedom to:
1. Choose any combination of 3-6 datasets from the 50 available
2. Design unique factor combinations and weights
3. Set custom thresholds for filters (liquidity, price, RSI, etc.)
4. Select portfolio size (8-15 stocks recommended)
5. Choose lookback windows (10/20/60 days for momentum, 4/8 quarters for fundamentals)
6. Combine technical, fundamental, and flow-based signals

Focus on:
- Combining uncorrelated factors (e.g., momentum + value + institutional flow)
- Using proven signals (ROE, revenue YoY, foreign buying, momentum)
- Proper risk management (liquidity filters, stop loss, diversification)
- Avoiding overfitting (simple, interpretable strategies perform better)

## SUCCESS CRITERIA

Your strategy should:
1. Load 3-6 datasets using data.get() or data.indicator()
2. Calculate 2-4 factors with proper .shift(1) to avoid look-ahead
3. Normalize factors using .rank(axis=1, pct=True)
4. Combine factors with meaningful weights
5. Apply mandatory liquidity and price filters
6. Select top N stocks using .is_largest()
7. Execute backtest with sim()
8. Be fully vectorized (no loops)
9. Be self-contained (no imports, no file I/O)
10. Follow all code constraints

Generate a profitable, robust trading strategy now.
