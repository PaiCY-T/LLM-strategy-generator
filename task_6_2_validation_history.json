{
  "records": [
    {
      "iteration_num": 0,
      "timestamp": "2025-11-02T06:39:13.751376",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return), shifted to prevent look-ahead bias\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY), shifted\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE factor, shifted\n    roe_factor = roe.shift(1)\n\n    # PE Ratio, shifted\n    pe_factor = pe_ratio.shift(1)\n\n    # 3. Liquidity Filter: Average daily volume > 150M TWD\n    # Calculate 20-day average volume in shares, then multiply by close price to get TWD\n    avg_volume_value = (volume.rolling(20).mean() * close).shift(1)\n    liquid_stocks = (avg_volume_value > 150_000_000).fillna(False)\n\n    # 4. Strategy Rules - Combining successful patterns and targeted improvements\n    # Retain high ROE and positive revenue growth\n    # Improve by adding a more stringent momentum filter and a value tilt (lower PE)\n    \n    # Quality filter: ROE > 10%\n    quality_filter = (roe_factor > 10)\n\n    # Growth filter: Revenue YoY growth > 0%\n    growth_filter = (revenue_growth_factor > 0)\n\n    # Momentum filter: Top 30% of stocks by 20-day return\n    # This is a key improvement over a simple positive return filter\n    momentum_filter = returns_20d.rank(axis=1, ascending=False) <= (returns_20d.shape[1] * 0.3)\n    momentum_filter = momentum_filter.fillna(False)\n\n    # Value filter: PE Ratio below 20 and not negative (avoiding distressed companies)\n    # This adds a value component to potentially smooth returns and reduce drawdown\n    value_filter = (pe_factor > 0) & (pe_factor < 20)\n    \n    # Combine all filters\n    # All conditions must be met for a stock to be selected\n    position = quality_filter & growth_filter & momentum_filter & value_filter & liquid_stocks\n    \n    # Handle NaN values explicitly where filters might produce them if not already handled\n    position = position.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:39:09.201805",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-02T06:39:09.220300",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-02T06:39:32.608766",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nmonthly_revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Long-Term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Fundamental Strength (ROE and Revenue Growth)\n# Smooth ROE over 4 quarters and forward-fill\nroe_smoothed = roe.rolling(4).mean().ffill().shift(1)\n# Forward-fill monthly revenue YoY\nrevenue_growth = monthly_revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth\nfundamental_strength = (roe_smoothed * 0.6 + revenue_growth * 0.4)\n# Factor 3: Institutional Conviction (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Short-term Reversal (Inverse RSI, lower RSI is better)\n# We use 100 - RSI so that higher values indicate more oversold conditions\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nfundamental_strength_rank = fundamental_strength.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weighted average\ncombined_factor = (momentum_rank * 0.35 +\n                   fundamental_strength_rank * 0.30 +\n                   institutional_flow_rank * 0.25 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions for a balanced strategy\n# We want RSI to be in a reasonable range, not too high (overbought) nor too low (oversold)\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_range_filter]\n# 5. Select stocks (top 10 stocks based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:39:13.801014",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-02T06:39:38.161631",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors, ensuring no look-ahead bias with .shift(1)\n    # Momentum factor: 20-day return, shifted\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY), shifted\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE filter: High ROE (e.g., > 10%)\n    roe_filter = (roe.shift(1) > 10)\n\n    # Price momentum: Rank stocks by 20-day return\n    # Use a longer lookback for momentum to capture stronger trends\n    momentum_rank = returns_20d.rank(axis=1, ascending=False)\n\n    # Add a longer-term momentum component (e.g., 60-day return)\n    returns_60d = close.pct_change(60).shift(1)\n    long_term_momentum_rank = returns_60d.rank(axis=1, ascending=False)\n\n    # Moving average crossover (e.g., 20-day SMA > 60-day SMA)\n    # This acts as a trend filter to avoid downtrends\n    sma_20 = close.rolling(20).mean().shift(1)\n    sma_60 = close.rolling(60).mean().shift(1)\n    ma_crossover = (sma_20 > sma_60)\n\n    # Combine revenue growth with a higher threshold for better quality growth\n    # Also ensure revenue growth is positive\n    revenue_growth_strong = (revenue_growth_factor > 15)\n\n    # Price-to-Earnings Ratio Filter: Avoid extremely high PE ratios, but also not too low (value trap)\n    # Focus on reasonable valuations for growth stocks\n    pe_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 30)\n\n    # 3. Liquidity filter: Average daily volume > 150M TWD\n    # Calculate average daily volume over 20 days\n    avg_volume = (volume.rolling(20).mean() * close).shift(1)\n    liquidity_filter = (avg_volume > 150_000_000)\n\n    # 4. Combine all conditions for entry\n    # Prioritize strong ROE, robust revenue growth, and positive momentum with a trend filter\n    # and reasonable valuation.\n    # Weight momentum higher by selecting top performers.\n    condition = (\n        roe_filter &                               # High ROE for quality\n        revenue_growth_strong &                     # Strong revenue growth\n        (momentum_rank <= 0.2 * len(close.columns)) & # Top 20% by 20-day momentum\n        (long_term_momentum_rank <= 0.3 * len(close.columns)) & # Top 30% by 60-day momentum\n        ma_crossover &                              # Ensure upward trend\n        pe_filter &                                 # Reasonable valuation\n        liquidity_filter                            # Ensure sufficient liquidity\n    )\n\n    # Fill NaN values with False to prevent errors\n    position = condition.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:39:32.640680",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-02T06:39:52.455659",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Use adjusted data\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # For market cap filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow factor\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Forward-fill monthly/quarterly data to daily frequency, then shift\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Forward-fill monthly data to daily frequency, then shift\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (Foreign Buying Strength)\n# Shift to avoid look-ahead bias\ninstitutional_flow = foreign_strength.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD\nprice_filter = close.shift(1) > 15\n# Market capitalization filter: Market cap > 5 Billion TWD\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:39:38.187967",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-02T06:40:10.653776",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # For market cap filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\nrsi = data.indicator('RSI') # Technical indicator for filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Higher momentum is better\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill then take rolling mean. Higher ROE is better.\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\n# Higher YoY revenue growth is better\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\n# Positive foreign net buy indicates institutional interest. Higher is better.\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0. Prioritize momentum and quality.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD for mid-large caps\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:39:52.486077",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-02T06:40:23.182192",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Higher momentum is better\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Higher ROE is better\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Higher revenue growth is better\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\n# Positive net buy indicates institutional interest\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\n# Weights are chosen to balance different factor types\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:40:10.687364",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-02T06:40:38.592739",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then smooth\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Adjusted close price > 20 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (focus on mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: RSI between 30 and 70 (avoiding extreme overbought/oversold conditions)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks (top 12 stocks based on combined factor score)\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:40:23.218909",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-02T06:40:43.729055",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return) - preserved from champion\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - preserved from champion\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE filter - preserved from champion, adding a minimum threshold\n    roe_filter = roe.shift(1) > 10 # Require ROE > 10%\n\n    # Price-to-Earnings Ratio filter - new addition for value tilt\n    # Use 3-month average PE to smooth out noise, filter for reasonable value\n    pe_ratio_smoothed = pe_ratio.rolling(60).mean().shift(1) # Using 60 days for ~3 months\n    pe_filter = (pe_ratio_smoothed > 5) & (pe_ratio_smoothed < 25) # Avoid extreme low/high PE\n\n    # Moving Average Crossover for trend confirmation - new addition\n    # Use 50-day and 200-day simple moving averages\n    ma_50 = close.rolling(50).mean().shift(1)\n    ma_200 = close.rolling(200).mean().shift(1)\n    ma_crossover = ma_50 > ma_200 # Golden cross indicator\n\n    # Combine momentum, revenue growth, and ROE for initial selection\n    # Emphasize stronger growth and momentum for higher Sharpe\n    # Rank momentum and growth, then select top quartile\n    momentum_rank = returns_20d.rank(axis=1, ascending=False)\n    growth_rank = revenue_growth_factor.rank(axis=1, ascending=False)\n\n    # Combine ranks and filter for top performers\n    # Target stocks with strong combined momentum and growth, and good ROE\n    stock_selection = (momentum_rank <= len(close.columns) / 4) & \\\n                      (growth_rank <= len(close.columns) / 4) & \\\n                      roe_filter & \\\n                      pe_filter & \\\n                      ma_crossover\n\n    # 3. Liquidity filter - preserved and enhanced for robustness\n    # Ensure average daily volume > 150M TWD (volume * close price)\n    avg_daily_value = (volume * close).rolling(20).mean().shift(1)\n    liquidity_filter = avg_daily_value > 150_000_000\n\n    # 4. Final selection combining all conditions\n    position = stock_selection & liquidity_filter\n\n    # Handle NaN values explicitly, assuming False for non-selected stocks\n    position = position.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:40:38.635863",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-02T06:40:56.909580",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then take rolling mean\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, forward-filled)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average 20-day trading value > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:40:43.765358",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-02T06:41:12.917515",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(4*20).mean().shift(1) # Approx 4 quarters of daily data\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI Reversal (Inverse of RSI to favor oversold conditions)\n# Lower RSI (e.g., < 30) means higher (100 - RSI), indicating potential reversal\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter]\n# 5. Select stocks (top 15 stocks based on combined factor score)\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:40:56.941633",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 10,
      "timestamp": "2025-11-02T06:41:17.515635",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n    open_price = data.get('price:開盤價') # Added for more robust momentum\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return, using open to close for less noise)\n    # Shifted by 1 to prevent look-ahead bias\n    returns_20d = (close.shift(1) / open_price.shift(21) - 1).shift(1)\n\n    # Revenue growth factor (YoY), shifted by 1\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE quality filter (ROE > 10% for quality, shifted by 1)\n    roe_filter = (roe.shift(1) > 10)\n\n    # Price-to-Earnings Ratio filter (PE < 30 for value, shifted by 1)\n    # Added PE ratio to balance growth with value\n    pe_filter = (pe_ratio.shift(1) < 30)\n\n    # Moving average crossover (5-day MA > 20-day MA for short-term trend confirmation)\n    # Shifted by 1\n    ma_5 = close.rolling(window=5).mean().shift(1)\n    ma_20 = close.rolling(window=20).mean().shift(1)\n    ma_crossover = (ma_5 > ma_20)\n\n    # Liquidity filter: Average daily turnover > 150M TWD (price * volume)\n    # Adjusted for FinLab's '成交股數' (shares), so total value.\n    # Shifted by 1\n    avg_daily_turnover = (close * volume).rolling(window=20).mean().shift(1)\n    liquidity_filter = (avg_daily_turnover > 150_000_000)\n\n    # 3. Combine factors\n    # Strengthened momentum and revenue growth requirements, added MA confirmation and PE for value\n    # All factors must be true\n    signal = (\n        (returns_20d > 0.05) &  # Increased momentum threshold\n        (revenue_growth_factor > 15) &  # Increased revenue growth threshold\n        roe_filter &\n        pe_filter & # New: Added PE ratio filter\n        ma_crossover & # New: Added MA crossover for trend confirmation\n        liquidity_filter\n    )\n\n    # 4. Handle NaN values and return positions\n    # Fill NaN with False for the boolean series\n    position = signal.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets",
        "Unknown dataset key: 'price:開盤價' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n- Unknown dataset key: 'price:開盤價' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:41:12.954833",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 11,
      "timestamp": "2025-11-02T06:41:34.407637",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market Capitalization\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign buying strength\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY\nrsi = data.indicator('RSI') # Relative Strength Index\n# 2. Calculate factors\n# Factor 1: Mid-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Foreign Buying Strength (forward-fill and shift for daily alignment)\n# Foreign strength is typically a lower frequency signal, so ffill is appropriate.\nforeign_strength_factor = foreign_strength.ffill().shift(1)\n# Factor 3: Quality (ROE with 4-quarter smoothing, forward-fill and shift)\n# ROE is quarterly, so ffill and rolling mean for smoothing.\nquality_factor = roe.rolling(4, min_periods=1).mean().ffill().shift(1)\n# Factor 4: Revenue Growth (Monthly YoY, forward-fill and shift)\n# Monthly revenue data, so ffill for daily alignment.\nrevenue_growth_factor = revenue_yoy.ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nforeign_strength_rank = foreign_strength_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth_factor.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.40 +\n                   foreign_strength_rank * 0.25 +\n                   quality_rank * 0.20 +\n                   revenue_growth_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Close price > 25 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 25\n# Market Cap filter: Market value > 15B TWD for mid-large cap stocks\nmarket_cap_filter = market_value.ffill().shift(1) > 15_000_000_000\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 35 and 65)\nrsi_filter = (rsi.shift(1) > 35) & (rsi.shift(1) < 65)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:41:17.579362",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 12,
      "timestamp": "2025-11-02T06:41:52.697313",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign institutional flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical momentum\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum_60d = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() for quarterly data, then shift(1)\nquality_roe = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# ffill() for monthly data, then shift(1)\ngrowth_revenue = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI (Short-term momentum confirmation)\nrsi_factor = rsi.shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_60d.rank(axis=1, pct=True)\nquality_roe_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_revenue_rank = growth_revenue.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_rank = rsi_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_roe_rank * 0.20 +\n                   growth_revenue_rank * 0.20 +\n                   institutional_flow_rank * 0.20 +\n                   rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 70M TWD over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI health filter: Avoid extreme overbought/oversold conditions\nrsi_health_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_health_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:41:34.450496",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 13,
      "timestamp": "2025-11-02T06:41:57.200783",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    roe = data.get('fundamental_features:ROE稅後')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors, preserving successful patterns and adding improvements\n\n    # Momentum factor: Short-term (20-day) and Medium-term (60-day) returns\n    returns_20d = close.pct_change(20).shift(1)\n    returns_60d = close.pct_change(60).shift(1) # Added medium-term momentum\n\n    # Revenue growth factor (YoY)\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE quality filter: Stronger ROE requirement and consistency over time\n    # Check if ROE is consistently high (e.g., > 15 for last 3 periods)\n    roe_quality = (roe.shift(1) > 15) & (roe.shift(2) > 15) & (roe.shift(3) > 15)\n\n    # Valuation factor: Use PE ratio to avoid overvalued stocks\n    # Filter out companies with very high PE ratios (e.g., top 20% or > 30)\n    pe_filter = pe_ratio.shift(1).rank(axis=1, pct=True) < 0.8 # Avoid top 20% by PE\n\n    # Moving average crossover for trend confirmation (5-day over 20-day)\n    # This adds a short-term trend following component to improve entry/exit\n    ma_5d = close.rolling(5).mean().shift(1)\n    ma_20d = close.rolling(20).mean().shift(1)\n    ma_crossover = ma_5d > ma_20d\n\n    # Liquidity filter: Average daily volume > 150M TWD\n    avg_volume_20d = (volume * close).rolling(20).mean().shift(1)\n    liquidity_filter = avg_volume_20d > 150_000_000\n\n    # 3. Combine factors to create a refined selection criteria\n    # Increased weight on quality (ROE consistency) and added MA crossover for trend\n    # Combined short and medium term momentum and added PE filter for value\n    selection_criteria = (\n        roe_quality &\n        (revenue_growth_factor > 0) & # Only positive revenue growth\n        (returns_20d > 0.05) &       # Stronger short-term momentum requirement\n        (returns_60d > 0.10) &       # Stronger medium-term momentum requirement\n        ma_crossover &               # Trend confirmation\n        pe_filter                    # Valuation filter\n    )\n\n    # 4. Apply liquidity filter\n    position = selection_criteria & liquidity_filter\n\n    # Handle NaN values by filling with False (no position)\n    position = position.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:41:52.735565",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 14,
      "timestamp": "2025-11-02T06:42:01.221697",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return), shifted to prevent look-ahead\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY), shifted\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE filter: Quality metric, higher ROE indicates better quality\n    roe_filter = roe.shift(1) > 10 # Maintain ROE filter, adjusted threshold slightly\n\n    # Price-to-Earnings Ratio filter: Lower PE indicates undervaluation, shifted\n    pe_filter = pe_ratio.shift(1) < 25 # Add a PE ratio filter for value component\n\n    # 3. Liquidity filter: Average daily volume > 150M TWD\n    # Calculate average daily turnover value\n    avg_turnover = (close * volume).rolling(window=20).mean().shift(1)\n    liquidity_filter = avg_turnover > 150_000_000\n\n    # 4. Combine factors to create a ranking score\n    # Normalize and combine momentum and revenue growth\n    # Use rank to standardize values and avoid bias from extreme values\n    momentum_rank = returns_20d.rank(axis=1, ascending=False)\n    revenue_growth_rank = revenue_growth_factor.rank(axis=1, ascending=False)\n\n    # Combine ranks for a composite score\n    # Give more weight to momentum as it's a strong driver in the champion\n    composite_score = (momentum_rank * 0.6) + (revenue_growth_rank * 0.4)\n\n    # 5. Apply all filters\n    # Filter for quality (ROE), value (PE), and liquidity\n    filtered_stocks = roe_filter & pe_filter & liquidity_filter\n\n    # 6. Select top stocks based on composite score\n    # Apply the filters to the composite score before ranking\n    selection_candidates = composite_score[filtered_stocks]\n\n    # Select the top 20 stocks (can be adjusted based on desired concentration)\n    # Using a smaller number of top stocks can improve concentration and potentially Sharpe\n    position = selection_candidates.rank(axis=1, ascending=True) <= 20 # Rank ascending for top scores\n\n    # Handle NaN values, ensuring no stock is selected if data is missing\n    position = position.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:41:57.236623",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 15,
      "timestamp": "2025-11-02T06:42:22.003750",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Use .ffill() to align quarterly data to daily frequency\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Use .ffill() to align monthly data to daily frequency\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI Reversal (Inverse of RSI, favoring oversold conditions)\n# Higher value means lower RSI (more oversold)\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0.\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI health filter: Avoid extreme overbought/oversold conditions for general health\nrsi_health_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_health_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:42:01.264451",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 16,
      "timestamp": "2025-11-02T06:42:39.775446",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_cap = data.get('etl:market_value')  # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後')  # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Foreign investor flow\npe_ratio = data.get('price_earning_ratio:本益比')  # P/E Ratio for value\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day adjusted returns)\nmomentum_factor = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined ROE and Revenue Growth)\n# Smoothed ROE (4-quarter average)\nroe_smoothed = roe.rolling(4).mean().ffill().shift(1)\n# Monthly Revenue YoY (forward-filled to daily)\nrevenue_growth_ffill = revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth\nquality_growth_factor = (roe_smoothed + revenue_growth_ffill) / 2\n# Factor 3: Institutional Flow (20-day cumulative foreign net buy)\ninstitutional_flow_factor = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Value (Inverse of P/E Ratio)\n# Add a small epsilon to avoid division by zero for P/E\nvalue_factor = (1 / (pe_ratio.shift(1) + 1e-6))\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum_factor.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth_factor.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0.\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_growth_rank * 0.30 +\n                   institutional_flow_rank * 0.25 +\n                   value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Adjusted close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (mid-large caps)\nmarket_cap_filter = market_cap.shift(1) > 10_000_000_000\n# P/E Ratio filter: P/E must be positive (avoiding companies with losses or extreme P/E)\npe_positive_filter = (pe_ratio.shift(1) > 0) & (pe_ratio.shift(1) < 50) # Cap P/E to avoid extremely high values\n# ROE filter: Ensure positive ROE for quality\nroe_positive_filter = roe.ffill().shift(1) > 0\n# Apply all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & pe_positive_filter & roe_positive_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:42:22.048022",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 17,
      "timestamp": "2025-11-02T06:42:44.470568",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return, shifted to prevent look-ahead)\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY, shifted)\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE factor (shifted)\n    roe_factor = roe.shift(1)\n\n    # 3. Liquidity filter (Average daily volume > 150M TWD)\n    # Convert volume to TWD by multiplying with close price\n    avg_daily_value = (volume * close).rolling(20).mean().shift(1)\n    liquidity_filter = avg_daily_value > 150_000_000\n\n    # 4. Define selection criteria\n    # Preserve high ROE and positive revenue growth\n    quality_growth_filter = (roe_factor > 8) & (revenue_growth_factor > 0)\n\n    # Enhance momentum filter: use a combination of short-term momentum and price relative to moving average\n    # Short-term momentum: top 30% of 20-day returns\n    momentum_filter = returns_20d.rank(axis=1, ascending=False) <= (returns_20d.notna().sum(axis=1) * 0.3)\n\n    # Price over long-term moving average (200-day SMA) to capture long-term trend, shifted\n    sma_200 = close.rolling(200).mean().shift(1)\n    price_above_sma = (close.shift(1) > sma_200)\n\n    # Combine all filters\n    # Stronger emphasis on quality, growth, and robust momentum signal\n    # Add a PE ratio filter to avoid extremely overvalued stocks, but not too strict\n    pe_filter = (pe_ratio.shift(1) < 30) & (pe_ratio.shift(1) > 0) # Avoid negative PE and excessively high PE\n\n    # Final selection:\n    # Liquidity, Quality/Growth, Enhanced Momentum (short-term + long-term trend), and PE filter\n    buy_signals = liquidity_filter & quality_growth_filter & momentum_filter & price_above_sma & pe_filter\n\n    # 5. Position sizing (simple equal weight for selected stocks)\n    # Ensure NaN values are handled for division\n    num_stocks_selected = buy_signals.sum(axis=1)\n    position = buy_signals.div(num_stocks_selected, axis=0).fillna(0) # Equal weight, fillna for days with no selections\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:42:39.827283",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 18,
      "timestamp": "2025-11-02T06:43:00.561526",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')  # Quarterly fundamental\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')  # Monthly fundamental\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')  # Daily institutional flow\npe_ratio = data.get('price_earning_ratio:本益比') # Daily valuation\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Apply ffill for quarterly data, then calculate rolling mean, then shift\nquality = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Apply ffill for monthly data, then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (10-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Valuation filter: P/E ratio between 5 and 30 to avoid extreme values\npe_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 30)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter]\n# 5. Select stocks (top 10 stocks based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:42:44.526078",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 19,
      "timestamp": "2025-11-02T06:43:17.260022",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign investor flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical momentum/reversal\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then apply rolling mean\nquality = roe.ffill().rolling(4*20).mean().shift(1) # Approx 4 quarters (20 trading days/month * 3 months/quarter)\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buying)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Inverse RSI (to favor less overbought/more oversold conditions)\n# A lower RSI (e.g., <50) is generally considered less overbought.\n# (100 - RSI) will give higher values for lower RSI.\ninverse_rsi = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\ninverse_rsi_rank = inverse_rsi.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   inverse_rsi_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD for mid-large cap stocks\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_range_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_range_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:43:00.616597",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 20,
      "timestamp": "2025-11-02T06:43:29.799293",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ffill() to align quarterly data to daily, then shift(1)\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# ffill() to align monthly data to daily, then shift(1)\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (10-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(10).sum().shift(1)\n# Factor 5: RSI Mean Reversion (avoiding overbought)\n# We want stocks that are not extremely overbought, so lower RSI is better for selection\n# Or, we can use it as a filter. Let's use it as a filter for now.\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights. Higher weights for momentum and quality.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.30 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD\nprice_filter = close.shift(1) > 15\n# RSI filter: Avoid extremely overbought stocks (RSI < 70) and extremely oversold (RSI > 30)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:43:17.302422",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 21,
      "timestamp": "2025-11-02T06:43:34.246913",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return) - preserved from champion\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - preserved from champion, adding a threshold\n    # Focus on significant revenue growth\n    revenue_growth_factor = revenue_yoy.shift(1)\n    strong_revenue_growth = (revenue_growth_factor >= 15) # Only consider strong growth\n\n    # ROE filter - preserved from champion, adding a higher threshold for quality\n    # Emphasize higher quality companies\n    high_roe = (roe.shift(1) >= 15)\n\n    # Price momentum - adding 60-day momentum for a longer trend\n    returns_60d = close.pct_change(60).shift(1)\n    price_momentum = (returns_20d > 0) & (returns_60d > 0) # Both short and medium term positive momentum\n\n    # Adding a valuation filter: Low PE Ratio (below industry average or a reasonable cap)\n    # This aims to select undervalued growth stocks, improving risk-adjusted returns\n    # Using a cap of 25 as a general indicator for reasonable PE in Taiwan market\n    low_pe = (pe_ratio.shift(1) > 0) & (pe_ratio.shift(1) < 25)\n\n    # Liquidity filter - preserved requirement (>150M TWD average daily volume)\n    avg_volume_20d = volume.rolling(20).mean().shift(1)\n    liquidity_filter = avg_volume_20d * close.shift(1) >= 150_000_000\n\n    # 3. Combine factors to create a selection mask\n    # Combine high ROE, strong revenue growth, positive price momentum, and low PE\n    # This selects high-quality, growing companies with positive momentum trading at a reasonable valuation.\n    # The combination aims to reduce drawdown and improve win rate by focusing on robust fundamentals and trends.\n    selection = high_roe & strong_revenue_growth & price_momentum & low_pe & liquidity_filter\n\n    # 4. Generate positions\n    # Equal weight for selected stocks\n    position = selection.astype(float).divide(selection.sum(axis=1), axis=0)\n    position = position.fillna(0) # Handle cases where no stocks are selected\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:43:29.874567",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 22,
      "timestamp": "2025-11-02T06:43:50.200159",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market Cap for size filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor (quarterly)\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor (monthly)\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\nrsi = data.indicator('RSI') # Technical indicator\n# 2. Calculate factors\n# Factor 1: Long-term Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then shift\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Revenue Growth (Monthly Revenue YoY)\n# Monthly revenue, so ffill to daily and then shift\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Conviction (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Short-term Reversal (Inverse RSI, favoring oversold)\n# Higher value means more oversold (e.g., RSI 20 -> 80, RSI 80 -> 20)\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights. Sum of weights should be 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 10 Billion TWD for mid-large caps\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# RSI range filter: Avoid extremely overbought/oversold conditions (e.g., RSI < 20 or > 80)\n# This is applied to the original RSI, not the reversal factor\nrsi_filter = (rsi.shift(1) > 20) & (rsi.shift(1) < 80)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select top N stocks (e.g., top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:43:34.294296",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 23,
      "timestamp": "2025-11-02T06:44:09.088089",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後') # Quarterly fundamental data\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly fundamental data\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Daily institutional flow data\nrsi = data.indicator('RSI') # Daily technical indicator\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Higher momentum is generally better.\nmomentum_factor = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# Forward-fill quarterly ROE to daily, then take a 4-period (annual) rolling mean.\n# Higher ROE indicates better profitability.\nquality_factor = roe.ffill().rolling(4).mean().shift(1)\n# Factor 3: Revenue Growth (Monthly Revenue YoY)\n# Forward-fill monthly revenue growth to daily.\n# Higher growth indicates business expansion.\ngrowth_factor = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\n# Sum of foreign investor net buying over the past 20 trading days.\n# Positive net buy indicates institutional interest and potential buying pressure.\nflow_factor = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] across all stocks for each day.\nmomentum_rank = momentum_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\ngrowth_rank = growth_factor.rank(axis=1, pct=True)\nflow_rank = flow_factor.rank(axis=1, pct=True)\n# Combine factors with meaningful weights. The sum of weights should be 1.0.\n# Prioritize momentum and quality, then growth and institutional flow.\ncombined_factor = (momentum_rank * 0.35 +\n                   quality_rank * 0.30 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be greater than 50M TWD.\n# This ensures sufficient liquidity for trading.\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price must be greater than 15 TWD to avoid penny stocks.\nprice_filter = close.shift(1) > 15\n# RSI filter: Avoid extremely overbought stocks (RSI < 80).\n# This helps to mitigate risk from highly extended price moves.\nrsi_filter = rsi.shift(1) < 80\n# Apply all filters to the combined factor.\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the combined factor score for each day.\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest the strategy with quarterly rebalancing and an 8% stop loss.\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:43:50.246261",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 24,
      "timestamp": "2025-11-02T06:44:25.222550",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (20-day returns)\nmomentum = close.pct_change(20).shift(1)\n# Factor 2: Foreign Buying Strength\n# Directly use the foreign buying strength index\nforeign_flow = foreign_strength.shift(1)\n# Factor 3: Quality (ROE with 4-quarter smoothing)\n# Forward-fill monthly/quarterly data to daily, then apply rolling mean\nquality_roe = roe.ffill().rolling(4).mean().shift(1)\n# Factor 4: Growth (Monthly Revenue YoY)\n# Forward-fill monthly data to daily\ngrowth_rev = revenue_yoy.ffill().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nforeign_flow_rank = foreign_flow.rank(axis=1, pct=True)\nquality_roe_rank = quality_roe.rank(axis=1, pct=True)\ngrowth_rev_rank = growth_rev.rank(axis=1, pct=True)\n# Combine with weighted average. Weights sum to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   foreign_flow_rank * 0.25 +\n                   quality_roe_rank * 0.25 +\n                   growth_rev_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:44:09.155727",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 25,
      "timestamp": "2025-11-02T06:44:45.915733",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後') # Quality factor\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Growth factor\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Institutional flow\npe_ratio = data.get('price_earning_ratio:本益比') # Valuation factor\nmarket_value = data.get('etl:market_value') # Market cap for filter\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\n# Long-term momentum often works well in Taiwan market\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth\n# ROE (4-quarter rolling average for stability, forward-filled to daily)\nroe_smoothed = roe.rolling(4, min_periods=1).mean().ffill().shift(1)\n# Monthly Revenue YoY (forward-filled to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Combine ROE and Revenue Growth for a comprehensive quality/growth signal\nquality_growth = (roe_smoothed + revenue_growth) / 2\n# Factor 3: Institutional Flow (20-day sum of foreign net buy)\n# Foreign investors are a major force in the Taiwan market\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: Value (Inverse of P/E ratio, forward-filled)\n# Lower P/E (higher inverse P/E) indicates better value\ninverse_pe = (1 / pe_ratio).ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_growth_rank = quality_growth.rank(axis=1, pct=True)\ninstitutional_flow_rank = institutional_flow.rank(axis=1, pct=True)\ninverse_pe_rank = inverse_pe.rank(axis=1, pct=True)\n# Combine factors with intelligent weights\n# Momentum and Quality/Growth are often strong signals, Institutional Flow provides conviction, Value provides a safety net\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_growth_rank * 0.30 +\n                   institutional_flow_rank * 0.25 +\n                   inverse_pe_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\n# Ensures tradability and avoids illiquid stocks\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 15 TWD\n# Avoids penny stocks which can be highly volatile and risky\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Market value > 5 Billion TWD\n# Focuses on mid-to-large cap stocks for stability and institutional interest\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# P/E Ratio filter: P/E between 5 and 25\n# Excludes companies with negative earnings (P/E < 0) and extremely overvalued companies (P/E > 25)\npe_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 25)\n# Apply all filters to the combined factor\n# Use .dropna(how='all') to remove rows (dates) where all stocks are filtered out\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pe_filter].dropna(how='all')\n# 5. Select stocks\n# Select the top 10 stocks with the highest combined factor score\n# A portfolio size of 8-15 stocks provides diversification\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Quarterly rebalancing (resample=\"Q\") is suitable for multi-factor strategies\n# A stop loss of 8% helps manage downside risk\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:44:25.270714",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 26,
      "timestamp": "2025-11-02T06:45:06.140387",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # Adjusted Close Price, critical for price-based strategies\ntrading_value = data.get('price:成交金額')  # Trading Value, used for liquidity filter\nmarket_value = data.get('etl:market_value') # Market Capitalization, used for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity, a key profitability metric\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue Year-over-Year growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign Investor Net Buy volume\n# 2. Calculate factors\n# Factor 1: Medium-term Price Momentum (60-day returns)\n# Higher momentum is generally preferred.\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE, 4-quarter smoothed)\n# ROE is quarterly data, so we ffill to daily, then smooth over 4 quarters, then shift.\n# Higher ROE indicates better profitability.\nquality = roe.ffill().rolling(4, min_periods=1).mean().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly revenue data is ffilled to daily frequency, then shifted.\n# Higher revenue growth indicates business expansion.\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\n# Sum foreign net buy over 20 days to capture sustained institutional interest.\n# Positive net buy indicates institutional accumulation.\ninstitutional_flow = foreign_net_buy.rolling(20, min_periods=1).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1] to ensure comparability and prevent dominance by any single factor.\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine normalized factors with intelligent weights.\n# Weights are chosen to balance different investment styles (momentum, quality, growth, smart money).\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   flow_rank * 0.20)\n# 4. Apply filters to ensure liquidity, reasonable price, and sufficient market capitalization\n# Liquidity filter: Average daily trading value over the past 20 days must exceed 50M TWD.\n# This avoids illiquid stocks that are hard to trade.\nliquidity_filter = trading_value.rolling(20, min_periods=1).mean().shift(1) > 50_000_000\n# Price filter: Close price must be greater than 20 TWD.\n# This avoids penny stocks which can be highly volatile and risky.\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value must be greater than 5 Billion TWD.\n# This focuses on mid-to-large cap stocks, reducing exposure to micro-caps.\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Apply all filters to the combined factor score.\n# Only stocks passing all filters will be considered for selection.\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select the top 10 stocks with the highest combined factor scores from the filtered list.\n# This forms the portfolio for the next period.\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Execute the backtest with quarterly rebalancing and an 8% stop loss.\n# Quarterly rebalancing aligns with fundamental data frequency and reduces transaction costs.\n# Stop loss helps manage downside risk.\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:44:45.969554",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 27,
      "timestamp": "2025-11-02T06:45:11.458869",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return) - Original\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - Original\n    # Apply a smoothing or threshold to revenue growth to reduce noise\n    revenue_growth_factor = revenue_yoy.shift(1).rolling(5).mean() # Smoothed revenue growth\n\n    # ROE filter - Original, but with a stricter threshold and smoothing\n    # Use a rolling median to make ROE more robust to outliers\n    roe_filtered = roe.shift(1).rolling(3).median() # Smoothed ROE\n\n    # Add a valuation factor: Inverse PE ratio to favor undervalued stocks\n    # Cap PE ratio to avoid extreme values and take inverse\n    pe_capped = pe_ratio.shift(1).mask(pe_ratio.shift(1) > 50, 50) # Cap PE at 50\n    inverse_pe = 1 / pe_capped # Higher is better (lower PE)\n\n    # 3. Combine factors and create a composite score\n    # Normalize factors to combine them effectively\n    # Rank factors to ensure relative strength is considered\n    momentum_rank = returns_20d.rank(axis=1, pct=True)\n    revenue_rank = revenue_growth_factor.rank(axis=1, pct=True)\n    roe_rank = roe_filtered.rank(axis=1, pct=True)\n    pe_rank = inverse_pe.rank(axis=1, pct=True)\n\n    # Weighted combination of factors - Increased weight on ROE and Momentum\n    # Added PE as a new factor to improve value aspect\n    composite_score = (\n        0.35 * roe_rank +        # Higher weight for quality\n        0.35 * momentum_rank +   # Higher weight for momentum\n        0.20 * revenue_rank +    # Moderate weight for growth\n        0.10 * pe_rank           # Lower weight for value, but still present\n    )\n\n    # 4. Apply filters\n    # Liquidity filter: Average daily volume > 150M TWD\n    # Calculate average daily turnover (price * volume)\n    avg_daily_turnover = (close * volume).rolling(20).mean().shift(1)\n    liquidity_filter = avg_daily_turnover > 150_000_000\n\n    # Minimum ROE filter (e.g., > 8%)\n    min_roe_filter = (roe_filtered > 8)\n\n    # Minimum revenue growth filter (e.g., > 0%)\n    min_revenue_growth_filter = (revenue_growth_factor > 0)\n\n    # Combine all filters\n    combined_filters = liquidity_filter & min_roe_filter & min_revenue_growth_filter\n\n    # 5. Select top stocks based on composite score and filters\n    # Select top N stocks (e.g., top 10%) from the filtered universe\n    top_n_percent = 0.10 # Select top 10% of stocks by composite score\n    selection = (composite_score > composite_score.quantile(1 - top_n_percent, axis=1)) & combined_filters\n\n    # Handle NaN values and ensure boolean output\n    selection = selection.fillna(False)\n\n    return selection",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:45:06.199224",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 28,
      "timestamp": "2025-11-02T06:45:29.582820",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_cap = data.get('etl:market_value') # Market capitalization for size filter\nroe = data.get('fundamental_features:ROE稅後') # Return on Equity for quality\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Monthly Revenue YoY for growth\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Foreign institutional flow\nrsi = data.indicator('RSI') # Relative Strength Index for technical signal\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality & Growth (Combined ROE and Monthly Revenue YoY)\n# Smooth ROE over 4 quarters and forward-fill to daily\nroe_smoothed = roe.rolling(4).mean().ffill()\n# Forward-fill monthly revenue YoY to daily\nrevenue_growth = revenue_yoy.ffill()\n# Combine and normalize ROE and Revenue Growth before shifting\n# This creates a combined fundamental score\nfundamental_combined = (roe_smoothed.rank(axis=1, pct=True) * 0.6 +\n                        revenue_growth.rank(axis=1, pct=True) * 0.4).shift(1)\n# Factor 3: Institutional Flow (20-day sum of Foreign Net Buy)\n# Sum foreign net buy over 20 days\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 4: RSI Reversal (Inverse RSI, favoring oversold conditions)\n# Higher value means more oversold (e.g., RSI 20 -> 80, RSI 80 -> 20)\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize each factor to percentile ranks first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nfundamental_rank = fundamental_combined.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with meaningful weights\ncombined_factor = (momentum_rank * 0.35 +\n                   fundamental_rank * 0.30 +\n                   flow_rank * 0.20 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market capitalization > 10B TWD for mid-large caps\nmarket_cap_filter = market_cap.shift(1) > 10_000_000_000\n# RSI range filter: Avoid extreme overbought/oversold for general trading\n# (Note: RSI reversal factor already handles oversold preference)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select top N stocks (e.g., top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:45:11.515505",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 29,
      "timestamp": "2025-11-02T06:45:33.892941",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return) - preserved from champion\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - preserved from champion\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE filter - preserved from champion, adding a minimum threshold\n    # Increased minimum ROE to target higher quality companies\n    roe_filter = (roe.shift(1) > 10) # Champion likely used a higher threshold, tuning slightly\n\n    # Calculate 60-day Simple Moving Average for price smoothing\n    # This helps identify trends and reduces noise\n    sma_60 = close.rolling(window=60).mean().shift(1)\n\n    # 3. Liquidity filter: Average daily volume > 150M TWD\n    # Converted volume to TWD using close price\n    avg_volume_value = (volume * close).rolling(window=20).mean().shift(1)\n    liquidity_filter = (avg_volume_value > 150_000_000)\n\n    # 4. Combine factors for stock selection\n    # Champion likely used momentum, revenue growth, and ROE.\n    # We enhance by adding a price trend filter (close > SMA_60)\n    # and adjust thresholds for stronger signals.\n    # Also, added a PE ratio filter to avoid extremely overvalued stocks.\n    # Using a PE range (0 < PE < 30) for value and growth balance.\n    pe_filter = (pe_ratio.shift(1) > 0) & (pe_ratio.shift(1) < 30)\n\n    # Combine all filters\n    long_condition = (\n        (returns_20d > 0.05) &  # Stronger momentum threshold\n        (revenue_growth_factor > 10) & # Stronger revenue growth threshold\n        roe_filter &\n        (close.shift(1) > sma_60) & # Price above 60-day SMA for trend confirmation\n        pe_filter &\n        liquidity_filter\n    )\n\n    # 5. Define position based on long conditions\n    # Convert boolean series to 1 for long, 0 for no position\n    position = long_condition.astype(int)\n\n    # Handle NaN values by filling with 0, ensuring no look-ahead.\n    position = position.fillna(0)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T14:45:29.643289",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 0,
      "timestamp": "2025-11-02T08:15:30.882560",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing, then forward-fill)\nquality = roe.rolling(4).mean().ffill().shift(1)\n# Factor 3: Growth (Monthly Revenue YoY, forward-fill)\ngrowth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of Foreign Net Buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: Value (Inverse of P/E Ratio, forward-fill)\n# Handle potential division by zero or negative P/E later with filters\nvalue_factor = (1 / pe_ratio).ffill().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\ngrowth_rank = growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.25 +\n                   quality_rank * 0.20 +\n                   growth_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 0 and 30 (avoid negative P/E and extremely high P/E)\npe_filter = (pe_ratio.ffill().shift(1) > 0) & (pe_ratio.ffill().shift(1) < 30)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_filter]\n# 5. Select stocks (top 10 stocks)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {
        "total_return": 0.1651985814197757,
        "annual_return": 0.3016237247228108,
        "sharpe_ratio": 0.9201967264321633,
        "max_drawdown": -0.22128054948793688,
        "win_rate": 0.2954805392170181,
        "position_count": 252
      },
      "feedback": "============================================================\nPERFORMANCE ATTRIBUTION - Iteration 0\n============================================================\n\n❌ REGRESSION: Sharpe ratio degraded\n  Previous: 2.4751\n  Current:  0.9202\n  Delta:    -1.5549\n\n📊 DETECTED CHANGES (3 total):\n\n🔥 CRITICAL CHANGES (High Impact):\n  • roe_smoothing:\n      From: raw (window=1)\n      To:   not_used (window=None)\n\n📝 Other Changes:\n  • revenue_handling: simple_shift → forward_fill\n  • price_filter: 10 → 20\n\n💡 ATTRIBUTION INSIGHTS:\n\n⚠️  Performance degraded after critical changes:\n\n🎯 LEARNING DIRECTIVE:\n  → Review iteration 6's successful patterns\n  → Preserve proven elements: ROE smoothing, strict filters\n  → Make INCREMENTAL improvements, not revolutionary changes\n============================================================\n\n## CURRENT CHAMPION\n\nIteration: 6\nSharpe Ratio: 2.4751\nEstablished: 2025-10-12 06:43:01\n\nProven Success Patterns:\n- price > 10 TWD - Filters penny stocks\n\n## AVOID (Learned from Past Failures)\n\n- Avoid: Increasing liquidity threshold from 50 to 60 (learned from iter 152)\n- Avoid: Increasing liquidity threshold from 50 to 70000000 (learned from iter 103)\n- Avoid: Increasing liquidity threshold from 50 to 30000000 (learned from iter 24)\n- Avoid: Increasing liquidity threshold from 50 to 80 (learned from iter 15)\n- Avoid: Increasing liquidity threshold from 50 to 20000000 (learned from iter 14)\n- Avoid: Increasing liquidity threshold from 50 to 75 (learned from iter 10)\n- Avoid: Increasing liquidity threshold from 50 to 100 (learned from iter 9)\n- Avoid: Changing roe_smoothing from raw (window=1) to smoothed (window=60) (learned from iter 5)\n- Avoid: Decreasing liquidity threshold from 50 to 40 (learned from iter 3)\n- Avoid: Increasing liquidity threshold from 50 to 50000000 (learned from iter 2)\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:15:15.103272",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-02T08:15:15.132355",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-02T08:15:48.064273",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily, then apply rolling mean\nquality = roe.ffill().rolling(4*20).mean().shift(1) # Approx 4 quarters of daily data\n# Factor 3: Revenue Growth (monthly data aligned to daily)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\n# Combine with weights summing to 1.0\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.25 +\n                   revenue_rank * 0.25 +\n                   flow_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# RSI filter: Avoid extreme overbought/oversold conditions (RSI between 30 and 70)\nrsi_filter = (rsi.shift(1) > 30) & (rsi.shift(1) < 70)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & rsi_filter]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {
        "total_return": 0.18223964339144877,
        "annual_return": -0.04569624812932128,
        "sharpe_ratio": 1.2196549646992052,
        "max_drawdown": -0.24078131294513294,
        "win_rate": 0.06153783853790534,
        "position_count": 252
      },
      "feedback": "============================================================\nPERFORMANCE ATTRIBUTION - Iteration 1\n============================================================\n\n❌ REGRESSION: Sharpe ratio degraded\n  Previous: 2.4751\n  Current:  1.2197\n  Delta:    -1.2555\n\n📊 DETECTED CHANGES (4 total):\n\n🔥 CRITICAL CHANGES (High Impact):\n  • roe_smoothing:\n      From: raw (window=1)\n      To:   not_used (window=None)\n\n📝 Other Changes:\n  • revenue_handling: simple_shift → forward_fill\n  • value_factor: pe_ratio → None\n  • price_filter: 10 → 20\n\n💡 ATTRIBUTION INSIGHTS:\n\n⚠️  Performance degraded after critical changes:\n\n🎯 LEARNING DIRECTIVE:\n  → Review iteration 6's successful patterns\n  → Preserve proven elements: ROE smoothing, strict filters\n  → Make INCREMENTAL improvements, not revolutionary changes\n============================================================\n\n## CURRENT CHAMPION\n\nIteration: 6\nSharpe Ratio: 2.4751\nEstablished: 2025-10-12 06:43:01\n\nProven Success Patterns:\n- price > 10 TWD - Filters penny stocks\n\n## AVOID (Learned from Past Failures)\n\n- Avoid: Increasing liquidity threshold from 50 to 60 (learned from iter 152)\n- Avoid: Increasing liquidity threshold from 50 to 70000000 (learned from iter 103)\n- Avoid: Increasing liquidity threshold from 50 to 30000000 (learned from iter 24)\n- Avoid: Increasing liquidity threshold from 50 to 80 (learned from iter 15)\n- Avoid: Increasing liquidity threshold from 50 to 20000000 (learned from iter 14)\n- Avoid: Increasing liquidity threshold from 50 to 75 (learned from iter 10)\n- Avoid: Increasing liquidity threshold from 50 to 100 (learned from iter 9)\n- Avoid: Changing roe_smoothing from raw (window=1) to smoothed (window=60) (learned from iter 5)\n- Avoid: Decreasing liquidity threshold from 50 to 40 (learned from iter 3)\n- Avoid: Increasing liquidity threshold from 50 to 50000000 (learned from iter 2)\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:15:30.974161",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-02T08:16:00.693733",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_net_buy = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Price Momentum (60-day returns)\nmomentum = close.pct_change(60).shift(1)\n# Factor 2: Quality (ROE with 4-quarter smoothing)\n# ROE is quarterly, so ffill to daily and then smooth\nquality = roe.ffill().rolling(4*20).mean().shift(1) # Approx 4 quarters of daily data\n# Factor 3: Growth (Monthly Revenue YoY)\n# Monthly revenue, so ffill to daily\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Institutional Flow (20-day sum of foreign net buy)\ninstitutional_flow = foreign_net_buy.rolling(20).sum().shift(1)\n# Factor 5: RSI Reversal (Lower RSI implies oversold, higher rank)\n# We want to buy oversold, so we'll use (100 - RSI) to rank\nrsi_reversal = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\nmomentum_rank = momentum.rank(axis=1, pct=True)\nquality_rank = quality.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nflow_rank = institutional_flow.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal.rank(axis=1, pct=True)\n# Combine with weights (summing to 1.0)\ncombined_factor = (momentum_rank * 0.30 +\n                   quality_rank * 0.20 +\n                   revenue_rank * 0.20 +\n                   flow_rank * 0.20 +\n                   rsi_reversal_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Close price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {
        "total_return": -0.2764888498670458,
        "annual_return": -0.18271039837403358,
        "sharpe_ratio": 5.7809814382128515,
        "max_drawdown": -0.8729790995840178,
        "win_rate": 0.3602113755270141,
        "position_count": 252
      },
      "feedback": "============================================================\nPERFORMANCE ATTRIBUTION - Iteration 2\n============================================================\n\n✅ IMPROVEMENT: Sharpe ratio improved\n  Previous: 2.4751\n  Current:  5.7810\n  Delta:    +3.3058\n\n📊 DETECTED CHANGES (4 total):\n\n🔥 CRITICAL CHANGES (High Impact):\n  • roe_smoothing:\n      From: raw (window=1)\n      To:   not_used (window=None)\n\n📝 Other Changes:\n  • revenue_handling: simple_shift → forward_fill\n  • value_factor: pe_ratio → None\n  • price_filter: 10 → 20\n\n💡 ATTRIBUTION INSIGHTS:\n\n✅ Performance improved after critical changes:\n\n============================================================\n\n## CURRENT CHAMPION\n\nIteration: 6\nSharpe Ratio: 2.4751\nEstablished: 2025-10-12 06:43:01\n\nProven Success Patterns:\n- price > 10 TWD - Filters penny stocks\n\n## AVOID (Learned from Past Failures)\n\n- Avoid: Increasing liquidity threshold from 50 to 60 (learned from iter 152)\n- Avoid: Increasing liquidity threshold from 50 to 70000000 (learned from iter 103)\n- Avoid: Increasing liquidity threshold from 50 to 30000000 (learned from iter 24)\n- Avoid: Increasing liquidity threshold from 50 to 80 (learned from iter 15)\n- Avoid: Increasing liquidity threshold from 50 to 20000000 (learned from iter 14)\n- Avoid: Increasing liquidity threshold from 50 to 75 (learned from iter 10)\n- Avoid: Increasing liquidity threshold from 50 to 100 (learned from iter 9)\n- Avoid: Changing roe_smoothing from raw (window=1) to smoothed (window=60) (learned from iter 5)\n- Avoid: Decreasing liquidity threshold from 50 to 40 (learned from iter 3)\n- Avoid: Increasing liquidity threshold from 50 to 50000000 (learned from iter 2)\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:15:48.140872",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-02T08:17:17.051876",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused factor, also for filter\ngross_profit_margin = data.get('fundamental_features:營業毛利率') # Underused quality factor\nnet_profit_margin = data.get('fundamental_features:稅後淨利率') # Underused quality factor\npe_ratio = data.get('price:本益比') # Underused value factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused financial health factor\n# 2. Calculate factors (prioritizing underused factors)\n# Factor 1: Quality - Gross Profit Margin (higher is better)\n# Forward-fill monthly/quarterly data and shift to avoid look-ahead\nquality_gross_margin = gross_profit_margin.ffill().shift(1)\n# Factor 2: Quality - Net Profit Margin (higher is better)\nquality_net_margin = net_profit_margin.ffill().shift(1)\n# Factor 3: Value - Inverse P/E Ratio (lower P/E is better, so inverse makes higher better)\n# Handle potential division by zero or negative P/E in ranking/filtering\nvalue_inverse_pe = (1 / pe_ratio).ffill().shift(1)\n# Factor 4: Financial Health - Inverse Debt Ratio (lower debt is better, so inverse makes higher better)\n# Handle potential division by zero or very small debt ratios\n# For robustness, we will rank debt_ratio directly and then reverse the rank\nfinancial_health_debt_ratio = debt_ratio.ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\ngross_margin_rank = quality_gross_margin.rank(axis=1, pct=True)\nnet_margin_rank = quality_net_margin.rank(axis=1, pct=True)\ninverse_pe_rank = value_inverse_pe.rank(axis=1, pct=True)\n# For debt ratio, lower is better, so we reverse the rank\ndebt_ratio_rank_reversed = (1 - financial_health_debt_ratio.rank(axis=1, pct=True))\n# Combine with weights, emphasizing quality and value\ncombined_factor = (gross_margin_rank * 0.35 +\n                   net_margin_rank * 0.25 +\n                   inverse_pe_rank * 0.25 +\n                   debt_ratio_rank_reversed * 0.15)\n# 4. Apply filters (using underused factors for additional filters)\n# Liquidity filter: Average trading value over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Target larger, more stable companies (underused factor)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000 # Greater than 10 Billion TWD\n# P/E Ratio filter: Exclude stocks with negative P/E (negative earnings) or extremely high P/E\npe_ratio_valid_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 50)\n# Debt Ratio filter: Exclude companies with excessively high debt (e.g., > 150%)\ndebt_ratio_filter = financial_health_debt_ratio < 150\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pe_ratio_valid_filter & debt_ratio_filter]\n# 5. Select top N stocks\nposition = filtered_factor.is_largest(10) # Select top 10 stocks\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:16:00.788118",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-02T08:17:22.702517",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return), shifted to prevent look-ahead\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY), shifted\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE factor, shifted\n    roe_factor = roe.shift(1)\n\n    # PE Ratio factor, shifted\n    pe_factor = pe_ratio.shift(1)\n\n    # 3. Liquidity filter: Average daily volume > 150M TWD\n    # Calculate 20-day average volume in shares, then convert to TWD using close price\n    avg_volume_shares = volume.rolling(20).mean().shift(1)\n    avg_volume_twd = avg_volume_shares * close.shift(1)\n    liquidity_filter = (avg_volume_twd > 150_000_000)\n\n    # 4. Enhance ROE filter: Focus on high and stable ROE\n    # Filter for ROE > 15 and also ensure ROE is not excessively high (e.g., due to one-off events)\n    # Adding a lower bound for PE ratio to avoid extremely cheap stocks that might be value traps\n    roe_quality_filter = (roe_factor > 15) & (roe_factor < 50) & (pe_factor > 5)\n\n    # 5. Strengthen Revenue Growth: Combine with positive momentum\n    # Only consider stocks with strong positive revenue growth and positive price momentum\n    growth_momentum_filter = (revenue_growth_factor > 10) & (returns_20d > 0.05)\n\n    # 6. Combine all filters\n    # Stocks must meet liquidity, enhanced ROE quality, and growth momentum criteria\n    # Adding a check for PE ratio not to be too high, indicating overvaluation\n    combined_filter = liquidity_filter & \\\n                      roe_quality_filter & \\\n                      growth_momentum_filter & \\\n                      (pe_factor < 30)\n\n    # 7. Rank stocks based on a composite score (e.g., momentum + growth)\n    # Prioritize stocks with higher momentum and revenue growth\n    # Fill NaN values to ensure ranking works correctly\n    momentum_rank = returns_20d.rank(axis=1, ascending=False).fillna(close.shape[1])\n    revenue_rank = revenue_growth_factor.rank(axis=1, ascending=False).fillna(close.shape[1])\n    \n    # Composite score: lower rank is better (sum of ranks)\n    composite_score = momentum_rank + revenue_rank\n    \n    # Apply combined filter and then select top N stocks\n    # Use fillna(True) to ensure non-selected stocks get a very high score and are filtered out\n    filtered_scores = composite_score.where(combined_filter)\n    \n    # Select top 10 stocks based on the filtered composite score (lower score is better)\n    position = filtered_scores.rank(axis=1, ascending=True) <= 10\n    \n    # Handle cases where fewer than 10 stocks meet the criteria\n    position = position.where(combined_filter, False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:17:17.127136",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-02T08:17:26.997348",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return), shifted to prevent look-ahead bias\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY), shifted\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE filter: select companies with ROE > 15 (quality)\n    roe_filter = roe.shift(1) > 15\n\n    # PE Ratio filter: avoid extremely high PE ratios, focus on reasonable valuations\n    # Using a max PE of 40 to avoid overvalued stocks, and min PE of 5 to avoid distress\n    pe_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 40)\n\n    # 3. Liquidity filter: Average daily volume > 150M TWD (approx 150,000 shares * 1000 TWD/share)\n    # Assuming average price of a share is around 100 TWD, so 1.5M shares.\n    # Let's be more precise: (volume * close) rolling sum / 20 days > 150,000,000 TWD\n    # For simplicity, using volume directly as proxy for liquidity\n    avg_volume_20d = volume.rolling(20).mean().shift(1)\n    liquidity_filter = avg_volume_20d * close.shift(1) > 150_000_000\n\n    # 4. Combine factors to generate signals\n    # Enhance momentum by requiring positive 20-day return\n    momentum_signal = returns_20d > 0\n\n    # Enhance revenue growth by requiring positive growth\n    growth_signal = revenue_growth_factor > 0\n\n    # Combine all filters and signals\n    # We prioritize quality (ROE), reasonable valuation (PE), liquidity,\n    # and then look for positive momentum and revenue growth.\n    # The champion's high Sharpe suggests a strong quality/momentum blend.\n    # We add PE to refine value and potentially reduce drawdown from overbought stocks.\n    buy_signal = (roe_filter & pe_filter & liquidity_filter & momentum_signal & growth_signal)\n\n    # 5. Define position: Equal weight to all stocks that meet the criteria\n    # Fill NaN values with False for the boolean series\n    position = buy_signal.astype(float).fillna(0)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:17:22.776466",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-02T08:17:49.170156",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nimport numpy as np\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization\noperating_margin = data.get('fundamental_features:營業利益率') # Underused: Operating Profit Margin\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Debt Ratio\npe_ratio = data.get('price:本益比') # Underused: P/E Ratio\n# 2. Calculate factors\n# Factor 1: Quality - Operating Profit Margin (higher is better)\n# Use ffill for quarterly data and shift(1) to avoid look-ahead bias\nquality_op_margin = operating_margin.ffill().shift(1)\n# Factor 2: Quality/Risk - Inverse Debt Ratio (lower debt is better, so inverse)\n# Handle potential division by zero or negative values by replacing with NaN\ninv_debt_ratio = (1 / debt_ratio.replace([0, np.inf, -np.inf], np.nan)).ffill().shift(1)\n# Factor 3: Value - Inverse P/E Ratio (lower P/E is better, so inverse)\n# Handle potential division by zero, negative P/E (loss-making companies) by replacing with NaN\ninv_pe_ratio = (1 / pe_ratio.replace([0, np.inf, -np.inf], np.nan)).shift(1)\n# Factor 4: Size - Inverse Market Capitalization (smaller companies often have higher growth potential)\n# Handle potential division by zero by replacing with NaN\ninv_market_value = (1 / market_value.replace([0, np.inf, -np.inf], np.nan)).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nquality_op_margin_rank = quality_op_margin.rank(axis=1, pct=True)\ninv_debt_ratio_rank = inv_debt_ratio.rank(axis=1, pct=True)\ninv_pe_ratio_rank = inv_pe_ratio.rank(axis=1, pct=True)\ninv_market_value_rank = inv_market_value.rank(axis=1, pct=True)\n# Combine with diverse weights, prioritizing quality and value from underused factors\ncombined_factor = (quality_op_margin_rank * 0.35 +\n                   inv_debt_ratio_rank * 0.25 +\n                   inv_pe_ratio_rank * 0.25 +\n                   inv_market_value_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50 million TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Ensure minimum market capitalization > 1 billion TWD\n# This filters out micro-caps while still allowing for smaller companies via the inverse market value factor\nmarket_cap_filter = market_value.shift(1) > 1_000_000_000\n# P/E sanity filter: Exclude companies with extremely high or negative P/E ratios\n# Focus on companies with reasonable positive earnings\npe_sanity_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 50)\n# Debt Ratio sanity filter: Exclude companies with extremely high debt ratios (e.g., > 150%)\ndebt_sanity_filter = debt_ratio.shift(1) < 150\n# Apply all filters\nfiltered_factor = combined_factor[\n    liquidity_filter &\n    price_filter &\n    market_cap_filter &\n    pe_sanity_filter &\n    debt_sanity_filter\n]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Quarterly rebalancing with an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:17:27.064700",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-02T08:18:10.360834",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization\npb_ratio = data.get('price:股價淨值比') # Underused: Price-to-Book Ratio\ngross_margin = data.get('fundamental_features:營業毛利率') # Underused: Gross Profit Margin\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Debt Ratio\n# 2. Calculate factors\n# Factor 1: Value (Inverse Price-to-Book Ratio) - lower P/B is better\n# Handle potential division by zero or very small P/B values by capping at a reasonable inverse\nvalue_factor = (1 / pb_ratio.replace([0, -0], 0.001)).ffill().shift(1)\n# Factor 2: Quality (Gross Profit Margin) - higher is better\nquality_margin_factor = gross_margin.ffill().shift(1)\n# Factor 3: Financial Health (Inverse Debt Ratio) - lower debt is better\n# Handle potential division by zero or very small debt ratios\nfinancial_health_factor = (1 / debt_ratio.replace([0, -0], 0.001)).ffill().shift(1)\n# Factor 4: Stability (Inverse Volatility) - lower volatility is better\n# Calculate 60-day rolling standard deviation of daily returns\nvolatility = close.pct_change().rolling(60).std().shift(1)\n# Handle potential division by zero for volatility\nstability_factor = (1 / volatility.replace([0, -0], 0.0001))\n# 3. Combine factors (normalize first!)\nvalue_rank = value_factor.rank(axis=1, pct=True)\nquality_margin_rank = quality_margin_factor.rank(axis=1, pct=True)\nfinancial_health_rank = financial_health_factor.rank(axis=1, pct=True)\nstability_rank = stability_factor.rank(axis=1, pct=True)\n# Combine with diverse weights, emphasizing value and quality\ncombined_factor = (value_rank * 0.40 +\n                   quality_margin_rank * 0.30 +\n                   financial_health_rank * 0.20 +\n                   stability_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 25 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 25\n# Market Cap filter: Market value > 15 Billion TWD for mid-to-large caps\nmarket_cap_filter = market_value.shift(1) > 15_000_000_000\n# P/B Ratio filter: Avoid extremely low P/B (potential value traps) and extremely high P/B\npb_ratio_current = pb_ratio.ffill().shift(1)\npb_filter = (pb_ratio_current > 0.8) & (pb_ratio_current < 5.0)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:17:49.241632",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-02T08:18:32.445910",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # Adjusted close price for filters\ntrading_value = data.get('price:成交金額')  # Trading value for liquidity filter\nmarket_value = data.get('etl:market_value')  # Market capitalization for size filter\ngross_margin = data.get('fundamental_features:營業毛利率')  # Underused quality factor\nnet_profit_margin = data.get('fundamental_features:稅後淨利率')  # Underused quality factor\ndebt_ratio = data.get('fundamental_features:負債比率')  # Underused risk factor\npe_ratio = data.get('price:本益比')  # Underused value factor\npb_ratio = data.get('price:股價淨值比')  # Underused value factor for filter\nmfi = data.indicator('MFI')  # Underused technical momentum/flow indicator\n# 2. Calculate factors (all shifted by 1 to prevent look-ahead bias)\n# Factor 1: Quality - Gross Profit Margin (Higher is better)\n# Use 4-quarter rolling average for smoothing fundamental data\nquality_gross_margin = gross_margin.ffill().rolling(4).mean().shift(1)\n# Factor 2: Quality - Net Profit Margin (Higher is better)\n# Use 4-quarter rolling average for smoothing fundamental data\nquality_net_margin = net_profit_margin.ffill().rolling(4).mean().shift(1)\n# Factor 3: Value - Inverse P/E Ratio (Lower P/E is better, so higher inverse P/E)\nvalue_inverse_pe = (1 / pe_ratio).ffill().shift(1)\n# Factor 4: Financial Health - Inverse Debt Ratio (Lower Debt Ratio is better, so higher inverse Debt Ratio)\nvalue_inverse_debt_ratio = (1 / debt_ratio).ffill().shift(1)\n# Factor 5: Money Flow Index (Higher MFI indicates stronger buying pressure)\nmomentum_mfi = mfi.shift(1)\n# 3. Normalize and combine factors\n# Normalize each factor to percentile ranks [0, 1]\nrank_gross_margin = quality_gross_margin.rank(axis=1, pct=True)\nrank_net_margin = quality_net_margin.rank(axis=1, pct=True)\nrank_inverse_pe = value_inverse_pe.rank(axis=1, pct=True)\nrank_inverse_debt_ratio = value_inverse_debt_ratio.rank(axis=1, pct=True)\nrank_mfi = momentum_mfi.rank(axis=1, pct=True)\n# Combine factors with custom weights, emphasizing quality and value\ncombined_factor = (\n    rank_gross_margin * 0.25 +\n    rank_net_margin * 0.25 +\n    rank_inverse_pe * 0.20 +\n    rank_inverse_debt_ratio * 0.15 +\n    rank_mfi * 0.15\n)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 100M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 100_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market cap filter: Market value > 15 Billion TWD to focus on mid-to-large caps\nmarket_cap_filter = market_value.shift(1) > 15_000_000_000\n# Value filter: P/B Ratio < 4 to avoid extremely overvalued stocks\npb_filter = pb_ratio.ffill().shift(1) < 4\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_filter]\n# 5. Select top N stocks\n# Select top 12 stocks based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets",
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:18:10.429245",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-02T08:18:39.584181",
      "model": "gemini-2.5-flash",
      "code": "import pandas as pd\n\ndef strategy(data):\n    # 1. Load data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n    open_price = data.get('price:開盤價') # Added for ATR calculation\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return)\n    # Using open_price for return calculation to avoid look-ahead bias on the current day's close\n    returns_20d = open_price.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - already shifted\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE quality filter - already shifted\n    roe_filter = roe.shift(1)\n\n    # Price to Earnings Ratio (PE) - shifted for historical value\n    pe_filter = pe_ratio.shift(1)\n\n    # Calculate True Range for ATR (using high, low, close from previous day)\n    high = data.get('price:最高價')\n    low = data.get('price:最低價')\n    # Shifted to ensure no look-ahead bias for ATR components\n    high_shifted = high.shift(1)\n    low_shifted = low.shift(1)\n    close_shifted = close.shift(1)\n\n    # True Range calculation\n    tr1 = high_shifted - low_shifted\n    tr2 = abs(high_shifted - close_shifted.shift(1))\n    tr3 = abs(low_shifted - close_shifted.shift(1))\n    true_range = pd.concat([tr1, tr2, tr3], axis=1).max(axis=1)\n\n    # Average True Range (ATR) - smoothing over 14 periods\n    atr = true_range.rolling(14).mean()\n\n    # Volatility filter: Inverse of ATR to favor lower volatility stocks\n    # Adding a small constant to prevent division by zero\n    volatility_factor = 1 / (atr + 1e-6)\n\n    # 3. Liquidity Filter (Average daily volume > 150M TWD)\n    # Assuming average share price is around 30 TWD for a rough estimate of volume * price\n    # A more precise way would be to use actual market value of shares traded.\n    # For now, using volume as a proxy and assuming average price.\n    # Let's use a more direct value-based liquidity filter if available, or adjust the volume threshold.\n    # Assuming 150M TWD is the value, and average price per share is 30 TWD, then volume > 150M/30 = 5M shares\n    avg_volume_20d = volume.rolling(20).mean().shift(1)\n    liquidity_filter = (avg_volume_20d * close.shift(1)) > 150_000_000\n\n    # 4. Define buy/sell signals\n\n    # Champion's successful patterns: ROE, Revenue Growth, Price Momentum\n    # New pattern: Add a value component (PE ratio) and Volatility filter (ATR)\n\n    # Condition 1: Quality (High ROE)\n    quality_condition = roe_filter > 12  # Slightly adjusted ROE threshold\n\n    # Condition 2: Growth (Positive and strong revenue growth)\n    growth_condition = revenue_growth_factor > 10 # Revenue growth > 10% YoY\n\n    # Condition 3: Momentum (Positive 20-day return)\n    momentum_condition = returns_20d > 0.05 # Strong positive momentum (5% in 20 days)\n\n    # Condition 4: Value (Reasonable PE ratio)\n    value_condition = (pe_filter < 25) & (pe_filter > 5) # PE between 5 and 25\n\n    # Condition 5: Low Volatility (Favor stocks with lower ATR)\n    # We want stocks with higher volatility_factor (lower ATR)\n    # Rank stocks by volatility_factor and select top quartile (lower ATR)\n    # Using quantile to select the top 25% of least volatile stocks\n    low_volatility_condition = volatility_factor.rank(ascending=False, pct=True) < 0.25\n\n\n    # Combine all conditions\n    # Stocks must meet quality, growth, momentum, value, low volatility, AND liquidity criteria\n    buy_signals = (\n        quality_condition &\n        growth_condition &\n        momentum_condition &\n        value_condition &\n        low_volatility_condition &\n        liquidity_filter\n    )\n\n    # Handle NaN values by filling with False (no signal)\n    buy_signals = buy_signals.fillna(False)\n\n    # 5. Return the position (boolean series for stock selection)\n    return buy_signals",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets",
        "Unknown dataset key: 'price:開盤價' not in available datasets",
        "Unknown dataset key: 'price:最高價' not in available datasets",
        "Unknown dataset key: 'price:最低價' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n- Unknown dataset key: 'price:開盤價' not in available datasets\n- Unknown dataset key: 'price:最高價' not in available datasets\n- Unknown dataset key: 'price:最低價' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:18:32.520540",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 10,
      "timestamp": "2025-11-02T08:18:44.253084",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    roe = data.get('fundamental_features:ROE稅後')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors, ensuring no look-ahead bias with .shift(1)\n    # Momentum factor: 20-day return, shifted by 1 day\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor: YoY, shifted by 1 month (assuming monthly data for revenue)\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE factor: shifted by 1 quarter (assuming quarterly data for ROE)\n    roe_factor = roe.shift(1)\n\n    # PE Ratio factor: shifted by 1 day\n    pe_factor = pe_ratio.shift(1)\n\n    # 3. Apply filters and create signals\n\n    # Filter 1: Quality - High ROE (preserve champion's strength)\n    # Target: ROE > 15 (as in successful modification example)\n    quality_filter = (roe_factor > 15)\n\n    # Filter 2: Growth - Positive revenue growth (enhance champion's strength)\n    # Target: Revenue YoY growth > 0%\n    growth_filter = (revenue_growth_factor > 0)\n\n    # Filter 3: Momentum - Positive 20-day price momentum (preserve champion's strength)\n    # Target: 20-day return > 0%\n    momentum_filter = (returns_20d > 0)\n\n    # Filter 4: Valuation - Reasonable PE ratio (new addition to improve Sharpe)\n    # Target: PE ratio between 5 and 30 (avoiding extreme over/undervaluation)\n    valuation_filter = (pe_factor > 5) & (pe_factor < 30)\n\n    # Filter 5: Liquidity - Average daily volume > 150M TWD (preserve constraint)\n    # Calculate average daily volume over 20 days\n    avg_volume_20d = (volume * close).rolling(20).mean().shift(1)\n    liquidity_filter = (avg_volume_20d > 150_000_000) # 150 million TWD\n\n    # Combine all filters to create the final selection\n    # All conditions must be met for a stock to be selected\n    stock_selection = quality_filter & growth_filter & momentum_filter & valuation_filter & liquidity_filter\n\n    # 4. Define position: Hold selected stocks\n    # Convert boolean selection to numeric position (1 for buy, 0 for hold/sell)\n    position = stock_selection.astype(float)\n\n    # Handle NaN values by filling with 0, meaning no position if data is missing\n    position = position.fillna(0)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:18:39.655358",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 11,
      "timestamp": "2025-11-02T08:18:54.077644",
      "model": "gemini-2.5-flash",
      "code": "import numpy as np\nimport pandas as pd\n\ndef strategy(data):\n    # 1. Load data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return, adjusted for 60-day smoothing)\n    returns_20d = close.pct_change(20).shift(1)\n    # Smooth momentum with a 60-day moving average to reduce whipsaws and improve robustness\n    momentum_smoothed = returns_20d.rolling(60).mean()\n\n    # Revenue growth factor (YoY) - using quarterly revenue growth for stability\n    # Assuming 'fundamental_features:營收成長率' is quarterly YoY growth\n    # If not available, we stick to monthly_revenue:去年同月增減(%) as in champion\n    # For robustness, we'll use monthly_revenue:去年同月增減(%) as given in champion's code preview\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE factor - high quality filter\n    roe_factor = roe.shift(1)\n\n    # Valuation factor (PE ratio) - low PE is better\n    pe_factor = pe_ratio.shift(1)\n\n    # 3. Apply filters and combine factors\n    # Liquidity filter: Average daily volume > 150M TWD (assuming price range 10-1000 TWD, so 150_000 shares is a rough proxy)\n    # More accurately, average daily turnover value needs to be > 150,000,000 TWD\n    # Calculate turnover = close * volume. Using volume directly as a proxy for now due to common Finlab practice.\n    # We will use average daily turnover value for precise filtering.\n    daily_turnover = close * volume\n    liquidity_filter = daily_turnover.rolling(20).mean().shift(1) > 150_000_000\n\n    # Quality filter: ROE > 10%\n    quality_filter = roe_factor > 10\n\n    # Growth filter: Revenue YoY growth > 0 (positive growth)\n    growth_filter = revenue_growth_factor > 0\n\n    # Valuation filter: PE ratio between 5 and 30 (avoiding extreme values)\n    # Lower PE is generally better, but extremely low PE can indicate distress.\n    valuation_filter = (pe_factor > 5) & (pe_factor < 30)\n\n    # Combine filters\n    combined_filters = liquidity_filter & quality_filter & growth_filter & valuation_filter\n\n    # Rank stocks based on smoothed momentum and select top performers\n    # We use rank to select the best among the filtered stocks\n    # Higher momentum_smoothed is better\n    momentum_rank = momentum_smoothed.rank(axis=1, ascending=False)\n\n    # Select top N stocks (e.g., top 20%) that pass all filters\n    # The number 0.2 can be tuned based on backtest results\n    position = (momentum_rank <= (momentum_smoothed.shape[1] * 0.2)) & combined_filters\n\n    # Ensure no NaN values in the final selection\n    position = position.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:18:44.356389",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 12,
      "timestamp": "2025-11-02T08:19:14.348490",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization\ngross_profit_margin = data.get('fundamental_features:營業毛利率') # Underused: Quality factor\npb_ratio = data.get('price:股價淨值比') # Underused: Value factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Financial health/Risk factor\ncci = data.indicator('CCI') # Underused: Technical indicator for mean reversion\n# 2. Calculate factors (all shifted by 1 to prevent look-ahead bias)\n# Factor 1: Quality - Gross Profit Margin (higher is better)\n# Use rolling 4-period mean for smoothing quarterly data, then ffill for daily alignment\nquality_gpm = gross_profit_margin.rolling(4).mean().ffill().shift(1)\n# Factor 2: Value - Price-to-Book Ratio (lower is better)\nvalue_pb = pb_ratio.ffill().shift(1)\n# Factor 3: Financial Health - Debt Ratio (lower is better)\nhealth_debt = debt_ratio.ffill().shift(1)\n# Factor 4: Size - Market Capitalization (mid-to-large cap bias)\nsize_market_cap = market_value.shift(1)\n# Factor 5: Mean Reversion - CCI (buy when oversold, i.e., low CCI values)\nmean_reversion_cci = cci.shift(1)\n# 3. Normalize and combine factors\n# Normalize each factor to percentile ranks [0, 1]\n# For factors where lower values are better (P/B, Debt Ratio, oversold CCI), rank in descending order.\ngpm_rank = quality_gpm.rank(axis=1, pct=True) # Higher GPM is better\npb_rank = value_pb.rank(axis=1, pct=True, ascending=False) # Lower P/B is better\ndebt_rank = health_debt.rank(axis=1, pct=True, ascending=False) # Lower Debt Ratio is better\nmarket_cap_rank = size_market_cap.rank(axis=1, pct=True) # Higher Market Cap is better (for mid-large cap bias)\ncci_rank = mean_reversion_cci.rank(axis=1, pct=True, ascending=False) # Lower CCI (oversold) is better\n# Combine with diverse weights\ncombined_factor = (gpm_rank * 0.30 +\n                   pb_rank * 0.25 +\n                   debt_rank * 0.20 +\n                   market_cap_rank * 0.15 +\n                   cci_rank * 0.10)\n# 4. Apply filters for liquidity, price, and market cap\n# Liquidity filter: Average daily trading value over 20 days > 70 million TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD (avoiding penny stocks)\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (focus on mid-to-large cap)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# P/B Ratio sanity filter: Avoid extremely low P/B which might indicate distress\npb_sanity_filter = value_pb > 0.5\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_sanity_filter]\n# 5. Select top N stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Rebalance quarterly with an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:18:54.151110",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 13,
      "timestamp": "2025-11-02T08:19:29.875039",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value')\npe_ratio = data.get('price:本益比')\ngross_profit_margin = data.get('fundamental_features:營業毛利率')\ndebt_ratio = data.get('fundamental_features:負債比率')\n# 2. Calculate factors (prioritizing underused factors)\n# Factor 1: Value (Inverse P/E Ratio) - Higher is better\n# Use .ffill() for fundamental data, then .shift(1)\nvalue_factor = (1 / pe_ratio).ffill().shift(1)\n# Factor 2: Quality (Gross Profit Margin) - Higher is better\nquality_factor = gross_profit_margin.ffill().shift(1)\n# Factor 3: Financial Health (Inverse Debt Ratio) - Lower debt is better, so (100 - debt_ratio) makes higher better\nhealth_factor = (100 - debt_ratio).ffill().shift(1)\n# 3. Combine factors (normalize first!)\nvalue_rank = value_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\nhealth_rank = health_factor.rank(axis=1, pct=True)\n# Combine with diverse weights\ncombined_factor = (value_rank * 0.45 +\n                   quality_rank * 0.35 +\n                   health_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 60_000_000\n# Price filter: Avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter (Underused factor as a filter): Target mid-cap stocks (e.g., 5B to 50B TWD)\nmarket_cap_filter = (market_value.shift(1) > 5_000_000_000) & \\\n                    (market_value.shift(1) < 50_000_000_000)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:19:14.424766",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 14,
      "timestamp": "2025-11-02T08:19:45.985045",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - Prioritize underused factors and avoid frequently used ones\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization (Size factor)\ngross_profit_margin = data.get('fundamental_features:營業毛利率') # Underused: Quality factor\nnet_profit_margin = data.get('fundamental_features:稅後淨利率') # Underused: Quality factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Risk/Quality factor\npb_ratio = data.get('price:股價淨值比') # Underused: Value factor\n# 2. Calculate factors - Ensure .shift(1) and .ffill() for lower frequency data\n# Factor 1: Quality - Combined Profitability (Gross and Net Profit Margins)\n# Use 4-quarter rolling average for smoothing fundamental data\nprofitability_factor = (gross_profit_margin.ffill().rolling(4).mean() +\n                        net_profit_margin.ffill().rolling(4).mean()).shift(1)\n# Factor 2: Financial Health - Inverse Debt Ratio (Lower debt is better)\n# Use 4-quarter rolling average for smoothing\nfinancial_health_factor = (debt_ratio.ffill().rolling(4).mean()).shift(1)\n# Factor 3: Value - Inverse Price-to-Book Ratio (Lower P/B is better)\nvalue_factor = pb_ratio.ffill().shift(1)\n# Factor 4: Size - Market Capitalization (Favor larger, more stable companies)\nsize_factor = market_value.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nprofitability_rank = profitability_factor.rank(axis=1, pct=True)\n# For debt ratio and P/B, lower values are better, so invert the rank\nfinancial_health_rank = (1 - financial_health_factor.rank(axis=1, pct=True))\nvalue_rank = (1 - value_factor.rank(axis=1, pct=True))\n# For market cap, higher values are better\nsize_rank = size_factor.rank(axis=1, pct=True)\n# Combine with diverse weights\ncombined_factor = (profitability_rank * 0.40 + # Strong emphasis on core profitability\n                   financial_health_rank * 0.20 + # Good financial health\n                   value_rank * 0.20 + # Undervalued assets\n                   size_rank * 0.20) # Stability from larger market cap\n# 4. Apply filters - Mandatory liquidity and price filters, plus a market cap filter for stability\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market cap filter: Only consider companies with market value > 15 Billion TWD (mid-to-large cap)\nmarket_cap_filter = market_value.shift(1) > 15_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks - Top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:19:29.956120",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 15,
      "timestamp": "2025-11-02T08:19:50.515053",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return), shifted to prevent look-ahead bias\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY), shifted\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE filter: Preserve the quality aspect of the champion\n    # Apply a reasonable threshold for good ROE\n    roe_filter = roe.shift(1) > 10 # Shift ROE for look-ahead prevention\n\n    # Price-to-Earnings (PE) ratio filter: Add a value component.\n    # We want to avoid extremely high PE ratios, indicating overvaluation.\n    # Using a cap to filter out very expensive stocks.\n    pe_filter = (pe_ratio.shift(1) < 30) | pe_ratio.shift(1).isna() # Allow NaN or reasonable PE\n\n    # Moving Average Crossover (MAC) for trend confirmation and smoother entry/exit\n    # Short-term MA (20 days) and Long-term MA (60 days)\n    ma_20 = close.rolling(20).mean().shift(1)\n    ma_60 = close.rolling(60).mean().shift(1)\n    ma_crossover = ma_20 > ma_60 # Bullish trend when short MA > long MA\n\n    # 3. Combine factors to generate a selection signal\n\n    # Combine momentum and revenue growth. Rank them to pick the best.\n    # Higher weighting on revenue growth for stronger fundamental momentum.\n    combined_growth_momentum = (returns_20d.rank(axis=1, ascending=False) * 0.4 +\n                                revenue_growth_factor.rank(axis=1, ascending=False) * 0.6)\n\n    # Select top 20% based on combined growth and momentum, after filtering for quality and value\n    selection_signal = (roe_filter & pe_filter & ma_crossover &\n                        (combined_growth_momentum.rank(axis=1, ascending=True) <= combined_growth_momentum.count(axis=1) * 0.2))\n\n    # 4. Liquidity filter (Mandatory constraint)\n    # Calculate average daily volume over 20 days\n    avg_volume_20d = volume.rolling(20).mean().shift(1)\n    # Convert average volume to TWD for comparison (price * volume)\n    avg_trade_value_20d = avg_volume_20d * close.shift(1)\n    liquidity_filter = avg_trade_value_20d > 150_000_000 # Filter for >150M TWD\n\n    # 5. Final position\n    # Combine selected stocks with liquidity filter\n    position = selection_signal & liquidity_filter\n\n    # Handle potential NaN values by filling with False (no position)\n    position = position.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:19:46.065574",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 16,
      "timestamp": "2025-11-02T08:19:55.194401",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return), shifted to prevent look-ahead\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY), shifted\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE factor, shifted\n    roe_factor = roe.shift(1)\n\n    # PE Ratio, shifted\n    pe_ratio_factor = pe_ratio.shift(1)\n\n    # 3. Apply liquidity filter: Average daily volume > 150M TWD\n    # Calculate daily trading value = close * volume\n    trading_value = close * volume\n    # Calculate 20-day average trading value\n    liquidity_filter = trading_value.rolling(20).mean().shift(1) > 150_000_000\n\n    # 4. Define selection criteria based on successful patterns and targeted improvements\n\n    # Improve ROE filter: select companies with ROE > 15% and also growing\n    # Adding a minimum ROE threshold and ensuring it's positive.\n    roe_condition = (roe_factor > 10)\n\n    # Improve revenue growth: filter for strong positive growth\n    # Increase the threshold for revenue growth.\n    revenue_growth_condition = (revenue_growth_factor > 15)\n\n    # Enhance momentum: Filter for stocks with positive 20-day returns\n    # Consider a higher threshold for momentum.\n    momentum_condition = (returns_20d > 0.05) # Only positive momentum\n\n    # Add a value component: Filter for reasonable PE ratio (avoiding extremely high valuations)\n    # Avoid extremely high PE ratios, but allow for growth stocks with higher PEs\n    pe_condition = (pe_ratio_factor < 40) & (pe_ratio_factor > 0) # Avoid negative or excessively high PE\n\n    # Combine all conditions\n    # Prioritize quality (ROE) and growth (revenue), then add momentum and value.\n    # The combination of these factors aims to improve Sharpe while maintaining drawdown.\n    long_condition = (roe_condition & revenue_growth_condition & momentum_condition & pe_condition & liquidity_filter)\n\n    # 5. Handle NaN values and ensure boolean output\n    # Fill NaN values with False for the long_condition to avoid selecting stocks with incomplete data\n    long_condition = long_condition.fillna(False)\n\n    return long_condition",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:19:50.598922",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 17,
      "timestamp": "2025-11-02T08:20:11.964229",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\noperating_margin = data.get('fundamental_features:營業利益率')\npb_ratio = data.get('price:股價淨值比')\ndebt_ratio = data.get('fundamental_features:負債比率')\nmarket_cap = data.get('etl:market_value')\n# 2. Calculate factors (using underused factors)\n# Factor 1: Operating Profitability (Quality) - Higher is better\n# Forward-fill monthly/quarterly data and shift to avoid look-ahead bias\nquality_operating_margin = operating_margin.ffill().shift(1)\n# Factor 2: Inverse Price-to-Book (Value) - Higher is better (lower P/B)\n# Handle potential division by zero or NaN for P/B ratio\nvalue_inverse_pb = (1 / pb_ratio.ffill().shift(1)).replace([float('inf'), -float('inf')], float('nan'))\n# Factor 3: Financial Health (Risk) - Lower debt is better, so higher inverse is better\n# Assuming debt_ratio is a percentage, 100 - debt_ratio gives a health score\nhealth_inverse_debt = (100 - debt_ratio.ffill().shift(1)).clip(lower=0) # Ensure non-negative\n# Factor 4: Inverse Market Cap (Size bias towards smaller/mid-cap) - Higher is better (smaller market cap)\nsize_inverse_market_cap = (1 / market_cap.shift(1)).replace([float('inf'), -float('inf')], float('nan'))\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nquality_rank = quality_operating_margin.rank(axis=1, pct=True)\nvalue_rank = value_inverse_pb.rank(axis=1, pct=True)\nhealth_rank = health_inverse_debt.rank(axis=1, pct=True)\nsize_rank = size_inverse_market_cap.rank(axis=1, pct=True)\n# Combine with meaningful weights, prioritizing quality and value\ncombined_factor = (quality_rank * 0.35 +\n                   value_rank * 0.30 +\n                   health_rank * 0.20 +\n                   size_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 40M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Focus on small-to-mid caps (1 Billion to 50 Billion TWD)\nmarket_cap_filter = (market_cap.shift(1) > 1_000_000_000) & \\\n                    (market_cap.shift(1) < 50_000_000_000)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:19:55.278829",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 18,
      "timestamp": "2025-11-02T08:20:35.954193",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization (underused, for size factor)\n# Underused fundamental factors for diversity\npe_ratio = data.get('price:本益比') # P/E Ratio (underused, for value factor)\npb_ratio = data.get('price:股價淨值比') # P/B Ratio (underused, for value factor)\ngross_margin = data.get('fundamental_features:營業毛利率') # Gross Profit Margin (underused, for quality factor)\nnet_margin = data.get('fundamental_features:稅後淨利率') # Net Profit Margin (underused, for quality factor)\ndebt_ratio = data.get('fundamental_features:負債比率') # Debt Ratio (underused, for financial health factor)\n# 2. Calculate factors (all shifted by 1 to prevent look-ahead bias)\n# Factor 1: Value Factor (Inverse P/E and P/B)\n# Handle potential division by zero or negative values for P/E and P/B\n# Replace non-positive P/E and P/B with NaN, then fill with a neutral value (e.g., median or mean rank)\n# For ranking, it's often better to rank the inverse directly or rank the original and invert the rank.\n# Here, we'll rank the original and then invert the percentile rank for lower P/E/P/B being better.\npe_rank = pe_ratio.ffill().shift(1).rank(axis=1, pct=True)\npb_rank = pb_ratio.ffill().shift(1).rank(axis=1, pct=True)\n# Invert ranks: 1 - rank makes lower original value (e.g., P/E) result in higher factor score\nvalue_factor = (1 - pe_rank) * 0.5 + (1 - pb_rank) * 0.5\n# Factor 2: Quality Factor (Average of Gross Profit Margin and Net Profit Margin)\n# Higher margins are better\ngross_margin_factor = gross_margin.ffill().shift(1)\nnet_margin_factor = net_margin.ffill().shift(1)\nquality_factor = (gross_margin_factor.rank(axis=1, pct=True) + net_margin_factor.rank(axis=1, pct=True)) / 2\n# Factor 3: Financial Health Factor (Inverse Debt Ratio)\n# Lower debt ratio is better, so we invert the rank\ndebt_ratio_factor = debt_ratio.ffill().shift(1)\nfinancial_health_factor = 1 - debt_ratio_factor.rank(axis=1, pct=True)\n# Factor 4: Size Factor (Inverse Market Capitalization - preference for smaller caps)\n# Smaller market value is better, so we invert the rank\nmarket_value_factor = market_value.ffill().shift(1)\nsize_factor = 1 - market_value_factor.rank(axis=1, pct=True)\n# 3. Combine factors (normalize first, then combine with weights)\n# All factors are already in percentile rank form [0, 1] due to the way they were constructed or inverted.\n# Assign weights to prioritize value and quality, with supporting roles for financial health and small-cap.\ncombined_factor = (value_factor * 0.35 +\n                   quality_factor * 0.30 +\n                   financial_health_factor * 0.20 +\n                   size_factor * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days, higher threshold for diversity\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 80_000_000\n# Price filter: Avoid penny stocks, slightly higher threshold\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Target small to mid-cap stocks (e.g., 1B to 20B TWD)\nmarket_cap_filter = (market_value.shift(1) > 1_000_000_000) & \\\n                    (market_value.shift(1) < 20_000_000_000)\n# Value filters: Ensure reasonable P/E and P/B ratios\n# P/E must be positive and not excessively high (e.g., < 25)\npe_filter = (pe_ratio.shift(1) > 0) & (pe_ratio.shift(1) < 25)\n# P/B must be positive and not excessively high (e.g., < 3.0)\npb_filter = (pb_ratio.shift(1) > 0.5) & (pb_ratio.shift(1) < 3.0) # Avoid extremely low P/B which might indicate distress\n# Apply all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & pe_filter & pb_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks\n# Select top N stocks (e.g., 10-15) based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets",
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:20:12.050616",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 19,
      "timestamp": "2025-11-02T08:21:02.420779",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused factor: Market Capitalization\n# Underused fundamental factors for Quality, Value, and Financial Health\noperating_margin = data.get('fundamental_features:營業利益率') # Quality factor\npe_ratio = data.get('price:本益比') # Value factor\npb_ratio = data.get('price:股價淨值比') # Value factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Financial Health/Risk factor\n# 2. Calculate factors\n# Factor 1: Quality (Operating Profit Margin) - Higher is better\n# Use ffill for quarterly data and shift to avoid look-ahead bias\nquality_factor = operating_margin.ffill().shift(1)\n# Factor 2: Value (Inverse P/E Ratio) - Lower P/E is better, so rank P/E in descending order\n# Shift to avoid look-ahead bias\nvalue_pe_factor = pe_ratio.shift(1)\n# Factor 3: Financial Health (Inverse Debt Ratio) - Lower debt ratio is better, so rank debt ratio in descending order\n# Use ffill for quarterly data and shift to avoid look-ahead bias\nhealth_factor = debt_ratio.ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\n# For quality_factor, higher is better, so rank ascending (default)\nquality_rank = quality_factor.rank(axis=1, pct=True)\n# For value_pe_factor, lower P/E is better, so rank descending\nvalue_pe_rank = value_pe_factor.rank(axis=1, ascending=False, pct=True)\n# For health_factor, lower debt ratio is better, so rank descending\nhealth_rank = health_factor.rank(axis=1, ascending=False, pct=True)\n# Combine with diverse weights\n# Emphasize Quality and Financial Health, with a strong component of Value\ncombined_factor = (quality_rank * 0.40 +\n                   value_pe_rank * 0.35 +\n                   health_rank * 0.25)\n# 4. Apply filters for structural diversity and risk management\n# Liquidity filter: Average daily trading value over 20 days (higher threshold for mid-caps)\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 80_000_000\n# Price filter: Avoid penny stocks, set a higher minimum price\nprice_filter = close.shift(1) > 25\n# Market Cap filter: Target mid-cap stocks (e.g., 5 Billion to 100 Billion TWD)\n# This uses an underused factor for filtering, differentiating from common small-cap or large-cap biases\nmarket_cap_shifted = market_value.shift(1)\nmarket_cap_filter = (market_cap_shifted > 5_000_000_000) & (market_cap_shifted < 100_000_000_000)\n# P/E Ratio filter: Filter out extremely high or negative P/E ratios (often noisy)\npe_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 40)\n# Debt Ratio filter: Filter out companies with excessively high debt (e.g., > 80%)\ndebt_ratio_filter = debt_ratio.ffill().shift(1) < 80\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pe_filter & debt_ratio_filter]\n# 5. Select stocks\n# Select top 12 stocks based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets",
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:20:36.041677",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 20,
      "timestamp": "2025-11-02T08:21:24.518987",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused, for size filter and potential factor\ngross_margin = data.get('fundamental_features:營業毛利率') # Underused quality factor\nnet_margin = data.get('fundamental_features:稅後淨利率') # Underused quality factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused risk factor\npb_ratio = data.get('price:股價淨值比') # Underused value factor\n# 2. Calculate factors\n# Factor 1: Quality - Gross Profit Margin (higher is better)\n# Use .ffill() for quarterly data and .shift(1) to avoid look-ahead bias\nfactor_gross_margin = gross_margin.ffill().shift(1)\n# Factor 2: Quality - Net Profit Margin (higher is better)\nfactor_net_margin = net_margin.ffill().shift(1)\n# Factor 3: Financial Health - Inverse Debt Ratio (lower debt is better)\n# To make it a \"higher is better\" factor, we'll invert the rank later.\nfactor_debt_ratio = debt_ratio.ffill().shift(1)\n# Factor 4: Value - Inverse Price-to-Book Ratio (lower P/B is better)\n# To make it a \"higher is better\" factor, we'll invert the rank later.\nfactor_pb_ratio = pb_ratio.ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nrank_gross_margin = factor_gross_margin.rank(axis=1, pct=True)\nrank_net_margin = factor_net_margin.rank(axis=1, pct=True)\n# For debt ratio and P/B ratio, lower values are better, so we invert the rank\nrank_inverse_debt_ratio = 1 - factor_debt_ratio.rank(axis=1, pct=True)\nrank_inverse_pb_ratio = 1 - factor_pb_ratio.rank(axis=1, pct=True)\n# Combine with custom weights, prioritizing quality and financial health\ncombined_factor = (\n    rank_gross_margin * 0.35 +\n    rank_net_margin * 0.30 +\n    rank_inverse_debt_ratio * 0.20 +\n    rank_inverse_pb_ratio * 0.15\n)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 40M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market capitalization filter: Market value > 5 Billion TWD to avoid micro-caps\nmarket_cap_filter = market_value.shift(1) > 5_000_000_000\n# Financial health filter: Debt ratio < 70% to exclude highly leveraged companies\ndebt_health_filter = factor_debt_ratio < 70\n# Apply all filters\nfiltered_factor = combined_factor[\n    liquidity_filter &\n    price_filter &\n    market_cap_filter &\n    debt_health_filter\n]\n# 5. Select stocks\n# Select top 12 stocks based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:21:02.517726",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 21,
      "timestamp": "2025-11-02T08:21:42.601624",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused factor, used for size filter\n# Underused fundamental factors for Quality, Value, and Financial Health\ngross_margin = data.get('fundamental_features:營業毛利率')\nnet_margin = data.get('fundamental_features:稅後淨利率')\ndebt_ratio = data.get('fundamental_features:負債比率')\npb_ratio = data.get('price:股價淨值比')\n# 2. Calculate factors (all shifted to prevent look-ahead bias)\n# Quality Factor 1: Gross Profitability (Higher is better)\n# Use 4-quarter rolling mean for smoothing fundamental data\ngross_profitability = gross_margin.rolling(4).mean().ffill().shift(1)\n# Quality Factor 2: Net Profitability (Higher is better)\nnet_profitability = net_margin.rolling(4).mean().ffill().shift(1)\n# Financial Health Factor: Debt Ratio (Lower is better)\ndebt_health = debt_ratio.ffill().shift(1)\n# Value Factor: Price-to-Book Ratio (Lower is better)\nvalue_pb = pb_ratio.ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\ngross_profitability_rank = gross_profitability.rank(axis=1, pct=True)\nnet_profitability_rank = net_profitability.rank(axis=1, pct=True)\n# For factors where lower values are better (Debt Ratio, P/B Ratio), invert the rank\n# (1 - rank) ensures that lower original values get higher final ranks\ndebt_health_rank = (1 - debt_health.rank(axis=1, pct=True))\nvalue_pb_rank = (1 - value_pb.rank(axis=1, pct=True))\n# Combine with unique weights, emphasizing quality and financial health\ncombined_factor = (gross_profitability_rank * 0.35 +\n                   net_profitability_rank * 0.30 +\n                   debt_health_rank * 0.20 +\n                   value_pb_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 60M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 60_000_000\n# Price filter: Stock price > 25 TWD (avoiding very low-priced stocks)\nprice_filter = close.shift(1) > 25\n# Market Cap filter: Target small to mid-cap stocks (1B to 100B TWD)\n# This helps differentiate from large-cap focused strategies\nmarket_cap_filter = (market_value.shift(1) > 1_000_000_000) & \\\n                    (market_value.shift(1) < 100_000_000_000)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 15 stocks based on the combined factor score\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:21:24.643012",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 22,
      "timestamp": "2025-11-02T08:21:59.882759",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused factor, used for size filter\npe_ratio = data.get('price:本益比') # Underused factor: Valuation\noperating_margin = data.get('fundamental_features:營業利益率') # Underused factor: Quality\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused factor: Risk/Quality filter\ninv_trust_strength = data.get('institutional_investors_trading_summary:投信買賣超股數') # Less common institutional flow\n# 2. Calculate factors\n# Factor 1: Value (Inverse P/E Ratio) - Prioritize lower P/E\n# Handle potential division by zero or negative P/E by setting to NaN, rank will handle it.\nvalue_factor = (1 / pe_ratio).replace([float('inf'), -float('inf')], float('nan')).shift(1)\n# Factor 2: Quality (Operating Profit Margin) - Prioritize higher margin\n# Use ffill for quarterly data and shift to avoid look-ahead bias\nquality_factor = operating_margin.ffill().shift(1)\n# Factor 3: Institutional Conviction (Investment Trust Strength) - Prioritize positive strength\n# Smooth with a 5-day rolling mean to capture short-term conviction\ninv_trust_factor = inv_trust_strength.rolling(5).mean().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nvalue_rank = value_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\ninv_trust_rank = inv_trust_factor.rank(axis=1, pct=True)\n# Combine with weights, emphasizing value and quality\ncombined_factor = (value_rank * 0.45 +\n                   quality_rank * 0.35 +\n                   inv_trust_rank * 0.20)\n# 4. Apply diverse filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 15 Billion TWD to focus on mid-to-large caps\nmarket_cap_filter = market_value.shift(1) > 15_000_000_000\n# Debt Ratio filter: Debt ratio < 60% to select financially sound companies\ndebt_ratio_filter = debt_ratio.ffill().shift(1) < 60\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & debt_ratio_filter]\n# 5. Select stocks\n# Select top 12 stocks based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:21:42.691253",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 23,
      "timestamp": "2025-11-02T08:22:21.358137",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # Adjusted close for price filter\ntrading_value = data.get('price:成交金額')  # Trading value for liquidity filter\npb_ratio = data.get('price:股價淨值比')  # Underused factor: Price-to-Book Ratio\nnet_profit_margin = data.get('fundamental_features:稅後淨利率')  # Underused factor: Net Profit Margin\ndebt_ratio = data.get('fundamental_features:負債比率')  # Underused factor: Debt Ratio\nmarket_value = data.get('etl:market_value')  # Underused factor: Market Capitalization\n# 2. Calculate factors (all shifted by 1, ffill for fundamental/valuation data)\n# Factor 1: Value (Price-to-Book Ratio) - Lower P/B is generally better\nvalue_factor = pb_ratio.ffill().shift(1)\n# Factor 2: Quality (Net Profit Margin) - Higher margin indicates better profitability\nquality_factor = net_profit_margin.ffill().shift(1)\n# Factor 3: Financial Health (Debt Ratio) - Lower debt ratio indicates stronger financial health\nhealth_factor = debt_ratio.ffill().shift(1)\n# Factor 4: Size (Market Capitalization) - Smaller market cap is favored for potential small-cap premium\nsize_factor = market_value.ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nvalue_rank = value_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\nhealth_rank = health_factor.rank(axis=1, pct=True)\nsize_rank = size_factor.rank(axis=1, pct=True)\n# Adjust ranks for \"lower is better\" factors (Value, Health, Size)\n# We want higher scores for better stocks, so for these, we use (1 - rank)\nvalue_rank_adjusted = 1 - value_rank\nhealth_rank_adjusted = 1 - health_rank\nsize_rank_adjusted = 1 - size_rank\n# Combine factors with specific weights. Emphasize value and quality.\ncombined_factor = (value_rank_adjusted * 0.35 +\n                   quality_rank * 0.30 +\n                   health_rank_adjusted * 0.20 +\n                   size_rank_adjusted * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 50M TWD over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Target small to mid-cap stocks (e.g., < 50 Billion TWD)\n# This reinforces the small-cap bias from the size factor and adds structural diversity.\nmarket_cap_filter = market_value.ffill().shift(1) < 50_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks (top 10 stocks based on the combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:21:59.989057",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 24,
      "timestamp": "2025-11-02T08:22:26.485322",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return) - Original\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - Original\n    # Smoothed with a 3-month rolling average to reduce noise\n    revenue_growth_factor = revenue_yoy.shift(1).rolling(window=3).mean()\n\n    # ROE filter - Original, but we'll apply a tighter filter\n    # Combined with PE ratio to identify undervalued quality stocks\n    roe_filter = (roe.shift(1) > 15) & (pe_ratio.shift(1) > 0) & (pe_ratio.shift(1) < 25) # Added PE filter\n\n    # Volume filter for liquidity - Original (modified to average daily turnover)\n    # Ensure average daily turnover > 150M TWD\n    avg_daily_turnover = (close * volume).rolling(window=20).mean().shift(1)\n    liquidity_filter = avg_daily_turnover > 150_000_000\n\n    # 3. Combine factors for stock selection\n    # Emphasize strong positive momentum and revenue growth\n    # Rank stocks based on momentum and revenue growth, then select top performers\n    momentum_rank = returns_20d.rank(axis=1, ascending=False)\n    revenue_rank = revenue_growth_factor.rank(axis=1, ascending=False)\n\n    # Combine ranks using an equal weight approach\n    combined_rank = (momentum_rank + revenue_rank) / 2\n\n    # Select top 10% of stocks based on combined rank, after applying fundamental and liquidity filters\n    # Only consider stocks meeting ROE and PE criteria, and liquidity\n    filtered_stocks = roe_filter & liquidity_filter\n\n    # Apply combined rank only to filtered stocks and select top 10%\n    # Ensure to handle NaN values before ranking and selection\n    selected_stocks = combined_rank[filtered_stocks].rank(axis=1, ascending=True) < (combined_rank[filtered_stocks].count(axis=1) * 0.10)\n\n    # 4. Define position\n    # Long positions for selected stocks\n    position = selected_stocks.astype(int)\n\n    # Handle NaN values to ensure robustness\n    position = position.fillna(0)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:22:21.448613",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 25,
      "timestamp": "2025-11-02T08:22:31.475946",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return) - Original\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - Original\n    # Smoothed with a 3-month rolling mean to reduce noise and improve stability\n    revenue_growth_factor = revenue_yoy.rolling(3).mean().shift(1)\n\n    # ROE filter - Original\n    # Strengthened ROE requirement and added a minimum threshold\n    roe_filter = (roe.shift(1) > 10) & (roe.shift(1) < 50) # Avoid extremely high/low ROE\n\n    # PE Ratio filter - New: Add a value component to balance growth/momentum with valuation\n    # Filter out extremely high PE stocks, indicating overvaluation\n    pe_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 30) # Reasonable PE range\n\n    # 3. Combine factors to create a ranking score\n    # Normalize factors to avoid dominance by any single factor\n    momentum_rank = returns_20d.rank(axis=1, ascending=False)\n    revenue_growth_rank = revenue_growth_factor.rank(axis=1, ascending=False)\n\n    # Combined score, giving more weight to momentum and adding revenue growth\n    # Increased weight on revenue growth slightly to enhance performance\n    score = (momentum_rank * 0.6) + (revenue_growth_rank * 0.4)\n\n    # 4. Apply filters\n    # Liquidity filter: Average daily volume > 150M TWD\n    avg_volume = (volume * close).rolling(20).mean().shift(1)\n    liquidity_filter = avg_volume > 150_000_000\n\n    # Combine all filters and select top stocks based on score\n    # Apply ROE and PE filters before ranking to narrow down the universe\n    filtered_stocks = roe_filter & pe_filter & liquidity_filter\n    \n    # Apply the score only to filtered stocks\n    # Fill NaN scores with a high number to effectively remove them from top ranks\n    score = score.where(filtered_stocks).fillna(score.max().max() + 1)\n\n    # Select top 5 stocks by score (lower score is better after ranking)\n    # Changed to top 5 to focus on higher conviction trades\n    position = score.rank(axis=1, method='first') <= 5\n\n    # Ensure no NaN in the final output\n    position = position.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:22:26.572200",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 26,
      "timestamp": "2025-11-02T08:22:35.910089",
      "model": "gemini-2.5-flash",
      "code": "import pandas as pd\nimport numpy as np\n\ndef strategy(data):\n    # 1. Load data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數') * close # Calculate turnover in TWD\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Liquidity Filter: Ensure average daily turnover > 150M TWD\n    # Calculate average daily turnover over 20 days\n    avg_daily_turnover = volume.rolling(20).mean().shift(1)\n    liquid_stocks = avg_daily_turnover > 150_000_000\n\n    # 3. Calculate factors\n    # Momentum factor (20-day return, shifted to prevent look-ahead)\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY, shifted)\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE quality factor (shifted)\n    roe_factor = roe.shift(1)\n\n    # PE Ratio factor (shifted) - Lower PE is generally better\n    pe_factor = pe_ratio.shift(1)\n\n    # 4. Define selection criteria\n    # High ROE: Top 30% of ROE, ensure it's positive and not excessively high (e.g., due to one-off events)\n    # Using rank to select top performers\n    roe_rank = roe_factor.rank(axis=1, ascending=False)\n    high_roe = (roe_rank <= (roe_factor.shape[1] * 0.30)) & (roe_factor > 0) & (roe_factor < 50) # Cap ROE to avoid outliers\n\n    # Strong Revenue Growth: Top 40% of YoY growth, must be positive\n    revenue_growth_rank = revenue_growth_factor.rank(axis=1, ascending=False)\n    strong_growth = (revenue_growth_rank <= (revenue_growth_factor.shape[1] * 0.40)) & (revenue_growth_factor > 0)\n\n    # Momentum: Top 30% of 20-day returns\n    momentum_rank = returns_20d.rank(axis=1, ascending=False)\n    positive_momentum = (momentum_rank <= (returns_20d.shape[1] * 0.30)) & (returns_20d > 0)\n\n    # Value: PE Ratio filter - between 5 and 30, and not in the highest 20% (lower PE is better for value)\n    # Using a combination of absolute range and rank to find reasonable value\n    pe_rank = pe_factor.rank(axis=1, ascending=True)\n    reasonable_pe = (pe_factor >= 5) & (pe_factor <= 30) & (pe_rank <= (pe_factor.shape[1] * 0.80)) # Not in the highest 20% PE\n\n    # 5. Combine conditions to create the final selection\n    # Emphasize ROE, Growth, and Momentum, with a reasonable PE\n    # All conditions must be met for selection\n    selection = high_roe & strong_growth & positive_momentum & reasonable_pe & liquid_stocks\n\n    # 6. Handle NaN values and ensure boolean output\n    selection = selection.fillna(False)\n\n    # Return the boolean series indicating selected stocks\n    return selection",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:22:31.566469",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 27,
      "timestamp": "2025-11-02T08:23:23.095704",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_cap = data.get('etl:market_value') # Underused factor: Market Capitalization\noperating_margin = data.get('fundamental_features:營業利益率') # Underused factor: Operating Profit Margin\npb_ratio = data.get('price:股價淨值比') # Underused factor: Price-to-Book Ratio\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused factor: Debt Ratio\n# 2. Calculate factors with .shift(1) to prevent look-ahead bias\n# Factor 1: Quality - Operating Profitability (higher is better)\n# Use .ffill() for fundamental data to align to daily frequency\nquality_op_margin = operating_margin.ffill().shift(1)\n# Factor 2: Value - Inverse Price-to-Book (lower P/B is better, so inverse is higher)\n# Handle potential division by zero or inf by replacing with NaN before ranking\ninverse_pb = (1 / pb_ratio.ffill().shift(1)).replace([float('inf'), -float('inf')], float('nan'))\n# Factor 3: Financial Health - Inverse Debt Ratio (lower debt is better, so inverse is higher)\n# Handle potential division by zero or inf by replacing with NaN before ranking\ninverse_debt_ratio = (1 / debt_ratio.ffill().shift(1)).replace([float('inf'), -float('inf')], float('nan'))\n# Factor 4: Size - Inverse Market Capitalization (smaller cap is better, so inverse is higher)\ninverse_market_cap = (1 / market_cap.shift(1)).replace([float('inf'), -float('inf')], float('nan'))\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nquality_op_margin_rank = quality_op_margin.rank(axis=1, pct=True)\ninverse_pb_rank = inverse_pb.rank(axis=1, pct=True)\ninverse_debt_ratio_rank = inverse_debt_ratio.rank(axis=1, pct=True)\ninverse_market_cap_rank = inverse_market_cap.rank(axis=1, pct=True)\n# Combine with diverse weights, emphasizing quality and value\ncombined_factor = (quality_op_margin_rank * 0.35 +\n                   inverse_pb_rank * 0.30 +\n                   inverse_debt_ratio_rank * 0.20 +\n                   inverse_market_cap_rank * 0.15)\n# 4. Apply filters for liquidity, price, and market cap range (structural diversity)\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Target mid-cap stocks (5B to 50B TWD)\n# This avoids both micro-caps and mega-caps, creating a unique segment.\nmarket_cap_filter = (market_cap.shift(1) > 5_000_000_000) & (market_cap.shift(1) < 50_000_000_000)\n# P/B Ratio filter: Exclude extremely high P/B stocks (e.g., > 5.0)\n# Even though inverse P/B is a factor, this acts as a hard cap for outliers.\npb_filter = pb_ratio.ffill().shift(1) < 5.0\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_filter]\n# 5. Select top N stocks (selecting 15 stocks for diversification)\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:22:36.001796",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 28,
      "timestamp": "2025-11-02T08:23:44.096284",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused factor, used as filter\n# Underused/rare factors for diversity\nop_margin = data.get('fundamental_features:營業利益率') # Operating Profit Margin\npe_ratio = data.get('price:本益比') # P/E Ratio\ndebt_ratio = data.get('fundamental_features:負債比率') # Debt Ratio\nadx = data.indicator('ADX') # Average Directional Index\nit_strength = data.get('institutional_investors_trading_summary:投信買賣超股數') # Investment Trust Strength\n# 2. Calculate factors with proper shifting and forward-filling\n# Factor 1: Quality (Operating Profit Margin, 4-quarter average)\n# Higher operating margin is better\nquality_op_margin = op_margin.ffill().rolling(4).mean().shift(1)\n# Factor 2: Value (P/E Ratio)\n# Lower P/E ratio is better\nvalue_pe = pe_ratio.shift(1)\n# Factor 3: Financial Health (Debt Ratio, 4-quarter average)\n# Lower debt ratio is better\nhealth_debt = debt_ratio.ffill().rolling(4).mean().shift(1)\n# Factor 4: Trend Strength (ADX)\n# Higher ADX indicates stronger trend\ntrend_adx = adx.shift(1)\n# Factor 5: Domestic Institutional Conviction (Investment Trust Strength)\n# Higher strength indicates more conviction\nconviction_it = it_strength.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\n# For factors where lower is better (P/E, Debt Ratio), rank in descending order\nop_margin_rank = quality_op_margin.rank(axis=1, pct=True)\npe_rank = value_pe.rank(axis=1, pct=True, ascending=False) # Lower P/E is better\ndebt_rank = health_debt.rank(axis=1, pct=True, ascending=False) # Lower Debt Ratio is better\nadx_rank = trend_adx.rank(axis=1, pct=True)\nit_strength_rank = conviction_it.rank(axis=1, pct=True)\n# Combine with diverse weights\ncombined_factor = (op_margin_rank * 0.25 +\n                   pe_rank * 0.25 +\n                   debt_rank * 0.20 +\n                   adx_rank * 0.15 +\n                   it_strength_rank * 0.15)\n# 4. Apply filters for liquidity, price, market cap, and financial health\n# Liquidity filter: Average daily trading value > 70M TWD over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (focus on mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# Financial health filter: Debt ratio below 80% (avoid highly leveraged companies)\ndebt_cap_filter = health_debt < 0.8\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & debt_cap_filter]\n# 5. Select top N stocks (e.g., 15 stocks)\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:23:23.195880",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 29,
      "timestamp": "2025-11-02T08:24:04.451580",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\ngross_margin = data.get('fundamental_features:營業毛利率') # Underused factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused factor\npb_ratio = data.get('price:股價淨值比') # Underused factor\nmarket_value = data.get('etl:market_value') # Underused factor, used for filter\n# 2. Calculate factors\n# Factor 1: Profitability (Gross Profit Margin) - Higher is better\n# Using a 4-quarter rolling average for stability\ngross_profit_factor = gross_margin.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 2: Financial Health (Inverse of Debt Ratio) - Lower debt is better\n# Using a 4-quarter rolling average for stability, then inverse\nfinancial_health_factor = (100 / debt_ratio.ffill().rolling(window=4, min_periods=1).mean()).shift(1)\n# Add a small epsilon to avoid division by zero if debt_ratio is 0, though unlikely for real companies\nfinancial_health_factor = financial_health_factor.replace([float('inf'), -float('inf')], 0)\n# Factor 3: Value (Inverse of Price-to-Book Ratio) - Lower P/B is better\nvalue_factor = (1 / pb_ratio.ffill()).shift(1)\n# Add a small epsilon to avoid division by zero if pb_ratio is 0, though unlikely for real companies\nvalue_factor = value_factor.replace([float('inf'), -float('inf')], 0)\n# 3. Combine factors (normalize first!)\ngross_profit_rank = gross_profit_factor.rank(axis=1, pct=True)\nfinancial_health_rank = financial_health_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\n# Combine with weights emphasizing quality and financial health, then value\ncombined_factor = (gross_profit_rank * 0.40 +\n                   financial_health_rank * 0.35 +\n                   value_rank * 0.25)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Target mid-to-large cap stocks (> 15 Billion TWD)\nmarket_cap_filter = market_value.shift(1) > 15_000_000_000\n# P/B Ratio upper bound filter: Avoid extremely overvalued stocks by P/B (> 10)\npb_upper_bound_filter = pb_ratio.ffill().shift(1) < 10\n# Debt Ratio upper bound filter: Avoid companies with excessively high debt (> 200%)\ndebt_upper_bound_filter = debt_ratio.ffill().shift(1) < 200\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_upper_bound_filter & debt_upper_bound_filter]\n# 5. Select stocks\n# Select top 15 stocks based on the combined factor score\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T16:23:44.199617",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 0,
      "timestamp": "2025-11-02T09:20:51.382649",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused factor: Market Capitalization\npb_ratio = data.get('price:股價淨值比') # Underused factor: Price-to-Book Ratio\ngross_margin = data.get('fundamental_features:營業毛利率') # Underused factor: Gross Profit Margin\nnet_margin = data.get('fundamental_features:稅後淨利率') # Underused factor: Net Profit Margin\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused factor: Debt Ratio\n# 2. Calculate factors\n# Factor 1: Value (Inverse Price-to-Book Ratio)\n# Lower P/B is better, so take inverse to make higher values better.\n# Use .ffill() for fundamental data and .shift(1) to prevent look-ahead bias.\ninverse_pb = (1 / pb_ratio).ffill().shift(1)\n# Factor 2: Quality (Gross Profit Margin)\n# Higher gross margin indicates better operational efficiency.\ngross_margin_factor = gross_margin.ffill().shift(1)\n# Factor 3: Quality (Net Profit Margin)\n# Higher net margin indicates better overall profitability.\nnet_margin_factor = net_margin.ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\ninverse_pb_rank = inverse_pb.rank(axis=1, pct=True)\ngross_margin_rank = gross_margin_factor.rank(axis=1, pct=True)\nnet_margin_rank = net_margin_factor.rank(axis=1, pct=True)\n# Combine factors with custom weights\n# Prioritize value and balanced quality\ncombined_factor = (inverse_pb_rank * 0.45 +\n                   gross_margin_rank * 0.30 +\n                   net_margin_rank * 0.25)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter (Underused factor): Market value > 15 Billion TWD (mid to large cap)\nmarket_cap_filter = market_value.ffill().shift(1) > 15_000_000_000\n# Debt Ratio filter (Underused factor): Debt ratio < 60% (financial health)\ndebt_ratio_filter = debt_ratio.ffill().shift(1) < 60\n# P/B Ratio upper bound filter (Underused factor): P/B ratio < 3.0 (ensure value focus)\npb_upper_filter = pb_ratio.ffill().shift(1) < 3.0\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & debt_ratio_filter & pb_upper_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Rebalance quarterly with an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:19:34.828671",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-02T09:19:34.842482",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-02T09:21:10.954813",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused factor for filtering\npb_ratio = data.get('price:股價淨值比') # Underused value factor\noperating_margin = data.get('fundamental_features:營業利益率') # Underused quality factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused financial health factor\nmfi = data.indicator('MFI') # Underused technical indicator\n# 2. Calculate factors\n# Factor 1: Value (Inverse Price-to-Book Ratio)\n# Lower P/B is better, so we invert it. Add a small epsilon to avoid division by zero.\nvalue_factor = (1 / (pb_ratio + 1e-6)).ffill().shift(1)\n# Factor 2: Quality (Operating Profit Margin)\n# Higher operating margin indicates better core business profitability.\nquality_factor = operating_margin.ffill().shift(1)\n# Factor 3: Financial Health (Inverse Debt Ratio)\n# Lower debt ratio is better, so we use (100 - debt_ratio) to make higher values better.\nhealth_factor = (100 - debt_ratio).ffill().shift(1)\n# Factor 4: Money Flow Strength (MFI)\n# MFI combines price and volume to show buying/selling pressure. Higher MFI indicates stronger buying.\nmfi_factor = mfi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nvalue_rank = value_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\nhealth_rank = health_factor.rank(axis=1, pct=True)\nmfi_rank = mfi_factor.rank(axis=1, pct=True)\n# Combine with custom weights, prioritizing underused fundamental factors\ncombined_factor = (value_rank * 0.35 +\n                   quality_rank * 0.30 +\n                   health_rank * 0.20 +\n                   mfi_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD to focus on mid-to-large caps\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# P/B Ratio filter: P/B ratio < 3.0 to avoid extremely overvalued stocks\npb_filter = pb_ratio.ffill().shift(1) < 3.0\n# Operating Margin filter: Ensure positive operating profitability\nop_margin_positive_filter = operating_margin.ffill().shift(1) > 0\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_filter & op_margin_positive_filter]\n# 5. Select stocks\n# Select the top 15 stocks based on the combined factor score\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:20:51.505242",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-02T09:22:04.536713",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused factor, for filter\ngross_profit_margin = data.get('fundamental_features:營業毛利率') # Underused quality factor\nnet_profit_margin = data.get('fundamental_features:稅後淨利率') # Underused quality factor\npb_ratio = data.get('price:股價淨值比') # Underused value factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused risk/health factor\n# 2. Calculate factors\n# Factor 1: Gross Profit Margin (Quality) - higher is better\n# Use 4-quarter rolling average for smoothing, then ffill and shift to avoid look-ahead\ngpm_factor = gross_profit_margin.rolling(window=4, min_periods=1).mean().ffill().shift(1)\n# Factor 2: Net Profit Margin (Quality) - higher is better\n# Use 4-quarter rolling average for smoothing, then ffill and shift to avoid look-ahead\nnpm_factor = net_profit_margin.rolling(window=4, min_periods=1).mean().ffill().shift(1)\n# Factor 3: Inverse Price-to-Book Ratio (Value) - higher is better (lower P/B)\n# Cap P/B to a reasonable range (0.1 to 100) before inverting to avoid extreme values and division by zero/negative P/B.\npb_capped = pb_ratio.shift(1).clip(lower=0.1, upper=100)\ninv_pb_factor = 1 / pb_capped\n# Factor 4: Inverse Debt Ratio (Financial Health) - higher is better (lower debt)\n# Assuming debt_ratio is in percentage (e.g., 50 for 50%), subtract from 100.\n# Cap debt ratio to avoid extreme values, then ffill and shift.\ndebt_ratio_capped = debt_ratio.ffill().shift(1).clip(lower=0, upper=200)\ninv_debt_factor = 100 - debt_ratio_capped # Lower debt ratio means higher score\n# 3. Combine factors (normalize first!)\ngpm_rank = gpm_factor.rank(axis=1, pct=True)\nnpm_rank = npm_factor.rank(axis=1, pct=True)\ninv_pb_rank = inv_pb_factor.rank(axis=1, pct=True)\ninv_debt_rank = inv_debt_factor.rank(axis=1, pct=True)\n# Combine with weights. Emphasize profitability and financial health, with value.\ncombined_factor = (gpm_rank * 0.30 +\n                   npm_rank * 0.30 +\n                   inv_pb_rank * 0.25 +\n                   inv_debt_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 75M TWD (higher threshold for diversity)\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Stock price > 20 TWD (higher threshold for diversity)\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (focus on larger, more stable companies for diversity)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:21:11.058184",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-02T09:22:09.225342",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return) - shifted to prevent look-ahead bias\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - shifted to prevent look-ahead bias\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # Calculate 60-day moving average for trend confirmation\n    ma_60d = close.rolling(60).mean().shift(1)\n\n    # 3. Define filters\n    # Quality filter: ROE > 10%\n    quality_filter = (roe.shift(1) > 10)\n\n    # Growth filter: Revenue YoY growth > 10%\n    growth_filter = (revenue_growth_factor > 10)\n\n    # Momentum filter: Stock price showing positive momentum (20-day return > 0)\n    momentum_filter = (returns_20d > 0)\n\n    # Trend filter: Price above 60-day moving average\n    trend_filter = (close.shift(1) > ma_60d)\n\n    # Valuation filter: PE ratio between 10 and 30 (common range for growth stocks)\n    # Shifted to prevent look-ahead bias\n    valuation_filter = (pe_ratio.shift(1) > 10) & (pe_ratio.shift(1) < 30)\n\n    # Liquidity filter: Average daily turnover > 150M TWD\n    # Using volume * close price for turnover\n    avg_daily_turnover = (volume * close).rolling(20).mean().shift(1)\n    liquidity_filter = (avg_daily_turnover > 150_000_000)\n\n    # 4. Combine all filters\n    # Emphasize quality, growth, and momentum, with a sanity check on valuation and trend\n    # All conditions must be met for a stock to be considered\n    position = quality_filter & growth_filter & momentum_filter & trend_filter & valuation_filter & liquidity_filter\n\n    # Handle NaN values by filling with False (no position)\n    position = position.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:22:04.636630",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-02T09:22:25.937791",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization\npb_ratio = data.get('price:股價淨值比') # Underused: Price-to-Book Ratio\nop_margin = data.get('fundamental_features:營業利益率') # Underused: Operating Profit Margin\nnet_margin = data.get('fundamental_features:稅後淨利率') # Underused: Net Profit Margin\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Debt Ratio\n# 2. Calculate factors\n# Factor 1: Value (Inverse P/B Ratio) - lower P/B is better\n# Fill forward quarterly data and shift to prevent look-ahead bias\nvalue_factor = (1 / pb_ratio.ffill()).shift(1)\n# Factor 2: Quality (Operating Profit Margin) - higher margin is better\nquality_op_margin = op_margin.ffill().shift(1)\n# Factor 3: Quality (Net Profit Margin) - higher margin is better\nquality_net_margin = net_margin.ffill().shift(1)\n# Factor 4: Financial Health (Inverse Debt Ratio) - lower debt is better\n# To avoid division by zero or very small numbers, we can simply invert and shift\nfinancial_health = (1 / debt_ratio.ffill()).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nvalue_rank = value_factor.rank(axis=1, pct=True)\nop_margin_rank = quality_op_margin.rank(axis=1, pct=True)\nnet_margin_rank = quality_net_margin.rank(axis=1, pct=True)\nfinancial_health_rank = financial_health.rank(axis=1, pct=True)\n# Combine with weights. Prioritize quality and financial health, then value.\ncombined_factor = (value_rank * 0.25 +\n                   op_margin_rank * 0.30 +\n                   net_margin_rank * 0.30 +\n                   financial_health_rank * 0.15)\n# 4. Apply filters\n# Mandatory Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Mandatory Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Target mid-cap stocks (e.g., between 5 Billion and 50 Billion TWD)\n# This helps differentiate from large-cap focused strategies and micro-cap strategies.\nmarket_cap_filter = (market_value.shift(1) > 5_000_000_000) & \\\n                    (market_value.shift(1) < 50_000_000_000)\n# Fundamental sanity filters:\n# Avoid stocks with extremely high P/B (e.g., > 10) or extremely high Debt Ratio (e.g., > 1000%)\npb_sanity_filter = pb_ratio.ffill().shift(1) < 10\ndebt_sanity_filter = debt_ratio.ffill().shift(1) < 1000 # 1000% debt ratio is very high\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_sanity_filter & debt_sanity_filter]\n# 5. Select stocks\n# Select top 12 stocks based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:22:09.317729",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-02T09:22:42.595279",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Use adjusted data for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\n# Underused factors for diversity\ngross_profit_margin = data.get('fundamental_features:營業毛利率')\ndebt_ratio = data.get('fundamental_features:負債比率')\npb_ratio = data.get('price:股價淨值比')\nmarket_value = data.get('etl:market_value') # For market cap filter and factor\n# 2. Calculate factors\n# Factor 1: Quality (Gross Profit Margin) - Higher is better\n# Use 4-quarter average for stability and ffill for daily alignment\nquality_factor = gross_profit_margin.ffill().rolling(4).mean().shift(1)\n# Factor 2: Financial Health (Debt Ratio) - Lower is better\n# Use 4-quarter average for stability and ffill for daily alignment\nhealth_factor = debt_ratio.ffill().rolling(4).mean().shift(1)\n# Factor 3: Value (Price-to-Book Ratio) - Lower is better\nvalue_factor = pb_ratio.ffill().shift(1)\n# Factor 4: Size (Market Capitalization) - Favoring mid-to-large caps slightly\n# This will be used as a factor and a filter\nsize_factor = market_value.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nquality_rank = quality_factor.rank(axis=1, pct=True)\n# For debt_ratio and pb_ratio, lower values are better, so invert the rank\nhealth_rank = 1 - health_factor.rank(axis=1, pct=True)\nvalue_rank = 1 - value_factor.rank(axis=1, pct=True)\n# For market_cap, higher values (larger companies) are better in this strategy\nsize_rank = size_factor.rank(axis=1, pct=True)\n# Combine with diverse weights\ncombined_factor = (quality_rank * 0.40 +\n                   health_rank * 0.30 +\n                   value_rank * 0.20 +\n                   size_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 70M TWD (higher than common)\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 25 TWD (higher than common penny stock filter)\nprice_filter = close.shift(1) > 25\n# Market Cap filter: Market value > 15 Billion TWD (focus on mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 15_000_000_000\n# P/B Ratio filter: Avoid extremely low P/B (distress) or extremely high P/B (overvalued)\npb_filter = (value_factor > 0.6) & (value_factor < 6.0)\n# Debt Ratio filter: Avoid companies with very high debt ratios (> 100%)\ndebt_filter = health_factor < 1.0\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_filter & debt_filter]\n# 5. Select stocks\n# Select top 8 stocks based on the combined factor score\nposition = filtered_factor.is_largest(8)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:22:26.040662",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-02T09:23:08.542400",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Use adjusted data for price filters\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization\noperating_margin = data.get('fundamental_features:營業利益率') # Underused: Operating Profit Margin\npb_ratio = data.get('price:股價淨值比') # Underused: Price-to-Book Ratio\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Debt Ratio\n# 2. Calculate factors\n# Factor 1: Quality (4-quarter average Operating Profit Margin)\n# Higher operating margin indicates better core business profitability.\nquality_factor = operating_margin.rolling(4).mean().ffill().shift(1)\n# Factor 2: Value (Inverse Price-to-Book Ratio)\n# Lower P/B ratio indicates better value. We invert it so higher values are better.\nvalue_factor = (1 / pb_ratio).ffill().shift(1)\n# Factor 3: Financial Health (Inverse Debt Ratio)\n# Lower debt ratio indicates better financial health. We invert it by taking the negative,\n# so ranking will assign higher scores to lower debt.\nhealth_factor = (-debt_ratio).ffill().shift(1)\n# Factor 4: Size (Inverse Market Capitalization for Small-Cap Bias)\n# Lower market cap indicates smaller companies. We invert it so higher values are better for smaller companies.\nsize_factor = (1 / market_value).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nquality_rank = quality_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\nhealth_rank = health_factor.rank(axis=1, pct=True)\nsize_rank = size_factor.rank(axis=1, pct=True)\n# Combine with weights, prioritizing quality and value\ncombined_factor = (quality_rank * 0.35 +\n                   value_rank * 0.30 +\n                   health_rank * 0.20 +\n                   size_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be above 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price must be above 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Market value must be above 1 Billion TWD to avoid micro-caps\nmarket_cap_filter = market_value.shift(1) > 1_000_000_000\n# P/B Ratio filter: P/B ratio must be above 0.5 to avoid extremely distressed companies\npb_filter = pb_ratio.ffill().shift(1) > 0.5\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:22:42.696195",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-02T09:23:14.082647",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return) - Original\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - Original\n    # Modified: Use a longer period for revenue growth to smooth out noise (3-month average)\n    revenue_growth_factor = revenue_yoy.rolling(window=3, min_periods=1).mean().shift(1)\n\n    # ROE filter - Original\n    # Modified: Apply a minimum ROE threshold and also rank ROE to find top performers\n    roe_filter = (roe.shift(1) > 10) & (roe.shift(1).rank(axis=1, ascending=False) <= 100) # Top 100 stocks by ROE\n\n    # Valuation factor: PE Ratio\n    # Modified: Add a low PE ratio filter to select undervalued stocks, avoiding extremely high PE\n    pe_filter = (pe_ratio.shift(1) > 0) & (pe_ratio.shift(1) < 25) # Avoid negative PE and very high growth/speculative stocks\n\n    # Moving Average Crossover (SMA 20 vs SMA 60) - New addition for trend following\n    # This helps in identifying stronger trends and avoiding whipsaws\n    sma_20 = close.rolling(window=20).mean().shift(1)\n    sma_60 = close.rolling(window=60).mean().shift(1)\n    ma_crossover = sma_20 > sma_60\n\n    # 3. Combine factors and apply filters\n    # Liquidity filter: Average daily volume > 150M TWD (approx 50000 shares * 30 TWD/share)\n    # Using '成交股數' directly, ensure average volume is significant\n    avg_volume_mil = (volume.rolling(window=20).mean().shift(1) * close.rolling(window=20).mean().shift(1) / 1_000_000)\n    liquidity_filter = avg_volume_mil > 150\n\n    # Combine all conditions\n    # Emphasize quality (ROE), value (PE), growth (revenue), and momentum (price & MA)\n    buy_condition = (\n        roe_filter &\n        (revenue_growth_factor > 0) & # Only positive revenue growth\n        (returns_20d > 0) & # Positive 20-day momentum\n        pe_filter &\n        ma_crossover & # Ensure stock is in an uptrend\n        liquidity_filter\n    )\n\n    # Convert boolean series to 1 (buy) or 0 (hold/sell)\n    position = buy_condition.astype(int)\n\n    # Handle NaN values by filling with 0, ensuring no positions are taken on NaN\n    position = position.fillna(0)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:23:08.647622",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-02T09:24:01.695258",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\n# Underused/rare factors prioritized for diversity\npb_ratio_raw = data.get('price:股價淨值比')  # Price-to-Book Ratio (Value)\ngross_margin_raw = data.get('fundamental_features:營業毛利率')  # Gross Profit Margin (Quality)\ndebt_ratio_raw = data.get('fundamental_features:負債比率')  # Debt Ratio (Financial Health)\nmarket_value_raw = data.get('etl:market_value')  # Market Capitalization (Size)\nmfi_raw = data.indicator('MFI')  # Money Flow Index (Volume-weighted momentum)\n# 2. Calculate factors with .shift(1) and .ffill()\n# Factor 1: Value (P/B Ratio) - lower is better\npb_ratio = pb_ratio_raw.ffill().shift(1)\n# Factor 2: Quality (Gross Profit Margin) - higher is better\ngross_margin = gross_margin_raw.ffill().shift(1)\n# Factor 3: Financial Health (Debt Ratio) - lower is better\ndebt_ratio = debt_ratio_raw.ffill().shift(1)\n# Factor 4: Size (Market Capitalization) - smaller is better for this strategy\nmarket_value = market_value_raw.shift(1)\n# Factor 5: Volume-Weighted Momentum (MFI) - higher is better\nmfi = mfi_raw.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\n# For factors where 'lower is better', transform rank to (1 - rank)\npb_rank = (1 - pb_ratio.rank(axis=1, pct=True))\ngross_margin_rank = gross_margin.rank(axis=1, pct=True)\ndebt_rank = (1 - debt_ratio.rank(axis=1, pct=True))\nmarket_value_rank = (1 - market_value.rank(axis=1, pct=True))\nmfi_rank = mfi.rank(axis=1, pct=True)\n# Combine with unique weights, emphasizing value, quality, and financial health with a small-cap tilt\ncombined_factor = (pb_rank * 0.25 +\n                   gross_margin_rank * 0.25 +\n                   debt_rank * 0.20 +\n                   market_value_rank * 0.15 +\n                   mfi_rank * 0.15)\n# 4. Apply filters for liquidity, price, and fundamental health\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Ensure minimum market cap > 1 Billion TWD\nmarket_cap_filter = market_value_raw.shift(1) > 1_000_000_000\n# P/B Ratio filter: Avoid extremely low P/B which might indicate distress (e.g., P/B > 0.5)\npb_filter = pb_ratio_raw.ffill().shift(1) > 0.5\n# Debt Ratio filter: Avoid excessively high debt (e.g., Debt Ratio < 100%)\ndebt_filter = debt_ratio_raw.ffill().shift(1) < 100\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_filter & debt_filter]\n# 5. Select stocks (top 10)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:23:14.191183",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-02T09:24:06.633399",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    roe = data.get('fundamental_features:ROE稅後')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Liquidity filter: Average daily volume > 150M TWD\n    # Calculate average daily turnover value (price * volume)\n    avg_daily_turnover = (close * volume).rolling(window=20).mean().shift(1)\n    liquidity_filter = (avg_daily_turnover > 150_000_000)\n\n    # 3. Quality filter: ROE > 15%\n    roe_filter = (roe.shift(1) > 15)\n\n    # 4. Growth factor: Revenue YoY growth\n    # Use 3-month average for smoother growth signal and reduce noise\n    revenue_growth_smoothed = revenue_yoy.rolling(window=3).mean().shift(1)\n    growth_filter = (revenue_growth_smoothed > 10) # Target positive and strong growth\n\n    # 5. Momentum factor: 20-day return, but add a longer-term trend check\n    returns_20d = close.pct_change(20).shift(1)\n    returns_60d = close.pct_change(60).shift(1) # Longer-term momentum\n    momentum_filter = (returns_20d > 0.05) & (returns_60d > 0.10) # Strong short-term and positive longer-term momentum\n\n    # 6. Valuation factor: PE Ratio (lower is better, but avoid negative/extreme low)\n    # Filter out extremely high PE and negative PE (loss-making)\n    pe_filter = (pe_ratio.shift(1) > 5) & (pe_ratio.shift(1) < 30)\n\n    # 7. Combine all filters\n    # Emphasize quality and growth, then momentum and reasonable valuation\n    # Ensure all conditions are met for selection\n    long_condition = liquidity_filter & roe_filter & growth_filter & momentum_filter & pe_filter\n\n    # 8. Position sizing: Equal weight for selected stocks\n    # Use fillna(False) to ensure non-selected stocks are False\n    position = long_condition.astype(int).fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:24:01.804552",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 10,
      "timestamp": "2025-11-02T09:24:11.388233",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n    open_price = data.get('price:開盤價') # Added for more robust momentum\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return, using open to close for robustness)\n    # Using (close / open) - 1 for daily return and rolling sum for 20-day\n    returns_20d = (close.pct_change(20)).shift(1) # Original champion uses close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - shifted to prevent look-ahead\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE quality factor - shifted to prevent look-ahead\n    roe_factor = roe.shift(1)\n\n    # Price-to-Earnings Ratio (PE) factor - shifted to prevent look-ahead\n    pe_factor = pe_ratio.shift(1)\n\n    # 3. Define selection criteria\n    # High ROE filter: Preserve quality focus, slightly increase threshold\n    roe_condition = (roe_factor > 18)\n\n    # Revenue growth filter: Strong growth, positive YoY\n    revenue_growth_condition = (revenue_growth_factor > 10)\n\n    # Price momentum filter: Positive 20-day return, and ranking for relative strength\n    momentum_condition = (returns_20d > 0.05) & (returns_20d.rank(axis=1, ascending=False) < 0.2 * len(returns_20d.columns)) # Top 20% momentum\n\n    # Value filter: Add a PE ratio condition to balance growth/momentum with value\n    # Only consider stocks with reasonable PE, not excessively high\n    pe_condition = (pe_factor > 0) & (pe_factor < 25) # Avoid negative PE and extremely high growth stock PEs\n\n    # Liquidity filter: Average daily volume > 150M TWD for the past 20 days\n    # (Price * Volume) for market value of trade\n    avg_daily_trade_value = (close * volume).rolling(20).mean().shift(1)\n    liquidity_condition = (avg_daily_trade_value > 150_000_000)\n\n    # 4. Combine conditions\n    # Weighted combination of quality, growth, momentum, and value\n    # Emphasize momentum, but keep quality and growth as base filters\n    long_condition = roe_condition & revenue_growth_condition & momentum_condition & liquidity_condition & pe_condition\n\n    # 5. Determine position (boolean series for stock selection)\n    position = long_condition.astype(int) # Convert boolean to 0/1 for position\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets",
        "Unknown dataset key: 'price:開盤價' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n- Unknown dataset key: 'price:開盤價' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:24:06.739285",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 11,
      "timestamp": "2025-11-02T09:24:16.477300",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Liquidity Filter: Average daily volume > 150M TWD (price * volume)\n    # Using '成交股數' and '收盤價' to estimate turnover\n    avg_dollar_volume = (volume * close).rolling(window=20).mean().shift(1)\n    liquid_stocks = (avg_dollar_volume > 150_000_000)\n\n    # 3. Quality Filter: ROE (Return on Equity)\n    # Require ROE to be positive and relatively high, using a percentile rank approach\n    # Shifted to prevent look-ahead bias\n    roe_rank = roe.shift(1).rank(axis=1, pct=True)\n    high_roe = (roe_rank > 0.70) # Top 30% ROE\n\n    # 4. Growth Factor: Revenue YoY growth\n    # Require positive revenue growth and rank it\n    revenue_growth_rank = revenue_yoy.shift(1).rank(axis=1, pct=True)\n    strong_growth = (revenue_growth_rank > 0.60) & (revenue_yoy.shift(1) > 0) # Top 40% growth and positive\n\n    # 5. Momentum Factor: 20-day return\n    # Increased lookback for momentum stability and reduced noise\n    returns_20d = close.pct_change(20).shift(1)\n    positive_momentum = (returns_20d > 0)\n    # Add a relative momentum component: top 40% of positive momentum stocks\n    momentum_rank = returns_20d.rank(axis=1, pct=True)\n    strong_momentum = (momentum_rank > 0.60) & positive_momentum\n\n    # 6. Valuation Filter: PE Ratio (Added to improve risk-adjusted returns)\n    # Filter out extremely high PE ratios, focusing on reasonable valuations\n    # Using a 20-day average PE to smooth out daily fluctuations\n    avg_pe = pe_ratio.rolling(window=20).mean().shift(1)\n    reasonable_pe = (avg_pe > 0) & (avg_pe < 30) # Avoid negative/zero PE and very high PE\n\n    # 7. Combine all factors\n    # Weighted combination: ROE and Growth are fundamental quality, Momentum for timing, PE for valuation\n    # All conditions must be met for a stock to be selected\n    buy_signals = liquid_stocks & high_roe & strong_growth & strong_momentum & reasonable_pe\n\n    # 8. Define position: Buy selected stocks, hold equal weight\n    # Using boolean series directly for selection\n    position = buy_signals\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:24:11.518547",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 12,
      "timestamp": "2025-11-02T09:24:40.886179",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\npb_ratio = data.get('price:股價淨值比')  # Underused: Value factor\nop_margin = data.get('fundamental_features:營業利益率')  # Underused: Quality factor\ndebt_ratio = data.get('fundamental_features:負債比率')  # Underused: Financial health factor\nmarket_cap = data.get('etl:market_value')  # Underused: Size factor\n# 2. Calculate factors\n# Factor 1: Value (Inverse P/B Ratio) - Lower P/B is better\nvalue_factor = (1 / pb_ratio).ffill().shift(1)\n# Factor 2: Quality (Operating Profit Margin) - Higher margin is better\nquality_op_margin = op_margin.ffill().shift(1)\n# Factor 3: Financial Health (Inverse Debt Ratio) - Lower debt is better\nfinancial_health_debt = (1 / debt_ratio).ffill().shift(1)\n# Factor 4: Size (Inverse Market Cap for Small-Cap Bias) - Smaller market cap is better\nsize_factor = (1 / market_cap).ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nvalue_rank = value_factor.rank(axis=1, pct=True)\nquality_op_margin_rank = quality_op_margin.rank(axis=1, pct=True)\nfinancial_health_debt_rank = financial_health_debt.rank(axis=1, pct=True)\nsize_rank = size_factor.rank(axis=1, pct=True)\n# Combine with unique weights, prioritizing value and quality\ncombined_factor = (value_rank * 0.35 +\n                   quality_op_margin_rank * 0.30 +\n                   financial_health_debt_rank * 0.20 +\n                   size_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 40M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Stock price > 15 TWD\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Target small-to-mid cap range (1B to 50B TWD)\nmarket_cap_filter = (market_cap.shift(1) > 1_000_000_000) & \\\n                    (market_cap.shift(1) < 50_000_000_000)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:24:16.588089",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 13,
      "timestamp": "2025-11-02T09:25:09.071585",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused factor: Market Capitalization\n# Underused fundamental factors\ngross_margin = data.get('fundamental_features:營業毛利率')\ndebt_ratio = data.get('fundamental_features:負債比率')\npe_ratio = data.get('price:本益比') # Underused factor: P/E Ratio\n# Underused technical indicator\nmfi = data.indicator('MFI') # Money Flow Index\n# 2. Calculate factors\n# Factor 1: Quality - Gross Profit Margin (higher is better)\n# Forward fill for quarterly data, then shift to prevent look-ahead\nfactor_gross_margin = gross_margin.ffill().shift(1)\n# Factor 2: Quality/Risk - Debt Ratio (lower is better, so invert for ranking)\nfactor_debt_ratio = debt_ratio.ffill().shift(1)\n# Factor 3: Value - Inverse P/E Ratio (lower P/E is better, so higher inverse P/E)\n# Handle potential division by zero or negative P/E by filtering later.\nfactor_inverse_pe = (1 / pe_ratio).ffill().shift(1)\n# Factor 4: Short-term Buying Pressure - Money Flow Index (higher is better)\nfactor_mfi = mfi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nrank_gross_margin = factor_gross_margin.rank(axis=1, pct=True)\n# Invert rank for lower debt being better\nrank_debt_ratio = (1 - factor_debt_ratio.rank(axis=1, pct=True))\n# Higher inverse PE is better\nrank_inverse_pe = factor_inverse_pe.rank(axis=1, pct=True)\nrank_mfi = factor_mfi.rank(axis=1, pct=True)\n# Combine with weights. Prioritize quality and value, give some weight to MFI.\ncombined_factor = (rank_gross_margin * 0.35 +\n                   rank_debt_ratio * 0.25 +\n                   rank_inverse_pe * 0.25 +\n                   rank_mfi * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 50M TWD (higher than common)\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD (higher than common to avoid penny stocks)\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (focus on mid-large caps for stability)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# P/E Ratio filter: P",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:24:41.009360",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 0,
      "timestamp": "2025-11-02T09:26:04.919858",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value')  # Underused: Market Capitalization\n# Underused fundamental factors for Quality and Value\ngross_margin = data.get('fundamental_features:營業毛利率')\nnet_margin = data.get('fundamental_features:稅後淨利率')\npb_ratio = data.get('price:股價淨值比')\npe_ratio = data.get('price:本益比')\ndebt_ratio = data.get('fundamental_features:負債比率')\n# 2. Calculate factors\n# All factors are shifted by 1 to prevent look-ahead bias and forward-filled for lower frequency data.\n# Factor 1: Profitability (Quality) - Average of Gross and Net Profit Margins\n# Use 4-quarter rolling average for stability\nprofitability_score = (gross_margin.ffill().rolling(4).mean() + net_margin.ffill().rolling(4).mean()) / 2\nprofitability_score = profitability_score.shift(1)\n# Factor 2: Value - Inverse of P/B Ratio and P/E Ratio\n# Cap extreme values for robustness before taking inverse\npb_ratio_capped = pb_ratio.ffill().clip(lower=0.5, upper=5)\npe_ratio_capped = pe_ratio.ffill().clip(lower=5, upper=50)\nvalue_score = (1 / pb_ratio_capped + 1 / pe_ratio_capped) / 2\nvalue_score = value_score.shift(1)\n# Factor 3: Financial Health (Risk) - Inverse of Debt Ratio\n# Cap debt ratio at 100% and convert to a score where higher is better (lower debt)\ndebt_ratio_capped = debt_ratio.ffill().clip(upper=100)\nhealth_score = 100 - debt_ratio_capped\nhealth_score = health_score.shift(1)\n# 3. Combine factors (normalize first!)\nprofitability_rank = profitability_score.rank(axis=1, pct=True)\nvalue_rank = value_score.rank(axis=1, pct=True)\nhealth_rank = health_score.rank(axis=1, pct=True)\n# Combine with diverse weights, emphasizing profitability and value\ncombined_factor = (profitability_rank * 0.40 +\n                   value_rank * 0.35 +\n                   health_rank * 0.25)\n# 4. Apply filters for liquidity, price, market cap, and fundamental sanity\n# Liquidity filter: Average daily trading value > 75M TWD (higher than common for diversity)\nliquidity_",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets",
        "Unknown dataset key: 'price:本益比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n- Unknown dataset key: 'price:本益比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:25:37.691761",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-02T09:25:37.703537",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-02T09:26:30.559530",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\n# Load underused factors\nmarket_value = data.get('etl:market_value')  # Underused: Market Capitalization (Size)\ngross_profit_margin = data.get('fundamental_features:營業毛利率')  # Underused: Gross Profit Margin (Quality)\nnet_profit_margin = data.get('fundamental_features:稅後淨利率')  # Underused: Net Profit Margin (Quality)\npe_ratio = data.get('price:本益比')  # Underused: P/E Ratio (Value)\npb_ratio = data.get('price:股價淨值比')  # Underused: P/B Ratio (Value)\ndebt_ratio_data = data.get('fundamental_features:負債比率')  # Underused: Debt Ratio (Risk/Quality)\n# 2. Calculate factors (with .ffill() for fundamental/valuation data and .shift(1) for all)\n# Factor 1: Value - Earnings Yield (Inverse P/E)\nearnings_yield = (1 / pe_ratio).ffill().shift(1)\n# Factor 2: Value - Book-to-Market (Inverse P/B)\nbook_to_market = (1 / pb_ratio).ffill().shift(1)\n# Factor 3: Quality - Gross Profit Margin\ngross_margin = gross_profit_margin.ffill().shift(1)\n# Factor 4: Quality - Net Profit Margin\nnet_margin = net_profit_margin.ffill().shift(1)\n# Factor 5: Risk/Quality - Debt Ratio (lower is better)\ndebt_ratio = debt_ratio_data.ffill().shift(1)\n# Factor 6: Size - Market Capitalization (smaller is often better for growth, but larger for stability)\n# We will rank it inversely to favor smaller caps for potential higher returns.\nmarket_cap = market_value.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nearnings_yield_rank = earnings_yield.rank(axis=1, pct=True)\nbook_to_market_rank = book_to_market.rank(axis=1, pct=True)\ngross_margin_rank = gross_margin.rank(axis=1, pct=True)\nnet_margin_rank = net_margin.rank(axis=1, pct=True)\n# For debt ratio and market cap, lower values are better, so we invert the rank\ndebt_ratio_rank = 1 - debt_ratio.rank(axis=1, pct=True)\nmarket_cap_rank = 1 - market_cap.rank(axis=1, pct=True)\n# Combine into a single score with custom weights\n# Prioritize Quality and Value, with a smaller tilt towards smaller caps\ncombined_factor = (\n    earnings_yield_rank * 0.20 +\n    book_to_market_rank * 0.20 +\n    gross_margin_rank * 0.20 +\n    net_margin_rank * 0.20 +\n    debt_ratio_rank * 0.10 +\n    market_cap_rank * 0.10\n)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 40M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Ensure market cap is above 1 Billion TWD but not excessively large\nmarket_cap_filter = (market_cap > 1_000_000_000) & (market_cap < 100_000_000_000)\n# Valuation filters: Avoid extreme P/E and P/B ratios\npe_filter = (pe_ratio.ffill().shift(1) > 0) & (pe_ratio.ffill().shift(1) < 35) # Positive P/E, not excessively high\npb_filter = (pb_ratio.ffill().shift(1) > 0.5) & (pb_ratio.ffill().shift(1) < 5) # Reasonable P/B range\n# Combine all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & pe_filter & pb_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Rebalance quarterly, with a slightly different stop loss of 10%\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.10)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets",
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:26:05.066072",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-02T09:26:37.196732",
      "model": "gemini-2.5-flash",
      "code": "import numpy as np\nimport pandas as pd\n\ndef strategy(data):\n    # 1. Load data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n    open_price = data.get('price:開盤價') # Added for more precise momentum calculation\n\n    # 2. Calculate factors\n    # Momentum factor: 20-day return, calculated from open to close for robustness\n    # Using open_price to avoid look-ahead bias if close is used directly in current day's decision\n    momentum_20d = (close.shift(1) / open_price.shift(21) - 1).fillna(0) # Shift(1) for close, Shift(21) for open 20 days ago\n\n    # Revenue growth factor (YoY), shifted to avoid look-ahead\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE quality filter: High ROE indicates strong profitability\n    roe_filter = (roe.shift(1) > 10) # Using a threshold of 10 for stronger quality focus\n\n    # Valuation factor: Low PE ratio indicates undervaluation\n    # Using inverse of PE to rank higher for lower PE, handle inf for negative earnings\n    pe_inverse = (1 / pe_ratio.shift(1)).replace([np.inf, -np.inf], np.nan).fillna(0)\n    pe_filter = (pe_inverse > pe_inverse.quantile(0.7, axis=1)) # Select top 30% by inverse PE (lowest PE)\n\n    # Moving Average Crossover for trend confirmation (smoothed price)\n    # Using 50-day and 200-day simple moving averages\n    ma_50 = close.shift(1).rolling(50).mean()\n    ma_200 = close.shift(1).rolling(200).mean()\n    ma_crossover = (ma_50 > ma_200) # Bullish crossover for long-term trend\n\n    # 3. Liquidity filter (Average daily volume > 150M TWD)\n    # Assuming price is in TWD, volume is number of shares. \n    # Average daily turnover = average volume * average close price\n    avg_turnover_20d = (volume.shift(1) * close.shift(1)).rolling(20).mean()\n    liquidity_filter = (avg_turnover_20d > 150_000_000)\n\n    # 4. Combine factors to create a composite score\n    # Normalize factors to avoid dominance by one\n    momentum_rank = momentum_20d.rank(axis=1, pct=True)\n    revenue_rank = revenue_growth_factor.rank(axis=1, pct=True)\n\n    # Weighted combination of factors\n    # Increased weight for momentum and added valuation and MA crossover\n    buy_signal = (\n        (momentum_rank > 0.7) & # Top 30% momentum\n        (revenue_rank > 0.6) & # Top 40% revenue growth\n        roe_filter &          # Strong ROE\n        pe_filter &           # Low PE\n        ma_crossover          # Confirm long-term uptrend\n    )\n\n    # Apply all filters\n    final_selection = buy_signal & liquidity_filter\n\n    # 5. Determine positions\n    # Select top N stocks or all stocks that meet criteria\n    # For simplicity, we select all stocks that meet the criteria\n    position = final_selection.astype(float) # Convert boolean to float for position sizing\n\n    # Ensure no look-ahead bias by shifting the final position if needed (already handled by factor shifts)\n    # The `position` series should represent the desired holdings for the *next* trading period.\n    # FinLab handles rebalancing based on this output.\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets",
        "Unknown dataset key: 'price:開盤價' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n- Unknown dataset key: 'price:開盤價' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:26:30.676358",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-02T09:26:41.787465",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load necessary data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return) - shifted to prevent look-ahead\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - shifted to prevent look-ahead\n    # Apply a smoothing or rolling mean to revenue_yoy to reduce noise and enhance robustness\n    revenue_growth_smoothed = revenue_yoy.rolling(window=3, min_periods=1).mean().shift(1)\n\n    # ROE filter: Select stocks with consistently high ROE\n    # Use a rolling mean for ROE to smooth out quarterly fluctuations and identify stable performers\n    roe_smoothed = roe.rolling(window=4, min_periods=1).mean().shift(1) # Use 4 quarters for annual view\n\n    # PE Ratio filter: Filter out extremely overvalued stocks. Lower PE is generally better.\n    # Use a median or a specific threshold, shifted.\n    pe_ratio_shifted = pe_ratio.shift(1)\n\n    # 3. Define selection criteria based on factors\n    # Criteria 1: Strong positive momentum\n    momentum_condition = returns_20d > 0.05  # Increased threshold for stronger momentum\n\n    # Criteria 2: Robust revenue growth\n    revenue_condition = revenue_growth_smoothed > 10 # Target higher, stable growth\n\n    # Criteria 3: High and stable ROE\n    roe_condition = roe_smoothed > 15 # Maintain high ROE quality\n\n    # Criteria 4: Reasonable valuation (PE ratio) - Avoid extremely high PE\n    # Using a cap on PE to avoid overvalued growth stocks, but not too low to exclude all growth.\n    pe_condition = (pe_ratio_shifted > 5) & (pe_ratio_shifted < 30) # PE between 5 and 30\n\n    # 4. Liquidity filter: Average daily volume > 150M TWD\n    # Calculate average daily turnover (price * volume) over a 20-day period\n    avg_daily_turnover = (close * volume).rolling(20).mean().shift(1)\n    liquidity_condition = avg_daily_turnover > 150_000_000\n\n    # 5. Combine all conditions\n    # All conditions must be met for a stock to be selected\n    # Enhanced combination: Use a weighted approach or stricter AND conditions\n    stock_selection = (\n        momentum_condition &\n        revenue_condition &\n        roe_condition &\n        pe_condition &\n        liquidity_condition\n    )\n\n    # Fill NaN values with False for stocks that don't meet all criteria or have missing data\n    stock_selection = stock_selection.fillna(False)\n\n    # Return the boolean series indicating selected stocks\n    return stock_selection",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:26:37.312836",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-02T09:27:03.502368",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value') # Underused factor for size filter\ngross_margin = data.get('fundamental_features:營業毛利率') # Underused quality factor\noperating_margin = data.get('fundamental_features:營業利益率') # Underused quality factor\nnet_profit_margin = data.get('fundamental_features:稅後淨利率') # Underused quality factor\npe_ratio = data.get('price:本益比') # Underused value factor\npb_ratio = data.get('price:股價淨值比') # Underused value factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused risk factor\nmfi = data.indicator('MFI') # Underused technical indicator for momentum\n# 2. Calculate factors\n# Factor 1: Quality (Average of three profitability margins)\n# Use .ffill() for fundamental data to align to daily frequency\nquality_factor = (gross_margin.ffill() + operating_margin.ffill() + net_profit_margin.ffill()) / 3\nquality_factor = quality_factor.shift(1)\n# Factor 2: Value (Inverse of P/E and P/B ratios)\n# Lower P/E and P/B are better for value, so we take the inverse. Add a small epsilon to avoid division by zero.\nvalue_pe = (1 / (pe_ratio.ffill() + 1e-6)).shift(1)\nvalue_pb = (1 / (pb_ratio.ffill() + 1e-6)).shift(1)\nvalue_factor = (value_pe + value_pb) / 2\n# Factor 3: Financial Health/Risk (Inverse of Debt Ratio)\n# Lower debt ratio is better, so we take the inverse.\nhealth_factor = (1 / (debt_ratio.ffill() + 1e-6)).shift(1)\n# Factor 4: Money Flow Momentum (MFI)\n# MFI is a volume-weighted momentum indicator.\nmomentum_mfi = mfi.shift(1)\n# 3. Combine factors (normalize first!)\nquality_rank = quality_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\nhealth_rank = health_factor.rank(axis=1, pct=True)\nmomentum_rank = momentum_mfi.rank(axis=1, pct=True)\n# Combine with weights, emphasizing quality, value, and health, with some momentum.\n# Weights sum to 1.0\ncombined_factor = (quality_rank * 0.35 +\n                   value_rank * 0.30 +\n                   health_rank * 0.20 +\n                   momentum_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Target mid-cap stocks (5B to 100B TWD)\nmarket_cap_filter = (market_value.shift(1) > 5_000_000_000) & \\\n                    (market_value.shift(1) < 100_000_000_000)\n# Valuation filters: Filter out extremely high/low P/E and P/B ratios\n# P/E between 5 and 40 (reasonable range for value/growth)\npe_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 40)\n# P/B between 0.5 and 8 (avoiding distressed or extremely overvalued assets)\npb_filter = (pb_ratio.ffill().shift(1) > 0.5) & (pb_ratio.ffill().shift(1) < 8)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pe_filter & pb_filter]\n# 5. Select stocks\n# Select top 12 stocks based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets",
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:26:41.903222",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-02T09:27:25.916234",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization\npe_ratio = data.get('price:本益比') # Underused: P/E Ratio\nnet_profit_margin = data.get('fundamental_features:稅後淨利率') # Underused: Net Profit Margin\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Debt Ratio\n# 2. Calculate factors with .shift(1) to prevent look-ahead bias\n# Factor 1: Value (Inverse P/E Ratio) - Higher is better (lower P/E)\n# Fill NaN/inf values before inversion to avoid issues, then ffill\nvalue_factor = (1 / pe_ratio.replace([float('inf'), -float('inf')], float('nan'))).ffill().shift(1)\n# Factor 2: Quality (Net Profit Margin) - Higher is better\nquality_factor = net_profit_margin.ffill().shift(1)\n# Factor 3: Financial Health (Inverse Debt Ratio) - Higher is better (lower debt ratio)\n# Handle potential zero debt ratio by adding a small epsilon or capping, then ffill\nhealth_factor = (1 / (debt_ratio.replace(0, 0.001))).ffill().shift(1) # Replace 0 with small value to avoid inf\n# Factor 4: Size (Inverse Market Cap - favoring smaller caps) - Higher is better (smaller market cap)\nsize_factor = (1 / market_value).shift(1)\n# Factor 5: Short-term Momentum (20-day adjusted close return)\nmomentum_factor = close.pct_change(20).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nvalue_rank = value_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\nhealth_rank = health_factor.rank(axis=1, pct=True)\nsize_rank = size_factor.rank(axis=1, pct=True)\nmomentum_rank = momentum_factor.rank(axis=1, pct=True)\n# Combine with diverse weights, prioritizing underused factors\ncombined_factor = (value_rank * 0.25 +\n                   quality_rank * 0.25 +\n                   health_rank * 0.20 +\n                   size_rank * 0.15 +\n                   momentum_rank * 0.15)\n# 4. Apply filters for liquidity, price, and minimum market cap (structural diversity)\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Minimum market cap > 2 Billion TWD to avoid micro-caps, but still allow small-caps\nmarket_cap_filter = market_value.shift(1) > 2_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select top N stocks (e.g., 10 stocks)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:本益比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:本益比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:27:03.613942",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-02T09:27:31.689694",
      "model": "gemini-2.5-flash",
      "code": "import numpy as np\n\ndef strategy(data):\n    # 1. Load data\n    close = data.get('price:收盤價')\n    volume = data.get('price:成交股數')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return)\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY) - Shifted to avoid look-ahead\n    revenue_growth_factor = revenue_yoy.shift(1)\n\n    # ROE filter - Shifted to avoid look-ahead\n    roe_filter = roe.shift(1)\n\n    # 3. Liquidity filter (Average daily volume > 150M TWD)\n    # Convert volume to TWD value (price * volume) and average over 20 days\n    avg_dollar_volume = (close * volume).rolling(20).mean().shift(1)\n    liquidity_mask = (avg_dollar_volume > 150_000_000)\n\n    # 4. Define selection criteria\n    # High ROE: Top 30% of ROE (increased from previous implicit threshold)\n    # We use a rank-based approach to dynamically select top performers\n    roe_rank_threshold = roe_filter.rank(axis=1, pct=True) > 0.70\n\n    # Strong Revenue Growth: Top 40% of positive revenue growth (more aggressive than before)\n    # Combine with a minimum growth rate to ensure actual growth\n    revenue_growth_rank_threshold = (revenue_growth_factor.rank(axis=1, pct=True) > 0.60) & \\\n                                    (revenue_growth_factor > 5) # Ensure at least 5% YoY growth\n\n    # Price Momentum: Top 30% of 20-day returns (similar to champion)\n    momentum_rank_threshold = returns_20d.rank(axis=1, pct=True) > 0.70\n\n    # Valuation filter: Lower PE ratio (Bottom 50% of positive PE ratios, to avoid extremely high PEs)\n    # Exclude negative PE ratios which often indicate losses\n    pe_lower_bound = pe_ratio.where(pe_ratio > 0).rank(axis=1, pct=True) < 0.50\n\n    # 5. Combine all conditions for stock selection\n    # All conditions must be met (AND logic)\n    # Added PE ratio as a new constraint to refine value\n    # Added ROE rank and revenue growth rank for more robust selection\n    selection = (roe_rank_threshold &\n                 revenue_growth_rank_threshold &\n                 momentum_rank_threshold &\n                 pe_lower_bound &\n                 liquidity_mask)\n\n    # Handle NaN values by filling with False for the boolean mask\n    selection = selection.fillna(False)\n\n    return selection",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:收盤價' not in available datasets",
        "Unknown dataset key: 'price:成交股數' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:收盤價' not in available datasets\n- Unknown dataset key: 'price:成交股數' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:27:26.062576",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-02T09:28:17.140373",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization\n# Underused Fundamental Factors\npb_ratio = data.get('price:股價淨值比') # Underused: Price-to-Book Ratio\nop_margin = data.get('fundamental_features:營業利益率') # Underused: Operating Profit Margin\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Debt Ratio\n# Underused Institutional Factor\nit_strength = data.get('institutional_investors_trading_summary:投信買賣超股數') # Underused: Investment Trust Strength\n# 2. Calculate factors\n# Factor 1: Value (Inverse of Price-to-Book Ratio)\n# Lower P/B is better, so we take the inverse. Add a small epsilon to avoid division by zero.\nvalue_factor = (1 / (pb_ratio.ffill().shift(1) + 0.001))\n# Factor 2: Quality (Operating Profit Margin - 4-quarter average)\n# Higher operating margin indicates better core business profitability.\nquality_op_margin = op_margin.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 3: Financial Health (Inverse of Debt Ratio)\n# Lower debt ratio is better, indicating lower financial risk.\n# Assuming debt_ratio is in percentage, we can use (100 - debt_ratio) or simply rank it.\n# For ranking, lower debt ratio will get a higher rank, which is what we want.\nhealth_debt_ratio = (100 - debt_ratio.ffill().shift(1))\n# Factor 4: Institutional Conviction (Investment Trust Strength - 5-day sum)\n# Higher strength indicates stronger conviction from domestic investment trusts.\ninstitutional_conviction = it_strength.ffill().rolling(window=5, min_periods=1).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nvalue_rank = value_factor.rank(axis=1, pct=True)\nop_margin_rank = quality_op_margin.rank(axis=1, pct=True)\ndebt_ratio_rank = health_debt_ratio.rank(axis=1, pct=True)\nit_conviction_rank = institutional_conviction.rank(axis=1, pct=True)\n# Combine with custom weights, prioritizing value and quality/health\ncombined_factor = (value_rank * 0.35 +\n                   op_margin_rank * 0.30 +\n                   debt_ratio_rank * 0.20 +\n                   it_conviction_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 15 Billion TWD to focus on mid-large caps (underused factor)\nmarket_cap_filter = market_value.shift(1) > 15_000_000_000\n# P/B Ratio filter: P/B < 3.0 to ensure reasonable valuation (underused factor)\npb_filter = pb_ratio.ffill().shift(1) < 3.0\n# Debt Ratio filter: Debt Ratio < 60% to ensure good financial health (underused factor)\ndebt_filter = debt_ratio.ffill().shift(1) < 60\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_filter & debt_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:27:31.810826",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-02T09:28:40.651794",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - Prioritizing underused factors and avoiding common ones\nclose = data.get('etl:adj_close')  # Needed for price filter\ntrading_value = data.get('price:成交金額')  # Needed for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization\npb_ratio = data.get('price:股價淨值比') # Underused: Price-to-Book Ratio\nop_margin = data.get('fundamental_features:營業利益率') # Underused: Operating Profit Margin\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Debt Ratio\nadx = data.indicator('ADX') # Technical, less common than RSI/MACD/KD\n# 2. Calculate factors with .shift(1) and .ffill()\n# Factor 1: Value (Inverse P/B Ratio) - Lower P/B is better, so invert for ranking\n# Use .ffill() for fundamental data to align with daily frequency\nvalue_factor = (1 / pb_ratio.ffill()).shift(1)\n# Factor 2: Quality (Operating Profit Margin) - Higher margin is better\nquality_factor = op_margin.ffill().shift(1)\n# Factor 3: Financial Health (Inverse Debt Ratio) - Lower debt is better, so invert for ranking\nhealth_factor = (1 / debt_ratio.ffill()).shift(1)\n# Factor 4: Trend Strength (ADX) - Higher ADX indicates stronger trend\n# ADX is a daily indicator, no need for ffill\ntrend_strength_factor = adx.shift(1)\n# 3. Normalize factors using rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\nquality_rank = quality_factor.rank(axis=1, pct=True)\nhealth_rank = health_factor.rank(axis=1, pct=True)\ntrend_rank = trend_strength_factor.rank(axis=1, pct=True)\n# Combine with weights - aiming for a balance of value, quality, health, and trend strength\n# Weights sum to 1.0\ncombined_factor = (value_rank * 0.35 +\n                   quality_rank * 0.30 +\n                   health_rank * 0.20 +\n                   trend_rank * 0.15)\n# 4. Apply filters (Mandatory and additional for diversity/risk)\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid very low-priced stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD for larger, more stable companies (underused factor)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# P/B Ratio cap: Avoid extremely high P/B ratios (e.g., > 3.0)\npb_cap_filter = pb_ratio.ffill().shift(1) < 3.0\n# Debt Ratio cap: Avoid companies with excessively high debt (e.g., > 80%)\ndebt_cap_filter = debt_ratio.ffill().shift(1) < 80\n# Combine all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & pb_cap_filter & debt_cap_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select top N stocks (e.g., 10 stocks)\nposition = filtered_factor.is_largest(10)\n#",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:28:17.265244",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-02T09:28:58.714568",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization\npb_ratio = data.get('price:股價淨值比') # Underused: Price-to-Book Ratio\noperating_margin = data.get('fundamental_features:營業利益率') # Underused: Operating Profit Margin\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Debt Ratio\nadx = data.indicator('ADX') # Technical indicator for trend strength\n# 2. Calculate factors (using underused factors and diverse categories)\n# Factor 1: Value (Inverse Price-to-Book Ratio) - Lower P/B is better\n# Use .ffill() for fundamental data, then .shift(1)\nvalue_factor = (1 / pb_ratio).ffill().shift(1)\n# Factor 2: Quality (Operating Profit Margin) - Higher margin is better\n# Use .ffill() for fundamental data, then .shift(1)\nquality_margin_factor = operating_margin.ffill().shift(1)\n# Factor 3: Financial Health (Inverse Debt Ratio) - Lower debt is better\n# Use .ffill() for fundamental data, then .shift(1)\nhealth_debt_factor = (1 / debt_ratio).ffill().shift(1)\n# Factor 4: Trend Strength (ADX) - Higher ADX indicates stronger trend\n# Use .shift(1) for technical indicators\ntrend_adx_factor = adx.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nvalue_rank = value_factor.rank(axis=1, pct=True)\nquality_margin_rank = quality_margin_factor.rank(axis=1, pct=True)\nhealth_debt_rank = health_debt_factor.rank(axis=1, pct=True)\ntrend_adx_rank = trend_adx_factor.rank(axis=1, pct=True)\n# Combine with diverse weights, emphasizing underused fundamental factors\ncombined_factor = (value_rank * 0.35 +\n                   quality_margin_rank * 0.30 +\n                   health_debt_rank * 0.20 +\n                   trend_adx_rank * 0.15)\n# 4. Apply filters (including underused market_value for structural diversity)\n# Liquidity filter: Average trading value over 20 days > 40M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Stock price > 15 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 15\n# Market Capitalization filter: Market value > 10 Billion TWD (prioritize mid/large caps)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# P/B Ratio floor filter: Avoid extremely low P/B which might indicate distress (e.g., P/B > 0.5)\npb_floor_filter = pb_ratio.ffill().shift(1) > 0.5\n# Combine all filters\nall_filters = liquidity_filter & price_filter & market_cap_filter & pb_floor_filter\nfiltered_factor = combined_factor[all_filters]\n# 5. Select stocks (top 10 based on combined factor score)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:股價淨值比' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:股價淨值比' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T17:28:40.801471",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 0,
      "timestamp": "2025-11-02T10:24:23.773363",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # 1. Load data\n    close = data.get('etl:adj_close')\n    volume = data.get('price:成交金額')\n    revenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\n    roe = data.get('fundamental_features:ROE稅後')\n    pe_ratio = data.get('price_earning_ratio:本益比')\n\n    # 2. Calculate factors\n    # Momentum factor (20-day return), shifted to prevent look-ahead bias\n    returns_20d = close.pct_change(20).shift(1)\n\n    # Revenue growth factor (YoY), shifted\n    # Using a 3-month average to smooth out monthly volatility and capture trend\n    revenue_growth_factor = revenue_yoy.rolling(3).mean().shift(1)\n\n    # ROE factor, shifted\n    # High ROE indicates quality, filter for strong profitability\n    roe_factor = roe.shift(1)\n\n    # PE Ratio factor, shifted\n    # Lower PE is generally better, but we want to avoid value traps\n    pe_factor = pe_ratio.shift(1)\n\n    # 3. Define selection criteria\n    # Filter for high ROE (top quartile of positive ROE stocks)\n    # Using a minimum ROE of 8% as a base quality threshold\n    roe_condition = (roe_factor > 8) & (roe_factor.rank(axis=1, pct=True) >= 0.75)\n\n    # Filter for strong revenue growth (positive and above median)\n    # Increased minimum revenue growth to 10%\n    revenue_growth_condition = (revenue_growth_factor > 10) & (revenue_growth_factor.rank(axis=1, pct=True) >= 0.5)\n\n    # Filter for strong price momentum (positive and above median)\n    # Using a 60-day momentum to capture stronger trends vs 20-day\n    returns_60d = close.pct_change(60).shift(1)\n    momentum_condition = (returns_60d > 0) & (returns_60d.rank(axis=1, pct=True) >= 0.6) # Top 40% momentum\n\n    # Filter out extremely high PE ratios to avoid overvalued stocks\n    # Upper bound PE of 30, lower bound of 5 to avoid potential value traps\n    pe_condition = (pe_factor < 30) & (pe_factor > 5)\n\n    # 4. Liquidity filter: Average daily volume over 20 days > 150M TWD\n    # Using close price * volume to estimate transaction value\n    avg_dollar_volume = (close * volume).rolling(20).mean().shift(1)\n    liquidity_condition = avg_dollar_volume > 150_000_000\n\n    # 5. Combine all conditions\n    # All conditions must be met for a stock to be selected\n    # Adding PE condition to balance growth/momentum with valuation\n    stock_selection = roe_condition & revenue_growth_condition & momentum_condition & pe_condition & liquidity_condition\n\n    # 6. Position sizing (equal weight for selected stocks)\n    # Fill NaN values in stock_selection with False before calculating positions\n    position = stock_selection.astype(float).divide(stock_selection.sum(axis=1), axis=0).fillna(0)\n\n    return position",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n✅ Execution: SUCCESS\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:24:15.357700",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "iteration_num": 0,
        "timestamp": "2025-11-02T10:24:15.374814",
        "model_config": {
          "model_name": "gemini-2.5-flash",
          "temperature": 1.0,
          "max_tokens": 8000
        },
        "prompt_config": {
          "template_path": "prompt_template_v3_comprehensive.txt",
          "version": "v3_comprehensive",
          "template_hash": "sha256:70967f435e0f21ba5192c15dd433ba426bda3cd76487781c45ad56a4c28aa213"
        },
        "system_thresholds": {
          "anti_churn_threshold": 0.05,
          "probation_period": 2,
          "novelty_threshold": 0.3,
          "max_iterations": 30
        },
        "environment_state": {
          "python_version": "3.10.12 (main, Aug 15 2025, 14:32:43) [GCC 11.4.0]",
          "packages": {
            "finlab": "1.5.3",
            "pandas": "2.3.2",
            "numpy": "2.2.6",
            "scipy": "1.15.3"
          },
          "api_endpoints": [
            "https://generativelanguage.googleapis.com/v1beta"
          ],
          "os_info": "Linux 5.15.153.1-microsoft-standard-WSL2"
        },
        "custom_config": null
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 1,
      "timestamp": "2025-11-02T10:25:23.127056",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused: Market Capitalization for size factor and filter\ngross_margin = data.get('fundamental_features:營業毛利率') # Underused: Quality factor\nnet_margin = data.get('fundamental_features:稅後淨利率') # Underused: Quality factor\npe_ratio = data.get('price_earning_ratio:本益比') # Underused: Value factor\npb_ratio = data.get('price_earning_ratio:股價淨值比') # Underused: Value factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused: Financial health/risk factor\n# 2. Calculate factors (apply shift(1) and ffill() as needed)\n# All fundamental data are typically monthly/quarterly, so ffill() is used.\n# Market value is daily, so only shift(1) is needed.\n# Factor 1: Quality - Profitability Margins\n# Higher gross and net margins are better\nprofit_margin_factor = (gross_margin.ffill().shift(1) + net_margin.ffill().shift(1)) / 2\n# Factor 2: Value - Inverse P/E and P/B\n# Lower P/E and P/B are better, so we will invert their ranks later\npe_factor = pe_ratio.ffill().shift(1)\npb_factor = pb_ratio.ffill().shift(1)\n# Factor 3: Financial Health - Inverse Debt Ratio\n# Lower debt ratio is better\ndebt_health_factor = debt_ratio.ffill().shift(1)\n# Factor 4: Size - Inverse Market Capitalization (Small Cap bias)\n# Lower market value is better for small cap\nsize_factor = market_value.shift(1)\n# 3. Normalize factors (rank first, then invert if \"low is good\")\n# Normalize profitability: higher is better\nprofit_margin_rank = profit_margin_factor.rank(axis=1, pct=True)\n# Normalize value factors: lower P/E and P/B are better, so invert rank\npe_rank_inv = (1 - pe_factor.rank(axis=1, pct=True))\npb_rank_inv = (1 - pb_factor.rank(axis=1, pct=True))\nvalue_rank = (pe_rank_inv * 0.5 + pb_rank_inv * 0.5)\n# Normalize financial health: lower debt ratio is better, so invert rank\ndebt_health_rank_inv = (1 - debt_health_factor.rank(axis=1, pct=True))\n# Normalize size factor: lower market value is better for small cap, so invert rank\nsize_rank_inv = (1 - size_factor.rank(axis=1, pct=True))\n# Combine normalized factors with unique weights\n# Emphasizing Quality and Value, with Financial Health and Small Cap as supporting factors\ncombined_factor = (profit_margin_rank * 0.40 +\n                   value_rank * 0.30 +\n                   debt_health_rank_inv * 0.20 +\n                   size_rank_inv * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000 # Increased threshold from example\n# Price filter: Avoid penny stocks\nprice_filter = close.shift(1) > 15 # Increased threshold from example\n# Market Cap filter: Explicitly target small to mid-cap stocks (e.g., < 15 billion TWD)\nmarket_cap_filter = market_value.shift(1) < 15_000_000_000\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Use a slightly different stop loss (0.10) for structural diversity\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.10)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {
        "total_return": -0.7151504415299231,
        "annual_return": -0.6217776935747713,
        "sharpe_ratio": 1.2101400353631708,
        "max_drawdown": -0.3081406620241485,
        "win_rate": 0.8244753019285334,
        "position_count": 252
      },
      "feedback": "============================================================\nPERFORMANCE ATTRIBUTION - Iteration 1\n============================================================\n\n❌ REGRESSION: Sharpe ratio degraded\n  Previous: 2.4751\n  Current:  1.2101\n  Delta:    -1.2650\n\n📊 DETECTED CHANGES (4 total):\n\n🔥 CRITICAL CHANGES (High Impact):\n  • liquidity_threshold:\n      From: 50\n      To:   40000000\n  • roe_smoothing:\n      From: raw (window=1)\n      To:   not_used (window=None)\n\n📝 Other Changes:\n  • revenue_handling: simple_shift → not_used\n  • price_filter: 10 → 15\n\n💡 ATTRIBUTION INSIGHTS:\n\n⚠️  Performance degraded after critical changes:\n\n🎯 LEARNING DIRECTIVE:\n  → Review iteration 6's successful patterns\n  → Preserve proven elements: ROE smoothing, strict filters\n  → Make INCREMENTAL improvements, not revolutionary changes\n============================================================\n\n## CURRENT CHAMPION\n\nIteration: 6\nSharpe Ratio: 2.4751\nEstablished: 2025-10-12 06:43:01\n\nProven Success Patterns:\n- price > 10 TWD - Filters penny stocks\n\n## AVOID (Learned from Past Failures)\n\n- Avoid: Increasing liquidity threshold from 50 to 60 (learned from iter 152)\n- Avoid: Increasing liquidity threshold from 50 to 70000000 (learned from iter 103)\n- Avoid: Increasing liquidity threshold from 50 to 30000000 (learned from iter 24)\n- Avoid: Increasing liquidity threshold from 50 to 80 (learned from iter 15)\n- Avoid: Increasing liquidity threshold from 50 to 20000000 (learned from iter 14)\n- Avoid: Increasing liquidity threshold from 50 to 75 (learned from iter 10)\n- Avoid: Increasing liquidity threshold from 50 to 100 (learned from iter 9)\n- Avoid: Changing roe_smoothing from raw (window=1) to smoothed (window=60) (learned from iter 5)\n- Avoid: Decreasing liquidity threshold from 50 to 40 (learned from iter 3)\n- Avoid: Increasing liquidity threshold from 50 to 50000000 (learned from iter 2)\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:24:23.948223",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 2,
      "timestamp": "2025-11-02T10:25:41.077671",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused factor, used for momentum and filter\npb_ratio = data.get('price_earning_ratio:股價淨值比') # Underused factor\nop_margin = data.get('fundamental_features:營業利益率') # Underused factor\ndebt_ratio = data.get('fundamental_features:負債比率') # Underused factor\n# 2. Calculate factors with .shift(1) and .ffill()\n# Factor 1: Value (Inverse Price-to-Book Ratio)\n# Lower P/B is better, so we'll invert the rank later\npb_factor = pb_ratio.ffill().shift(1)\n# Factor 2: Quality (Operating Profit Margin)\n# Higher operating margin is better\nop_margin_factor = op_margin.ffill().shift(1)\n# Factor 3: Risk/Quality (Inverse Debt Ratio)\n# Lower debt ratio is better, so we'll invert the rank later\ndebt_ratio_factor = debt_ratio.ffill().shift(1)\n# Factor 4: Size Momentum (Market Value Growth)\n# Captures growth in company size, not just stock price\nmv_momentum_factor = market_value.pct_change(60).shift(1) # 60-day market value change\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\npb_rank = pb_factor.rank(axis=1, pct=True)\nop_margin_rank = op_margin_factor.rank(axis=1, pct=True)\ndebt_rank = debt_ratio_factor.rank(axis=1, pct=True)\nmv_momentum_rank = mv_momentum_factor.rank(axis=1, pct=True)\n# Invert ranks for factors where lower values are better (P/B, Debt Ratio)\npb_rank_inverted = 1 - pb_rank\ndebt_rank_inverted = 1 - debt_rank\n# Combine with unique weights\ncombined_factor = (pb_rank_inverted * 0.35 +\n                   op_margin_rank * 0.30 +\n                   debt_rank_inverted * 0.20 +\n                   mv_momentum_rank * 0.15)\n# 4. Apply diverse filters\n# Liquidity filter: Higher threshold to target more liquid stocks\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 100_000_000\n# Price filter: Avoid penny stocks, higher minimum price\nprice_filter = close.shift(1) > 20\n# Market Capitalization filter: Target mid to large cap stocks (using an underused factor)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000 # Filter out small caps (10 Billion TWD)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks (fewer stocks for potentially higher conviction)\nposition = filtered_factor.is_largest(8)\n# 6. Run backtest with monthly rebalancing and a tighter stop loss\nreport = sim(position, resample=\"M\", upload=False, stop_loss=0.05)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {
        "total_return": -0.7453720525460553,
        "annual_return": 0.09265260907757794,
        "sharpe_ratio": 0.4386309454671095,
        "max_drawdown": -0.5385532051669315,
        "win_rate": 0.5574957137537484,
        "position_count": 252
      },
      "feedback": "============================================================\nPERFORMANCE ATTRIBUTION - Iteration 2\n============================================================\n\n❌ REGRESSION: Sharpe ratio degraded\n  Previous: 2.4751\n  Current:  0.4386\n  Delta:    -2.0365\n\n📊 DETECTED CHANGES (5 total):\n\n🔥 CRITICAL CHANGES (High Impact):\n  • liquidity_threshold:\n      From: 50\n      To:   100000000\n  • roe_smoothing:\n      From: raw (window=1)\n      To:   not_used (window=None)\n\n📝 Other Changes:\n  • revenue_handling: simple_shift → not_used\n  • value_factor: pe_ratio → pb_ratio\n  • price_filter: 10 → 20\n\n💡 ATTRIBUTION INSIGHTS:\n\n⚠️  Performance degraded after critical changes:\n\n🎯 LEARNING DIRECTIVE:\n  → Review iteration 6's successful patterns\n  → Preserve proven elements: ROE smoothing, strict filters\n  → Make INCREMENTAL improvements, not revolutionary changes\n============================================================\n\n## CURRENT CHAMPION\n\nIteration: 6\nSharpe Ratio: 2.4751\nEstablished: 2025-10-12 06:43:01\n\nProven Success Patterns:\n- price > 10 TWD - Filters penny stocks\n\n## AVOID (Learned from Past Failures)\n\n- Avoid: Increasing liquidity threshold from 50 to 60 (learned from iter 152)\n- Avoid: Increasing liquidity threshold from 50 to 70000000 (learned from iter 103)\n- Avoid: Increasing liquidity threshold from 50 to 30000000 (learned from iter 24)\n- Avoid: Increasing liquidity threshold from 50 to 80 (learned from iter 15)\n- Avoid: Increasing liquidity threshold from 50 to 20000000 (learned from iter 14)\n- Avoid: Increasing liquidity threshold from 50 to 75 (learned from iter 10)\n- Avoid: Increasing liquidity threshold from 50 to 100 (learned from iter 9)\n- Avoid: Changing roe_smoothing from raw (window=1) to smoothed (window=60) (learned from iter 5)\n- Avoid: Decreasing liquidity threshold from 50 to 40 (learned from iter 3)\n- Avoid: Increasing liquidity threshold from 50 to 50000000 (learned from iter 2)\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:25:23.266494",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 3,
      "timestamp": "2025-11-02T10:26:08.571879",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\noperating_margin = data.get('fundamental_features:營業利益率')  # Underused: Quality/Profitability\npb_ratio = data.get('price_earning_ratio:股價淨值比')  # Underused: Value\nmarket_value = data.get('etl:market_value')  # Underused: Size\ninvestment_trust_strength = data.get('institutional_investors_trading_summary:投信買賣超股數') # Underused: Institutional Conviction\n# 2. Calculate factors\n# Factor 1: Quality - Operating Profit Margin (4-quarter average for stability)\n# Higher operating margin indicates better core business profitability.\nop_margin_factor = operating_margin.ffill().rolling(4).mean().shift(1)\n# Factor 2: Value - Price-to-Book Ratio\n# Lower P/B ratio indicates potential undervaluation.\npb_factor = pb_ratio.shift(1)\n# Factor 3: Size - Market Capitalization\n# Favor smaller to mid-cap stocks for potential growth, but within a reasonable range.\nmarket_cap_factor = market_value.shift(1)\n# Factor 4: Institutional Conviction - Investment Trust Buying Strength\n# Higher strength indicates domestic institutional interest and potential upward momentum.\nit_strength_factor = investment_trust_strength.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nop_margin_rank = op_margin_factor.rank(axis=1, pct=True)\n# For P/B and Market Cap, lower values are better, so reverse the rank\npb_rank = (1 - pb_factor.rank(axis=1, pct=True))\nmarket_cap_rank = (1 - market_cap_factor.rank(axis=1, pct=True))\nit_strength_rank = it_strength_factor.rank(axis=1, pct=True)\n# Combine with unique weights\ncombined_factor = (op_margin_rank * 0.30 +\n                   pb_rank * 0.25 +\n                   market_cap_rank * 0.20 +\n                   it_strength_rank * 0.25)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap Range Filter: Select mid-to-small cap stocks (1B to 20B TWD)\n# This adds structural diversity by targeting a specific market segment.\nmarket_cap_range_filter = (market_value.shift(1) > 1_000_000_000) & \\\n                          (market_value.shift(1) < 20_000_000_000)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_range_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {
        "total_return": -0.2215752911489399,
        "annual_return": 0.2257798618295586,
        "sharpe_ratio": 2.5604600394789623,
        "max_drawdown": -0.16699112669862057,
        "win_rate": 0.23850480201015906,
        "position_count": 252
      },
      "feedback": "============================================================\nPERFORMANCE ATTRIBUTION - Iteration 3\n============================================================\n\n➡️ SIMILAR: Sharpe ratio remained similar\n  Previous: 2.4751\n  Current:  2.5605\n  Delta:    +0.0853\n\n📊 DETECTED CHANGES (5 total):\n\n🔥 CRITICAL CHANGES (High Impact):\n  • liquidity_threshold:\n      From: 50\n      To:   70\n  • roe_smoothing:\n      From: raw (window=1)\n      To:   not_used (window=None)\n\n📝 Other Changes:\n  • revenue_handling: simple_shift → not_used\n  • value_factor: pe_ratio → pb_ratio\n  • price_filter: 10 → 20\n\n💡 ATTRIBUTION INSIGHTS:\n  • No critical changes detected in this iteration\n\n============================================================\n\n## CURRENT CHAMPION\n\nIteration: 6\nSharpe Ratio: 2.4751\nEstablished: 2025-10-12 06:43:01\n\nProven Success Patterns:\n- price > 10 TWD - Filters penny stocks\n\n## AVOID (Learned from Past Failures)\n\n- Avoid: Increasing liquidity threshold from 50 to 60 (learned from iter 152)\n- Avoid: Increasing liquidity threshold from 50 to 70000000 (learned from iter 103)\n- Avoid: Increasing liquidity threshold from 50 to 30000000 (learned from iter 24)\n- Avoid: Increasing liquidity threshold from 50 to 80 (learned from iter 15)\n- Avoid: Increasing liquidity threshold from 50 to 20000000 (learned from iter 14)\n- Avoid: Increasing liquidity threshold from 50 to 75 (learned from iter 10)\n- Avoid: Increasing liquidity threshold from 50 to 100 (learned from iter 9)\n- Avoid: Changing roe_smoothing from raw (window=1) to smoothed (window=60) (learned from iter 5)\n- Avoid: Decreasing liquidity threshold from 50 to 40 (learned from iter 3)\n- Avoid: Increasing liquidity threshold from 50 to 50000000 (learned from iter 2)\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:25:41.217355",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 4,
      "timestamp": "2025-11-02T10:27:21.055471",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_cap = data.get('etl:market_value') # For market cap filter\n# Prioritize underused/rare factors\ngross_profit_margin = data.get('fundamental_features:營業毛利率')\ndebt_ratio = data.get('fundamental_features:負債比率')\npb_ratio = data.get('price_earning_ratio:股價淨值比')\ncurrent_month_revenue = data.get('monthly_revenue:當月營收')\n# 2. Calculate factors\n# Factor 1: Gross Profit Margin (Quality)\n# Higher gross profit margin indicates better operational efficiency.\ngpm_factor = gross_profit_margin.ffill().shift(1)\n# Factor 2: Inverse Debt Ratio (Financial Health)\n# Lower debt ratio indicates stronger financial health, so we invert it.\n# Add a small epsilon to avoid division by zero if debt_ratio is 0.\ndebt_ratio_shifted = debt_ratio.ffill().shift(1)\ndebt_ratio_factor = 1 / (debt_ratio_shifted + 0.001)\n# Factor 3: Inverse Price-to-Book Ratio (Value)\n# Lower P/B ratio indicates better value, so we invert it.\n# Add a small epsilon to avoid division by zero if pb_ratio is 0.\npb_ratio_shifted = pb_ratio.ffill().shift(1)\npb_factor = 1 / (pb_ratio_shifted + 0.001)\n# Factor 4: Monthly Revenue Strength (Short-term Growth/Momentum)\n# Compare current month's revenue to its 3-month average to capture recent strength.\nrevenue_shifted = current_month_revenue.ffill().shift(1)\nrevenue_3m_avg = revenue_shifted.rolling(3).mean()\n# Avoid division by zero for revenue_3m_avg\nrevenue_strength_factor = revenue_shifted / (revenue_3m_avg + 0.001)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\ngpm_rank = gpm_factor.rank(axis=1, pct=True)\ndebt_ratio_rank = debt_ratio_factor.rank(axis=1, pct=True)\npb_rank = pb_factor.rank(axis=1, pct=True)\nrevenue_strength_rank = revenue_strength_factor.rank(axis=1, pct=True)\n# Combine factors with custom weights, emphasizing quality and value.\ncombined_factor = (gpm_rank * 0.30 +\n                   debt_ratio_rank * 0.25 +\n                   pb_rank * 0.25 +\n                   revenue_strength_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: 20-day average trading value > 70M TWD (higher",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n✅ Execution: SUCCESS\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:26:08.718328",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 5,
      "timestamp": "2025-11-02T10:27:28.867552",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # Load necessary data, ensuring no look-ahead bias with .shift(1)\n    close = data.get('etl:adj_close')\n    trading_value = data.get('price:成交金額')\n    operating_margin = data.get('fundamental_features:營業利益率')\n    pb_ratio = data.get('price_earning_ratio:股價淨值比')\n    market_value = data.get('etl:market_value')\n    roe = data.get('fundamental_features:ROE稅後')\n    revenue_growth = data.get('fundamental_features:營收成長率')\n\n    # 1. Liquidity Filter: Average daily trading value > 150M TWD\n    # Shift(1) to avoid look-ahead bias on current day's trading value\n    liquidity_filter = (trading_value.shift(1).rolling(20).mean() > 150_000_000).fillna(False)\n\n    # 2. Price Momentum: Short-term momentum with a slight twist\n    # Calculate 20-day momentum (close price change)\n    momentum_20d = (close.shift(1) / close.shift(21) - 1).rank(axis=1, pct=True)\n\n    # 3. Quality/Profitability: Combine Operating Margin and ROE\n    # Higher operating margin indicates better operational efficiency\n    # High ROE indicates strong profitability\n    quality_score = (operating_margin.shift(1).rank(axis=1, pct=True) * 0.5 +\n                     roe.shift(1).rank(axis=1, pct=True) * 0.5)\n\n    # 4. Value Factor: PB Ratio (lower is better)\n    # Invert PB ratio for ranking (lower PB means higher rank)\n    value_score = (1 / pb_ratio.shift(1)).rank(axis=1, pct=True)\n\n    # 5. Growth Factor: Revenue Growth\n    # Prioritize companies with positive and strong revenue growth\n    growth_filter = (revenue_growth.shift(1) > 0.1).fillna(False) # Require at least 10% growth\n\n    # Combine factors using a weighted approach and cross-sectional ranking\n    # Emphasize momentum and quality, with value as a supporting factor\n    # Filter for growth before ranking\n    combined_score = (momentum_20d * 0.4 + quality_score * 0.3 + value_score * 0.3)\n    \n    # Apply growth and liquidity filters\n    filtered_score = combined_score[growth_filter & liquidity_filter]\n\n    # Select top 5% of stocks based on the combined score\n    # Ensure a minimum number of stocks are selected if available\n    position = filtered_score.rank(axis=1, pct=True) > 0.95\n    \n    # Ensure at least 5 stocks are selected if possible, to prevent empty portfolios\n    # This part requires careful handling to avoid non-vectorized operations if not supported\n    # For FinLab, we usually rely on the top % selection to implicitly handle this.\n    # If a specific number of stocks is needed, a more complex selection logic might be required.\n    # For now, we stick to the top 5% based on rank.\n\n    return position",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n✅ Execution: SUCCESS\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:27:21.193598",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 6,
      "timestamp": "2025-11-02T10:27:55.108583",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\n# Underused/Rare Factors\ngross_margin = data.get('fundamental_features:營業毛利率')\npe_ratio = data.get('price_earning_ratio:本益比')\nrevenue_mom_change = data.get('monthly_revenue:上月比較增減(%)')\nrsi = data.indicator('RSI')\n# 2. Calculate factors with .shift(1) and .ffill()\n# Factor 1: Quality - Smoothed Gross Profit Margin (4-quarter average)\n# Use .ffill() for quarterly data, then .shift(1)\nsmoothed_gross_margin = gross_margin.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 2: Value - Inverse P/E Ratio\n# Handle potential division by zero or negative P/E by replacing inf with 0\ninverse_pe = (1 / pe_ratio.ffill()).replace([float('inf'), -float('inf')], 0).shift(1)\n# Factor 3: Growth - Monthly Revenue MoM Change\n# Use .ffill() for monthly data, then .shift(1)\nrevenue_growth_factor = revenue_mom_change.ffill().shift(1)\n# Factor 4: Technical - RSI Reversal (Lower RSI implies more oversold, higher potential for reversal)\n# Use (100 - RSI) to rank oversold stocks higher\nrsi_reversal_factor = (100 - rsi).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\ngross_margin_rank = smoothed_gross_margin.rank(axis=1, pct=True)\ninverse_pe_rank = inverse_pe.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth_factor.rank(axis=1, pct=True)\nrsi_reversal_rank = rsi_reversal_factor.rank(axis=1, pct=True)\n# Combine with diverse weights, prioritizing underused fundamentals and short-term growth\ncombined_factor = (gross_margin_rank * 0.35 +\n                   inverse_pe_rank * 0.25 +\n                   revenue_growth_rank * 0.25 +\n                   rsi_reversal_rank * 0.15)\n# 4. Apply filters for liquidity, price, and fundamental sanity\n# Liquidity filter: Average trading value over 20 days > 60M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 60_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# P/E Ratio filter: P/E between 5 and 30 (reasonable valuation range)\npe_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 30)\n# Gross Margin filter: Ensure positive gross margin\npositive_gross_margin_filter = smoothed_gross_margin > 0\n# Apply all filters",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n✅ Execution: SUCCESS\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:27:29.015392",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 7,
      "timestamp": "2025-11-02T10:29:29.321051",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nimport numpy as np\nclose = data.get('etl:adj_close')  # ✅ Use adjusted data for price filter and P/E, P/B calculation\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_cap = data.get('etl:market_value')  # Underused factor, used for market cap filter\n# Underused/rare factors prioritized for diversity\npe_ratio = data.get('price_earning_ratio:本益比')\npb_ratio = data.get('price_earning_ratio:股價淨值比')\nrevenue_mom = data.",
      "validation_passed": false,
      "validation_errors": [
        "Syntax error at line 9: invalid syntax"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Syntax error at line 9: invalid syntax\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:27:55.251195",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 8,
      "timestamp": "2025-11-02T10:29:56.414498",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value')\nnet_profit_margin_raw = data.get('fundamental_features:稅後淨利率')\npe_ratio_raw = data.get('price_earning_ratio:本益比')\nrevenue_mom_raw = data.get('monthly_revenue:上月比較增減(%)')\nadj_volume_raw = data.get('etl:adj_close_volume')\n# 2. Calculate factors\n# Factor 1: Quality (Smoothed Net Profit Margin)\n# Use 4-quarter rolling mean for stability and ffill for daily alignment\nquality_factor = net_profit_margin_raw.ffill().rolling(4).mean().shift(1)\n# Factor 2: Value (Inverse P/E Ratio)\n# Invert P/E for a \"cheapness\" factor, ffill for daily alignment\n# Handle potential division by zero or negative P/E with filters later\nvalue_factor = (1 / pe_ratio_raw.ffill()).shift(1)\n# Factor 3: Growth Momentum (Smoothed Monthly Revenue MoM)\n# Use 3-month rolling mean for stability and ffill for daily alignment\ngrowth_factor = revenue_mom_raw.ffill().rolling(3).mean().shift(1)\n# Factor 4: Volume Momentum (Current Volume vs. Long-term Average Volume)\n# Compare current adjusted volume to its 60-day moving average\nvolume_momentum = (adj_volume_raw / adj_volume_raw.rolling(60).mean()).shift(1)\n# 3. Combine factors (normalize first!)\nquality_rank = quality_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\ngrowth_rank = growth_factor.rank(axis=1, pct=True)\nvolume_rank = volume_momentum.rank(axis=1, pct=True)\n# Combine with diverse weights\ncombined_factor = (quality_rank * 0.30 +\n                   value_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   volume_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (focus on larger companies)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# P/E Ratio filter: P/E between 5 and 30 (avoiding extreme values and non-profitable companies)\npe_filter = (pe_ratio_raw.ffill().shift(1) > 5) & (pe_ratio_raw.ffill().shift(1) < 30)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pe_filter]\n# 5. Select stocks\n# Select top 12 stocks based on the combined factor score\nposition = filtered_factor.is_largest(12)\n# 6. Run backtest\n# Quarterly rebalancing with an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'etl:adj_close_volume' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'etl:adj_close_volume' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:29:29.561524",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 9,
      "timestamp": "2025-11-02T10:30:18.240187",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value')\nnet_profit_margin = data.get('fundamental_features:稅後淨利率')\npb_ratio = data.get('price_earning_ratio:股價淨值比')\nrevenue_mom = data.get('monthly_revenue:上月比較增減(%)')\nbroker_balance_index = data.get('etl:broker_transactions:balance_index')\n# 2. Calculate factors\n# Factor 1: Quality - Smoothed Net Profit Margin (4-quarter average)\n# Prioritizes 'fundamental_features:稅後淨利率' from underused list\nquality_factor = net_profit_margin.ffill().shift(1).rolling(window=4, min_periods=1).mean()\n# Factor 2: Value - Inverse Price-to-Book Ratio\n# Prioritizes 'fundamental_features:股價淨值比' from underused list\n# Invert so higher values are better (lower P/B)\nvalue_factor = (1 / pb_ratio).ffill().shift(1)\n# Factor 3: Growth Momentum - Monthly Revenue MoM\n# Prioritizes 'monthly_revenue:上月比較增減(%)' from underused list\ngrowth_factor = revenue_mom.ffill().shift(1)\n# Factor 4: Institutional Conviction - Smoothed Broker Balance Index\n# Uses 'etl:broker_transactions:balance_index' for structural diversity\nconviction_factor = broker_balance_index.shift(1).rolling(window=20, min_periods=5).mean()\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nquality_rank = quality_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\ngrowth_rank = growth_factor.rank(axis=1, pct=True)\nconviction_rank = conviction_factor.rank(axis=1, pct=True)\n# Combine with unique weights\ncombined_factor = (quality_rank * 0.30 +\n                   value_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   conviction_rank * 0.20)\n# 4. Apply diverse filters\n# Liquidity filter: Higher threshold than common patterns\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Higher threshold to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Focus on larger companies\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000 # 10 Billion TWD\n# P/B Ratio guardrail: Exclude extremely overvalued stocks\npb_guardrail = pb_ratio.ffill().shift(1) < 3.0\n# Profitability guardrail: Exclude unprofitable companies\nprofitability_guardrail = net_profit_margin.ffill().shift(1) > 0.0\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_guardrail & profitability_guardrail]\n# 5. Select stocks\n# Select top 10 stocks for diversification\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Use quarterly rebalancing and a standard stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'etl:broker_transactions:balance_index' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'etl:broker_transactions:balance_index' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:29:56.558533",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 10,
      "timestamp": "2025-11-02T10:31:14.358305",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Adjusted market cap, used for size filter\n# Underused/rare factors prioritized for diversity\nnet_profit_margin = data.get('fundamental_features:稅後淨利率') # Quality factor\npe_ratio = data.get('price_earning_ratio:本益比') # Value factor\nrevenue_mom_change = data.get('monthly_revenue:上月比較增減(%)') # Short-term growth momentum\ninv_trust_strength = data.get('institutional_investors_trading_summary:投信買賣超股數') # Domestic institutional sentiment\n# 2. Calculate factors\n# Factor 1: Quality - Smoothed Net Profit Margin (4-quarter average)\n# Higher net profit margin is better\nquality_factor = net_profit_margin.ffill().rolling(4).mean().shift(1)\n# Factor 2: Value - Inverse P/E Ratio (lower P/E is better, so inverse makes higher better)\n# Filter out negative P/E (loss-making) later\nvalue_factor = (1 / pe_ratio).shift(1)\n# Factor 3: Short-term Growth Momentum - Monthly Revenue MoM Change\n# Higher MoM change is better\ngrowth_momentum_factor = revenue_mom_change.ffill().shift(1)\n# Factor 4: Domestic Institutional Conviction - Sum of Investment Trust Strength over 5 days\n# Higher strength indicates stronger conviction\ninstitutional_conviction_factor = inv_trust_strength.rolling(5).sum().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nquality_rank = quality_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\ngrowth_momentum_rank = growth_momentum_factor.rank(axis=1, pct=True)\ninstitutional_conviction_rank = institutional_conviction_factor.rank(axis=1, pct=True)\n# Combine with unique weights, emphasizing quality and value, then growth and institutional flow\ncombined_factor = (quality_rank * 0.35 +\n                   value_rank * 0.30 +\n                   growth_momentum_rank * 0.20 +\n                   institutional_conviction_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 70M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market cap filter: Market capitalization > 10 Billion TWD to focus on mid-large caps\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# P/E Ratio filter: P/E must be positive (profitable) and not excessively high (< 30)\npe_filter = (pe_ratio.shift(1) > 0) & (pe_ratio.shift(1) < 30)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pe_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Quarterly rebalancing with an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {
        "total_return": -0.6522826356730406,
        "annual_return": -0.19411739985287213,
        "sharpe_ratio": 2.6215042112672036,
        "max_drawdown": -0.8107547063487905,
        "win_rate": 0.33648934178992396,
        "position_count": 252
      },
      "feedback": "============================================================\nPERFORMANCE ATTRIBUTION - Iteration 10\n============================================================\n\n➡️ SIMILAR: Sharpe ratio remained similar\n  Previous: 2.5605\n  Current:  2.6215\n  Delta:    +0.0610\n\n📊 DETECTED CHANGES (1 total):\n\n📝 Other Changes:\n  • value_factor: pb_ratio → pe_ratio\n\n💡 ATTRIBUTION INSIGHTS:\n  • No critical changes detected in this iteration\n\n============================================================\n\n## CURRENT CHAMPION\n\nIteration: 3\nSharpe Ratio: 2.5605\nEstablished: 2025-11-02T18:26:08.516523\n\nProven Success Patterns:\n- price > 20 TWD - Filters penny stocks\n- market_cap filter - Size-based stock selection\n\n## AVOID (Learned from Past Failures)\n\n- Avoid: Increasing liquidity threshold from 50 to 60 (learned from iter 152)\n- Avoid: Increasing liquidity threshold from 50 to 70000000 (learned from iter 103)\n- Avoid: Increasing liquidity threshold from 50 to 30000000 (learned from iter 24)\n- Avoid: Increasing liquidity threshold from 50 to 80 (learned from iter 15)\n- Avoid: Increasing liquidity threshold from 50 to 20000000 (learned from iter 14)\n- Avoid: Increasing liquidity threshold from 50 to 75 (learned from iter 10)\n- Avoid: Increasing liquidity threshold from 50 to 100 (learned from iter 9)\n- Avoid: Changing roe_smoothing from raw (window=1) to smoothed (window=60) (learned from iter 5)\n- Avoid: Decreasing liquidity threshold from 50 to 40 (learned from iter 3)\n- Avoid: Increasing liquidity threshold from 50 to 50000000 (learned from iter 2)\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:30:18.383721",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 11,
      "timestamp": "2025-11-02T10:31:22.337439",
      "model": "gemini-2.5-flash",
      "code": "def strategy(data):\n    # Load necessary data\n    close = data.get('etl:adj_close')\n    trading_value = data.get('price:成交金額')\n    operating_margin = data.get('fundamental_features:營業利益率')\n    pb_ratio = data.get('price_earning_ratio:股價淨值比')\n    roe = data.get('fundamental_features:ROE稅後')\n    revenue_growth_yoy = data.get('fundamental_features:營收成長率') # Year-over-year revenue growth\n\n    # 1. Liquidity Filter: Ensure sufficient trading volume\n    # Preserve champion's liquidity requirement (>150M TWD average daily trading value)\n    liquidity_filter = trading_value.rolling(window=20).mean().shift(1) > 150_000_000\n\n    # 2. Price Momentum: Short-term price strength (relative to 60-day average)\n    # Champion uses price momentum; refine with relative strength\n    # Calculate 20-day and 60-day simple moving averages\n    ma20 = close.rolling(window=20).mean().shift(1)\n    ma60 = close.rolling(window=60).mean().shift(1)\n\n    # Momentum condition: Current price above short-term MA, and short-term MA above long-term MA\n    # This indicates strong upward trend and avoids whipsaws\n    momentum_filter = (close.shift(1) > ma20) & (ma20 > ma60)\n\n    # 3. Quality Filter (ROE and Operating Margin): Preserve champion's quality focus\n    # High ROE: Companies effectively generating profit from equity\n    # High Operating Margin: Companies with efficient core operations\n    # Shifted to prevent look-ahead bias\n    quality_filter = (roe.shift(1) > 0.15) & (operating_margin.shift(1) > 0.05)\n\n    # 4. Value Filter (PB Ratio): Introduce a value component to balance momentum\n    # Low PB ratio suggests undervaluation relative to book value\n    # Avoid extremely low PB (potential value traps) and extremely high PB\n    pb_filter = (pb_ratio.shift(1) > 0.5) & (pb_ratio.shift(1) < 3)\n\n    # 5. Growth Filter (Revenue Growth): Add a growth component for future potential\n    # Positive year-over-year revenue growth indicates expanding business\n    growth_filter = revenue_growth_yoy.shift(1) > 0.10 # At least 10% YoY growth\n\n    # Combine all filters\n    # The champion likely uses cross-sectional ranking implicitly with price momentum.\n    # Here, we combine filters to select top-performing stocks.\n    # The `&` operator implicitly performs cross-sectional filtering by selecting stocks that meet all conditions.\n    selection = liquidity_filter & momentum_filter & quality_filter & pb_filter & growth_filter\n\n    # Rank selected stocks by a composite score for final position sizing or selection\n    # For simplicity and to maintain champion's structure, we'll return a boolean series.\n    # If a position series with weights is needed, further ranking/weighting would be applied here.\n\n    # Ensure no NaN values in the final selection\n    position = selection.fillna(False)\n\n    return position",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n✅ Execution: SUCCESS\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:31:14.547223",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 12,
      "timestamp": "2025-11-02T10:32:59.971327",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nnet_profit_margin = data.get('fundamental_features:稅後淨利率')  # Underused: Quality factor\nrevenue_mom_change = data.get('monthly_revenue:上月比較增減(%)')  # Underused: Short-term growth momentum\npe_ratio = data.get('price_earning_ratio:本益比')  # Underused: Valuation factor\nadj_volume = data.get('etl:adj_close_volume')  # Underused: Volume confirmation\nmarket_cap = data.get('price:總市值')  # Underused: Market cap filter\n# 2. Calculate factors\n# Factor 1: Quality (Net Profit Margin, 4-quarter average)\n# Use .ffill() for quarterly data to align to daily frequency\nquality_factor = net_profit_margin.ffill().rolling(4).mean().shift(1)\n# Factor 2: Short-term Growth Momentum (Monthly Revenue MoM Change)\n# Use .ffill() for monthly data to align to daily frequency\ngrowth_factor = revenue_mom_change.ffill().shift(1)\n# Factor 3: Value (Inverse P/E Ratio)\n# Handle potential non-positive P/E ratios to avoid division by zero or negative values\npe_ratio_filtered = pe_ratio.ffill().where(pe_ratio.ffill() > 0)\nvalue_factor = (1 / pe_ratio_filtered).shift(1)\n# Clip extreme inverse P/E values to prevent outliers from dominating\nvalue_factor = value_factor.clip(lower=0, upper=0.1) # Corresponds to P/E >= 10\n# Factor 4: Volume Momentum (Ratio of short-term to long-term average volume)\nshort_vol_avg = adj_volume.rolling(5).mean()\nlong_vol_avg = adj_volume.rolling(20).mean()\n# Avoid division by zero or very small long_vol_avg\nvolume_momentum = (short_vol_avg / long_vol_avg).where(long_vol_avg > 0).shift(1)\n# 3. Combine factors (normalize first!)\nquality_rank = quality_factor.rank(axis=1, pct=True)\ngrowth_rank = growth_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\nvolume_momentum_rank = volume_momentum.rank(axis=1, pct=True)\n# Combine with diverse weights\ncombined_factor = (quality_rank * 0.35 +\n                   growth_rank * 0.30 +\n                   value_rank * 0.20 +\n                   volume_momentum_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value > 40 million TWD over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Stock price > 15 TWD\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Total market value > 8 billion TWD (using an underused factor)\nmarket_cap_filter = market_cap.shift(1) > 8_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Rebalance quarterly, with a slightly different stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.07)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'etl:adj_close_volume' not in available datasets",
        "Unknown dataset key: 'price:總市值' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'etl:adj_close_volume' not in available datasets\n- Unknown dataset key: 'price:總市值' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:31:22.474824",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 13,
      "timestamp": "2025-11-02T10:33:57.135133",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Underused, used for market cap filter\n# Underused factors for diversity\npe_ratio = data.get('price_earning_ratio:本益比')\npb_ratio = data.get('price_earning_ratio:股價淨值比')\nrevenue_mom_change = data.get('monthly_revenue:上月比較增減(%)')\nadj_volume = data.get('etl:adj_close_volume')\n# 2. Calculate factors\n# Factor 1: Inverse P/E Ratio (Value) - Prioritize underused\n# Handle potential division by zero or negative P/E by replacing inf/-inf with NaN\ninverse_pe = (1 / pe_ratio).replace([float('inf'), -float('inf')], float('nan'))\ninverse_pe = inverse_pe.ffill().shift(1)\n# Factor 2: Inverse P/B Ratio (Value) - Prioritize underused\n# Handle potential division by zero or negative P/B by replacing inf/-inf with NaN\ninverse_pb = (1 / pb_ratio).replace([float('inf'), -float('inf')], float('nan'))\ninverse_pb = inverse_pb.ffill().shift(1)\n# Factor 3: Monthly Revenue MoM Change (Growth) - Prioritize underused\nrevenue_growth_factor = revenue_mom_change.ffill().shift(1)\n# Factor 4: Volume Momentum (Demand/Interest) - Prioritize underused\n# Ratio of short-term average volume to long-term average volume\nshort_avg_volume = adj_volume.rolling(5).mean()\nlong_avg_volume = adj_volume.rolling(20).mean()\nvolume_momentum = (short_avg_volume / long_avg_volume - 1).shift(1)\n# 3. Combine factors (normalize first!)\ninverse_pe_rank = inverse_pe.rank(axis=1, pct=True)\ninverse_pb_rank = inverse_pb.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth_factor.rank(axis=1, pct=True)\nvolume_momentum_rank = volume_momentum.rank(axis=1, pct=True)\n# Combine with diverse weights, emphasizing underused value and growth factors\ncombined_factor = (inverse_pe_rank * 0.30 +\n                   inverse_pb_rank * 0.30 +\n                   revenue_growth_rank * 0.25 +\n                   volume_momentum_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days, slightly higher threshold\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Avoid penny stocks, slightly higher threshold\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Target larger companies, underused as a filter\nmarket_cap_filter = market_value.shift(1) > 8_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Use quarterly rebalancing and a slightly higher stop loss for structural diversity\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.10)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'etl:adj_close_volume' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'etl:adj_close_volume' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:33:00.139931",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 14,
      "timestamp": "2025-11-02T10:35:15.482288",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Adjusted market capitalization\n# Underused fundamental factors\nnet_profit_margin = data.get('fundamental_features:稅後淨利率') # Quality\nrevenue_mom = data.get('monthly_revenue:上月比較增減(%)') # Short-term Growth\npe_ratio = data.get('price_earning_ratio:本益比') # Value\n# Underused volume factor\nadj_volume = data.get('etl:adj_close_volume') # Adjusted volume\n# 2. Calculate factors\n# Factor 1: Quality - Smoothed Net Profit Margin (4-quarter average)\n# Use ffill() for quarterly data, then shift(1) to prevent look-ahead bias\nquality_factor = net_profit_margin.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 2: Short-term Growth - Monthly Revenue MoM\n# Use ffill() for monthly data, then shift(1)\ngrowth_factor = revenue_mom.ffill().shift(1)\n# Factor 3: Value - Inverse P/E Ratio\n# Use ffill() for quarterly data, then shift(1)\n# Filter out non-positive P/E ratios to avoid division by zero or negative values\npe_factor = pe_ratio.ffill().shift(1)\ninverse_pe = 1 / pe_factor\n# Replace infinite values (from P/E=0) with NaN and ensure only positive P/E contribute to value\ninverse_pe = inverse_pe.replace([float('inf'), -float('inf')], float('nan'))\ninverse_pe[pe_factor <= 0] = float('nan')\n# Factor 4: Volume Momentum - 5-day percentage change of 20-day average volume\n# Shift(1) for daily data\nvolume_momentum = adj_volume.rolling(20).mean().pct_change(5).shift(1)\n# 3. Combine factors (normalize first!)\nquality_rank = quality_factor.rank(axis=1, pct=True)\ngrowth_rank = growth_factor.rank(axis=1, pct=True)\ninverse_pe_rank = inverse_pe.rank(axis=1, pct=True)\nvolume_momentum_rank = volume_momentum.rank(axis=1, pct=True)\n# Combine with diverse weights\n# Prioritize quality and value, with growth and volume as supporting signals\ncombined_factor = (quality_rank * 0.35 +\n                   inverse_pe_rank * 0.30 +\n                   growth_rank * 0.20 +\n                   volume_momentum_rank * 0.15)\n# 4. Apply filters (using different thresholds for diversity)\n# Liquidity filter: Average daily trading value > 70M TWD (higher than common 30-50M)\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 70_000_000\n# Price filter: Close price > 20 TWD (higher than common 10 TWD)\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD (targeting mid-large caps)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks\n# Select top 10 stocks (a common, diversified portfolio size)\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Use a tighter stop loss (0.05) for different risk profile\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.05)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'etl:adj_close_volume' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'etl:adj_close_volume' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:33:57.277755",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 15,
      "timestamp": "2025-11-02T10:36:02.087928",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # Market capitalization\nnet_profit_margin = data.get('fundamental_features:稅後淨利率') # Underused: Quality\npe_ratio = data.get('price_earning_ratio:本益比') # Underused: Value\npb_ratio = data.get('price_earning_ratio:股價淨值比') # Underused: Value\nrevenue_mom = data.get('monthly_revenue:上月比較增減(%)') # Underused: Growth\nadj_close_volume = data.get('etl:adj_close_volume') # Underused: Volume\n# 2. Calculate factors with .shift(1) and .ffill()\n# Factor 1: Smoothed Net Profit Margin (Quality)\n# Use 4-quarter rolling average for stability\nquality_factor = net_profit_margin.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 2: Inverse P/E Ratio (Value)\n# Handle potential division by zero or negative P/E with a small epsilon\nvalue_pe_factor = (1 / (pe_ratio.ffill().shift(1) + 1e-6))\n# Factor 3: Monthly Revenue MoM (Growth)\ngrowth_factor = revenue_mom.ffill().shift(1)\n# Factor 4: Volume Momentum (Liquidity/Interest)\n# Calculate 60-day volume change to capture sustained interest\nvolume_momentum_factor = adj_close_volume.pct_change(60).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nquality_rank = quality_factor.rank(axis=1, pct=True)\nvalue_pe_rank = value_pe_factor.rank(axis=1, pct=True)\ngrowth_rank = growth_factor.rank(axis=1, pct=True)\nvolume_momentum_rank = volume_momentum_factor.rank(axis=1, pct=True)\n# Combine with unique weights. Prioritize quality and value, with growth and volume as confirmation.\ncombined_factor = (quality_rank * 0.35 +\n                   value_pe_rank * 0.30 +\n                   growth_rank * 0.20 +\n                   volume_momentum_rank * 0.15)\n# 4. Apply filters for structural diversity\n# Liquidity filter: Higher threshold than common patterns\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Higher minimum price to avoid penny stocks\nprice_filter = close.shift(1) > 25\n# Market Cap filter: Focus on larger, more stable companies\nmarket_cap_filter = market_value.shift(1) > 15_000_000_000\n# P/E Ratio filter: Avoid extremely high or negative P/E ratios (distressed or speculative)\npe_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 30)\n# P/B Ratio filter: Avoid extremely low or high P/B ratios\npb_filter = (pb_ratio.ffill().shift(1) > 0.8) & (pb_ratio.ffill().shift(1) < 4)\n# Quality filter: Ensure positive net profit margin\npositive_profit_filter = quality_factor > 0\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pe_filter & pb_filter & positive_profit_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the filtered combined factor\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'etl:adj_close_volume' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'etl:adj_close_volume' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:35:15.627569",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 16,
      "timestamp": "2025-11-02T10:36:52.534261",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_cap = data.get('price:總市值') # Underused: Total Market Cap\nnet_profit_margin_raw = data.get('fundamental_features:稅後淨利率') # Underused: Net Profit Margin\nbook_value_per_share_raw = data.get('fundamental_features:每股淨值') # Underused: Book Value Per Share\nrevenue_mom_raw = data.get('monthly_revenue:上月比較增減(%)') # Underused: Monthly Revenue MoM\nadj_volume = data.get('etl:adj_close_volume') # Underused: Adjusted Close Volume\n# 2. Calculate factors\n# Factor 1: Quality - Smoothed Net Profit Margin\n# Use 4-quarter rolling average for stability\nquality_factor = net_profit_margin_raw.ffill().rolling(window=4, min_periods=1).mean().shift(1)\n# Factor 2: Value - Inverse Price-to-Book Ratio\n# Calculate P/B using adjusted close and book value per share\n# Then take the inverse, higher is better for value\npb_ratio = close.shift(1) / book_value_per_share_raw.ffill().shift(1)\nvalue_factor = (1 / pb_ratio)\n# Factor 3: Short-term Growth Momentum - Monthly Revenue MoM\n# Already a percentage, forward fill and shift\ngrowth_factor = revenue_mom_raw.ffill().shift(1)\n# Factor 4: Volume Momentum - Ratio of short-term to long-term average volume\n# Indicates increasing interest/accumulation\nshort_term_volume_avg = adj_volume.rolling(window=20).mean().shift(1)\nlong_term_volume_avg = adj_volume.rolling(window=60).mean().shift(1)\nvolume_momentum_factor = short_term_volume_avg / long_term_volume_avg - 1\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nquality_rank = quality_factor.rank(axis=1, pct=True)\nvalue_rank = value_factor.rank(axis=1, pct=True)\ngrowth_rank = growth_factor.rank(axis=1, pct=True)\nvolume_momentum_rank = volume_momentum_factor.rank(axis=1, pct=True)\n# Combine with diverse weights\ncombined_factor = (quality_rank * 0.30 +\n                   value_rank * 0.25 +\n                   growth_rank * 0.25 +\n                   volume_momentum_rank * 0.20)\n# 4. Apply filters for risk management and liquidity\n# Liquidity filter: Average daily trading value > 100M TWD (higher threshold)\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 100_000_000\n# Price filter: Stock price > 15 TWD (slightly higher minimum price)\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Market capitalization > 10 Billion TWD (target larger companies)\nmarket_cap_filter = market_cap.shift(1) > 10_000_000_000\n# P/B Ratio filter: Avoid extremely overvalued stocks by P/B (P/B < 3)\npb_filter = pb_ratio < 3\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_filter]\n# 5. Select stocks\n# Select top 8 stocks (fewer stocks for higher conviction)\nposition = filtered_factor.is_largest(8)\n# 6. Run backtest\n# Quarterly rebalancing with a tighter stop loss of 5%\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.05)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'price:總市值' not in available datasets",
        "Unknown dataset key: 'fundamental_features:每股淨值' not in available datasets",
        "Unknown dataset key: 'etl:adj_close_volume' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'price:總市值' not in available datasets\n- Unknown dataset key: 'fundamental_features:每股淨值' not in available datasets\n- Unknown dataset key: 'etl:adj_close_volume' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:36:02.234626",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 17,
      "timestamp": "2025-11-02T10:37:23.998984",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits, used for price filter\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nnet_profit_margin = data.get('fundamental_features:稅後淨利率')  # Underused: Profitability\npe_ratio = data.get('price_earning_ratio:本益比')  # Underused: Valuation\nrevenue_mom = data.get('monthly_revenue:上月比較增減(%)')  # Underused: Short-term Growth\nmarket_cap = data.get('etl:market_value')  # Underused: Size (as price:總市值)\n# 2. Calculate factors\n# Factor 1: Profitability (Net Profit Margin)\n# Higher net profit margin is better\nfactor_profitability = net_profit_margin.ffill().shift(1)\n# Factor 2: Value (Inverse P/E Ratio)\n# Lower P/E is better, so we invert it for ranking\n# Filter out non-positive P/E ratios before inversion to avoid infinity/NaN\nfactor_value = (1 / pe_ratio).ffill().shift(1)\n# Factor 3: Short-term Revenue Momentum (Monthly Revenue MoM)\n# Higher MoM growth is better\nfactor_growth = revenue_mom.ffill().shift(1)\n# Factor 4: Size (Inverse Market Cap for Small-Cap Bias)\n# Smaller market cap is better, so we invert it for ranking\nfactor_size = (1 / market_cap).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nprofitability_rank = factor_profitability.rank(axis=1, pct=True)\nvalue_rank = factor_value.rank(axis=1, pct=True)\ngrowth_rank = factor_growth.rank(axis=1, pct=True)\nsize_rank = factor_size.rank(axis=1, pct=True)\n# Combine with diverse weights\n# Emphasize profitability and value, with strong growth and a small-cap bias\ncombined_factor = (profitability_rank * 0.35 +\n                   value_rank * 0.30 +\n                   growth_rank * 0.25 +\n                   size_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Target higher liquidity to avoid illiquid stocks\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 100_000_000\n# Price filter: Avoid very low-priced stocks\nprice_filter = close.shift(1) > 25\n# P/E Ratio filter: Exclude extreme or negative P/E values for robustness\npe_ratio_valid_filter = (pe_ratio.ffill().shift(1) > 5) & (pe_ratio.ffill().shift(1) < 40)\n# Net Profit Margin filter: Ensure positive profitability\nprofitability_positive_filter = net_profit_margin.ffill().shift(1) > 0\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & pe_ratio_valid_filter & profitability_positive_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Use quarterly rebalancing and a standard stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {
        "total_return": -0.37761506672124745,
        "annual_return": 0.66300796309076,
        "sharpe_ratio": 2.939224834641932,
        "max_drawdown": -0.024282452267704487,
        "win_rate": 0.6666090278838991,
        "position_count": 252
      },
      "feedback": "============================================================\nPERFORMANCE ATTRIBUTION - Iteration 17\n============================================================\n\n✅ IMPROVEMENT: Sharpe ratio improved\n  Previous: 2.5605\n  Current:  2.9392\n  Delta:    +0.3788\n\n📊 DETECTED CHANGES (3 total):\n\n🔥 CRITICAL CHANGES (High Impact):\n  • liquidity_threshold:\n      From: 70\n      To:   100000000\n\n📝 Other Changes:\n  • value_factor: pb_ratio → pe_ratio\n  • price_filter: 20 → 25\n\n💡 ATTRIBUTION INSIGHTS:\n\n✅ Performance improved after critical changes:\n  • Stricter liquidity filter improved quality\n\n============================================================\n\n## CURRENT CHAMPION\n\nIteration: 3\nSharpe Ratio: 2.5605\nEstablished: 2025-11-02T18:26:08.516523\n\nProven Success Patterns:\n- price > 20 TWD - Filters penny stocks\n- market_cap filter - Size-based stock selection\n\n## AVOID (Learned from Past Failures)\n\n- Avoid: Increasing liquidity threshold from 50 to 60 (learned from iter 152)\n- Avoid: Increasing liquidity threshold from 50 to 70000000 (learned from iter 103)\n- Avoid: Increasing liquidity threshold from 50 to 30000000 (learned from iter 24)\n- Avoid: Increasing liquidity threshold from 50 to 80 (learned from iter 15)\n- Avoid: Increasing liquidity threshold from 50 to 20000000 (learned from iter 14)\n- Avoid: Increasing liquidity threshold from 50 to 75 (learned from iter 10)\n- Avoid: Increasing liquidity threshold from 50 to 100 (learned from iter 9)\n- Avoid: Changing roe_smoothing from raw (window=1) to smoothed (window=60) (learned from iter 5)\n- Avoid: Decreasing liquidity threshold from 50 to 40 (learned from iter 3)\n- Avoid: Increasing liquidity threshold from 50 to 50000000 (learned from iter 2)\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:36:52.698550",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 18,
      "timestamp": "2025-11-02T10:38:40.148892",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data - ALWAYS use adjusted data for price!\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\nmarket_value = data.get('etl:market_value') # For market cap filter\n# Underused/diverse factors\npb_ratio = data.get('price_earning_ratio:股價淨值比') # Prioritize: Underused valuation\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Prioritize: Underused growth\nmfi = data.indicator('MFI') # Less common technical indicator\ninvestment_trust_strength = data.get('institutional_investors_trading_summary:投信買賣超股數') # Underused institutional conviction\n# 2. Calculate factors\n# Factor 1: Value (Inverse P/B Ratio) - Higher is better (lower P/B)\n# Handle potential division by zero or negative P/B\ninverse_pb = (1 / pb_ratio.ffill().shift(1)).replace([float('inf'), -float('inf')], float('nan'))\n# Factor 2: Monthly Revenue Growth Year-over-Year\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 3: Money Flow Index (MFI) - Measures buying/selling pressure\n# MFI is typically 0-100. Higher values indicate stronger buying pressure.\nmoney_flow = mfi.shift(1)\n# Factor 4: Investment Trust Buying Strength - Domestic institutional conviction\n# Higher values indicate stronger conviction from investment trusts.\ntrust_strength = investment_trust_strength.ffill().shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\ninverse_pb_rank = inverse_pb.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth.rank(axis=1, pct=True)\nmoney_flow_rank = money_flow.rank(axis=1, pct=True)\ntrust_strength_rank = trust_strength.rank(axis=1, pct=True)\n# Combine with diverse weights\n# Prioritize value and growth, balance with technical and institutional conviction\ncombined_factor = (inverse_pb_rank * 0.35 +\n                   revenue_growth_rank * 0.30 +\n                   money_flow_rank * 0.20 +\n                   trust_strength_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 40M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Stock price > 15 TWD (avoid penny stocks)\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Market value > 3 Billion TWD (avoid micro-caps)\nmarket_cap_filter = market_value.shift(1) > 3_000_000_000\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter]\n# 5. Select stocks (select top 15 stocks)\nposition = filtered_factor.is_largest(15)\n# 6. Run backtest with quarterly rebalancing and 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {
        "total_return": 0.5503349350319124,
        "annual_return": 0.6955892637079425,
        "sharpe_ratio": 1.1594748979504823,
        "max_drawdown": -0.5368338235416953,
        "win_rate": 0.744762826799729,
        "position_count": 252
      },
      "feedback": "============================================================\nPERFORMANCE ATTRIBUTION - Iteration 18\n============================================================\n\n❌ REGRESSION: Sharpe ratio degraded\n  Previous: 2.9392\n  Current:  1.1595\n  Delta:    -1.7797\n\n📊 DETECTED CHANGES (4 total):\n\n🔥 CRITICAL CHANGES (High Impact):\n  • liquidity_threshold:\n      From: 100000000\n      To:   40\n\n📝 Other Changes:\n  • revenue_handling: not_used → forward_fill\n  • value_factor: pe_ratio → pb_ratio\n  • price_filter: 25 → 15\n\n💡 ATTRIBUTION INSIGHTS:\n\n⚠️  Performance degraded after critical changes:\n  • Relaxing liquidity filter likely reduced quality\n    → Higher threshold (100000000) selects more stable stocks\n\n🎯 LEARNING DIRECTIVE:\n  → Review iteration 17's successful patterns\n  → Preserve proven elements: ROE smoothing, strict filters\n  → Make INCREMENTAL improvements, not revolutionary changes\n============================================================\n\n## CURRENT CHAMPION\n\nIteration: 17\nSharpe Ratio: 2.9392\nEstablished: 2025-11-02T18:37:23.952389\n\nProven Success Patterns:\n- liquidity_filter > 100,000,000 TWD - Selects stable, high-volume stocks\n- price > 25 TWD - Filters penny stocks\n- market_cap filter - Size-based stock selection\n\n## AVOID (Learned from Past Failures)\n\n- Avoid: Increasing liquidity threshold from 50 to 60 (learned from iter 152)\n- Avoid: Increasing liquidity threshold from 50 to 70000000 (learned from iter 103)\n- Avoid: Increasing liquidity threshold from 50 to 30000000 (learned from iter 24)\n- Avoid: Decreasing liquidity threshold from 100000000 to 40 (learned from iter 18)\n- Avoid: Increasing liquidity threshold from 50 to 80 (learned from iter 15)\n- Avoid: Increasing liquidity threshold from 50 to 20000000 (learned from iter 14)\n- Avoid: Increasing liquidity threshold from 50 to 75 (learned from iter 10)\n- Avoid: Increasing liquidity threshold from 50 to 100 (learned from iter 9)\n- Avoid: Changing roe_smoothing from raw (window=1) to smoothed (window=60) (learned from iter 5)\n- Avoid: Decreasing liquidity threshold from 50 to 40 (learned from iter 3)\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:37:24.157582",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 19,
      "timestamp": "2025-11-02T10:40:04.220454",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # ✅ Adjusted for dividends/splits\ntrading_value = data.get('price:成交金額')  # OK for liquidity filter\npe_ratio = data.get('price_earning_ratio:本益比')\npb_ratio = data.get('price_earning_ratio:股價淨值比')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nmarket_value = data.get('etl:market_value')\n# 2. Calculate factors\n# Factor 1: Inverse P/E Ratio (Value factor, lower P/E is better)\n# Handle potential division by zero or negative P/E by replacing inf/-inf with NaN\npe_ratio_inv = (1 / pe_ratio.ffill().shift(1)).replace([float('inf'), -float('inf')], float('nan'))\n# Factor 2: Inverse P/B Ratio (Value factor, lower P/B is better)\n# Handle potential division by zero or negative P/B by replacing inf/-inf with NaN\npb_ratio_inv = (1 / pb_ratio.ffill().shift(1)).replace([float('inf'), -float('inf')], float('nan'))\n# Factor 3: Monthly Revenue Growth (Growth factor)\nrevenue_growth = revenue_yoy.ffill().shift(1)\n# Factor 4: Inverse Market Cap (Size factor, favoring smaller/mid-cap)\n# Handle potential division by zero by replacing inf/-inf with NaN\nmarket_cap_inv = (1 / market_value.shift(1)).replace([float('inf'), -float('inf')], float('nan'))\n# 3. Combine factors (normalize first!)\npe_rank = pe_ratio_inv.rank(axis=1, pct=True)\npb_rank = pb_ratio_inv.rank(axis=1, pct=True)\nrevenue_rank = revenue_growth.rank(axis=1, pct=True)\nmarket_cap_rank = market_cap_inv.rank(axis=1, pct=True)\n# Combine with unique weights, emphasizing value and growth\ncombined_factor = (pe_rank * 0.35 +\n                   pb_rank * 0.30 +\n                   revenue_rank * 0.25 +\n                   market_cap_rank * 0.10)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 40M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Stock price > 15 TWD\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Filter out micro-caps (< 1 Billion TWD) and mega-caps (> 100 Billion TWD)\n# This aims to target mid-cap stocks for a unique risk",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n✅ Execution: SUCCESS\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:38:40.303109",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 20,
      "timestamp": "2025-11-02T10:41:51.323816",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value')\nbvps = data.get('fundamental_features:每股淨值')\npb_ratio = data.get('price_earning_ratio:股價淨值比')\nmonthly_revenue = data.get('monthly_revenue:當月營收')\ninvestment_trust_strength = data.get('institutional_investors_trading_summary:投信買賣超股數')\nrsi = data.indicator('RSI')\n# 2. Calculate factors\n# Factor 1: Book Value Per Share (BVPS) Growth - Underused fundamental\n# Look for companies with increasing BVPS over the past year (4 quarters)\nbvps_growth = bvps.ffill().pct_change(4).shift(1)\n# Factor 2: Inverse Price-to-Book Ratio (Value) - Underused fundamental\n# Lower P/B is better for value, so use 1/P/B\ninverse_pb = (1 / pb_ratio).ffill().shift(1)\n# Factor 3: Monthly Revenue Momentum - Underused high-frequency fundamental\n# Look for strong short-term momentum in current monthly revenue (3-month growth)\nrevenue_momentum = monthly_revenue.ffill().pct_change(3).shift(1)\n# Factor 4: Investment Trust Buying Strength - Less common institutional flow\n# Indicates domestic institutional conviction\nit_strength_factor = investment_trust_strength.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nbvps_growth_rank = bvps_growth.rank(axis=1, pct=True)\ninverse_pb_rank = inverse_pb.rank(axis=1, pct=True)\nrevenue_momentum_rank = revenue_momentum.rank(axis=1, pct=True)\nit_strength_rank = it_strength_factor.rank(axis=1, pct=True)\n# Combine with diverse weights\ncombined_factor = (bvps_growth_rank * 0.30 +\n                   inverse_pb_rank * 0.30 +\n                   revenue_momentum_rank * 0.25 +\n                   it_strength_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days > 40M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Stock price > 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Market value > 8B TWD to focus on mid-large caps\nmarket_cap_filter = market_value.shift(1) > 8_000_000_000\n# RSI filter: Avoid extremely overbought conditions (RSI < 70)\nrsi_filter = rsi.shift(1) < 70\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & rsi_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'fundamental_features:每股淨值' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'fundamental_features:每股淨值' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:40:04.371216",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 21,
      "timestamp": "2025-11-02T10:44:37.270881",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value')\nbook_value_per_share = data.get('fundamental_features:每股淨值')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\ninvestment_trust_strength = data.get('institutional_investors_trading_summary:投信買賣超股數')\ncci = data.indicator('CCI')\natr = data.indicator('ATR')\n# 2. Calculate factors\n# Factor 1: Value (Book Value Per Share) - Higher BVPS is generally better\n# Use ffill for quarterly data and shift to prevent look-ahead bias\nbvps_factor = book_value_per_share.ffill().shift(1)\n# Factor 2: Growth (Monthly Revenue Year-over-Year Growth) - Higher growth is better\n# Use ffill for monthly data and shift to prevent look-ahead bias\nrevenue_growth_factor = revenue_yoy.ffill().shift(1)\n# Factor 3: Institutional Conviction (Investment Trust Strength) - Higher strength indicates more buying\n# Use ffill for potentially lower frequency data and shift\nit_strength_factor = investment_trust_strength.ffill().shift(1)\n# Factor 4: Short-term Momentum/Trend (Commodity Channel Index) - Higher positive CCI indicates stronger upward momentum\ncci_factor = cci.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nbvps_rank = bvps_factor.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth_factor.rank(axis=1, pct=True)\nit_strength_rank = it_strength_factor.rank(axis=1, pct=True)\ncci_rank = cci_factor.rank(axis=1, pct=True)\n# Combine with unique weights\ncombined_factor = (bvps_rank * 0.25 +\n                   revenue_growth_rank * 0.30 +\n                   it_strength_rank * 0.25 +\n                   cci_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days must be above 40M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Stock price must be above 15 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Market value must be above 10B TWD to avoid micro",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'fundamental_features:每股淨值' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'fundamental_features:每股淨值' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:41:51.511101",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 22,
      "timestamp": "2025-11-02T10:45:59.296774",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value')\n# Underused factors and related data\npb_ratio = data.get('price_earning_ratio:股價淨值比')\npe_ratio = data.get('price_earning_ratio:本益比')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)')\nmfi = data.indicator('MFI')\n# 2. Calculate factors\n# Factor 1: Inverted Price-to-Book Ratio (Value Factor)\n# Filter out non-positive P/B ratios, then invert. Lower P/B is better for value.\n# Cap P/B to avoid extreme values before inverting.\npb_ratio_clean = pb_ratio.ffill().shift(1).clip(lower=0.5, upper=100)\ninverted_pb = 1 / pb_ratio_clean\n# Factor 2: Monthly Revenue Year-over-Year Growth (Growth Factor)\nrevenue_growth_factor = revenue_yoy.ffill().shift(1)\n# Factor 3: Foreign Buying Strength (Institutional Conviction Factor)\nforeign_strength_factor = foreign_strength.ffill().shift(1)\n# Factor 4: Money Flow Index (Volume-weighted Technical Momentum)\nmfi_factor = mfi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\ninverted_pb_rank = inverted_pb.rank(axis=1, pct=True)\nrevenue_growth_rank = revenue_growth_factor.rank(axis=1, pct=True)\nforeign_strength_rank = foreign_strength_factor.rank(axis=1, pct=True)\nmfi_rank = mfi_factor.rank(axis=1, pct=True)\n# Combine with diverse weights\ncombined_factor = (inverted_pb_rank * 0.30 +\n                   revenue_growth_rank * 0.30 +\n                   foreign_strength_rank * 0.25 +\n                   mfi_rank * 0.15)\n# 4. Apply diverse filters\n# Liquidity filter: Higher threshold to target more liquid stocks\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 75_000_000\n# Price filter: Avoid very low-priced stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Target mid-to-large cap stocks\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# P/E Ratio filter: Avoid extremely overvalued or negative P/E stocks\npe_ratio_shifted = pe_ratio.ffill().shift(1)\npe_ratio_filter = (pe_ratio_shifted > 5) & (pe_ratio_shifted < 35)\n# MFI range filter: Avoid extreme overbought/oversold conditions\nmfi_range_filter = (mfi.shift(1) > 20) & (mfi.shift(1) < 80)\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pe_ratio_filter & mfi_range_filter]\n# 5. Select stocks\nposition = filtered_factor.is_largest(10)",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n✅ Execution: SUCCESS\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:44:37.420330",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 23,
      "timestamp": "2025-11-02T10:48:23.354738",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value')\n# Underused factors for diversity\npb_ratio = data.get('price_earning_ratio:股價淨值比')\nmonthly_revenue = data.get('monthly_revenue:當月營收')\nadj_volume = data.get('etl:adj_close_volume')\nmargin_ratio = data.get('etl:margin_trading_short_sales:margin_ratio')\n# 2. Calculate factors with proper look-ahead prevention\n# Factor 1: Inverse Price-to-Book Ratio (Value)\n# Use .ffill() for quarterly data and .shift(1)\ninverse_pb = (1 / pb_ratio.ffill()).shift(1)\n# Factor 2: Monthly Revenue Momentum (Growth)\n# Use .ffill() for monthly data, calculate MoM change, and .shift(1)\nrevenue_mom = monthly_revenue.ffill().pct_change(1).shift(1)\n# Factor 3: Volume Momentum (Activity/Technical)\n# Calculate 10-day percentage change in adjusted volume and .shift(1)\nvolume_momentum = adj_volume.pct_change(10).shift(1)\n# Factor 4: Margin Ratio Change (Sentiment/Risk)\n# Calculate 5-day change in margin ratio and .shift(1)\nmargin_ratio_change = margin_ratio.diff(5).shift(1)\n# 3. Normalize factors and combine\n# Normalize each factor to percentile ranks [0, 1]\ninverse_pb_rank = inverse_pb.rank(axis=1, pct=True)\nrevenue_mom_rank = revenue_mom.rank(axis=1, pct=True)\nvolume_momentum_rank = volume_momentum.rank(axis=1, pct=True)\nmargin_ratio_change_rank = margin_ratio_change.rank(axis=1, pct=True)\n# Combine factors with diverse weights\n# Prioritizing underused fundamental and growth factors\ncombined_factor = (inverse_pb_rank * 0.35 +\n                   revenue_mom_rank * 0.30 +\n                   volume_momentum_rank * 0.20 +\n                   margin_ratio_change_rank * 0.15)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 20 days\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 40_000_000\n# Price filter: Avoid penny stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Avoid very small cap stocks (using underused market_value)\nmarket_cap_filter = market_value.shift(1) > 8_000_000_000\n# P/B Ratio filter: Exclude extremely high P/B stocks (using underused pb_ratio)\npb_filter = pb_ratio.ffill().shift(1) < 5\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & pb_filter]\n# 5. Select stocks\n# Select top 10 stocks based on the combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'etl:adj_close_volume' not in available datasets",
        "Unknown dataset key: 'etl:margin_trading_short_sales:margin_ratio' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'etl:adj_close_volume' not in available datasets\n- Unknown dataset key: 'etl:margin_trading_short_sales:margin_ratio' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:45:59.442485",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 24,
      "timestamp": "2025-11-02T10:48:29.208343",
      "model": "gemini-2.5-flash",
      "code": "import pandas as pd\n\ndef strategy(data):\n    # 1. Load necessary data (shifted to prevent look-ahead bias)\n    close = data.get('etl:adj_close').shift(1)\n    trading_value = data.get('price:成交金額').shift(1)\n    net_profit_margin = data.get('fundamental_features:稅後淨利率').shift(1)\n    pe_ratio = data.get('price_earning_ratio:本益比').shift(1)\n    revenue_mom = data.get('monthly_revenue:上月比較增減(%)').shift(1)\n    \n    # 2. Liquidity Filter: Ensure average daily trading value is above 150M TWD\n    # Using 20-day rolling mean for robustness\n    liquidity_filter = trading_value.rolling(20).mean() > 150_000_000 \n    \n    # 3. Price Momentum: Calculate 20-day momentum (current price vs. 20 days ago)\n    # Using adjusted close for accurate returns\n    momentum_20d = (close / close.shift(20) - 1).fillna(0)\n    \n    # 4. Moving Average Crossover for trend confirmation\n    # Short-term (10-day) and Long-term (60-day) Simple Moving Averages\n    ma_short = close.rolling(10).mean()\n    ma_long = close.rolling(60).mean()\n    \n    # 5. Trend Filter: Short MA crosses above Long MA, indicating an uptrend\n    trend_filter = (ma_short > ma_long).fillna(False)\n    \n    # 6. Profitability Filter: Use Net Profit Margin to select fundamentally strong companies\n    # Filter for companies with positive and relatively high net profit margins\n    profitability_filter = (net_profit_margin > 5) # Increased threshold for higher quality\n    \n    # 7. Valuation Filter: Incorporate PE Ratio to avoid overvalued stocks\n    # Select stocks with a reasonable PE ratio (e.g., between 5 and 30)\n    # Also, ensure PE is not negative (meaning losses)\n    valuation_filter = (pe_ratio > 5) & (pe_ratio < 30) \n    \n    # 8. Revenue Momentum Filter: Look for companies with growing revenue\n    # Filter for positive month-over-month revenue growth\n    revenue_growth_filter = (revenue_mom > 0)\n    \n    # 9. Combine all filters\n    # The champion strategy relied on strong momentum and low drawdown.\n    # We preserve momentum (momentum_20d > 0.05 for stronger signal) and trend.\n    # We add profitability, valuation, and revenue growth for fundamental strength,\n    # aiming to enhance Sharpe and maintain low drawdown by selecting higher-quality companies.\n    \n    # Strong buy signal: positive momentum, strong uptrend, liquid, profitable, reasonable valuation, and revenue growth\n    # Rank momentum to pick the top performers among qualifying stocks\n    \n    # Ensure all conditions are met AND apply a strong momentum threshold\n    combined_filter = (\n        liquidity_filter & \n        trend_filter & \n        profitability_filter & \n        valuation_filter & \n        revenue_growth_filter &\n        (momentum_20d > 0.05) # Increased momentum threshold for better performance\n    )\n    \n    # 10. Select top N stocks based on momentum from the filtered universe\n    # This step helps to focus on the strongest signals among the qualified stocks.\n    # Rank momentum only for stocks that pass the combined filter\n    filtered_momentum = momentum_20d[combined_filter]\n    \n    # Select top 10 stocks by momentum from the filtered list\n    # Use .rank(ascending=False) to get higher ranks for higher momentum\n    position = filtered_momentum.rank(axis=1, ascending=False) <= 10\n    \n    # Handle cases where no stocks meet the criteria\n    position = position.fillna(False)\n    \n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Line 1: Import statement not allowed: import pandas"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Line 1: Import statement not allowed: import pandas\n\nRequired fixes:\n- Remove all import statements (data.get() provides all needed data)\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:48:23.510229",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 25,
      "timestamp": "2025-11-02T10:51:35.115463",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value')\npb_ratio = data.get('price_earning_ratio:股價淨值比')\nroe = data.get('fundamental_features:ROE稅後')\nrevenue_mom = data.get('monthly_revenue:上月比較增減(%)')\ninv_trust_strength = data.get('institutional_investors_trading_summary:投信買賣超股數')\nmfi = data.indicator('MFI')\n# 2. Calculate factors\n# Factor 1: Value (Inverse Price-to-Book Ratio) - Prioritized underused factor\n# Use ffill for fundamental data, then shift to avoid look-ahead\nvalue_factor = (1 / pb_ratio).ffill().shift(1)\n# Factor 2: Quality (Smoothed Return on Equity)\n# Use 4-",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": true,
      "execution_error": null,
      "metrics": {},
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n✅ Execution: SUCCESS\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:48:29.362653",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 26,
      "timestamp": "2025-11-02T10:52:52.990960",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\npb_ratio_raw = data.get('price_earning_ratio:股價淨值比')\nrevenue_yoy_raw = data.get('monthly_revenue:去年同月增減(%)')\nit_strength_raw = data.get('institutional_investors_trading_summary:投信買賣超股數')\nmarket_cap_raw = data.get('etl:market_value')\nroe_raw = data.get('fundamental_features:ROE稅後')\natr = data.indicator('ATR')\n# 2. Calculate factors\n# Factor 1: Inverse Price-to-Book Ratio (Value)\n# Fill forward for quarterly data, then shift to avoid look-ahead bias\npb_ratio = pb_ratio_raw.ffill()\n# Replace zero or infinite P/B with NaN to avoid division errors, then inverse\ninverse_pb = (1 / pb_ratio.replace([0, float('inf'), -float('inf')], float('nan'))).shift(1)\n# Factor 2: Monthly Revenue Growth Year-over-Year (Growth Momentum)\n# Fill forward for monthly data, then shift\nrevenue_yoy = revenue_yoy_raw.ffill().shift(1)\n# Factor 3: Investment Trust Buying Strength (Institutional Conviction)\n# Fill forward for monthly/weekly data, then shift\nit_strength = it_strength_raw.ffill().shift(1)\n# Factor 4: Inverse Market Capitalization (Small Cap Bias)\n# Shift to avoid look-ahead bias\nmarket_cap = market_cap_raw\n# Replace zero or infinite market cap with NaN, then inverse\ninverse_market_cap = (1 / market_cap.replace([0, float('inf'), -float('inf')], float('nan'))).shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\ninverse_pb_rank = inverse_pb.rank(axis=1, pct=True)\nrevenue_yoy_rank = revenue_yoy.rank(axis=1, pct=True)\nit_strength_rank = it_strength.rank(axis=1, pct=True)\ninverse_market_cap_rank = inverse_market_cap.rank(axis=1, pct=True)\n# Combine with unique weights\ncombined_factor = (inverse_pb_rank * 0.30 +\n                   revenue_yoy_rank * 0.25 +\n                   it_strength_rank * 0.25 +\n                   inverse_market_cap_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average trading value over 60 days > 75M TWD\nliquidity_",
      "validation_passed": true,
      "validation_errors": [],
      "execution_success": false,
      "execution_error": "AttributeError: 'NoneType' object has no attribute 'get'",
      "metrics": null,
      "feedback": "✅ Validation: PASSED - Code meets all security requirements\n\n❌ Execution: FAILED\nError: AttributeError: 'NoneType' object has no attribute 'get'\n\nLikely cause: Invalid dataset key or data object is None\nCheck that all data.get() keys match available datasets\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:51:35.279788",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 27,
      "timestamp": "2025-11-02T10:52:57.806899",
      "model": "gemini-2.5-flash",
      "code": "import pandas as pd\n\ndef strategy(data):\n    # 1. Load necessary data with appropriate shifts to prevent look-ahead bias\n    close = data.get('etl:adj_close').shift(1) # Adjusted close for price calculations\n    trading_value = data.get('price:成交金額').shift(1) # For liquidity filter\n    net_profit_margin = data.get('fundamental_features:稅後淨利率').shift(1) # Profitability\n    pe_ratio = data.get('price_earning_ratio:本益比').shift(1) # Valuation\n    revenue_mom = data.get('monthly_revenue:上月比較增減(%)').shift(1) # Revenue momentum\n\n    # 2. Liquidity Filter: Ensure average daily trading value is above 150M TWD\n    # Calculate 20-day simple moving average of trading value\n    avg_trading_value = trading_value.rolling(window=20, min_periods=10).mean()\n    liquid_stocks = avg_trading_value > 150_000_000\n\n    # 3. Price Momentum: Calculate 20-day price momentum\n    # Use adjusted close price to calculate momentum\n    momentum_20d = (close / close.rolling(window=20, min_periods=10).mean()) - 1\n    # Select top 30% stocks by momentum\n    top_momentum = momentum_20d.rank(axis=1, pct=True) > 0.7\n\n    # 4. Profitability & Valuation Filter: Combine Net Profit Margin and PE Ratio\n    # High net profit margin (above median) implies good profitability\n    high_profitability = net_profit_margin.rank(axis=1, pct=True) > 0.5\n\n    # Low PE ratio (below 25th percentile, but not negative/too low indicating distress)\n    # Ensure PE is positive and not excessively high\n    low_pe = (pe_ratio < pe_ratio.quantile(0.25, axis=1)) & (pe_ratio > 5)\n\n    # 5. Revenue Momentum Filter: Look for companies with increasing revenue month-over-month\n    # Revenue momentum above 0 implies growth\n    positive_revenue_mom = revenue_mom > 0\n\n    # 6. Combine all filters\n    # The champion strategy relied on strong momentum and low drawdowns.\n    # We enhance it by adding profitability, valuation, and revenue growth.\n    # The liquidity filter is crucial for tradability.\n    combined_signal = (\n        liquid_stocks\n        & top_momentum\n        & high_profitability\n        & low_pe\n        & positive_revenue_mom\n    )\n\n    # Handle NaN values by filling with False\n    position = combined_signal.fillna(False)\n\n    return position",
      "validation_passed": false,
      "validation_errors": [
        "Line 1: Import statement not allowed: import pandas"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Line 1: Import statement not allowed: import pandas\n\nRequired fixes:\n- Remove all import statements (data.get() provides all needed data)\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:52:53.148485",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 28,
      "timestamp": "2025-11-02T10:54:16.449124",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')  # Adjusted for dividends/splits, used for filters\ntrading_value = data.get('price:成交金額')  # Used for liquidity filter\nmarket_value = data.get('etl:market_value')  # Used for market cap filter\nmonthly_revenue_yoy = data.get('monthly_revenue:去年同月增減(%)') # Underused factor: Monthly Revenue YoY Growth\nbook_value_per_share = data.get('fundamental_features:每股淨值') # Underused factor: Book Value Per Share\nforeign_strength = data.get('institutional_investors_trading_summary:外陸資買賣超股數(不含外資自營商)') # Less common institutional factor: Foreign Buying Strength\nmfi = data.indicator('MFI') # Less common technical indicator: Money Flow Index\n# 2. Calculate factors\n# Factor 1: Monthly Revenue Growth Momentum (MRGM)\n# Captures short-term fundamental growth, forward-fill and shift to avoid look-ahead\nmrgm_factor = monthly_revenue_yoy.ffill().shift(1)\n# Factor 2: Book Value Growth (BVG)\n# Captures fundamental quality/value growth over 4 quarters, forward-fill and shift\nbook_value_per_share_ffill = book_value_per_share.ffill()\nbvg_factor = book_value_per_share_ffill.pct_change(4).shift(1)\n# Factor 3: Foreign Buying Strength (FBS)\n# Captures institutional conviction and smart money flow, forward-fill and shift\nfbs_factor = foreign_strength.ffill().shift(1)\n# Factor 4: Money Flow Index (MFI)\n# Captures buying/selling pressure based on price and volume, shifted\nmfi_factor = mfi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks [0, 1]\nmrgm_rank = mrgm_factor.rank(axis=1, pct=True)\nbvg_rank = bvg_factor.rank(axis=1, pct=True)\nfbs_rank = fbs_factor.rank(axis=1, pct=True)\nmfi_rank = mfi_factor.rank(axis=1, pct=True)\n# Combine with diverse weights, emphasizing underused fundamental and institutional factors\ncombined_factor = (mrgm_rank * 0.30 +\n                   bvg_rank * 0.25 +\n                   fbs_rank * 0.25 +\n                   mfi_rank * 0.20)\n# 4. Apply filters\n# Liquidity filter: Average daily trading value over 20 days > 50M TWD\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 50_000_000\n# Price filter: Stock price > 20 TWD to avoid penny stocks\nprice_filter = close.shift(1) > 20\n# Market Cap filter: Market value > 10 Billion TWD to focus on mid-large caps (underused factor used as filter)\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000\n# MFI range filter: MFI between 20 and 80 to avoid extreme overbought/oversold conditions\nmfi_range_filter = (mfi.shift(1) > 20) & (mfi.shift(1) < 80)\n# Apply all filters to the combined factor\nfiltered_factor = combined_factor[liquidity_filter & price_filter & market_cap_filter & mfi_range_filter]\n# 5. Select stocks\n# Select the top 10 stocks based on the filtered combined factor score\nposition = filtered_factor.is_largest(10)\n# 6. Run backtest\n# Backtest with quarterly rebalancing and an 8% stop loss\nreport = sim(position, resample=\"Q\", upload=False, stop_loss=0.08)",
      "validation_passed": false,
      "validation_errors": [
        "Unknown dataset key: 'fundamental_features:每股淨值' not in available datasets"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Unknown dataset key: 'fundamental_features:每股淨值' not in available datasets\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:52:57.965401",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    },
    {
      "iteration_num": 29,
      "timestamp": "2025-11-02T10:55:34.501573",
      "model": "gemini-2.5-flash",
      "code": "# 1. Load data\nclose = data.get('etl:adj_close')\ntrading_value = data.get('price:成交金額')\nmarket_value = data.get('etl:market_value')\npb_ratio = data.get('price_earning_ratio:股價淨值比')\nrevenue_yoy = data.get('monthly_revenue:去年同月增減(%)')\ninvestment_trust_strength = data.get('institutional_investors_trading_summary:投信買賣超股數')\nmfi = data.indicator('MFI')\npe_ratio = data.get('price_earning_ratio:本益比')\n# 2. Calculate factors\n# Factor 1: Value (Inverse P/B Ratio) - Prioritizing underused fundamental_features:股價淨值比\n# Handle potential division by zero or negative P/B by setting to NaN or a very low rank later\npb_ratio_shifted = pb_ratio.ffill().shift(1)\nvalue_factor = 1 / pb_ratio_shifted\n# Replace inf with NaN for ranking\nvalue_factor = value_factor.replace([float('inf'), -float('inf')], float('nan'))\n# Factor 2: Growth (Monthly Revenue YoY) - Prioritizing underused monthly_revenue\ngrowth_factor = revenue_yoy.ffill().shift(1)\n# Factor 3: Institutional Conviction (Investment Trust Strength) - Prioritizing underused institutional data\nconviction_factor = investment_trust_strength.ffill().shift(1)\n# Factor 4: Money Flow Momentum (MFI) - Using a less common technical indicator for ranking\nmfi_factor = mfi.shift(1)\n# 3. Combine factors (normalize first!)\n# Normalize each factor to percentile ranks\nvalue_rank = value_factor.rank(axis=1, pct=True)\ngrowth_rank = growth_factor.rank(axis=1, pct=True)\nconviction_rank = conviction_factor.rank(axis=1, pct=True)\nmfi_rank = mfi_factor.rank(axis=1, pct=True)\n# Combine with diverse weights, emphasizing underused factors\ncombined_factor = (value_rank * 0.30 +\n                   growth_rank * 0.25 +\n                   conviction_rank * 0.25 +\n                   mfi_rank * 0.20)\n# 4. Apply diverse filters\n# Liquidity filter: Higher threshold than common patterns\nliquidity_filter = trading_value.rolling(20).mean().shift(1) > 100_000_000\n# Price filter: Avoid very low-priced stocks\nprice_filter = close.shift(1) > 15\n# Market Cap filter: Focus on mid-to-large caps, using 'etl:market_value' as a filter, not a ranking factor\nmarket_cap_filter = market_value.shift(1) > 10_000_000_000 # 10 Billion TWD\n# Valuation filter (P/E): Avoid extremely overvalued stocks and negative P/E\npe_ratio_shifted = pe_ratio.ffill().shift(1)\npe_filter = (pe_ratio_shifted < 30) & (pe_ratio_shifted > 0)\n# P/B filter: Ensure positive P/B for value factor validity\npb_filter_positive = pb_ratio_shifted > 0\n# Apply all filters\nfiltered_factor = combined_factor[liquidity_filter &",
      "validation_passed": false,
      "validation_errors": [
        "Syntax error at line 47: '[' was never closed"
      ],
      "execution_success": false,
      "execution_error": null,
      "metrics": null,
      "feedback": "❌ Validation: FAILED\nErrors found:\n- Syntax error at line 47: '[' was never closed\n\nRequired fixes:\n\n\n",
      "data_checksum": "EMPTY_DATA_CHECKSUM_00000000000000000000000000000000000000000000",
      "data_version": {
        "finlab_version": "1.5.3",
        "data_pull_timestamp": "2025-11-02T18:54:16.610350",
        "dataset_row_counts": {
          "price:收盤價": null,
          "price:成交金額": null,
          "fundamental_features:ROE稅後": null
        }
      },
      "config_snapshot": {
        "backtest": {
          "default_start_date": "2018-01-01",
          "default_end_date": "2024-12-31",
          "transaction_costs": {
            "default_fee_ratio": 0.001425,
            "default_tax_ratio": 0.003,
            "conservative": {
              "fee_ratio": 0.0,
              "tax_ratio": 0.003
            },
            "realistic": {
              "fee_ratio": 0.001425,
              "tax_ratio": 0.003
            }
          },
          "report_fee_comparison": true
        },
        "yaml_validation": {
          "enabled": true,
          "normalization": {
            "enabled": true,
            "debug_mode": false,
            "strict_mode": false
          }
        },
        "anti_churn": {
          "probation_period": 2,
          "probation_threshold": 0.1,
          "post_probation_threshold": 0.05,
          "post_probation_relative_threshold": 0.01,
          "additive_threshold": 0.02,
          "threshold_logging_enabled": true,
          "min_sharpe_for_champion": 0.5,
          "target_update_frequency": 0.15,
          "tuning_range": {
            "probation_period": [
              1,
              3
            ],
            "probation_threshold": [
              0.05,
              0.15
            ],
            "post_probation_threshold": [
              0.03,
              0.1
            ]
          },
          "staleness": {
            "staleness_check_interval": 50,
            "staleness_cohort_percentile": 0.1,
            "staleness_min_cohort_size": 5,
            "staleness_enabled": true
          }
        },
        "multi_objective": {
          "enabled": true,
          "calmar_retention_ratio": 0.9,
          "max_drawdown_tolerance": 1.1
        },
        "features": {
          "enable_anti_churn": true,
          "enable_adaptive_tuning": false
        },
        "resource_monitoring": {
          "enabled": "${MONITORING_ENABLED:true}",
          "config_file": "config/monitoring_config.yaml",
          "resource_monitor": {
            "enabled": "${RESOURCE_MONITOR_ENABLED:true}",
            "collection_interval": "${RESOURCE_COLLECTION_INTERVAL:5}"
          },
          "diversity_monitor": {
            "enabled": "${DIVERSITY_MONITOR_ENABLED:true}",
            "collapse_threshold": "${DIVERSITY_COLLAPSE_THRESHOLD:0.1}",
            "collapse_window": "${DIVERSITY_COLLAPSE_WINDOW:5}",
            "staleness_threshold": "${CHAMPION_STALENESS_THRESHOLD:20}"
          },
          "container_monitor": {
            "enabled": "${CONTAINER_MONITOR_ENABLED:true}",
            "scan_interval": "${CONTAINER_STATS_INTERVAL:30}",
            "auto_cleanup": "${CONTAINER_AUTO_CLEANUP:true}"
          },
          "alerting": {
            "enabled": "${ALERTS_ENABLED:true}",
            "evaluation_interval": "${ALERT_EVALUATION_INTERVAL:10}",
            "suppression_window": "${ALERT_SUPPRESSION_WINDOW:300}",
            "thresholds": {
              "memory_percent": "${MEMORY_THRESHOLD:80.0}",
              "cpu_percent": "${CPU_THRESHOLD:90.0}",
              "success_rate_percent": "${SUCCESS_RATE_THRESHOLD:20.0}",
              "orphaned_containers": "${ORPHANED_THRESHOLD:3}"
            }
          },
          "prometheus": {
            "enabled": "${PROMETHEUS_ENABLED:true}",
            "port": "${PROMETHEUS_PORT:8000}",
            "endpoint": "${PROMETHEUS_ENDPOINT:/metrics}"
          },
          "grafana": {
            "dashboard_file": "${GRAFANA_DASHBOARD:config/grafana_dashboard.json}",
            "refresh_interval": "${GRAFANA_REFRESH:5}"
          },
          "log_champion_updates": true,
          "alert_on_excessive_churn": true,
          "alert_on_stagnation": true
        },
        "mutation": {
          "exit_mutation": {
            "enabled": true,
            "weight": 0.2,
            "gaussian_std_dev": 0.15,
            "bounds": {
              "stop_loss_pct": {
                "min": 0.01,
                "max": 0.2
              },
              "take_profit_pct": {
                "min": 0.05,
                "max": 0.5
              },
              "trailing_stop_offset": {
                "min": 0.005,
                "max": 0.05
              },
              "holding_period_days": {
                "min": 1,
                "max": 60
              }
            }
          }
        },
        "exit_mutation": {
          "enabled": true,
          "exit_mutation_probability": 0.3,
          "mutation_config": {
            "tier1_weight": 0.5,
            "tier2_weight": 0.3,
            "tier3_weight": 0.2,
            "parameter_ranges": {
              "stop_loss_range": [
                0.8,
                1.2
              ],
              "take_profit_range": [
                0.9,
                1.3
              ],
              "trailing_range": [
                0.85,
                1.25
              ]
            }
          },
          "validation": {
            "max_retries": 3,
            "validation_timeout": 5
          },
          "monitoring": {
            "log_mutations": true,
            "track_mutation_types": true,
            "log_validation": true
          }
        },
        "maintenance": {
          "contender_threshold": 100,
          "archival_percentage": 0.2,
          "compression_age_days": 180,
          "backup_retention_days": 7
        },
        "sandbox": {
          "enabled": "${SANDBOX_ENABLED:true}",
          "docker": {
            "image": "${DOCKER_IMAGE:finlab-sandbox:latest}",
            "memory_limit": "${DOCKER_MEMORY_LIMIT:2g}",
            "cpu_count": "${DOCKER_CPU_LIMIT:0.5}",
            "timeout_seconds": "${DOCKER_TIMEOUT:600}",
            "network_mode": "${DOCKER_NETWORK_MODE:bridge}",
            "read_only_filesystem": "${DOCKER_READ_ONLY:true}",
            "seccomp_profile": "${SECCOMP_PROFILE:config/seccomp_profile.json}"
          },
          "security": {
            "validation_enabled": "${VALIDATION_ENABLED:true}"
          },
          "monitoring": {
            "enabled": "${MONITORING_ENABLED:true}",
            "export_metrics": "${EXPORT_METRICS:true}"
          }
        },
        "llm": {
          "enabled": true,
          "provider": "openrouter",
          "innovation_rate": 0.3,
          "fallback": {
            "enabled": true,
            "max_retries": 3,
            "retry_delay": 2
          },
          "generation": {
            "max_tokens": "${LLM_MAX_TOKENS:2000}",
            "temperature": "${LLM_TEMPERATURE:0.7}",
            "timeout": "${LLM_TIMEOUT:60}"
          },
          "model": "${LLM_MODEL:google/gemini-2.5-flash}",
          "openrouter": {
            "api_key": "${OPENROUTER_API_KEY}",
            "model": "${LLM_MODEL:anthropic/claude-3.5-sonnet}",
            "http_referer": "https://github.com/finlab-project",
            "app_name": "finlab-innovation"
          },
          "gemini": {
            "api_key": "${GOOGLE_API_KEY}",
            "model": "${LLM_MODEL:gemini-2.5-flash}",
            "safety": {
              "block_none": false
            }
          },
          "openai": {
            "api_key": "${OPENAI_API_KEY}",
            "model": "${LLM_MODEL:gpt-4}",
            "organization": "${OPENAI_ORG_ID}"
          }
        },
        "fitness": {
          "multi_objective_weights": {
            "sharpe": 0.7,
            "diversity": 0.3
          },
          "diversity_calculation": {
            "factor_weight": 0.4,
            "correlation_weight": 0.3,
            "risk_weight": 0.3
          },
          "similarity_rejection": {
            "factor_overlap_threshold": 0.8,
            "correlation_threshold": 0.75
          },
          "mode": "${LLM_MODE:structured}",
          "hybrid_structured_ratio": "${HYBRID_STRUCTURED_RATIO:0.80}"
        },
        "structured_innovation": {
          "validation": {
            "strict_mode": "${YAML_STRICT_MODE:true}",
            "timeout": "${YAML_VALIDATION_TIMEOUT:5}",
            "max_retries": "${YAML_VALIDATION_RETRIES:3}",
            "detailed_errors": "${YAML_DETAILED_ERRORS:true}"
          },
          "code_generation": {
            "debug_mode": "${CODE_GEN_DEBUG:false}",
            "timeout": "${CODE_GEN_TIMEOUT:10}",
            "validate_ast": "${VALIDATE_GENERATED_CODE:true}",
            "check_imports": "${CHECK_IMPORTS:true}"
          },
          "fallback": {
            "auto_fallback": "${AUTO_FALLBACK:true}",
            "fallback_mode": "${FALLBACK_MODE:factor_graph}",
            "log_fallbacks": "${LOG_FALLBACKS:true}"
          },
          "extraction": {
            "multi_pattern": "${MULTI_PATTERN_EXTRACTION:true}",
            "max_attempts": "${EXTRACTION_MAX_ATTEMPTS:3}",
            "cleanup_enabled": "${CLEAN_YAML:true}"
          },
          "monitoring": {
            "log_validation": "${LOG_VALIDATION:true}",
            "log_code_generation": "${LOG_CODE_GEN:true}",
            "export_metrics": "${EXPORT_YAML_METRICS:true}"
          }
        }
      },
      "mode": null,
      "parameters": null
    }
  ]
}